<!DOCTYPE html>
<html lang="de" dir="ltr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Taussil â€“ Jetzt bestellen</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#5a5a5a; --card:#f1f1f1; --ink:#111; --muted:#555; --cta:#33BBDF;
  --bar:#1d2021; --ok:#22c55e; --warn:#f59e0b; --err:#ef4444;
  --border:1px solid rgba(0,0,0,.12); --radius:16px;
  --shadow:0 12px 28px rgba(0,0,0,.18), 0 2px 8px rgba(0,0,0,.08);
  --hit:48px;
}
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}

/* Shell */
.app{max-width:1200px;margin:0 auto;padding:16px 14px 28px;display:flex;flex-direction:column;gap:12px}

/* Toolbar */
.toolbar{
  position:sticky; top:8px; z-index:20; display:flex; align-items:center; justify-content:space-between; gap:12px;
  background:var(--bar); color:#fff; border-radius:24px; padding:10px 14px; border:1px solid rgba(255,255,255,.12);
  box-shadow:0 8px 24px rgba(0,0,0,.35)
}
.brand{display:flex; align-items:center; gap:10px}
.brand-logo{ width:40px; height:40px; border-radius:10px; object-fit:contain; background:#fff; padding:4px; border:1px solid rgba(255,255,255,.24) }
.brand-name{font-weight:800}
.header-actions{display:flex; gap:8px; align-items:center}
.lang{height:40px; border-radius:12px; border:1px solid rgba(255,255,255,.25); background:#0f1112; color:#fff; padding:0 10px; font-weight:700; cursor:pointer}
.btn,.btn-cta{ height:var(--hit); padding:0 14px; border-radius:14px; border:1px solid rgba(0,0,0,.15); display:inline-flex; align-items:center; justify-content:center; gap:8px; font-weight:800; cursor:pointer }
.btn{ background:#fff; color:#111 }
.btn-cta{ background:linear-gradient(180deg,#33BBDF,#1da9cf); color:#fff; border:none; box-shadow:0 6px 18px rgba(29,169,207,.32) }
.btn-sm{ height:34px; padding:0 10px; border-radius:10px; border:1px solid rgba(0,0,0,.15); background:#fff; font-weight:700; cursor:pointer }

/* Filters */
.filters-bar{ background:var(--card); border:var(--border); border-radius:12px; box-shadow:var(--shadow); padding:10px; display:flex; gap:8px; align-items:center; flex-wrap:wrap }
.input,.select{ height:40px; border-radius:12px; border:1px solid rgba(0,0,0,.14); padding:0 12px; font-size:14px; background:#fff }
.chip{ padding:6px 10px; border:1px solid rgba(0,0,0,.14); border-radius:999px; background:#fff; cursor:pointer; font-size:12px }
.chip.active{ background:#c7f9ff; border-color:#9be5f1 }

.card{ background:var(--card); border:var(--border); border-radius:var(--radius); box-shadow:var(--shadow); padding:12px }
.section-head{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:8px }
.title{ font-weight:800; font-size:18px }
.small{ font-size:12px; color:var(--muted) }
.badge{ font-size:11px; padding:3px 8px; border-radius:999px; background:#eee; color:#222; border:1px solid transparent }
.badge.open{ background:rgba(34,197,94,.12); color:#16a34a; border-color:rgba(34,197,94,.25) }
.badge.closed{ background:rgba(239,68,68,.12); color:#ef4444; border-color:rgba(239,68,68,.25) }

/* GRID: Desktop 3 â†’ Wide 4 â†’ Mobile 2 */
.grid{ display:grid; grid-template-columns: repeat(3, 1fr); gap:12px }
@media (min-width:1280px){ .grid{ grid-template-columns: repeat(4, 1fr) } }
@media (max-width:720px){ .grid{ grid-template-columns: repeat(2, 1fr) } }

/* Tile card */
.tile{
  background:#fff; border:1px solid rgba(0,0,0,.12); border-radius:14px; overflow:hidden;
  display:flex; flex-direction:column; box-shadow:0 4px 12px rgba(0,0,0,.08); min-height:270px
}
/* === Product deals: compact horizontal cards in a grid === */
.pgrid{
  display:grid;
  grid-template-columns: repeat(3, 1fr);
  gap:10px;
}
@media (min-width:1280px){ .pgrid{ grid-template-columns: repeat(4, 1fr) } }
@media (max-width:720px){ .pgrid{ grid-template-columns: repeat(2, 1fr) } }

.pitem{
  background:#fff; border:1px solid rgba(0,0,0,.12); border-radius:14px;
  box-shadow:0 4px 12px rgba(0,0,0,.08);
  display:grid; grid-template-columns: 84px 1fr auto; /* ØµÙˆØ±Ø© ÙŠØ³Ø§Ø±ØŒ Ù…Ø¹Ù„ÙˆÙ…Ø§ØªØŒ Ø²Ø± ÙŠÙ…ÙŠÙ† */
  align-items:center; gap:10px; padding:8px 10px;
  min-height:120px; /* ~ Ù†ØµÙ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ø·Ø¹Ù… */
}
.pitem-left{
  width:84px; height:84px; border:1px solid rgba(0,0,0,.1); border-radius:10px;
  background:#fff; display:flex; align-items:center; justify-content:center; overflow:hidden;
}
.pitem-left img{ width:100%; height:100%; object-fit:contain; object-position:center; display:block }

.pitem-mid{ display:flex; flex-direction:column; gap:4px; min-width:0 }
.pname{ font-weight:800; font-size:12px; line-height:1.2; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
.prest{ font-size:11px; color:#555; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
.pprice{ font-weight:800; font-size:12px }
.pprice s{ opacity:.6; margin-inline-end:6px }

.pitem-right{ display:flex; align-items:center; justify-content:flex-end }
.pitem-right .btn-sm{ height:34px; padding:0 10px; border-radius:10px; }


/* Cover frame (contain) */
.tile-media{
  position:relative; aspect-ratio: 16 / 9; background:#fff; border-bottom:1px solid rgba(0,0,0,.06);
  overflow:hidden; display:flex; align-items:center; justify-content:center;
}
.tile-media > img.tile-cover{
  width:100% !important; height:100% !important; display:block;
  object-fit:contain !important; object-position:center; image-rendering:auto;
}
/* Logo */
.tile-logo{
  position:absolute; bottom:8px; left:8px; width:42px; height:42px; border-radius:10px;
  object-fit:contain; background:#fff; border:1px solid rgba(0,0,0,.12); padding:4px
}
/* Restaurant discount badge over the cover (top-left) */
.rest-disc{
  position:absolute;
  top:10px; left:8px;
  z-index:3;
}
.tile-meta-right{ flex-wrap:wrap } /* ÙŠØ³Ù…Ø­ Ù„Ø¨Ù‚ÙŠØ© Ø§Ù„Ø´Ø§Ø±Ø§Øª Ø¨Ø§Ù„Ø§Ù„ØªÙØ§Ù Ø¯Ø§Ø®Ù„ Ø§Ù„Ø³Ø·Ø± */

[dir="rtl"] .tile-logo{ left:auto; right:8px }
/* Text */
.tile-body{ padding:10px; display:flex; flex-direction:column; gap:6px; flex:1 1 auto; min-height:120px }
.line-1{ display:-webkit-box; -webkit-line-clamp:1; -webkit-box-orient:vertical; overflow:hidden; text-overflow:ellipsis; white-space:normal }
.tile-name{ font-weight:800; font-size:15px }
.tile-sub{ font-size:12px; color:#444 }
/* Full-width action button with outer margins */
.tile-actions{
  padding: 0 10px 10px;           /* ÙŠÙ…ÙŠÙ†/ÙŠØ³Ø§Ø± 5px + Ø£Ø³ÙÙ„ 5px */
}
.tile-actions .btn-cta{
  display:block;
  width:100%;                   /* ÙŠÙ…ØªØ¯ Ø¹Ù„Ù‰ Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© */
}

/* Meta: left/right */
.tile-meta{ display:flex; align-items:center; justify-content:space-between; gap:8px; font-size:12px; color:#333 }
.tile-meta-left{ display:flex; align-items:center; gap:6px }
.tile-meta-right{ display:flex; align-items:center; gap:8px }
.meta-time{ white-space:nowrap; display:inline-flex; align-items:center; gap:4px }
/* Discount base (size only â€“ colors inline from JS) */
.badge.sale{ font-size:20px; padding:5px 20px; font-weight:800; border-radius:999px; }
/* Product discount badge */
.pdisc{
  font-size:11px; font-weight:800; padding:2px 6px; border-radius:999px;
  background:#fee2e2; color:#b91c1c; border:1px solid #fecaca;
}
/* badge Ø£Ø¹Ù„Ù‰ ÙŠÙ…ÙŠÙ† Ø§Ù„ØµÙˆØ±Ø© */
.pdisc-abs{
  position:absolute; top:6px; right:6px;
  z-index:2;
}
[dir="rtl"] .pdisc-abs{ right:auto; left:6px }

/* Dialogs (menu/cart) â€” Ù…Ø®ØªØµØ±Ø© */
.dlg{ width:min(980px,96%); border:none; border-radius:16px; padding:0; overflow:hidden }
.dlg::backdrop{ background:rgba(0,0,0,.45) }
.dlg-head{ display:flex; align-items:center; justify-content:space-between; padding:10px 12px; background:var(--bar); color:#fff }
.dlg-title{ font-weight:800 }
.menu{ display:grid; grid-template-columns: 260px 1fr; gap:12px; padding:12px; background:var(--card); max-height:72vh; overflow:auto }
@media (max-width:900px){ .menu{ grid-template-columns: 1fr } }
.menu-side{ background:#fff; border:1px solid rgba(0,0,0,.08); border-radius:12px; padding:10px; display:flex; flex-direction:column; gap:6px; position:sticky; top:0; height:fit-content }
.menu-cat{ padding:10px; border-radius:10px; border:1px solid rgba(0,0,0,.08); background:#f8fafc; cursor:pointer; font-weight:700; text-align:start }
.menu-cat.active{ background:#e6f7fb; border-color:#aee7f5 }
.menu-list{ background:#fff; border:1px solid rgba(0,0,0,.08); border-radius:12px; padding:10px; display:flex; flex-direction:column; gap:8px }
.item{
  display:grid; grid-template-columns: 72px 1fr auto; gap:8px;
  border-top:1px dashed #e5e7eb; padding-top:8px;
  align-items:center;
}
.item:first-child{ border-top:0; padding-top:0 }

/* Ø¥Ø·Ø§Ø± ØµÙˆØ±Ø© Ø§Ù„Ù…Ù†ØªØ¬ */
.item .ph{
  width:72px; height:72px; border-radius:12px;
  background:#fff; border:1px solid rgba(0,0,0,.08);
  display:flex; align-items:center; justify-content:center; overflow:hidden;
}
.item .im{ width:100%; height:100%; object-fit:contain; object-position:center }

.item:first-child{ border-top:0; padding-top:0 }
.item .nm{ font-weight:800 }
.item .ds{ font-size:12px; color:#555 }
.item .pr{ font-weight:800 }
/* ØªÙˆØ³ÙŠØ· Ø¹Ù…ÙˆØ¯ÙŠ Ø¨ÙŠÙ† ØµÙˆØ±Ø©/Ø§Ø³Ù…/Ø£ÙƒØ´Ù† */
.item{ align-items:center }                   /* ÙŠÙˆØ³Ù‘Ø· Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø¹Ù†ØµØ± ÙƒÙ„Ù‡Ø§ */
.item .txt{
  display:flex; flex-direction:column;
  justify-content:center;                     /* ÙŠÙ†Ø²Ù‘Ù„ Ø§Ù„Ø§Ø³Ù… Ù„Ù„ÙˆØ³Ø· */
  min-height:72px;                            /* Ù†ÙØ³ Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„ØµÙˆØ±Ø© .ph (72px) */
}
.item .act{ display:flex; gap:8px; align-items:center }  /* Ø§Ù„Ø³Ø¹Ø± + Ø²Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ© */

/* Product image (menu) */
.item .ph{
  width:72px; height:72px; border-radius:12px; border:1px solid rgba(0,0,0,.08);
  background:#fff; overflow:hidden; display:flex; align-items:center; justify-content:center;
}
.item .ph img{ width:100%; height:100%; object-fit:contain; object-position:center; display:block }

/* Cart (Ù…Ø®ØªØµØ±) */
.cart{ padding:12px; background:#fff; max-height:60vh; overflow:auto }
/* ØµÙˆØ±Ø© + ØªÙØ§ØµÙŠÙ„ + ÙƒÙ…ÙŠØ© + Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ */
.cart-row{
  display:grid;
  grid-template-columns: 64px 1fr auto auto;
  gap:8px;
  border-bottom:1px solid #eee;
  padding:8px 0;
}

/* Ù…ØµØºÙ‘Ø± Ø§Ù„Ù…Ù†ØªØ¬ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø³Ù„Ø© */
.cart-thumb{
  width:56px; height:56px;
  border-radius:10px;
  border:1px solid rgba(0,0,0,.12);
  object-fit:contain;
  background:#fff;
}

.cart-row .q{ display:flex; gap:6px; align-items:center }
.cart-foot{ display:flex; align-items:center; justify-content:space-between; padding:10px 12px; background:#f6f8fc; border-top:1px solid #e5e7eb }
.total{ font-weight:800 }

/* Toast */
.toast{ position:fixed; left:50%; transform:translateX(-50%); bottom:18px; background:#1d2021; color:#fff; border-radius:12px; padding:10px 14px; opacity:0; transition:opacity .18s; z-index:2000 }
.toast.show{ opacity:1 }

/* Skeleton */
.skel{ border-radius:12px; background:linear-gradient(90deg,#efefef,#f6f6f6,#efefef); background-size:200% 100%; animation:shine 1.6s linear infinite }
@keyframes shine{ 0%{background-position:200% 0} 100%{background-position:-200% 0} }
.tile .skel{ height:160px }
/* --- Horizontal rails (carousels) --- */
/* Category rail (between HOT and TOP) */
.cat-rail{display:flex; gap:10px; overflow:auto; padding:6px 2px; scrollbar-width:none}
.cat-rail::-webkit-scrollbar{display:none}
.cat-chip{
  flex:0 0 auto; display:flex; align-items:center; gap:8px; padding:8px 12px;
  border-radius:999px; border:1px solid rgba(0,0,0,.12); background:#fff; cursor:pointer; user-select:none;
  box-shadow:0 2px 8px rgba(0,0,0,.06); font-weight:700
}
.cat-chip .ico{font-size:18px; line-height:1}
.cat-chip.active{background:#e6f7fb; border-color:#aee7f5}

.rail-card { margin-bottom:12px }
.rail-head { display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px }
.rail-title { font-weight:800; font-size:16px }
.rail {
  position:relative;
  background:#fff; border:1px solid rgba(0,0,0,.08); border-radius:12px; padding:6px;
}
.rail-inner{
  display:flex; gap:12px; overflow:auto; scroll-snap-type:x mandatory; padding:2px;
  scrollbar-width:none; -ms-overflow-style:none;
}
.rail-inner::-webkit-scrollbar{ display:none }
.rail .tile{ flex:0 0 auto; min-width:280px; max-width:340px; scroll-snap-align:start }
.rail-nav{
  position:absolute; top:50%; transform:translateY(-50%); z-index:2;
  width:36px; height:36px; border-radius:10px; border:1px solid rgba(0,0,0,.12);
  background:#fff; cursor:pointer; display:flex; align-items:center; justify-content:center; font-weight:800;
  box-shadow:0 6px 14px rgba(0,0,0,.12);
}
.rail-nav.prev{ left:6px } .rail-nav.next{ right:6px }
@media (max-width:720px){
  .rail .tile{ min-width: 78vw; max-width: 78vw; }
}
/* === Configurator (Optionen) === */
.cfg{ width:min(720px,96%); border:none; border-radius:16px; padding:0; overflow:hidden }
.cfg::backdrop{ background:rgba(0,0,0,.45) }
.cfg-head{ display:flex; align-items:center; justify-content:space-between; padding:10px 12px; background:var(--bar); color:#fff }
.cfg-title{ font-weight:800 }
.cfg-body{ background:var(--card); padding:12px; display:flex; flex-direction:column; gap:10px; max-height:70vh; overflow:auto }
.cfg-row{ background:#fff; border:1px solid rgba(0,0,0,.08); border-radius:12px; padding:10px; }
.cfg-row .hdr{ display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:6px; font-weight:800 }
.cfg-hint{ font-size:12px; color:#666 }
.opt{ display:flex; align-items:center; justify-content:space-between; gap:8px; padding:6px 0; border-top:1px dashed #eee }
.opt:first-child{ border-top:0 }
.opt-left{ display:flex; align-items:center; gap:10px }
.opt-name{ font-weight:600 }
.opt-price{ font-size:12px; color:#333 }
.opt-qty{ display:flex; align-items:center; gap:6px }
.opt-qty .btn-sm{ width:28px; min-width:28px; padding:0; text-align:center }
.cfg-foot{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 12px; background:#f6f8fc; border-top:1px solid #e5e7eb }
.cfg-total{ font-weight:800 }
/* Ø§Ù„Ø´Ø§Ø±Ø© Ø®Ø§Ø±Ø¬ Ø¥Ø·Ø§Ø± Ø§Ù„ØµÙˆØ±Ø© */
.badge-disc{
  position:absolute; top:-8px; right:-8px; z-index:5; pointer-events:none;
  display:inline-flex; align-items:center; justify-content:center;
  min-width:34px; height:22px; padding:0 8px; border-radius:999px;
  background:#ef4444; color:#fff; font-weight:800; font-size:12px; line-height:1;
  box-shadow:0 2px 6px rgba(0,0,0,.25);
}
[dir="rtl"] .badge-disc{ right:auto; left:-8px }

/* ØºÙ„Ø§Ù Ù„Ù„ØµÙˆØ±Ø© Ù„Ù†ÙØ³Ù‚ÙØ· ÙÙˆÙ‚Ù‡ Ø§Ù„Ø´Ø§Ø±Ø© Ø¨Ø¯ÙˆÙ† Ø§Ù„ØªØ£Ø«ÙŠØ± Ø¹Ù„Ù‰ Ø¥Ø·Ø§Ø± Ø§Ù„ØµÙˆØ±Ø© Ù†ÙØ³Ù‡ */
.pitem-left-wrap{ position:relative; width:84px; height:84px }
.item .ph-wrap{ position:relative; width:72px; height:72px }

/* Ø§Ø¬Ø¹Ù„ Ø§Ù„Ø­Ø§ÙˆÙŠØ§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ© ØªÙ…Ù„Ø£ Ø§Ù„ØºÙ„Ø§Ù ÙÙ‚Ø· */
.pitem-left{ width:100%; height:100% }
.item .ph{ width:100%; height:100% }

/* Ø¶Ù…Ø§Ù† Ø£Ù† Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©/Ø§Ù„Ø¹Ù†ØµØ± ØªØ³Ù…Ø­ Ø¨Ø®Ø±ÙˆØ¬ Ø§Ù„Ø´Ø§Ø±Ø© Ù‚Ù„ÙŠÙ„Ø§Ù‹ */
.pitem, .item{ position:relative; overflow:visible }
/* ==== Product deals: mobile = single-column list ==== */
@media (max-width:720px){
  /* Ø§Ø¬Ø¹Ù„ Ø´Ø¨ÙƒØ© Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø¹Ù…ÙˆØ¯Ø§Ù‹ ÙˆØ§Ø­Ø¯Ø§Ù‹ */
  .pgrid{
    grid-template-columns: 1fr !important;
    gap: 10px;                 /* Ù…Ø³Ø§ÙØ© Ù…Ø±ÙŠØ­Ø© Ø¨ÙŠÙ† Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª */
  }

  /* Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ù†ØªØ¬ ØªØ¨Ù‚Ù‰ Ø£ÙÙ‚ÙŠØ©: ØµÙˆØ±Ø© ÙŠØ³Ø§Ø± + Ù†Øµ + Ø²Ø± ÙŠÙ…ÙŠÙ† */
  .pitem{
    grid-template-columns: 84px 1fr auto;  /* ÙƒÙ…Ø§ Ù‡ÙŠØŒ Ù„ÙƒÙ† ØªÙ…ØªØ¯ Ø¨Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø§ÙˆÙŠØ© */
    width: 100%;
  }
}
/* ==== Mobile-only menu layout ==== */
@media (max-width:900px){
  /* Ù…Ù†Ø¨Ø«Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙŠØµØ¨Ø­ Ø¹Ù…ÙˆØ¯ÙŠØ§Ù‹ */
  .menu{
    display:flex !important;
    flex-direction:column;
    gap:10px;
    padding:12px;
    background:var(--card);
    max-height:72vh;
    overflow:auto;
  }

  /* Ø³Ù„Ø§ÙŠØ¯Ø± ÙØ¦Ø§Øª Ø£ÙÙ‚ÙŠ Ø¨Ø§Ù„Ø³Ø­Ø¨ (Ø¨Ø¯ÙˆÙ† Ø£Ø³Ù‡Ù…) */
  .menu-rail{
    display:flex;
    gap:8px;
    overflow:auto;
    padding:6px 2px;
    scrollbar-width:none; -ms-overflow-style:none;
  }
  .menu-rail::-webkit-scrollbar{ display:none }
  .menu-chip{
    flex:0 0 auto;
    display:flex; align-items:center; gap:8px;
    padding:8px 12px;
    border-radius:999px;
    border:1px solid rgba(0,0,0,.12);
    background:#fff;
    cursor:pointer; user-select:none;
    box-shadow:0 2px 8px rgba(0,0,0,.06);
    font-weight:800; font-size:13px;
    white-space:nowrap;
  }
  .menu-chip.active{ background:#e6f7fb; border-color:#aee7f5 }

  /* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ØªØ­Øª Ø§Ù„Ø³Ù„Ø§ÙŠØ¯Ø± Ø¨Ø¹Ø±Ø¶ ÙƒØ§Ù…Ù„ */
  .menu-list{
    background:#fff;
    border:1px solid rgba(0,0,0,.08);
    border-radius:12px;
    padding:10px;
    display:flex;
    flex-direction:column;
    gap:8px;
  }

  /* Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ù†ØªØ¬ Ù„Ù„Ø¬ÙˆØ§Ù„ (ØµÙˆØ±Ø© ÙŠØ³Ø§Ø±ØŒ Ù†Øµ ÙˆØ³Ø·ØŒ Ø²Ø± ÙŠÙ…ÙŠÙ† + Ø§Ù„Ø³Ø¹Ø± ØªØ­Øª Ø§Ù„Ø§Ø³Ù…) */
  .item{
    display:grid;
    grid-template-columns:72px 1fr auto;
    gap:8px;
    align-items:center;
    border-top:1px dashed #e5e7eb;
    padding-top:8px;
  }
  .item:first-child{ border-top:0; padding-top:0 }
  .item .ph{ width:72px; height:72px; border-radius:12px; border:1px solid rgba(0,0,0,.08); background:#fff; overflow:hidden; display:flex; align-items:center; justify-content:center }
  .item .im{ width:100%; height:100%; object-fit:contain; object-position:center }
  .item .txt{ display:flex; flex-direction:column; justify-content:center; gap:2px; min-height:72px }
  .item .nm{ font-weight:800; line-height:1.2 }
  .item .ds{ font-size:12px; color:#555 }
  .item .pr{ font-weight:800 } /* Ø§Ù„Ø³Ø¹Ø± Ø£Ø³ÙÙ„ Ø§Ù„Ø§Ø³Ù… */
  .item .act .btn-sm{ width:34px; min-width:34px; height:34px; padding:0; display:inline-flex; align-items:center; justify-content:center }

  /* Ø´Ø§Ø±Ø© Ø§Ù„Ø®ØµÙ… Ø®Ø§Ø±Ø¬ Ø¥Ø·Ø§Ø± Ø§Ù„ØµÙˆØ±Ø© */
  .item .ph-wrap{ position:relative; width:72px; height:72px }
  .badge-disc{
    position:absolute; top:-8px; right:-8px; z-index:5; pointer-events:none;
    display:inline-flex; align-items:center; justify-content:center;
    min-width:34px; height:22px; padding:0 8px; border-radius:999px;
    background:#ef4444; color:#fff; font-weight:800; font-size:12px; line-height:1;
    box-shadow:0 2px 6px rgba(0,0,0,.25);
  }
}

</style>

<!-- Firebase Compat -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyD0g9T3amjuPodsLS6ZQkHYWrzV1UrX_QI",
    authDomain: "taussil-lieferservice-8bbe9.firebaseapp.com",
    projectId: "taussil-lieferservice-8bbe9",
    storageBucket: "taussil-lieferservice-8bbe9.firebasestorage.app",
    messagingSenderId: "583536892937",
    appId: "1:583536892937:web:5d5ff133de4d8b3b28ecd8",
    databaseURL: "https://taussil-lieferservice-8bbe9-default-rtdb.europe-west1.firebasedatabase.app"
  };
  try{ firebase.initializeApp(firebaseConfig); }catch(e){}
</script>
</head>
<body>
<div class="app">
  <!-- Topbar -->
  <div class="toolbar">
    <div class="brand">
      <img class="brand-logo" src="https://firebasestorage.googleapis.com/v0/b/taussil-lieferservice-8bbe9.firebasestorage.app/o/Stampel%20400%20ohne.png?alt=media&token=6f98c1db-751c-47bc-872d-1628b634b3e2" alt="Taussil">
      <div class="brand-name">Taussil</div>
    </div>
    <div class="header-actions">
      <select id="lang" class="lang" aria-label="Sprache">
        <option value="de" selected>Deutsch</option>
        <option value="en">English</option>
        <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
        <option value="tr">TÃ¼rkÃ§e</option>
      </select>
      <button id="viewCart" class="btn-cta">Warenkorb (0)</button>
    </div>
  </div>

  <!-- Filters -->
  <div class="filters-bar">
    <button class="chip" data-chip="open">Jetzt geÃ¶ffnet</button>
    <select id="sort" class="select">
      <option value="rec">Empfohlen</option>
      <option value="rate">Beste Bewertung</option>
      <option value="fast">Schnellste Zustellung</option>
      <option value="lowfee">Geringe LiefergebÃ¼hr</option>
    </select>
    <select id="city" class="select" style="min-width:160px">
      <option value="">Alle StÃ¤dte</option>
    </select>
    <input id="q" class="input" placeholder="Restaurant suchen â€¦" style="flex:1;min-width:200px">
  </div>

  <!-- Grid -->
  <section class="card">
    <div class="section-head">
      <div class="title" data-i18n="restaurants">Restaurants</div>
      <div class="small" id="countInfo"></div>
    </div>
	<!-- HOT DEALS (>=25%) -->
<section id="rail-hot-sec" class="rail-card card hidden">
  <div class="rail-head">
    <div class="rail-title">ğŸ”¥ Rabatte Ã¼ber 20%</div>

    <div class="small">Top-Deals heute</div>
  </div>
  <div class="rail">
    <button class="rail-nav prev" data-nav="hot">â€¹</button>
    <div id="railHot" class="rail-inner"></div>
    <button class="rail-nav next" data-nav="hot">â€º</button>
  </div>
</section>
<!-- CATEGORIES (chips) -->
<section id="rail-cats" class="rail-card card">
  <div class="rail-head">
    <div class="rail-title" data-i18n="categories">Kategorien</div>
  </div>
  <div id="catRail" class="cat-rail"></div>
</section>

<!-- TOP RATED -->
<section id="rail-top-sec" class="rail-card card hidden">
  <div class="rail-head">
    <div class="rail-title">â­ï¸ Top bewertet</div>
    <div class="small">Unsere Bestseller</div>
  </div>
  <div class="rail">
    <button class="rail-nav prev" data-nav="top">â€¹</button>
    <div id="railTop" class="rail-inner"></div>
    <button class="rail-nav next" data-nav="top">â€º</button>
  </div>
</section>

<!-- PRODUCT DEALS GRID (no slider) -->
<section id="grid-prod-deals" class="card hidden">
  <div class="section-head">
    <div class="title">ğŸ’¸ Angebote auf Produkte</div>
    <div class="small">Artikel mit Rabatt</div>
  </div>
  <div id="prodDealsGrid" class="pgrid"></div>
</section>



    <div id="grid" class="grid">
      <!-- skeleton tiles -->
      <div class="tile"><div class="tile-media"><div class="skel" style="width:100%;height:100%"></div></div></div>
      <div class="tile"><div class="tile-media"><div class="skel" style="width:100%;height:100%"></div></div></div>
      <div class="tile"><div class="tile-media"><div class="skel" style="width:100%;height:100%"></div></div></div>
    </div>
  </section>
</div>

<!-- Menu dialog -->
<dialog id="menuDialog" class="dlg">
  <div class="dlg-head">
    <div class="dlg-title" id="menuTitle">MenÃ¼</div>
    <button id="menuClose" class="btn">âœ•</button>
  </div>
  <div id="menuBody" class="menu"></div>
</dialog>

<!-- Cart dialog -->
<dialog id="cartDialog" class="dlg">
  <div class="dlg-head">
    <div class="dlg-title" data-i18n="cartTitle">Warenkorb</div>
    <button id="cartClose" class="btn">âœ•</button>
  </div>
  <div id="cartBody" class="cart"></div>
  <div class="cart-foot">
    <div id="cartTotal" class="total">Summe: 0,00 â‚¬</div>
    <button id="checkout" class="btn-cta">Bestellung bestÃ¤tigen</button>
  </div>
</dialog>
<!-- Configurator dialog -->
<dialog id="cfgDialog" class="cfg">
  <div class="cfg-head">
    <div class="cfg-title" id="cfgTitle">Optionen</div>
    <button id="cfgClose" class="btn">âœ•</button>
  </div>
  <div id="cfgBody" class="cfg-body"><!-- filled by JS --></div>
  <div class="cfg-foot">
    <div class="cfg-total" id="cfgTotal">â€”</div>
    <div style="display:flex;gap:8px;align-items:center">
      <div class="opt-qty">
        <button id="cfgQtyMinus" class="btn-sm">âˆ’</button>
        <span id="cfgQty">1</span>
        <button id="cfgQtyPlus" class="btn-sm">+</button>
      </div>
      <button id="cfgDone" class="btn-cta" disabled>OK</button>
    </div>
  </div>
</dialog>

<div id="toast" class="toast">OK</div>

<script>
/* ===== i18n ===== */
/* ===== i18n ===== */
const I18N = {
  de:{
    restaurants:"Restaurants", openNow:"Jetzt geÃ¶ffnet", search:"Restaurant suchen â€¦", allCities:"Alle StÃ¤dte",
    sort:{rec:"Empfohlen",rate:"Beste Bewertung",fast:"Schnellste Zustellung",lowfee:"Geringe LiefergebÃ¼hr"},
    menu:"MenÃ¼", viewMenu:"Zur Speisekarte", open:"GeÃ¶ffnet", closed:"Geschlossen", promo:"Aktion", add:"HinzufÃ¼gen",
    cart:n=>`Warenkorb (${n})`, cartTitle:"Warenkorb", emptyCart:"Warenkorb ist leer",
    multiWarn:"Hinweis: Der Warenkorb enthÃ¤lt Artikel von mehreren Restaurants.",
    sum:v=>`Summe: ${v}`, checkout:"Bestellung bestÃ¤tigen", added:"Zum Warenkorb hinzugefÃ¼gt",
    noItems:"Keine Artikel verfÃ¼gbar", noRestaurants:"Keine Restaurants verfÃ¼gbar", city:"Stadt",
    options:"Optionen", quantity:"Menge", choose:"AuswÃ¤hlen", done:"HinzufÃ¼gen",
    delivery:"Lieferung", freeDelivery:"Lieferung kostenlos", pickup:"Abholung",
    subtotal:v=>`Zwischensumme: ${v}`, minOrder:"Mindestbestellwert",
    needMore:n=>`Noch ${n} bis zum Mindestbestellwert`,
    belowMinWarn:"Mindestbestellwert nicht erreicht", 
    invalidSel:"Bitte Optionen prÃ¼fen", from:"ab" 
  },

  en:{
    restaurants:"Restaurants", openNow:"Open now", search:"Search restaurantâ€¦", allCities:"All cities",
    sort:{rec:"Recommended",rate:"Top rated",fast:"Fastest",lowfee:"Low fee"},
    menu:"Menu", viewMenu:"View menu", open:"Open", closed:"Closed", promo:"Promo", add:"Add",
    cart:n=>`Cart (${n})`, cartTitle:"Cart", emptyCart:"Cart is empty",
    multiWarn:"Note: Your cart has items from multiple restaurants.",
    sum:v=>`Total: ${v}`, checkout:"Checkout", added:"Added to cart",
    noItems:"No items available", noRestaurants:"No restaurants available", city:"City",
    delivery:"Delivery", freeDelivery:"Free delivery", pickup:"Pickup",
    subtotal:v=>`Subtotal: ${v}`, minOrder:"Minimum order",
    needMore:n=>`Add ${n} to reach the minimum order`,
    belowMinWarn:"Minimum order not reached"
  },

  ar:{
    restaurants:"Ø§Ù„Ù…Ø·Ø§Ø¹Ù…", openNow:"Ù…ÙØªÙˆØ­ Ø§Ù„Ø¢Ù†", search:"Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø·Ø¹Ù…â€¦", allCities:"ÙƒÙ„ Ø§Ù„Ù…Ø¯Ù†",
    sort:{rec:"Ù…ÙˆØµÙ‰ Ø¨Ù‡",rate:"Ø§Ù„Ø£Ø¹Ù„Ù‰ ØªÙ‚ÙŠÙŠÙ…Ø§Ù‹",fast:"Ø§Ù„Ø£Ø³Ø±Ø¹",lowfee:"Ø£Ù‚Ù„ Ø±Ø³ÙˆÙ…"},
    menu:"Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©", viewMenu:"Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©", open:"Ù…ÙØªÙˆØ­", closed:"Ù…ØºÙ„Ù‚", promo:"Ø¹Ø±Ø¶", add:"Ø£Ø¶ÙÙ",
    cart:n=>`Ø³Ù„Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª (${n})`, cartTitle:"Ø³Ù„Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª", emptyCart:"Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©",
    multiWarn:"Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ø³Ù„Ø© ØªØ­ØªÙˆÙŠ Ø¹Ù†Ø§ØµØ± Ù…Ù† Ø£ÙƒØ«Ø± Ù…Ù† Ù…Ø·Ø¹Ù….",
    sum:v=>`Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: ${v}`, checkout:"ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨", added:"Ø£ÙØ¶ÙŠÙ Ø¥Ù„Ù‰ Ø§Ù„Ø³Ù„Ø©",
    noItems:"Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ± Ù…ØªØ§Ø­Ø©", noRestaurants:"Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø·Ø§Ø¹Ù… Ù…ØªØ§Ø­Ø©", city:"Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©",
    delivery:"Ø§Ù„ØªÙˆØµÙŠÙ„", freeDelivery:"ØªÙˆØµÙŠÙ„ Ù…Ø¬Ø§Ù†ÙŠ", pickup:"Ø§Ø³ØªÙ„Ø§Ù… Ù…Ù† Ø§Ù„Ù…Ø·Ø¹Ù…",
    subtotal:v=>`Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ: ${v}`, minOrder:"Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø·Ù„Ø¨",
    needMore:n=>`Ø£Ø¶Ù ${n} Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰`,
    belowMinWarn:"Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…ÙØªØ­Ù‚Ù‚"
  },

  tr:{
    restaurants:"Restoranlar", openNow:"Åimdi aÃ§Ä±k", search:"Restoran araâ€¦", allCities:"TÃ¼m ÅŸehirler",
    sort:{rec:"Ã–nerilen",rate:"En yÃ¼ksek puan",fast:"En hÄ±zlÄ±",lowfee:"DÃ¼ÅŸÃ¼k Ã¼cret"},
    menu:"MenÃ¼", viewMenu:"MenÃ¼yÃ¼ gÃ¶r", open:"AÃ§Ä±k", closed:"KapalÄ±", promo:"Kampanya", add:"Ekle",
    cart:n=>`Sepet (${n})`, cartTitle:"Sepet", emptyCart:"Sepet boÅŸ",
    multiWarn:"Not: Sepette birden fazla restorandan Ã¼rÃ¼n var.",
    sum:v=>`Toplam: ${v}`, checkout:"SipariÅŸi onayla", added:"Sepete eklendi",
    noItems:"ÃœrÃ¼n yok", noRestaurants:"Restoran yok", city:"Åehir",
    delivery:"Teslimat", freeDelivery:"Ãœcretsiz teslimat",
    subtotal:v=>`Ara toplam: ${v}`, minOrder:"Asgari sipariÅŸ", pickup:"Gel-al (Pickup)",
    needMore:n=>`Asgari sipariÅŸ iÃ§in ${n} daha ekleyin`,
    belowMinWarn:"Asgari sipariÅŸ tutarÄ± saÄŸlanmadÄ±"
  }
};

let LANG = localStorage.getItem('taussil:lang') || 'de';
const T = (k)=>{ const v=k.split('.').reduce((o,p)=>(o||{})[p],I18N[LANG]); return typeof v==='function'?v:k?v: k; };
function applyLang(){
  document.querySelectorAll('[data-i18n]').forEach(el=>{ const key=el.getAttribute('data-i18n'); const v=T(key); if(typeof v==='string') el.textContent=v; });
  document.getElementById('q').placeholder = T('search');
  document.querySelector('.chip[data-chip="open"]').textContent = T('openNow');
  document.querySelector('#city option[value=""]').textContent = T('allCities');
  const sort=document.getElementById('sort');
  sort.options[0].textContent=T('sort.rec'); sort.options[1].textContent=T('sort.rate'); sort.options[2].textContent=T('sort.fast'); sort.options[3].textContent=T('sort.lowfee');
  document.getElementById('checkout').textContent=T('checkout');
  document.querySelector('#cartDialog .dlg-title').textContent=T('cartTitle');
  const rtl = (LANG==='ar'); document.documentElement.lang=LANG; document.documentElement.dir= rtl?'rtl':'ltr';
}

/* ===== Firestore ===== */
const fs = firebase.firestore();
/* ===== Categories (chips) ===== */
const CATS=[
  {key:'bbq',     ico:'ğŸ–', label:{de:'Grill/BBQ',            en:'BBQ',      ar:'Ø´ÙˆØ§Ø¡',            tr:'Izgara'}},
  {key:'seafood', ico:'ğŸŸ', label:{de:'Fisch & MeeresfrÃ¼chte', en:'Seafood',  ar:'Ù…Ø£ÙƒÙˆÙ„Ø§Øª Ø¨Ø­Ø±ÙŠØ©',   tr:'Deniz Ã¼rÃ¼nleri'}},
  {key:'vegan',   ico:'ğŸŒ¿', label:{de:'Vegan',                 en:'Vegan',    ar:'Ù†Ø¨Ø§ØªÙŠ',           tr:'Vegan'}},
  {key:'asian',   ico:'ğŸœ', label:{de:'Asiatisch',             en:'Asian',    ar:'Ø¢Ø³ÙŠÙˆÙŠ',           tr:'Asya'}},
  {key:'pizza',   ico:'ğŸ•', label:{de:'Pizza',                 en:'Pizza',    ar:'Ø¨ÙŠØªØ²Ø§',           tr:'Pizza'}},
  {key:'burger',  ico:'ğŸ”', label:{de:'Burger',                en:'Burgers',  ar:'Ø¨Ø±ØºØ±',            tr:'Burger'}},
  {key:'dessert', ico:'ğŸ°', label:{de:'Desserts',              en:'Desserts', ar:'Ø­Ù„ÙˆÙŠØ§Øª',          tr:'TatlÄ±'}},
  {key:'coffee',  ico:'â˜•',  label:{de:'Kaffee',                en:'Coffee',   ar:'Ù‚Ù‡ÙˆØ©',            tr:'Kahve'}}
];
let SELECTED_CAT='';
const catLabel = k => { const c=CATS.find(x=>x.key===k); return c ? (c.label[LANG]||c.label.de) : k; };

function buildCatRail(){
  const rail=document.getElementById('catRail'); if(!rail) return;
  rail.innerHTML='';
  const frag=document.createDocumentFragment();
  CATS.forEach(c=>{
    const btn=document.createElement('button');
    btn.className='cat-chip'+(SELECTED_CAT===c.key?' active':'');
    btn.setAttribute('data-cat',c.key);
    btn.innerHTML = `<span class="ico">${c.ico}</span><span>${esc(catLabel(c.key))}</span>`;
    btn.addEventListener('click',()=>{
      SELECTED_CAT = (SELECTED_CAT===c.key) ? '' : c.key;
      buildCatRail();
      renderCatalog();
    });
    frag.appendChild(btn);
  });
  rail.appendChild(frag);
}

function matchCat(r){
  if(!SELECTED_CAT) return true;
  // Ø§Ù„Ø£ÙØ¶Ù„: Ù…ØµÙÙˆÙØ© marketTags
  if (Array.isArray(r.marketTags) && r.marketTags.includes(SELECTED_CAT)) return true;
  // Ø¨Ø¯Ø§Ø¦Ù„ Ù„Ø§Ù†Ø³Ø¬Ø§Ù… Ø§Ù„Ø®Ù„ÙÙŠØ§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
  const c1 = String(r.cuisine||'').toLowerCase();
  const c2 = String(r.category||'').toLowerCase();
  return c1.includes(SELECTED_CAT) || c2.includes(SELECTED_CAT);
}

/* ===== Helpers ===== */
const $ = s=>document.querySelector(s);
const toast = t=>{ const el=$("#toast"); el.textContent=t; el.classList.add("show"); setTimeout(()=>el.classList.remove("show"),1600); };
const eur = n=> new Intl.NumberFormat(LANG==='tr'?'tr-TR':LANG==='ar'?'ar-EG':LANG==='en'?'en-GB':'de-DE',{style:'currency',currency:'EUR'}).format(Number(n||0));
const esc = s=> String(s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
const lastPart = t=> (String(t||'').split(',').map(s=>s.trim()).pop()||'');
const isOpenNow = r=> typeof r.isOpen==='boolean'?r.isOpen:(r.status==='active');
// --- discounts (restaurant vs product) ---
function getRestaurantDiscount(r){
  const raw = (r.discountPercent ?? r.discount ?? r?.promo?.discountPercent ?? null);
  if (raw == null) return 0;
  const n = Number(String(raw).replace(/[^\d.]/g,''));
  return Number.isFinite(n) ? n : 0;
}

function getProductDiscount(p){
  if (!p) return 0;

  if (p.discountPercent != null){
    const n = Number(String(p.discountPercent).replace(/[^\d.]/g,''));
    return Number.isFinite(n) ? n : 0;
  }

  if (typeof p.discount === 'object' && p.discount){
    if (p.discount.active === false) return 0;
    if (p.discount.type === 'percent'){
      return Number(p.discount.value)||0;
    }
    if (p.discount.type === 'amount'){
      const base = Number(p.price||0), val = Number(p.discount.value)||0;
      return base>0 ? Math.min(100, Math.round((val/base)*100)) : 0;
    }
  }

  if (p.discount != null){
    const n = Number(String(p.discount).replace(/[^\d.]/g,''));
    return Number.isFinite(n) ? n : 0;
  }

  if (p?.promo?.discountPercent != null){
    const n = Number(String(p.promo.discountPercent).replace(/[^\d.]/g,''));
    return Number.isFinite(n) ? n : 0;
  }
  return 0;
}

// price builder (old+new) â€” supports "from" label
function priceHtml(base, discPct, {prefixFrom=false}={}){
  const b = Number(base||0), d = Number(discPct||0);
  if (d>0){
    const n = Math.max(0, Math.round(b*(100-d))/100);
    return (prefixFrom?(T('from')+' '):'') +
      `<span style="text-decoration:line-through;opacity:.6;margin-inline-end:6px">${eur(b)}</span>`+
      `<span class="pr">${eur(n)}</span>`;
  }
  return (prefixFrom?(T('from')+' '):'') + `<span class="pr">${eur(b)}</span>`;
}

// canonical unit price (used by cart/configurator)
function computeUnitPrice(r, p, extraPerUnit = 0){
  const restPct = getRestaurantDiscount(r);
  const prodPct = getProductDiscount(p);
  const effPct  = prodPct > 0 ? prodPct : restPct;

  const base = Number(p.price||0);
  const discounted = effPct>0 ? Math.max(0, Math.round(base*(100-effPct))/100) : base;

  return {
    unit: discounted + Number(extraPerUnit||0),
    unitOld: base + Number(extraPerUnit||0),
    discPct: effPct
  };
}

// keep API for product-deals grid
function computeDealUnit(r, p){
  const { unit, unitOld, discPct } = computeUnitPrice(r, p, 0);
  return { unit, unitOld, discPct };
}
// --- Aliases Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø§Ù„Ù†Ø¯Ø§Ø¡Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ---
// ÙƒØ§Ù†Øª Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ØªÙØ³Ù…Ù‘Ù‰ getDiscountPercent / getProductDiscountPercent
// Ù†Ø¹Ø±Ù‘Ù Ù…Ø¯Ø§Ø®Ù„ ØªÙˆØ§ÙÙ‚ÙŠØ© ØªØ±Ø¨Ø·Ù‡Ø§ Ø¨Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©.
function getDiscountPercent(r){
  return getRestaurantDiscount(r);
}
function getProductDiscountPercent(p, restaurantLevel = 0){
  const prod = getProductDiscount(p);
  const rest = Number(restaurantLevel || 0);
  return prod > 0 ? prod : rest;
}


// Ø£Ø³Ù‡Ù… ØªÙ†Ù‚Ù‘Ù„ rails
function bindRailNav(){
  document.querySelectorAll('.rail-nav').forEach(btn=>{
    if (btn.dataset.bound) return;       // Ø§Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±
    btn.dataset.bound = '1';
    btn.addEventListener('click', ()=>{
      const key = btn.dataset.nav;
      const el  = key==='hot' ? document.getElementById('railHot')
                 : /* key==='top' */ document.getElementById('railTop');
      if(!el) return;
      const dir = btn.classList.contains('next') ? 1 : -1;
      el.scrollBy({ left: dir * (el.clientWidth * 0.9), behavior:'smooth' });
    });
  });
}


// Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Builder Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„Ø¯ÙŠÙƒ
// Ø¥Ù† ÙƒØ§Ù† Ù„Ø¯ÙŠÙƒ buildRestaurantCard(r) ÙØ³Ù†Ø³ØªØ¹Ù…Ù„Ù‡ ÙƒÙ…Ø§ Ù‡Ùˆ.
// Ø¥Ù† Ù„Ù… ÙŠÙƒÙ† Ù„Ø¯ÙŠÙƒØŒ Ù„ÙÙ‘ ÙƒÙˆØ¯ Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙŠ Ø¯Ø§Ù„Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ø³ØªØ¹Ù…Ù„Ù‡Ø§ Ø£Ø¯Ù†Ø§Ù‡.

/* ===== State ===== */
let RESTAURANTS=[]; let CART=[]; let PROD_CACHE=new Map();
// Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø³Ù„Ø© Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„Ù…Ø·Ø¹Ù… (Ø±Ø³Ù… Ø§Ù„ØªÙˆØµÙŠÙ„â€¦)
let CART_INFO = null; // { rid, rname, delivery }
// Pickup toggle: Ø¹Ù†Ø¯Ù…Ø§ ÙŠÙƒÙˆÙ† true Ù†ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ ÙˆØ±Ø³ÙˆÙ… Ø§Ù„ØªÙˆØµÙŠÙ„ ÙÙŠ Ø§Ù„Ø³Ù„Ø©
let PICKUP = false;

/* ===== Load & Render ===== */
async function loadRestaurants(){
  const grid=$("#grid");
  grid.innerHTML = `
    <div class="tile"><div class="tile-media"><div class="skel" style="width:100%;height:100%"></div></div></div>
    <div class="tile"><div class="tile-media"><div class="skel" style="width:100%;height:100%"></div></div></div>
    <div class="tile"><div class="tile-media"><div class="skel" style="width:100%;height:100%"></div></div></div>`;
  const snap = await fs.collection('restaurants').get();
  const rows=[]; snap.forEach(d=> rows.push({id:d.id, ...d.data()}));
  RESTAURANTS = rows;
  buildCityFilter(rows);
  renderCatalog();
  loadProductDeals().catch(()=>{ /* ØªØ¬Ø§Ù‡Ù„ Ø£Ø®Ø·Ø§Ø¡ Ø·ÙÙŠÙØ© */ });

}
function buildCityFilter(rows){
  const citySel=$("#city");
  const cities=[...new Set(rows.map(r=> r.city || lastPart(r.address_text||'')).filter(Boolean))].sort((a,b)=>a.localeCompare(b));
  const keep=citySel.value;
  citySel.innerHTML = `<option value="">${T('allCities')}</option>` + cities.map(c=>`<option value="${esc(c)}">${esc(c)}</option>`).join('');
  if(cities.includes(keep)) citySel.value=keep;
}
function renderCatalog(){
  const grid = $("#grid");
  const q = ($("#q").value||'').trim().toLowerCase();
  const openOnly = document.querySelector('.chip[data-chip="open"]').classList.contains('active');
  const city = $("#city").value || '';
  
  const sort = $("#sort").value;

    // Ø­Ø¯Ù‘ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø³Ø§Ø®Ù†Ø©: Ø®ØµÙ… Ø£ÙƒØ¨Ø± Ù…Ù† 20%
  const HOT = 20;

  // ØªØ­Ø¯ÙŠØ« Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¨Ø§Ù†Ø± (Ø«Ø§Ø¨Øª "Ã¼ber 20%")
  const hotTitle = document.querySelector('#rail-hot-sec .rail-title');
  if (hotTitle) hotTitle.textContent = `ğŸ”¥ Rabatte Ã¼ber 20%`;


  // 1) Ø¨Ù†Ø§Ø¡ rows
  let rows = RESTAURANTS.slice();
  if (openOnly) rows = rows.filter(isOpenNow);
  if (city) rows = rows.filter(r => (r.city || lastPart(r.address_text||'')) === city);
  if (q) rows = rows.filter(r =>
    (r.name||'').toLowerCase().includes(q) ||
    String(r.address_text||'').toLowerCase().includes(q)
  );
rows = rows.filter(matchCat);
  if (sort==='rate') rows.sort((a,b)=>(b.rating||0)-(a.rating||0));
  else if (sort==='fast') rows.sort((a,b)=>
    ((typeof a.etaExtraMinutes==='number'?a.etaExtraMinutes:999) -
     (typeof b.etaExtraMinutes==='number'?b.etaExtraMinutes:999))
  );
  else if (sort==='lowfee') rows.sort((a,b)=>(a.deliveryFee||999)-(b.deliveryFee||999));
  else rows.sort((a,b)=>(b.priorityScore||0)-(a.priorityScore||0));

  $("#countInfo").textContent = rows.length ? `${rows.length} ${T('restaurants')}` : T('noRestaurants');

  // Helpers Ù…Ø­Ù„ÙŠØ©
  const getDisc = (r)=>{
    const raw = (r.discountPercent ?? r.discount ?? (r.promo && r.promo.discountPercent) ?? null);
    if (raw==null) return 0;
    const n = Number(String(raw).replace(/[^\d.]/g,''));
    return Number.isFinite(n) ? n : 0;
  };
  const createCard = (r)=>{
    const addrText = (r.address_text && String(r.address_text).trim())
      || [r.zip, r.city].filter(Boolean).join(' ').trim();
    const coverUrl = r.coverUrl || '';
    const logoUrl  = r.logoUrl  || '';
    const showCover = !!coverUrl && coverUrl !== logoUrl;
    const showLogo  = !!logoUrl;
    const deliveryMinutes = (typeof r.etaExtraMinutes === 'number' && r.etaExtraMinutes >= 0) ? r.etaExtraMinutes : null;
// Delivery fee & Min order (from restaurant doc; with backward-compat keys)
const feeRaw = (r.deliveryFee ?? (r.delivery && r.delivery.fee) ?? null);
const feeNum = (feeRaw==null ? null : Number(feeRaw));
const freeDelivery = (feeNum===0 || feeNum==null);

// badge: Lieferung kostenlos (green) OR Lieferung: â‚¬X
const deliveryHtml = freeDelivery
  ? `<span class="badge" style="background:rgba(34,197,94,.12);color:#16a34a;border-color:rgba(34,197,94,.25)">Lieferung kostenlos</span>`
  : `<span class="badge">Lieferung: ${eur(feeNum)}</span>`;

// Min order (Mindestbestellwert)
const moRaw = (r.minOrder ?? (r.order && r.order.min) ?? null);
const moNum = (moRaw==null ? null : Number(moRaw));
const minOrderHtml = (moNum!=null && moNum>0)
  ? `<span class="badge">MBW: ${eur(moNum)}</span>`
  : ``;

    const disc = getDisc(r);
    const hasDisc = disc > 0;
    const discStyle = hasDisc
      ? (disc >= 20
          ? 'background:#fee2e2;border:1px solid #fecaca;color:#b91c1c'
          : 'background:#fff0d1;border:1px solid #ffd18a;color:#8a5a00')
      : '';
    const discHtml = hasDisc ? `<span class="badge sale" style="${discStyle}">-${Math.round(disc)}%</span>` : ``;

    const rate = Number(r.rating);
    const rateHtml = Number.isFinite(rate) && rate>0
      ? `<span class="badge">â­ï¸ ${rate.toFixed(1)}</span>`
      : `<span class="badge">Neu</span>`;

    const card = document.createElement('div'); card.className='tile';
    card.innerHTML = `
      <div class="tile-media">
  ${showCover ? `<img class="tile-cover" src="${coverUrl}" alt="" loading="lazy" decoding="async">` : ``}
  ${showLogo  ? `<img class="tile-logo"  src="${logoUrl}"  alt="" loading="lazy" decoding="async">` : ``}
  ${hasDisc ? `<div class="rest-disc">${discHtml}</div>` : ``}
</div>

      <div class="tile-body">
        <div class="tile-name line-1">${esc(r.name||'(â€”)')}</div>
        <div class="tile-sub line-1">${esc(addrText)}</div>
        <div class="tile-meta">
  
    <span class="badge ${isOpenNow(r)?'open':'closed'}">${isOpenNow(r)?T('open'):T('closed')}</span>
  </div>
  <div class="tile-meta-right">
    ${deliveryMinutes!=null ? `<span class="meta-time">ğŸ•’ <strong>${deliveryMinutes}</strong> min</span>` : ``}
    ${deliveryHtml}
    ${minOrderHtml}
  </div>
</div>
<div class="tile-actions">
  <button class="btn-cta" data-open="${r.id}">${T('viewMenu')}</button>
</div>

      </div>`;
    card.querySelectorAll('[data-open]').forEach(b=> b.addEventListener('click', ()=> openMenu(r.id)));
    return card;
  };
  const renderRail = (secId, contId, items)=>{
    const sec  = document.getElementById(secId);
    const cont = document.getElementById(contId);
    if (!sec || !cont) return;
    cont.innerHTML = '';
    if (!items.length){ sec.classList.add('hidden'); return; }
    const frag = document.createDocumentFragment();
    items.forEach(r=> frag.appendChild(createCard(r)));
    cont.appendChild(frag);
    sec.classList.remove('hidden');
  };
  

  // 2) ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª (Ø¨Ø¯ÙˆÙ† deals)
  const seen = new Set();
    const hot = rows
    .filter(r => getDisc(r) > HOT)
    .sort((a,b) => getDisc(b) - getDisc(a));

  hot.forEach(r=> seen.add(r.id));

  const top = rows
    .filter(r => !seen.has(r.id))
    .sort((a,b) => (b.rating||0) - (a.rating||0))
    .slice(0, 12);
  top.forEach(r=> seen.add(r.id));

  const rest = rows.filter(r => !seen.has(r.id));

  // 3) Ø±Ø³Ù… Ø§Ù„Ø³ÙƒÙ‘ØªÙŠÙ†
  renderRail('rail-hot-sec', 'railHot', hot);
  renderRail('rail-top-sec', 'railTop', top);

  // 4) Ø§Ù„Ø´Ø¨ÙƒØ©
  grid.innerHTML = '';
  rest.forEach(r => grid.appendChild(createCard(r)));

  // 5) Prefetch Ù„Ù„ØµÙˆØ± (Ø¨Ø¯ÙˆÙ† deals)
  (function prefetchImages(){
    const urls = [];
    const pick = (arr)=> arr.slice(0,4).forEach(r=>{
      if(r.coverUrl) urls.push(r.coverUrl);
      else if(r.logoUrl) urls.push(r.logoUrl);
    });
    pick(hot); pick(top); pick(rest);
    const head = document.head || document.getElementsByTagName('head')[0];
    urls.slice(0,8).forEach(href=>{
      try{
        const l = document.createElement('link');
        l.rel='prefetch'; l.as='image'; l.href=href;
        head.appendChild(l);
      }catch(_){}
    });
  })();
}
// ÙŠØ¨Ù†ÙŠ Ø¹Ù†ØµØ± Ø¨Ø·Ø§Ù‚Ø© ØµÙÙ‚Ø© Ù…Ù†ØªØ¬ Ø¨Ù†Ù…Ø· Ø§Ù„Ø´Ø¨ÙƒØ© (ØµÙˆØ±Ø© ÙŠØ³Ø§Ø± - Ù†Øµ ÙˆØ³Ø· - Ø²Ø± ÙŠÙ…ÙŠÙ†)
function createProductDealGridItem(r, p){
  const pic =
    (Array.isArray(p.images) && p.images[0]) ? p.images[0] :
    (typeof p.img === 'string' && p.img) ? p.img :
    (typeof p.imageUrl === 'string' && p.imageUrl) ? p.imageUrl : '';

  const hasOpts =
    (Array.isArray(p.optionGroupIds) && p.optionGroupIds.length>0) ||
    (Array.isArray(p.sizes) && p.sizes.length>0);

 const { unit, unitOld, discPct } = computeDealUnit(r, p);
const discHtml = (discPct > 0) ? `<span class="badge-disc">-${Math.round(discPct)}%</span>` : '';


  const priceHtml = (unitOld > unit)
    ? `<div class="pprice"><s>${eur(unitOld)}</s><strong>${eur(unit)}</strong></div>`
    : `<div class="pprice"><strong>${eur(unit)}</strong></div>`;

  const el = document.createElement('div');
  el.className = 'pitem';
  el.innerHTML = `
   <div class="pitem-left-wrap">
  <div class="pitem-left">
    ${pic ? `<img src="${esc(pic)}" loading="lazy" decoding="async" alt="">`
          : `<div style="font-size:13px;color:#999">â€”</div>`}
  </div>
  ${discHtml}
</div>

    <div class="pitem-mid">
  <div class="pname">${esc(p.name || p.title || '(â€”)')}</div>
  <div class="prest">${esc(r.name || '')}</div>
  ${priceHtml}
</div>


    </div>
    <div class="pitem-right">
      ${hasOpts
  ? `<button class="btn-sm" data-cfg="${r.id}::${p.id}" title="${T('choose')}">ï¼‹</button>`
  : `<button class="btn-sm" data-add="${r.id}::${p.id}" title="${T('add')}">ï¼‹</button>`}

    </div>
  `;

  // Ø£Ø²Ø±Ø§Ø±
  const addBtn = el.querySelector('[data-add]');
  if (addBtn){
    addBtn.addEventListener('click', ()=>{
      addToCart(r, p);
    });
  }
  const cfgBtn = el.querySelector('[data-cfg]');
  if (cfgBtn){
    cfgBtn.addEventListener('click', async ()=>{
      await openConfigurator(r, p);
    });
  }
  return el;
}

// ÙŠØ±Ø³Ù… Ø´Ø¨ÙƒØ© Ø§Ù„Ø¹Ø±ÙˆØ¶ ÙÙŠ #prodDealsGrid
function renderProductDealsGrid(list){
  const sec  = document.getElementById('grid-prod-deals');
  const cont = document.getElementById('prodDealsGrid');
  if(!sec || !cont) return;
  cont.innerHTML = '';
  if(!list.length){ sec.classList.add('hidden'); return; }
  const frag = document.createDocumentFragment();
  list.forEach(({r,p})=> frag.appendChild(createProductDealGridItem(r,p)));
  cont.appendChild(frag);
  sec.classList.remove('hidden');
}


// ØªØ­Ù…ÙŠÙ„ Ù…Ù†ØªØ¬Ø§Øª Ø¹Ù„ÙŠÙ‡Ø§ Ø­Ø³ÙˆÙ…Ø§Øª (Ø¹Ø¨Ø± ÙƒÙ„ Ø§Ù„Ù…Ø·Ø§Ø¹Ù… Ø§Ù„Ù…Ø­Ù…Ù‘Ù„Ø©)
async function loadProductDeals(){
  if(!Array.isArray(RESTAURANTS) || !RESTAURANTS.length){ renderProductDealsRail([]); return; }

  const deals = [];

  // Ø§Ø¬Ù„Ø¨ Ù…Ù† ÙƒÙ„ Ù…Ø·Ø¹Ù… Ù…Ù†ØªØ¬Ø§ØªÙ‡ØŒ Ø§Ù„ØªÙ‚Ø· Ø§Ù„Ù…Ø®ÙÙ‘ÙØ¶ ÙÙ‚Ø·ØŒ Ø«Ù… Ù‚ØµÙ‘ Ø¥Ù„Ù‰ Ø¹Ø¯Ø¯ Ù…Ø¹Ù‚ÙˆÙ„
  for (const r of RESTAURANTS){
    try{
      const snap = await fs.collection('restaurants').doc(r.id).collection('products').get();
      snap.forEach(d=>{
        const p = { id:d.id, ...d.data() };
        // Ø§Ø­Ø³Ø¨ Ø§Ù„Ø®ØµÙ… Ø§Ù„ÙØ¹Ù‘Ø§Ù„ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬
       const prodPct = getProductDiscount(p);
const restPct = getRestaurantDiscount(r);

        const eff = prodPct > 0 ? prodPct : restPct;
        if (eff > 0){
          deals.push({ r, p, eff });
        }
      });
    }catch(_){}
    // Ø­Ø¯ Ø£Ø¹Ù„Ù‰ Ù„Ù„Ø­ÙÙ…Ù„
    if (deals.length >= 48) break;
  }

  // Ø±ØªØ¨ Ø­Ø³Ø¨ Ø£Ø¹Ù„Ù‰ Ø®ØµÙ… ÙˆØ®Ø° Ø£ÙØ¶Ù„ 24
  deals.sort((a,b)=> b.eff - a.eff);
renderProductDealsGrid(deals.slice(0,24));  // â† Ø¨Ø¯Ù„ renderProductDealsRail(...)

// Ø§Ø­Ø°Ù/Ù„Ø§ ØªØ¶Ù Ø£ÙŠ Ù…Ù†Ø·Ù‚ Ù„Ø£Ø³Ù‡Ù… Ø§Ù„ØªÙ†Ù‚Ù„ - Ù„Ù… Ù†Ø¹Ø¯ Ø¨Ø­Ø§Ø¬Ø© Ù„Ù‡Ø§


  // ÙØ¹Ù„ Ø£Ø³Ù‡Ù… Ø§Ù„ØªÙ†Ù‚Ù„ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø³ÙƒØ© (Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙƒÙØ§ÙŠØ©)
  document.querySelectorAll('.rail-nav[data-nav="pdeal"]').forEach(btn=>{
    if(btn.dataset.bound) return;
    btn.dataset.bound = '1';
    btn.addEventListener('click', ()=>{
      const el = document.getElementById('railProdDeals');
      if(!el) return;
      const dir = btn.classList.contains('next') ? 1 : -1;
      el.scrollBy({ left: dir * (el.clientWidth * 0.9), behavior:'smooth' });
    });
  });
}


/* ===== Menu & Products (Ù…Ø®ØªØµØ± ÙˆÙ„Ø§ ØªÙƒØ±Ø§Ø±) ===== */
async function openMenu(rid){
  const dlg=$("#menuDialog"), body=$("#menuBody"), title=$("#menuTitle");
  body.innerHTML = `<div style="padding:18px" class="small">â€¦</div>`;
  dlg.showModal();

  const rDoc=await fs.collection('restaurants').doc(rid).get();
  if(!rDoc.exists){ body.innerHTML=`<div class="small">â€”</div>`; return; }
  const r={id:rid, ...rDoc.data()};
  title.textContent = `${T('menu')} â€“ ${r.name||''}`;

  if(PROD_CACHE.has(rid)){ const {cats,prods}=PROD_CACHE.get(rid); renderMenu(r,cats,prods); return; }

  const catsSnap=await fs.collection('restaurants').doc(rid).collection('categories').get();
  const cats=[]; catsSnap.forEach(d=> cats.push({id:d.id, ...d.data()})); cats.sort((a,b)=>(a.sort??0)-(b.sort??0));
  const proSnap=await fs.collection('restaurants').doc(rid).collection('products').get();
  let prods=[]; proSnap.forEach(d=> prods.push({id:d.id, ...d.data()}));
  prods = prods.filter(p=> p.isAvailable !== false);

  PROD_CACHE.set(rid,{cats,prods}); renderMenu(r,cats,prods);
}
// Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ù†Ø§Ø¡ Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø¬Ù… (Ù„Ùˆ Ø§Ù„Ø¯ÙŠØ§Ù„ÙˆØ¬ Ù…ÙØªÙˆØ­)
(function(){
  let ridOpen = null;
  const dlg = document.getElementById('menuDialog');

  // Ø§Ù„ØªØªØ¨Ø¹ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
  const _openMenu = openMenu;
  openMenu = async function(rid){
    ridOpen = rid;
    return _openMenu.apply(this, arguments);
  };

  // Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ø¹Ø±Ø¶â€”Ø£Ø¹Ø¯ Ø§Ù„Ø±Ø³Ù… Ø¥Ù† ÙƒØ§Ù† Ù…ÙØªÙˆØ­Ù‹Ø§
  let t;
  window.addEventListener('resize', ()=>{
    if (!dlg || !dlg.open || !ridOpen) return;
    clearTimeout(t);
    t = setTimeout(async ()=>{
      try{
        const rDoc = await fs.collection('restaurants').doc(ridOpen).get();
        const r = { id: ridOpen, ...rDoc.data() };
        let cats = [], prods = [];
        const cs = await fs.collection('restaurants').doc(ridOpen).collection('categories').get();
        cs.forEach(d=> cats.push({id:d.id, ...d.data()}));
        const ps = await fs.collection('restaurants').doc(ridOpen).collection('products').get();
        ps.forEach(d=> prods.push({id:d.id, ...d.data()}));
        prods = prods.filter(p=> p.isAvailable !== false);
        renderMenu(r, cats.sort((a,b)=>(a.sort??0)-(b.sort??0)), prods);
      }catch(_){}
    }, 200);
  });
})();

function renderMenu(r, cats, prods){
  const body = document.getElementById('menuBody');
  const isMobile = window.matchMedia('(max-width: 900px)').matches;

  // ÙÙ‡Ø±Ø³Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø©
  const byCat = new Map(); cats.forEach(c=>byCat.set(c.id,[])); byCat.set('_',[]);
  for (const p of prods){
    const cid = (p.categoryId && byCat.has(p.categoryId)) ? p.categoryId : '_';
    byCat.get(cid).push(p);
  }

  // ===== MOBILE: Ø³Ù„Ø§ÙŠØ¯Ø± Ø£ÙÙ‚ÙŠ + Ù‚Ø§Ø¦Ù…Ø© ÙƒØ§Ù…Ù„Ø© =====
  if (isMobile){
    let activeCid = cats[0]?.id || '_';

    const rail = document.createElement('div'); rail.className='menu-rail';
    const list = document.createElement('div'); list.className='menu-list';

    const makeChip = (c)=>{
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'menu-chip' + (activeCid===c.id?' active':'');
      btn.textContent = c.name || c.title || 'â€”';
      btn.addEventListener('click', ()=>{
        activeCid = c.id;
        rail.querySelectorAll('.menu-chip').forEach(x=>x.classList.remove('active'));
        btn.classList.add('active');
        paint();
      });
      return btn;
    };

    rail.innerHTML = '';
    cats.forEach(c => rail.appendChild(makeChip(c)));
    if ((byCat.get('_')||[]).length){ rail.appendChild(makeChip({id:'_', name:'â€¦'})); }

    function paint(){
      list.innerHTML = '';
      const items = (byCat.get(activeCid) || []).sort((a,b)=>(a.sort??0)-(b.sort??0));
      if (!items.length){ list.innerHTML = `<div class="small">â€”</div>`; return; }

      for (const it of items){
        const name  = it.name || it.title || '(â€”)';
        const desc  = it.desc || '';
        const price = (typeof it.price === 'number') ? it.price : Number(it.price||0);
        const imgUrl =
          (Array.isArray(it.images) && it.images[0]) ? it.images[0] :
          (typeof it.img === 'string' && it.img) ? it.img :
          (typeof it.imageUrl === 'string' && it.imageUrl) ? it.imageUrl : '';

        const restDisc = getRestaurantDiscount(r);
        const prodDisc = getProductDiscount(it);
        const effDisc  = prodDisc > 0 ? prodDisc : restDisc;

        const hasOpts =
          (Array.isArray(it.optionGroupIds) && it.optionGroupIds.length>0) ||
          (Array.isArray(it.sizes) && it.sizes.length>0);

        const hasSizes = Array.isArray(it.sizes) && it.sizes.length > 0;
        const priceBlock = priceHtml(price, effDisc, { prefixFrom: hasSizes });

        const row = document.createElement('div'); row.className='item';
        row.innerHTML = `
          <div class="ph-wrap">
            <div class="ph">
              ${imgUrl
                ? `<img class="im" src="${esc(imgUrl)}" loading="lazy" decoding="async" alt="">`
                : `<div class="im" style="display:flex;align-items:center;justify-content:center;font-size:12px;color:#999">â€”</div>`}
            </div>
            ${effDisc>0 ? `<span class="badge-disc">-${Math.round(effDisc)}%</span>` : ``}
          </div>

          <div class="txt">
            <div class="nm line-1">${esc(name)}</div>
            <div class="pr">${priceBlock}</div>
            ${desc ? `<div class="ds line-1">${esc(desc)}</div>` : ``}
          </div>

          <div class="act">
            ${hasOpts
              ? `<button class="btn-sm" data-cfg="${it.id}" title="${T('choose')}">ï¼‹</button>`
              : `<button class="btn-sm" data-add="${it.id}" title="${T('add')}">ï¼‹</button>`}
          </div>
        `;
        list.appendChild(row);
      }

      // Bind
      list.querySelectorAll('[data-add]').forEach(b=>{
        b.addEventListener('click',()=>{
          const pid=b.getAttribute('data-add'); const it=prods.find(x=>x.id===pid);
          addToCart(r,it);
        });
      });
      list.querySelectorAll('[data-cfg]').forEach(b=>{
        b.addEventListener('click', async ()=>{
          const pid=b.getAttribute('data-cfg'); const it=prods.find(x=>x.id===pid);
          await openConfigurator(r,it);
        });
      });
    }

    body.innerHTML=''; body.appendChild(rail); body.appendChild(list); paint();
    return;
  }

  // ===== DESKTOP (ÙƒÙ…Ø§ ÙƒØ§Ù†): Ø¹Ù…ÙˆØ¯ ÙØ¦Ø§Øª ÙŠØ³Ø§Ø± + Ù‚Ø§Ø¦Ù…Ø© ÙŠÙ…ÙŠÙ† =====
  const side=document.createElement('div'); side.className='menu-side';
  cats.forEach((c,i)=>{ const b=document.createElement('button'); b.className='menu-cat'+(i===0?' active':''); b.textContent=c.name||c.title||'â€”'; b.dataset.cid=c.id; side.appendChild(b); });
  if((byCat.get('_')||[]).length){ const b=document.createElement('button'); b.className='menu-cat'; b.textContent='â€¦'; b.dataset.cid='_'; side.appendChild(b); }

  const list=document.createElement('div'); list.className='menu-list';

  const paint=(cid)=>{
    list.innerHTML=''; const items=(byCat.get(cid)||[]).sort((a,b)=>(a.sort??0)-(b.sort??0));
    if(!items.length){ list.innerHTML=`<div class="small">â€”</div>`; return; }
    for (const it of items) {
      const name = it.name || it.title || '(â€”)';
      const desc = it.desc || '';
      const price = (typeof it.price === 'number') ? it.price : Number(it.price || 0);
      const imgUrl =
        (Array.isArray(it.images) && it.images[0]) ? it.images[0] :
        (typeof it.img === 'string' && it.img) ? it.img :
        (typeof it.imageUrl === 'string' && it.imageUrl) ? it.imageUrl : '';

      const restDisc = getRestaurantDiscount(r);
      const prodDisc = getProductDiscount(it);
      const effDisc  = prodDisc > 0 ? prodDisc : restDisc;

      const hasOpts =
        (Array.isArray(it.optionGroupIds) && it.optionGroupIds.length>0) ||
        (Array.isArray(it.sizes) && it.sizes.length>0);

      const hasSizes = Array.isArray(it.sizes) && it.sizes.length > 0;
      const priceBlock = priceHtml(price, effDisc, { prefixFrom: hasSizes });

      const row = document.createElement('div'); row.className='item';
      row.innerHTML = `
        <div class="ph">
          ${imgUrl
            ? `<img class="im" src="${esc(imgUrl)}" loading="lazy" decoding="async" alt="">`
            : `<div class="im" style="display:flex;align-items:center;justify-content:center;font-size:12px;color:#999">â€”</div>`}
        </div>
        <div class="txt">
          <div class="nm line-1">${esc(name)}</div>
          ${desc ? `<div class="ds line-1">${esc(desc)}</div>` : ``}
        </div>
        <div class="act" style="display:flex;gap:8px;align-items:center">
          <div class="pr">${priceBlock}</div>
          ${hasOpts
            ? `<button class="btn-sm" data-cfg="${it.id}">${T('choose')}</button>`
            : `<button class="btn-sm" data-add="${it.id}">${T('add')}</button>`}
        </div>
      `;
      list.appendChild(row);
    }

    list.querySelectorAll('[data-add]').forEach(b=>{
      b.addEventListener('click',()=>{
        const pid=b.getAttribute('data-add'); const it=prods.find(x=>x.id===pid);
        addToCart(r,it);
      });
    });
    list.querySelectorAll('[data-cfg]').forEach(b=>{
      b.addEventListener('click', async ()=>{
        const pid=b.getAttribute('data-cfg'); const it=prods.find(x=>x.id===pid);
        await openConfigurator(r,it);
      });
    });
  };

  paint(cats[0]?.id||'_');
  side.querySelectorAll('.menu-cat').forEach(btn=>{
    btn.addEventListener('click',()=>{
      side.querySelectorAll('.menu-cat').forEach(x=>x.classList.remove('active'));
      btn.classList.add('active'); paint(btn.dataset.cid);
    });
  });

  body.innerHTML=''; body.appendChild(side); body.appendChild(list);
}

/* ===== Cart (Ù…Ø®ØªØµØ±) ===== */
function addToCart(r,p){
  const distinct = new Set(CART.map(x=>x.rid));
  if (distinct.size && !distinct.has(r.id)){
    const msg=(LANG==='de')?'Sie haben Artikel von einem anderen Restaurant im Warenkorb. Warenkorb leeren und fortfahren?'
      :(LANG==='en')?'Your cart has items from another restaurant. Clear cart and continue?'
      :(LANG==='tr')?'Sepette baÅŸka bir restorandan Ã¼rÃ¼n var. Temizleyip devam edilsin mi?'
      :'ØªØ­ØªÙˆÙŠ Ø§Ù„Ø³Ù„Ø© Ø¹Ù†Ø§ØµØ± Ù…Ù† Ù…Ø·Ø¹Ù… Ø¢Ø®Ø±. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥ÙØ±Ø§Øº Ø§Ù„Ø³Ù„Ø© ÙˆØ§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ';
    if(!confirm(msg)) return; CART=[];
  }
// Ø­Ø¯Ù‘Ø« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø³Ù„Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø·Ø¹Ù…
CART_INFO = {
  rid: r.id,
  rname: (r.name||''),
  delivery: Number(r.flatDelivery ?? r.deliveryFlat ?? r.deliveryFee ?? 0) || 0,
  minOrder: Number(r.minOrder ?? r.minOrderValue ?? 0) || 0
};


 

  // Ø§Ø®ØªØ± Ø£ÙØ¶Ù„ Ù…ØµØ¯Ø± Ù„Ù„ØµÙˆØ±Ø©: images[0] Ø«Ù… img Ø«Ù… imageUrl (Ø¥Ù† ÙˆÙØ¬Ø¯)
  const img =
    (Array.isArray(p.images) && p.images[0]) ? p.images[0] :
    (typeof p.img === 'string' && p.img) ? p.img :
    (typeof p.imageUrl === 'string' && p.imageUrl) ? p.imageUrl : '';
const { unit, unitOld, discPct } = computeUnitPrice(r, p, 0);

  const key = `${r.id}::${p.id}`;
  const row = CART.find(x=>x.key===key);

  if (row){
    row.qty += 1;
  } else {
    CART.push({
      key, rid:r.id, rname:(r.name||''), pid:p.id,
      title:(p.name||p.title||''), 
      price: unit,            // Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ…
      unitOld: unitOld,       // Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù‚Ø¯ÙŠÙ… (Ù„Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø´Ø·ÙˆØ¨ Ø¥Ù† Ù„Ø²Ù…)
      discPct: discPct,       // Ù†Ø³Ø¨Ø© Ø§Ù„Ø®ØµÙ… (Ù„Ù„Ø±Ø¬ÙˆØ¹ Ø¥Ù† Ø£Ø±Ø¯Øª)
      qty:1, img
    });
  }

  updateCartBadge();
  toast(T('added'));
}

function updateCartBadge(){ const n=CART.reduce((s,x)=>s+x.qty,0); document.getElementById('viewCart').textContent=T('cart')(n); }
function openCart(){
  const dlg=$("#cartDialog"), body=$("#cartBody"); body.innerHTML='';
  if(!CART.length){ body.innerHTML=`<div class="small">${T('emptyCart')}</div>`; }
  else{
  const distinct=new Set(CART.map(x=>x.rid));
  if(distinct.size>1)
    body.insertAdjacentHTML('afterbegin',`<div class="small" style="color:#b45309;margin-bottom:8px">${T('multiWarn')}</div>`);

  for(const row of CART){
    const line = document.createElement('div'); line.className='cart-row';

    const imgHtml = row.img
      ? `<img class="cart-thumb" src="${esc(row.img)}" alt="">`
      : `<div class="cart-thumb" style="display:flex;align-items:center;justify-content:center;font-size:12px;color:#888">ğŸ½ï¸</div>`;
    const lineOldTotal = (row.unitOld!=null ? row.unitOld*row.qty : null);
    const lineNewTotal = row.price * row.qty;

    const priceBlock = (lineOldTotal!=null && lineOldTotal > lineNewTotal)
      ? `<span style="text-decoration:line-through;opacity:.6;margin-inline-end:6px">${eur(lineOldTotal)}</span><strong>${eur(lineNewTotal)}</strong>`
      : `<strong>${eur(lineNewTotal)}</strong>`;

    line.innerHTML = `
      ${imgHtml}
      <div>
        <strong class="line-1">${esc(row.title)}</strong>
        <div class="small line-1">${esc(row.rname)}</div>
      </div>
      <div class="q">
        <button class="btn-sm" data-dec="${row.key}">âˆ’</button>
        <span>${row.qty}</span>
        <button class="btn-sm" data-inc="${row.key}">+</button>
      </div>
      <div>${priceBlock}</div>
    `;
    body.appendChild(line);
  }

  body.querySelectorAll('[data-inc]').forEach(b=> b.addEventListener('click',()=> changeQty(b.dataset.inc,+1)));
  body.querySelectorAll('[data-dec]').forEach(b=> b.addEventListener('click',()=> changeQty(b.dataset.dec,-1)));
// === Min-Order notice + disable checkout (scoped) ===
(()=>{
  const cartSub     = CART.reduce((s,x)=> s + x.qty * x.price, 0);
  const minRequired = Number(CART_INFO?.minOrder || 0);
  const missingAmt  = Math.max(0, minRequired - cartSub);

  // Ø§Ù…Ø³Ø­ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø³Ø§Ø¨Ù‚ Ø¥Ù† ÙˆØ¬Ø¯
  const oldNotice = body.querySelector('#minOrderNotice');
  if (oldNotice) oldNotice.remove();

  // Ø£Ù†Ø´Ø¦ ØªÙ†Ø¨ÙŠÙ‡ Ø¬Ø¯ÙŠØ¯ Ø¥Ø°Ø§ ÙƒØ§Ù† ÙÙŠ Ø­Ø¯ Ø£Ø¯Ù†Ù‰
  // Ø£Ù†Ø´Ø¦ ØªÙ†Ø¨ÙŠÙ‡ Ø¬Ø¯ÙŠØ¯ Ø¥Ø°Ø§ ÙƒØ§Ù† ÙÙŠ Ø­Ø¯ Ø£Ø¯Ù†Ù‰ (Ù…Ø§ Ù„Ù… ÙŠÙƒÙ† Ø§Ù„Ø§Ù„ØªÙ‚Ø§Ø· Ù…ÙØ¹Ù‘Ù„)
if (!PICKUP && minRequired > 0) {

    const notice = document.createElement('div');
    notice.id = 'minOrderNotice';
    notice.className = 'small';
    notice.style.cssText = 'margin-top:8px;padding:10px 12px;background:#f9fafb;border:1px solid #e5e7eb;border-radius:10px;display:flex;flex-direction:column;gap:6px';
    notice.innerHTML = `
      <div>${T('minOrder')}: <strong>${eur(minRequired)}</strong></div>
      ${missingAmt > 0 ? `<div style="color:#b91c1c;font-weight:800">${T('needMore')(eur(missingAmt))}</div>` : ``}
    `;
    body.appendChild(notice);
  }

  // Ø¹Ø·Ù‘Ù„/ÙØ¹Ù‘Ù„ Ø²Ø± Ø§Ù„Ø¯ÙØ¹
  const payBtn = document.getElementById('checkout');
  if (payBtn) {
    const belowMin = (!PICKUP && minRequired > 0 && missingAmt > 0);

    payBtn.disabled = belowMin;
    payBtn.title = belowMin ? T('belowMinWarn') : '';
  }
})();

  // --- Ù…Ù„Ø®Øµ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± (Ø£Ø³ÙÙ„ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø³Ù„Ø©) ---
  const sub = CART.reduce((s,x)=>s+x.qty*x.price,0);
  const fee = (CART_INFO && Number(CART_INFO.delivery)) ? Number(CART_INFO.delivery) : 0;

  const summary = document.createElement('div');
  summary.className = 'small';
  summary.style.cssText = 'margin-top:8px;padding:10px 12px;background:#f9fafb;border:1px solid #e5e7eb;border-radius:10px;display:flex;flex-direction:column;gap:6px';

  const subLine = document.createElement('div');
  subLine.textContent = T('subtotal')(eur(sub));
  summary.appendChild(subLine);

  const feeLine = document.createElement('div');
feeLine.id = 'feeLine';

if (PICKUP){
  // Ø¹Ù†Ø¯ Ø§Ù„Ø§Ù„ØªÙ‚Ø§Ø·: Ø´Ø·Ø¨ Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø£ØµÙ„ÙŠØ© ÙˆØ¥Ø¸Ù‡Ø§Ø± 0,00 â‚¬
  const r = (typeof getCartRestaurant==='function') ? getCartRestaurant() : null;
  const origFee = r ? (Number(r.flatDelivery ?? r.deliveryFlat ?? r.deliveryFee ?? 0) || 0) : fee;
  feeLine.innerHTML = (origFee > 0)
    ? `${T('delivery')}: <s>${eur(origFee)}</s> <strong>0,00 â‚¬</strong> <span style="margin-inline-start:6px;color:#16a34a;font-weight:800">(${T('pickup')})</span>`
    : `<span style="color:#16a34a;font-weight:800">${T('freeDelivery')}</span>`;
} else if (fee > 0){
  feeLine.innerHTML = `${T('delivery')}: <strong>${eur(fee)}</strong>`;
} else {
  feeLine.innerHTML = `<span style="color:#16a34a;font-weight:800">${T('freeDelivery')}</span>`;
}
summary.appendChild(feeLine);


  body.appendChild(summary);
}
// --- ØµÙ Ø§Ù„Ø§Ù„ØªÙ‚Ø§Ø· (Pickup / Abholung) ---
const pickupRow = document.createElement('div');
pickupRow.style.cssText = 'display:flex;align-items:center;gap:8px;padding:8px 0;border-top:1px solid #eee';
pickupRow.innerHTML = `
  <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
    <input id="pickupToggle" type="checkbox" ${PICKUP ? 'checked' : ''}>
    <span>${T('pickup')}</span>
  </label>
`;
body.appendChild(pickupRow);

// Ø±Ø¨Ø· Ø§Ù„ØªØºÙŠÙŠØ±
pickupRow.querySelector('#pickupToggle').addEventListener('change', (e)=>{
  PICKUP = !!e.target.checked;

  if (PICKUP){
    // Ø£Ø²Ù„ ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ (Ø¥Ù† ÙˆÙØ¬Ø¯) ÙˆÙÙØ¹Ù‘Ù„ Ø§Ù„Ø¯ÙØ¹ Ø¯Ø§Ø¦Ù…Ù‹Ø§
    const minNotice = body.querySelector('#minOrderNotice');
    if (minNotice) minNotice.remove();
    const payBtn = document.getElementById('checkout');
    if (payBtn){ payBtn.disabled = false; payBtn.title=''; }

    // Ø´Ø·Ø¨ Ø±Ø³ÙˆÙ… Ø§Ù„ØªÙˆØµÙŠÙ„ Ø¨ØµØ±ÙŠÙ‹Ø§ ÙˆØ¥Ø¸Ù‡Ø§Ø± 0,00 â‚¬
    const feeEl = document.getElementById('feeLine');
    const r = (typeof getCartRestaurant==='function') ? getCartRestaurant() : null;
    const origFee = r ? (Number(r.flatDelivery ?? r.deliveryFlat ?? r.deliveryFee ?? 0) || 0) : 0;
    if (feeEl){
      feeEl.innerHTML = (origFee > 0)
        ? `${T('delivery')}: <s>${eur(origFee)}</s> <strong>0,00 â‚¬</strong> <span style="margin-inline-start:6px;color:#16a34a;font-weight:800">(${T('pickup')})</span>`
        : `<span style="color:#16a34a;font-weight:800">${T('freeDelivery')}</span>`;
    }

    updateTotal();   // Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¨Ø¯ÙˆÙ† ØªÙˆØµÙŠÙ„
  } else {
    // Ø£Ø¨Ø³Ø· Ø§Ø³ØªØ±Ø¬Ø§Ø¹: Ø£Ø¹Ø¯ Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø³Ù„Ø© Ù„ØªØ¹ÙˆØ¯ Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰/Ø§Ù„ØªÙˆØµÙŠÙ„ ÙƒÙ…Ø§ ÙƒØ§Ù†Øª
    openCart();
    return; // Ù„Ø£Ù† openCart() Ø³ÙŠØ³ØªØ¯Ø¹ÙŠ updateTotal() Ø¨Ù†ÙØ³Ù‡
  }
});

  updateTotal();
  dlg.showModal();
}

function changeQty(key,d){
  const row=CART.find(x=>x.key===key); if(!row) return;
  row.qty+=d;
  if(row.qty<=0) CART=CART.filter(x=>x.key!==key);
  if(CART.length===0) CART_INFO = null; // ØµÙÙ‘Ø± Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø³Ù„Ø© Ø¥Ù† Ø£ØµØ¨Ø­Øª ÙØ§Ø±ØºØ©
  openCart();
  updateCartBadge();
}

function updateTotal(){
  const sub = CART.reduce((s,x)=>s+x.qty*x.price,0);
  const fee = (CART_INFO && Number(CART_INFO.delivery)) ? Number(CART_INFO.delivery) : 0;
  const total = sub + (PICKUP ? 0 : (fee>0 ? fee : 0));
  document.getElementById('cartTotal').textContent = T('sum')(eur(total));
}


function checkout(){
  if(!CART.length){ toast(T('emptyCart')); return; }
  const payload={ createdAt:new Date().toISOString(), lang:LANG, items:CART.map(x=>({restaurantId:x.rid,productId:x.pid,title:x.title,qty:x.qty,price:x.price})), total:CART.reduce((s,x)=>s+x.qty*x.price,0) };
  console.log('ORDER_DRAFT', payload); alert('Order draft prepared (Console). Connect backend to place the order.');
}
async function fetchOptionGroups(rid, ids){
  if(!Array.isArray(ids) || !ids.length) return [];
  const col = fs.collection('restaurants').doc(rid).collection('option_groups');
  const groups = [];
  // Ø¬Ù„Ø¨ ÙƒÙ„ Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¨Ø§Ù„Ù€ id
  for(const gid of ids){
    try{
      const d = await col.doc(gid).get();
      if(d.exists){
        const x = d.data();
        groups.push({
          id: gid,
          name: x.name || '',
          type: (x.type==='multi'?'multi':'single'),
          min: Number.isFinite(+x.min)? +x.min : 0,
          max: (x.max==null ? null : (Number.isFinite(+x.max)? +x.max : null)),
          items: Array.isArray(x.items)? x.items.map(it=>({
            name: it.name || '',
            price: Number(it.priceDelta||0)
          })) : []
        });
      }
    }catch(_){}
  }
  return groups;
}

// Ù…Ù‡ÙŠÙ‘Ø¦ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª
async function openConfigurator(r, p){
  const dlg = document.getElementById('cfgDialog');
  const body = document.getElementById('cfgBody');
  const title= document.getElementById('cfgTitle');
  const totalEl=document.getElementById('cfgTotal');
  const qtyEl  =document.getElementById('cfgQty');
  const qMinus =document.getElementById('cfgQtyMinus');
  const qPlus  =document.getElementById('cfgQtyPlus');
  const doneBtn=document.getElementById('cfgDone');

  title.textContent = `${(p.name||p.title||'')} â€“ ${T('options')}`;
  let qty = 1;

  // Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø³Ø¹Ø±
  // Ø§Ù„Ø®ØµÙ… Ø§Ù„ÙØ¹Ù„ÙŠ Ù„Ù„Ù…Ù†ØªØ¬ (ÙŠØºÙ„Ø¨ Ø¹Ù„Ù‰ Ø®ØµÙ… Ø§Ù„Ù…Ø·Ø¹Ù…)
const restDisc = getDiscountPercent(r);
const prodDisc = getProductDiscountPercent(p, restDisc);

// Ù†Ø·Ø¨Ù‘Ù‚ Ø§Ù„Ø®ØµÙ… Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ ÙÙ‚Ø· (Ø§Ù„Ø¥Ø¶Ø§ÙØ§Øª ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ)
const __base = (typeof p.price==='number') ? p.price : Number(p.price||0);
const basePrice = prodDisc > 0 ? Math.max(0, Math.round(__base * (100 - prodDisc)) / 100) : __base;


  // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª
  // 1) Ø§Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª â€œØ§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©â€ Ù…Ù† ÙØ§ÙŠØ±Ø³ØªÙˆØ±
const fetched = await fetchOptionGroups(
  r.id,
  Array.isArray(p.optionGroupIds) ? p.optionGroupIds : []
);

// 2) Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¹Ù†Ø¯Ù†Ø§ sizes ÙÙŠ ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ù…Ù†ØªØ¬ØŒ Ø§Ø¨Ù†Ù Ù…Ø¬Ù…ÙˆØ¹Ø© Ø­Ø¬Ù… Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
const groups = [];
let sizeDefault = -1;

// ØªØ­Ø§Ø´ÙŠ Ø§Ù„Ø§Ø²Ø¯ÙˆØ§Ø¬ Ù„Ùˆ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ø³Ù…Ù‡Ø§ GrÃ¶ÃŸe/Size Ø£ØµÙ„Ø§Ù‹ Ø¶Ù…Ù† fetched
const SIZE_NAMES = ['grÃ¶ÃŸe','grÃ¶sse','size','Ø§Ù„Ø­Ø¬Ù…','boyut'];
const hasRealSizeGroup = fetched.some(g =>
  g.type === 'single' && SIZE_NAMES.some(n => String(g.name||'').toLowerCase().includes(n))
);

if (!hasRealSizeGroup && Array.isArray(p.sizes) && p.sizes.length){
  const items = p.sizes.map(s => ({
    name: s.name || '',
    // Ù†ØªÙˆÙ‚Ø¹ Ø£Ù† Ø§Ù„ÙˆØ«ÙŠÙ‚Ø© ØªØ­ÙØ¸ ÙØ±Ù‚ Ø§Ù„Ø³Ø¹Ø± ØªØ­Øª priceDelta
    // Ø¥Ù† ÙƒØ§Ù†Øª ØªØ­ÙØ¸Ù‡Ø§ Ø­Ù‚Ù„Ø§Ù‹ Ø¢Ø®Ø± (price Ø£Ùˆ delta) ØºÙŠÙ‘Ø±Ù‡ Ù‡Ù†Ø§
    price: Number(s.priceDelta || 0)
  }));

  // Ø§Ø®ØªØ± Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§ Ø§Ù„Ø£Ù‚Ù„ ÙØ±Ù‚Ù‹Ø§ (Ø¹Ø§Ø¯Ø©Ù‹ 0)
  const minDelta = Math.min(...items.map(i => i.price));
  sizeDefault = Math.max(0, items.findIndex(i => i.price === minDelta));

  groups.push({
    id: '__size__',
    name: 'GrÃ¶ÃŸe',
    type: 'single',
    min: 1,
    max: 1,
    items
  });
}

// 3) Ø£Ù„Ø­ÙÙ‚ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø§Ù„Ù‚Ø§Ø¯Ù…Ø© Ù…Ù† ÙØ§ÙŠØ±Ø³ØªÙˆØ±
groups.push(...fetched);

// 4) Ø§Ø¨Ù†Ù Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø£ÙˆÙ„ÙŠØ© Ù…Ø¹ ÙˆØ¶Ø¹ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
const state = groups.map(g => ({
  g,
  sel: (g.type === 'single'
          ? (g.id === '__size__' ? sizeDefault : -1)
          : g.items.map(()=>0))
}));


  function computeExtras(){
    let extras = 0;
    for(const s of state){
      const {g, sel} = s;
      if(g.type==='single'){
        if(sel>=0){ extras += g.items[sel].price; }
      }else{
        s.sel.forEach((q,i)=>{ if(q>0) extras += q * g.items[i].price; });
      }
    }
    return extras;
  }
  function isValid(){
    // ØªØ­Ù‚Ù‚ min/max Ø¹Ù„Ù‰ Ø£Ø³Ø§Ø³ Ø¹Ø¯Ø¯ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© (distinct)
    for(const s of state){
      const {g, sel} = s;
      let chosen = 0;
      if(g.type==='single'){ chosen = (sel>=0 ? 1 : 0); }
      else{ chosen = sel.reduce((c,q)=> c + (q>0?1:0), 0); }
      if(chosen < (g.min||0)) return false;
      if(g.max!=null && chosen > g.max) return false;
    }
    return true;
  }
  function paint(){
    body.innerHTML='';
    // Ø³Ø·Ø± Ø§Ù„Ø³Ø¹Ø±
    totalEl.textContent = `${T('sum')(eur((basePrice + computeExtras()) * qty))}`;
	qtyEl.textContent = String(qty);
    doneBtn.disabled = !isValid();

    // Ø±Ø³Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª
    for(const s of state){
      const {g} = s;
      const wrap = document.createElement('div'); wrap.className='cfg-row';
      const hint = (g.type==='single'
        ? (g.min===1 ? '(1 erforderlich)' : '(1 wÃ¤hlen)')
        : `(min ${g.min}${g.max!=null?`, max ${g.max}`:''})`);
      wrap.innerHTML = `
        <div class="hdr">
          <div>${esc(g.name||'â€”')}</div>
          <div class="cfg-hint">${esc(hint)}</div>
        </div>
      `;
      // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª
      g.items.forEach((it, i)=>{
        const row = document.createElement('div'); row.className='opt';
        if(g.type==='single'){
          const checked = (s.sel===i) ? 'checked' : '';
          row.innerHTML = `
            <div class="opt-left">
              <input type="radio" name="g_${g.id}" ${checked} data-g="${g.id}" data-i="${i}">
              <div>
                <div class="opt-name">${esc(it.name)}</div>
                <div class="opt-price">${it.price>0?`+ ${eur(it.price)}`:eur(0).replace(/\d[\d.,\s]*â‚¬/,'0,00 â‚¬')}</div>
              </div>
            </div>
            <div></div>
          `;
          row.querySelector('input').addEventListener('change',()=>{
            s.sel = i; paint();
          });
        }else{
          // multi: +/- ÙƒÙ…ÙŠØ§Øª
          const q = s.sel[i] || 0;
          row.innerHTML = `
            <div class="opt-left">
              <div>
                <div class="opt-name">${esc(it.name)}</div>
                <div class="opt-price">${it.price>0?`+ ${eur(it.price)}`:eur(0).replace(/\d[\d.,\s]*â‚¬/,'0,00 â‚¬')}</div>
              </div>
            </div>
            <div class="opt-qty">
              <button class="btn-sm" data-dec="${i}">âˆ’</button>
              <span>${q}</span>
              <button class="btn-sm" data-inc="${i}">+</button>
            </div>
          `;
          row.querySelector('[data-dec]').addEventListener('click', ()=>{
            const idx = +row.querySelector('[data-dec]').dataset.dec;
            s.sel[idx] = Math.max(0, (s.sel[idx]||0)-1);
            paint();
          });
          row.querySelector('[data-inc]').addEventListener('click', ()=>{
            const idx = +row.querySelector('[data-inc]').dataset.inc;
            // Ø¶Ø¨Ø· max Ø¹Ù„Ù‰ Ø£Ø³Ø§Ø³ Ø¹Ø¯Ø¯ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ù…ÙŠØ²Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©ØŒ Ù„ÙŠØ³ Ø§Ù„ÙƒÙ…ÙŠØ§Øª
            const distinct = s.sel.reduce((c,q)=> c+(q>0?1:0),0) + (s.sel[idx]===0?1:0);
            if(s.g.max!=null && distinct > s.g.max) return; // Ù„Ø§ Ù†ØªØ¬Ø§ÙˆØ² max
            s.sel[idx] = (s.sel[idx]||0)+1;
            paint();
          });
        }
        wrap.appendChild(row);
      });
      body.appendChild(wrap);
    }
  }

  qMinus.onclick = ()=>{ qty = Math.max(1, qty-1); paint(); };
  qPlus.onclick  = ()=>{ qty = Math.min(99, qty+1); paint(); };
  document.getElementById('cfgClose').onclick = ()=> dlg.close();

  doneBtn.onclick = ()=>{
    if(!isValid()){ toast(T('invalidSel')); return; }
    // Ø¨Ù†Ø§Ø¡ ÙˆØµÙ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© + Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ Ù„Ù„ÙˆØ­Ø¯Ø©
    const picked = state.map(s=>{
      const {g} = s;
      if(g.type==='single'){
        return (s.sel>=0) ? { group:g.name, items:[{ name:g.items[s.sel].name, qty:1, price:g.items[s.sel].price }]} : null;
      }else{
        const items = [];
        s.sel.forEach((q,i)=>{ if(q>0) items.push({ name:g.items[i].name, qty:q, price:g.items[i].price }); });
        return items.length ? { group:g.name, items } : null;
      }
    }).filter(Boolean);

    const extraPerUnit = computeExtras();
    addConfiguredToCart(r, p, { qty, picked, extraPerUnit });
    dlg.close();
  };

  paint();
  dlg.showModal();
}

// Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ù…Ù‡ÙŠÙ‘Ø£ Ø¥Ù„Ù‰ Ø§Ù„Ø³Ù„Ø©
function addConfiguredToCart(r, p, cfg){
  const distinct = new Set(CART.map(x=>x.rid));
  if (distinct.size && !distinct.has(r.id)){
    const msg=(LANG==='de')?'Sie haben Artikel von einem anderen Restaurant im Warenkorb. Warenkorb leeren und fortfahren?'
      :(LANG==='en')?'Your cart has items from another restaurant. Clear cart and continue?'
      :(LANG==='tr')?'Sepette baÅŸka bir restorandan Ã¼rÃ¼n var. Temizleyip devam edilsin mi?'
      :'ØªØ­ØªÙˆÙŠ Ø§Ù„Ø³Ù„Ø© Ø¹Ù†Ø§ØµØ± Ù…Ù† Ù…Ø·Ø¹Ù… Ø¢Ø®Ø±. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥ÙØ±Ø§Øº Ø§Ù„Ø³Ù„Ø© ÙˆØ§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ';
    if(!confirm(msg)) return; CART=[];
  }
  // Ø­Ø¯Ù‘Ø« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø³Ù„Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø·Ø¹Ù…
CART_INFO = {
  rid: r.id,
  rname: (r.name||''),
  delivery: Number(r.flatDelivery ?? r.deliveryFlat ?? r.deliveryFee ?? 0) || 0,
  minOrder: Number(r.minOrder ?? r.minOrderValue ?? 0) || 0
};


    // Ø­Ø³Ø§Ø¨ Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø© Ø¨Ø¹Ø¯/Ù‚Ø¨Ù„ Ø§Ù„Ø®ØµÙ… Ù…Ø¹ Ø§Ù„Ø¥Ø¶Ø§ÙØ§Øª Ù„ÙƒÙ„ ÙˆØ­Ø¯Ø©
  const extra = Number(cfg.extraPerUnit||0);
  const { unit, unitOld, discPct } = computeUnitPrice(r, p, extra);

  const img =
    (Array.isArray(p.images) && p.images[0]) ? p.images[0] :
    (typeof p.img === 'string' && p.img) ? p.img :
    (typeof p.imageUrl === 'string' && p.imageUrl) ? p.imageUrl : '';

  const sig = JSON.stringify(cfg.picked);
  const key = `${r.id}::${p.id}::${btoa(unescape(encodeURIComponent(sig))).slice(0,16)}`;

  const row = CART.find(x=>x.key===key);
  if(row){ row.qty += cfg.qty; }
  else{
    CART.push({
      key, rid:r.id, rname:(r.name||''), pid:p.id,
      title:(p.name||p.title||''), 
      price: unit,            // Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ… + Ø§Ù„Ø¥Ø¶Ø§ÙØ§Øª Ù„Ù„ÙˆØ­Ø¯Ø©
      unitOld: unitOld,       // Ù‚Ø¨Ù„ Ø§Ù„Ø®ØµÙ… + Ø§Ù„Ø¥Ø¶Ø§ÙØ§Øª Ù„Ù„ÙˆØ­Ø¯Ø© (Ù„Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø´Ø·ÙˆØ¨)
      discPct: discPct,
      qty: cfg.qty,
      img, opts: cfg.picked
    });
  }
  updateCartBadge();
  toast(T('added'));

}

/* ===== Bindings ===== */
window.addEventListener('DOMContentLoaded', ()=>{
  const sel=document.getElementById('lang'); sel.value=LANG; applyLang();
    sel.addEventListener('change',()=>{
    LANG=sel.value; localStorage.setItem('taussil:lang',LANG);
    applyLang(); buildCatRail(); renderCatalog();
  });
buildCatRail();
  bindRailNav(); // Ø±Ø¨Ø· Ø£Ø³Ù‡Ù… Ø§Ù„Ø³ÙƒÙƒ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©

  document.querySelector('.chip[data-chip="open"]').addEventListener('click',e=>{ e.currentTarget.classList.toggle('active'); renderCatalog(); });
  document.getElementById('sort').addEventListener('change',renderCatalog);
  document.getElementById('city').addEventListener('change',renderCatalog);
  document.getElementById('q').addEventListener('input',renderCatalog);

  document.getElementById('menuClose').addEventListener('click',()=> document.getElementById('menuDialog').close());
  document.getElementById('viewCart').addEventListener('click',openCart);
  document.getElementById('cartClose').addEventListener('click',()=> document.getElementById('cartDialog').close());
  document.getElementById('checkout').addEventListener('click',checkout);

  loadRestaurants().catch(err=>{ document.getElementById('grid').innerHTML = `<div class="small" style="color:#b91c1c">${esc(err?.message||String(err))}</div>`; });
});
</script>
</body>
</html>
