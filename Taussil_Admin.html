<!doctype html>
<html lang="de" dir="ltr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Taussil – Admin</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#f7f8fb; --card:#fff; --ink:#0b1320; --muted:#6b7280; --cta:#33BBDF;
  --border:1px solid rgba(0,0,0,.08); --radius:14px; --shadow:0 10px 30px rgba(0,0,0,.08);
}
*{box-sizing:border-box} html,body{margin:0;height:100%;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink)}
.app{max-width:1400px;margin:0 auto;padding:14px;display:flex;flex-direction:column;gap:12px}
.bar{display:flex;align-items:center;gap:10px;background:var(--card);border:var(--border);border-radius:12px;box-shadow:var(--shadow);padding:10px 12px;position:sticky;top:8px;z-index:5}
.brand{display:flex;flex-direction:column;font-weight:800}
.brand .sub{font-size:12px;color:var(--muted);font-weight:600}
.controls{margin-inline-start:auto;display:flex;align-items:center;gap:8px}
select, .btn, .icon{height:40px;border-radius:10px;border:1px solid rgba(0,0,0,.1);background:#fff;color:var(--ink);padding:0 10px;font-weight:700;cursor:pointer}
.btn.secondary{background:#f3f4f6}
.icon{width:40px;display:flex;align-items:center;justify-content:center}
.small{font-size:12px;color:var(--muted)}
.nav{display:flex;gap:8px}
.nav button{padding:10px 12px;border-radius:10px;border:1px solid rgba(0,0,0,.08);background:#fff;cursor:pointer}
.nav button.active{background:linear-gradient(180deg,#33BBDF,#1da9cf);color:#fff;border:none}
.tabs{display:flex;flex-direction:column;gap:12px}
.tab[hidden]{display:none}
.card{background:#fff;border:var(--border);border-radius:12px;box-shadow:var(--shadow)}
.card .ph{padding:12px 14px;border-bottom:1px solid rgba(0,0,0,.06);display:flex;align-items:center;justify-content:space-between}
.card .pb{padding:12px 14px}
.grid{display:grid;gap:10px}
.grid.cols-2{grid-template-columns:1fr 1fr}
.grid.cols-3{grid-template-columns:repeat(3,1fr)}
.row{display:flex;align-items:center;gap:10px}
.flex{display:flex;align-items:center;gap:10px}
.right{margin-inline-start:auto}
.logo{width:48px;height:48px;border-radius:12px;border:1px solid rgba(0,0,0,.06);object-fit:cover;background:#fff}
.avatar{width:40px;height:40px;border-radius:999px;border:1px solid rgba(0,0,0,.08);object-fit:cover;background:#fff}
.badge{font-size:11px;border-radius:999px;padding:4px 8px;border:1px solid rgba(0,0,0,.08);background:#f3f4f6}
.badge.blue{background:#eff6ff;border-color:#dbeafe;color:#1e40af}
.badge.green{background:#ecfdf5;border-color:#bbf7d0;color:#065f46}
.badge.gray{background:#f3f4f6;border-color:#e5e7eb;color:#374151}
.badge.rose{background:#fff1f2;border-color:#ffe4e6;color:#9f1239}
.chip{display:inline-block;font-size:12px;padding:5px 9px;border-radius:999px;background:#f3f4f6;border:1px solid rgba(0,0,0,.06);margin-inline:4px}
.table .tr{display:grid;grid-template-columns:auto 1fr 1fr auto auto auto;gap:10px;align-items:center;border-bottom:1px solid rgba(0,0,0,.06);padding:8px 0}
.table .tr:last-child{border-bottom:0}
.mono{font-family:ui-monospace,Menlo,monospace}
.donut{--a:0deg;--b:0deg;--c:0deg;--d:360deg;width:140px;height:140px;border-radius:50%;background:
 conic-gradient(#a1a1aa 0 var(--a), #60a5fa var(--a) var(--b), #34d399 var(--b) var(--c), #fda4af var(--c) var(--d));
  mask:radial-gradient(circle at 50% 50%, transparent 0 50px, #000 50px);margin:auto}
.kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
.kpi{background:#fff;border:var(--border);border-radius:12px;box-shadow:var(--shadow);padding:10px;display:flex;flex-direction:column;gap:6px;align-items:flex-start}
.kpi .n{font-weight:800;font-size:22px}
#gm{height:520px;border-radius:12px;border:1px solid rgba(0,0,0,.1)}
/* Modals */
.sheet, .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:1000}
.sheet.open, .modal.open{display:flex}
.sheet .box, .modal .box{background:#fff;color:#0b1320;border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 12px 40px rgba(0,0,0,.2);padding:14px;max-width:560px;width:92%}
.modal.right .box{max-width:420px;width:min(420px,92%);margin-inline-start:auto}
/* ===== Order modal scrolling ===== */
#order-modal .box{
  max-height: 80vh;          /* ارتفاع أعظمي للصندوق */
  overflow: auto;            /* تمكين التمرير داخل الصندوق */
}

/* ثبّت صف العنوان (زر الإغلاق) أعلى الصندوق أثناء التمرير */
#order-modal .box > .row:first-child{
  position: sticky;
  top: 0;
  z-index: 1;
  background: #fff;
  /* تمديد الخلفية على كامل عرض الصندوق مع الحفاظ على padding الداخلي */
  margin: -14px -14px 10px -14px;   /* يساوي padding:14px للصندوق */
  padding: 14px;
  border-bottom: 1px solid #e5e7eb;
}

/* Auth overlay */
#adminAuth{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.55);z-index:2000}
#adminAuth .box{background:#0f1a30;color:#e6e9ef;border:1px solid rgba(255,255,255,.14);border-radius:16px;padding:14px;width:min(560px,92%)}
#adminAuth .input, #adminAuth .btn{height:44px;border-radius:10px}
#adminAuth .input{border:1px solid rgba(255,255,255,.12);background:#0f1a30;color:#e6e9ef;padding:0 12px}
#adminAuth .btn{border:1px solid rgba(255,255,255,.12);background:#13213a;color:#e6e9ef}
#adminAuth .btn-cta{background:linear-gradient(180deg,#33BBDF,#1da9cf);border:none}
@media (max-width:900px){ .grid.cols-3{grid-template-columns:1fr} .table .tr{grid-template-columns:auto 1fr 1fr auto;grid-auto-rows:auto}}
/* Mini Map (Dashboard) */
/* ===== Dashboard layout (3/4 + 1/4) ===== */
:root{
  /* ارتفاع تقريبي للعمودين اليسار (يمكن تعديله) */
  --dashCardH: 520px;
  /* الخريطة نصف ارتفاع الأعمدة اليسار */
  --miniMapH: calc(var(--dashCardH) / 2);
}

/* شبكة الداشبورد: عمودان لليسار (3/4) + عمود يمين للخريطة (1/4) */
#tab-dashboard .grid.cols-3{
  grid-template-columns: 3fr 3fr 2fr;   /* 37.5% + 37.5% + 25% */
  grid-template-rows: auto auto;        /* صفّان: الخريطة فوق وبطاقة الرحلة تحت */
  align-items: start;
  gap: 12px;
}

/* اجعل الكاردين اليسار يمتدان على الصفّين (لتكون الخريطة نصف الارتفاع تقريبياً) */
#tab-dashboard .grid.cols-3 > .card:nth-child(1),
#tab-dashboard .grid.cols-3 > .card:nth-child(2){
  grid-row: 1 / span 2;
  min-height: var(--dashCardH);
}

/* عمود اليمين: الخريطة ثم بطاقة الرحلة */
#miniMapCard{ grid-column: 3; grid-row: 1; align-self: start; }
#miniTripCard{ grid-column: 3; grid-row: 2; align-self: start; }

/* حجم الخريطة = نصف ارتفاع الأعمدة اليسار */
#miniMapCard .pb{ padding: 12px; }
#mini-map{
  width: 100%;
  height: var(--miniMapH);
  min-height: 260px;
  border-radius: 12px;
  border: 1px solid rgba(0,0,0,.10);
  overflow: hidden;
}

/* بطاقة الرحلة تحت الخريطة */
#miniTripCard .pb{
  display: grid;
  grid-template-columns: 1fr;
  gap: 8px;
}

/* عناصر البطاقة (سائق/مطعم/كود/ETA/حالة/رسوم) */
.trip-row{ display:flex; align-items:center; gap:10px; }
.trip-row .chip{ margin-inline:0; }
.trip-meta{ display:grid; grid-template-columns: 1fr auto; gap:8px; }
.trip-meta .right{ margin-inline-start:auto; }
.trip-money{ font-weight:800; }

/* حماية من تمدد العناصر داخل صفوف الجداول */
#tab-dashboard .table .tr{ overflow:hidden; }
#tab-dashboard .table .tr > *{ min-width:0; }
#tab-dashboard .right{ white-space:nowrap; }

/* لا تسمح لقائمة الحالة أن تتمدد أكثر من اللازم */
.dropdown select{ max-width:180px; }

/* السماح بالتمرير داخل كل تبويب ومنع قص المحتوى */
.tab{ overflow:auto; }

/* استجابة للموبايل: عمود واحد */
@media (max-width: 900px){
  #tab-dashboard .grid.cols-3{
    grid-template-columns: 1fr;
    grid-template-rows: auto;
  }
  #tab-dashboard .grid.cols-3 > .card:nth-child(1),
  #tab-dashboard .grid.cols-3 > .card:nth-child(2){
    grid-row: auto;
    min-height: auto;
  }
  #miniMapCard, #miniTripCard{
    grid-column: auto; grid-row: auto;
  }
  #mini-map{ height: 320px; }
}
/* ===== Trip mini card ===== */
.trip-card{
  background:#fff;border:var(--border);border-radius:12px;box-shadow:var(--shadow);padding:10px;
}
.trip-grid{
  display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center;
}
.trip-main .trip-line{ display:flex; gap:8px; align-items:center; }
.trip-label{ font-size:12px; color:var(--muted); min-width:86px; }
.trip-value{ font-weight:700; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
.trip-stats{ display:flex; gap:8px; align-items:center; justify-content:flex-end; flex-wrap:wrap; }


/* ============ Taussil Compact UI (Config-first) ============ */
/* 🔧 جدول الإعدادات — غيّر القيم هنا بسرعة */
:root{
  --ui-font-base: 13px;     /* حجم النص الأساسي */
  --ui-font-small: 11px;    /* النص الصغير (.small) */
  --ui-gap: 8px;            /* المسافة بين عناصر الصف */
  --ui-row-pad-y: 6px;      /* الحشوة العمودية لكل صف */
  --ui-row-pad-x: 8px;      /* الحشوة الأفقية لكل صف */

  --ui-btn-h: 32px;         /* ارتفاع الأزرار و الـselect */
  --ui-btn-font: 12px;      /* حجم خط الأزرار */
  --ui-btn-pad-x: 10px;     /* حشوة أفقية للأزرار */
  --ui-radius: 10px;        /* نصف القطر للأزرار/الشارات */

  --ui-badge-font: 11px;    /* حجم خط الشارات (badge) */
  --ui-badge-pad-y: 2px;    /* حشوة الشارة عمودي */
  --ui-badge-pad-x: 8px;    /* حشوة الشارة أفقي */

  --ui-chip-font: 11px;     /* حجم خط الشرائح (chip) */
  --ui-chip-pad-y: 2px;     /* حشوة الـchip عمودي */
  --ui-chip-pad-x: 6px;     /* حشوة الـchip أفقي */

  --ui-logo: 26px;          /* حجم شعار المطعم */
  --ui-avatar: 28px;        /* حجم صورة السائق */
  --ui-mono: 12px;          /* خط أحادي مثل الكود/الكمية */

  --ui-break: 1400px;       /* تحته تنزل منطقة الإجراءات لسطر جديد */
}

/* (اختياري) وضع مضغوط جدًا بتبديل كلاس على body: <body class="compact-xxs"> */
.compact-xxs{
  --ui-font-base: 12px;
  --ui-font-small: 10px;
  --ui-gap: 6px;
  --ui-btn-h: 28px;
  --ui-btn-font: 11px;
  --ui-logo: 22px;
  --ui-avatar: 24px;
  --ui-mono: 11px;
}

/* ============ التطبيق ============ */
body{ font-size: var(--ui-font-base); }
.small{ font-size: var(--ui-font-small) !important; }
.mono{ font-size: var(--ui-mono); font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }

/* قوائم: الواردة/الفعّالة/السجل */
#incoming-list .tr,
#active-list .tr,
#orders-log .tr{
  display:flex; align-items:center;
  gap: var(--ui-gap);
  padding: var(--ui-row-pad-y) var(--ui-row-pad-x);
  overflow:hidden;
  flex-wrap:wrap;                /* مهم: لف العناصر داخل البطاقة */
}
#incoming-list .tr > *,
#active-list .tr > *,
#orders-log .tr > *{
  min-width:0;                   /* مهم: يسمح بالانكماش داخل flex */
}

/* منطقة الإجراءات يمين الصف */
#incoming-list .tr .right,
#active-list   .tr .right,
#orders-log    .tr .right{
  margin-left:auto;
  display:flex; align-items:center;
  gap: var(--ui-gap);
  flex-wrap:wrap;
  min-width:0;
}

/* أزرار و select */
#incoming-list .tr .btn,
#active-list   .tr .btn,
#orders-log    .tr .btn,
.gm-btn,
.dropdown select{
  height: var(--ui-btn-h);
  padding: 4px var(--ui-btn-pad-x);
  font-size: var(--ui-btn-font);
  border-radius: var(--ui-radius);
  line-height:1;
  white-space:nowrap;
}

/* شارات و شرائح */
.badge{
  font-size: var(--ui-badge-font);
  padding: var(--ui-badge-pad-y) var(--ui-badge-pad-x);
  border-radius: var(--ui-radius);
  line-height:1.2;
}
.chip{
  display:inline-block;
  font-size: var(--ui-chip-font);
  padding: var(--ui-chip-pad-y) var(--ui-chip-pad-x);
  border-radius: var(--ui-radius);
  line-height:1.2;
}

/* الصور */
.logo  { width: var(--ui-logo);   height: var(--ui-logo);   object-fit:cover; }
.avatar{ width: var(--ui-avatar); height: var(--ui-avatar); object-fit:cover; border-radius:50%; }

/* منع خروج النصوص الطويلة (اسم/زر طويل مثل Details) */
.tr .flex > div { min-width:0; }
.tr .flex div div{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

/* التفاف منطقة الإجراءات تحت المحتوى عند الشاشات الأضيق */
@media (max-width: var(--ui-break)){
  #incoming-list .tr .right,
  #active-list   .tr .right,
  #orders-log    .tr .right{
    flex-basis:100%;
    justify-content:flex-start;
  }
}
/* ===== Restaurants split view ===== */
.rest-split{
  display:grid;
  grid-template-columns: 1fr 6px 1fr; /* عمود – مقبض – عمود */
  gap:0;
  min-height: 520px;
}
.rest-sash{
  cursor: col-resize;
  background: repeating-linear-gradient(
    90deg,
    #e5e7eb, 0 3px,
    #f3f4f6, 3px 6px
  );
}
.rest-col{ min-width: 0; }
.rest-filters{
  display:grid; gap:8px; margin-bottom:10px;
  grid-template-columns: 1fr 1fr;
}
.rest-filters .row{ display:grid; grid-template-columns: 1fr 1fr; gap:8px; }
.rest-filters .input{
  height: 36px; border-radius:10px; border:1px solid rgba(0,0,0,.12); padding:0 10px;
}
@media (max-width: 900px){
  .rest-split{ grid-template-columns: 1fr; }
  .rest-sash{ display:none; }
}
@media (max-width: 900px){
  .rest-split{ grid-template-columns: 1fr; }
  .rest-sash{ display:none; }
}
/* ===== Fleets split view (approved | pending) ===== */
.fleet-split{
  display:grid;
  grid-template-columns: 1fr 6px 1fr;
  gap:0;
  min-height:520px;
}
.fleet-sash{
  cursor: col-resize;
  background: repeating-linear-gradient(90deg,#e5e7eb,0 3px,#f3f4f6,3px 6px);
}
.fleet-col{ min-width:0; }
.fleet-filters{
  display:grid; gap:8px; margin-bottom:10px;
  grid-template-columns: 1fr 1fr;
}
.fleet-filters .input{
  height:36px; border-radius:10px; border:1px solid rgba(0,0,0,.12); padding:0 10px;
}
/* internal scroll w/o visible scrollbar */
#fleets-approved-wrap .pb, #fleets-pending-wrap .pb{
  overflow:auto; scrollbar-width:none; -ms-overflow-style:none;
}
#fleets-approved-wrap .pb::-webkit-scrollbar, #fleets-pending-wrap .pb::-webkit-scrollbar{ width:0; height:0 }
@media (max-width: 900px){
  .fleet-split{ grid-template-columns:1fr; }
  .fleet-sash{ display:none; }
}

/* ===== Modal: viewport-contained, internal scroll, no visible scrollbar ===== */
.modal .box{
  max-height: 88vh;                  /* يحتوى ضمن الشاشة */
  overflow: auto;                    /* سكرول داخل الصندوق */
  overscroll-behavior: contain;      /* منع ارتداد الصفحة */
  display: flex;
  flex-direction: column;
  -webkit-overflow-scrolling: touch; /* سلاسة على iOS */

  /* إخفاء شريط السّكرول بصريًا مع بقاء السحب */
  scrollbar-width: none;             /* Firefox */
  -ms-overflow-style: none;          /* IE/Edge */
}
.modal .box::-webkit-scrollbar{      /* WebKit (Chrome/Safari/Edge) */
  width: 0;
  height: 0;
}

/* هيدر ثابت داخل المودال أثناء التمرير (بدون لاينر جانبي) */
.modal .box > .row:first-child{
  position: sticky;
  top: 0;
  z-index: 5;
  background: #fff;
  margin: -14px -14px 10px -14px;  /* نفس الحيلة اللي عندك لتمد الخلفية */
  padding: 14px;
  border-bottom: 1px solid #e5e7eb;
}

/* قفل تمرير الخلفية عند فتح المودال */
body.modal-open{ overflow: hidden; }
/* ===== Drivers tab: fixed 3 columns, inner scrolling w/o scrollbar line ===== */
#drivers-cols{
  display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px;
  align-items:stretch;
}
#drivers-cols .col.card{
  display:flex; flex-direction:column; min-height:520px;
}

/* رأس العمود */
#drivers-cols .col .ph{
  padding:12px 14px; border-bottom:1px solid rgba(0,0,0,.06);
  display:flex; gap:10px; align-items:center; justify-content:space-between;
}

/* جسم العمود قابل للسّكرول داخليًا */
#drivers-cols .col .pb{
  padding:10px 12px;
  overflow:auto;
  /* اضبط الارتفاع حسب شريط العنوان والـHeader عندك */
  max-height: calc(100vh - 220px);
  overscroll-behavior: contain;
}

/* اخفاء خطوط السّكرول لكل المتصفحات الشائعة */
#drivers-cols .col .pb::-webkit-scrollbar{ width:0; height:0 }
#drivers-cols .col .pb{ scrollbar-width:none; -ms-overflow-style:none }

/* صف السائق */
.drv-row{
  display:flex; gap:10px; align-items:center; justify-content:space-between;
  border:1px solid #e5e7eb; border-radius:10px; padding:8px; margin-bottom:8px;
}
.drv-row .who{ min-width:0 }
.drv-row .who .name{ font-weight:800; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
.drv-row .who .meta{ font-size:12px; color:#6b7280 }
.drv-row .actions{ display:flex; gap:6px; flex-wrap:wrap }
.drv-row .btn{ height:32px; padding:4px 10px; border-radius:10px; border:1px solid rgba(0,0,0,.1); background:#fff; cursor:pointer }
.drv-row .btn.primary{ background:linear-gradient(180deg,#33BBDF,#1da9cf); color:#fff; border:none }

/* استجابة */
@media (max-width:1100px){
  #drivers-cols{ grid-template-columns:1fr; }
  #drivers-cols .col .pb{ max-height: calc(100vh - 180px); }
}
/* ===== Orders Log – card-like rows, sticky header, inner scroll w/o scrollbar ===== */
#tab-orders .card .ph{
  position: sticky; top: 0; z-index: 2;
  background: #fff; /* يبقي الهيدر واضح أثناء التمرير */
}

#orders-log{
  overflow: auto;
  max-height: calc(100vh - 230px);
  overscroll-behavior: contain;
  scrollbar-width: none; -ms-overflow-style: none;
}
#orders-log::-webkit-scrollbar{ width:0; height:0 }

/* صف الطلب كـ بطاقة */
#orders-log .tr{
  display: grid;
  grid-template-columns: auto 110px 1.4fr 1.2fr auto auto auto;
  gap: var(--ui-gap);
  align-items: center;
  background: #fff;
  border: 1px solid #e5e7eb;
  border-radius: 10px;
  padding: 8px;
  margin-bottom: 8px;
}
#orders-log .tr:hover{
  box-shadow: var(--shadow);
  border-color: rgba(0,0,0,.1);
}

/* عناصر الصف */
#orders-log .select input{ width:16px; height:16px }
#orders-log .order-code{
  font-weight:800; text-align:center;
  background:#f8fafc; border:1px solid #e5e7eb; border-radius:8px; padding:4px 8px;
}
#orders-log .order-restaurant .logo{ width: var(--ui-logo); height: var(--ui-logo) }
#orders-log .order-driver .small{ color: var(--muted) }
#orders-log .order-platform .chip{ margin-inline:2px }
#orders-log .order-qty{
  justify-self:center;
  background:#f3f4f6; border:1px solid #e5e7eb; border-radius:8px; padding:2px 8px; font-weight:700;
}
#orders-log .order-actions{
  justify-self:end; display:flex; align-items:center; gap:6px; flex-wrap:wrap;
}

/* استجابة */
@media (max-width: 1100px){
  #orders-log .tr{
    grid-template-columns: auto 90px 1fr auto;
    grid-auto-rows: auto;
  }
  #orders-log .order-driver,
  #orders-log .order-platform{
    grid-column: 3 / -1;
  }
  #orders-log .order-actions{
    grid-column: 1 / -1; justify-self: start;
  }
}
/* ===== Dashboard – same card rows style ===== */
#tab-dashboard .card .ph{
  position: sticky; top: 0; z-index: 2;
  background:#fff;
}

/* Scroll containers without visible scrollbar */
#incoming-list, #active-list{
  overflow:auto;
  max-height: calc(100vh - 230px);
  overscroll-behavior: contain;
  scrollbar-width: none; -ms-overflow-style: none;
}
#incoming-list::-webkit-scrollbar, #active-list::-webkit-scrollbar{ width:0; height:0 }

/* Row = card */
#incoming-list .tr, #active-list .tr{
  display:grid;
  gap: var(--ui-gap);
  align-items:center;
  background:#fff;
  border:1px solid #e5e7eb;
  border-radius:10px;
  padding:8px;
  margin-bottom:8px;
}
#incoming-list .tr:hover, #active-list .tr:hover{
  box-shadow: var(--shadow);
  border-color: rgba(0,0,0,.1);
}

/* Grids */
#incoming-list .tr{
  grid-template-columns: 1.6fr auto auto auto 1fr auto;
}
#active-list .tr{
  grid-template-columns: 1.4fr auto 1fr;
}

/* Bits */
.order-qty{
  justify-self:center;
  background:#f3f4f6; border:1px solid #e5e7eb;
  border-radius:8px; padding:2px 8px; font-weight:700;
}
.order-price{ font-weight:800; }
.order-pickup{ display:flex; align-items:center; gap:6px; }
.row-actions{ justify-self:end; display:flex; gap:6px; flex-wrap:wrap; }
.order-platform .chip{ margin-inline:2px }

/* Responsive */
@media (max-width:1100px){
  #incoming-list .tr{
    grid-template-columns: 1fr auto;
    grid-auto-rows:auto;
  }
  #incoming-list .order-platform,
  #incoming-list .order-qty,
  #incoming-list .order-price,
  #incoming-list .order-pickup,
  #incoming-list .row-actions{
    grid-column: 1 / -1; justify-self:start;
  }

  #active-list .tr{
    grid-template-columns: 1fr auto;
  }
  #active-list .row-actions{
    grid-column: 1 / -1; justify-self:start;
  }
}
/* ===== Full-screen layout (safe-area + flex fill) ===== */
html, body { height: 100%; }
body { min-height: 100dvh; }                   /* dvh يعالج شريط المتصفح على الموبايل */
.app{
  min-height: 100dvh;
  display: flex; flex-direction: column;
  padding-bottom: calc(14px + env(safe-area-inset-bottom, 0px));
}
.bar{
  position: sticky;
  top: env(safe-area-inset-top, 8px);          /* احترام الـ notch */
}

/* اجعل التبويبات تملأ الشاشة، والسكرول يكون داخلها */
.tabs{ flex: 1; min-height: 0; display: flex; flex-direction: column; }
.tab { flex: 1; min-height: 0; overflow: auto; }

/* ===== Cards with internal scroll (بدون حدود ارتفاع مقصوصة) ===== */
/* Dashboard */
#tab-dashboard .card{ display:flex; flex-direction:column; min-height:0; }
#tab-dashboard .card .pb{
  flex:1; min-height:0; overflow:auto;
  scrollbar-width:none; -ms-overflow-style:none;
}
#tab-dashboard .card .pb::-webkit-scrollbar{ width:0; height:0 }
/* ألغِ أي max-height قديمة */
#incoming-list, #active-list{ max-height: none !important; }

/* Restaurants columns */
#tab-restaurants .card{ display:flex; flex-direction:column; min-height:0; }
#tab-restaurants .card .pb{
  flex:1; min-height:0; overflow:auto;
  scrollbar-width:none; -ms-overflow-style:none;
}
#tab-restaurants .card .pb::-webkit-scrollbar{ width:0; height:0 }

/* Drivers 3 columns */
#drivers-cols .col.card{ display:flex; flex-direction:column; min-height:0; }
#drivers-cols .col .pb{
  flex:1; min-height:0; overflow:auto;
  max-height: none !important;                 /* إزالة الحساب بـ 100vh */
  scrollbar-width:none; -ms-overflow-style:none;
}
#drivers-cols .col .pb::-webkit-scrollbar{ width:0; height:0 }

/* Orders log */
#tab-orders .card{ display:flex; flex-direction:column; min-height:0; }
#tab-orders .card .pb{
  flex:1; min-height:0; overflow:auto;
  scrollbar-width:none; -ms-overflow-style:none;
}
#tab-orders .card .pb::-webkit-scrollbar{ width:0; height:0 }
/* ===== Fleet Ops (Bulk) — layout (isolated) ===== */
#tab-fleetx #fleetx-grid{
  display:grid; grid-template-columns: 1fr 6px 1fr; gap:0; min-height:520px;
}
#tab-fleetx .fleetx-col{ min-width:0; }
#tab-fleetx .fleetx-sash{
  cursor: col-resize;
  background: repeating-linear-gradient(90deg,#e5e7eb,0 3px,#f3f4f6,3px 6px);
}
#tab-fleetx .fx-row{
  display:flex; align-items:center; gap:10px;
  border:1px solid #e5e7eb; border-radius:10px; padding:8px;
  background:#fff;
}
#tab-fleetx .fx-row:hover{ box-shadow: var(--shadow); border-color: rgba(0,0,0,.1); }

/* internal scroll without visible scrollbars */
#tab-fleetx .fleetx-col{ display:flex; flex-direction:column; }
#tab-fleetx #fleetx-orders, #tab-fleetx #fleetx-fleets{
  overflow:auto; max-height: calc(100vh - 260px);
  scrollbar-width:none; -ms-overflow-style:none;
}
#tab-fleetx #fleetx-orders::-webkit-scrollbar,
#tab-fleetx #fleetx-fleets::-webkit-scrollbar{ width:0; height:0; }

/* responsive: single column */
@media (max-width: 900px){
  #tab-fleetx #fleetx-grid{ grid-template-columns: 1fr; }
  #tab-fleetx .fleetx-sash{ display:none; }
}
/* === Admin Desktop Fit Patch (append at end) === */
:root{
  --admin-maxw: 1280px;    /* عدّلها 1200–1440 حسب رغبتك */
  --admin-padx: 16px;
}

/* 1) لا تمرير أفقي + حصر العرض داخل الشاشة */
html{ overflow-x: hidden; }
.app{
  max-width: none;  /* يلغي 1400px القديمة */
  width: min(var(--admin-maxw), 100vw - (var(--admin-padx)*2));
  margin-inline: auto;
}

/* 2) أي صف/جريد ما يدفّش الصفحة */
.row, .flex, .grid, .bar, .controls, .nav, .ph, .pb{ min-width: 0; }
.row, .flex, .controls, .nav{ flex-wrap: wrap; }

/* 3) جداول وبطاقات: أعمدة قابلة للانكماش (بدون تمدد أفقي) */
.table .tr{
  grid-template-columns:
    auto
    minmax(0,1fr)
    minmax(0,1fr)
    auto auto auto;
}
#incoming-list .tr{
  grid-template-columns:
    minmax(0,1.6fr)
    auto auto auto
    minmax(0,1fr)
    auto;
}
#active-list .tr{
  grid-template-columns:
    minmax(0,1.4fr)
    auto
    minmax(0,1fr);
}

/* 4) قصّ النصوص الطويلة بأناقة */
.app :where(.ellipsis, .force-fit, .trip-value, .right){
  min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
}

/* 5) الكروت تحتفظ بارتفاع الشاشة والسكرول داخلي */
.card{ display:flex; flex-direction:column; min-height:0; }
.card > .pb{
  flex:1; min-height:0; overflow:auto;
  scrollbar-width:none; -ms-overflow-style:none;
}
.card > .pb::-webkit-scrollbar{ width:0; height:0 }

/* 6) تهيئة لطيف 1366×768 */
@media (max-width: 1366px){
  :root{ --admin-maxw: 1400px; }
  .controls .small{ display:none; }  /* لإفساح المجال عند الضيق */
}
/* ===== [CASH-UI] highlight ===== */
.cash-row{
  border: 1px solid #ef4444 !important;   /* إطار أحمر */
}
.cash-price{
  color:#b91c1c; font-weight:800;         /* سعر أحمر ثقيل */
}

</style>
</head>
<body>

<!-- ========= Admin Auth Modal ========= -->
<div id="adminAuth" style="display:flex">
  <div class="box">
    <h3 style="margin:4px 0 10px">Admin Login</h3>
    <div class="grid">
      <input id="adEmail" class="input" type="email" placeholder="E-Mail">
      <input id="adPass"  class="input" type="password" placeholder="Passwort">
    </div>
    <button id="adLoginBtn" class="btn btn-cta" style="margin-top:8px;width:100%">Anmelden</button>
    <div id="adMsg" class="small" style="margin-top:6px;color:#fca5a5"></div>
  </div>
</div>

<!-- ========= App Shell ========= -->
<div class="app">
  <header class="bar">
    <div class="brand">
      <div data-i18n="brand.title">Taussil Admin</div>
      <div class="sub" data-i18n="brand.subtitle">Leitzentrale</div>
    </div>

    <div class="nav" id="nav">
  <button class="active" data-tab="dashboard" data-i18n="nav.dashboard">Dashboard</button>
  <button data-tab="restaurants" data-i18n="nav.restaurants">Restaurants</button>
  <button data-tab="drivers" data-i18n="nav.drivers">Fahrer</button>
  <button data-tab="fleets" data-i18n="nav.fleets">Fleets</button>
  <!-- + Fleet Ops (Bulk) -->
<button data-tab="fleetx" data-i18n="nav.fleetOps">Fleet Ops</button>
  <button data-tab="orders" data-i18n="nav.orders">Auftragsprotokoll</button>
  <button data-tab="map" data-i18n="nav.map">Karte</button>
</div>


    <div class="controls">
      <button id="btn-mute" class="icon" title="Mute/Unmute"><i data-lucide="volume-2"></i></button>
      <label for="lang" class="small" data-i18n="lang.label">Sprache / Language / اللغة</label>
      <select id="lang">
        <option value="de">DE</option><option value="en">EN</option><option value="ar">AR</option>
      </select>
      <!-- زر تسجيل الخروج هنا -->
      <button id="btn-logout" class="btn secondary" data-i18n="controls.logout">Abmelden</button>
    </div>
  </header>

  <div class="tabs">
    <!-- ===== Dashboard ===== -->
    <section id="tab-dashboard" class="tab">
      <div class="grid cols-3">
        <div class="card">
          <div class="ph">
            <div>
              <div style="font-weight:800" data-i18n="dashboard.incomingTitle">Eingehende Bestellungen</div>
              <div class="small" data-i18n="dashboard.incomingSub">Bestellungen in Bearbeitung</div>
            </div>
            <div class="badge"><span id="incoming-count">0</span></div>
          </div>
          <div class="pb table" id="incoming-list"></div>
        </div>

        <div class="card">
          <div class="ph"><div style="font-weight:800" data-i18n="dashboard.activeTitle">Laufende Lieferungen</div></div>
          <div class="pb table" id="active-list"></div>
        </div>

        <!-- Mini Map (يأخذ مكان بطاقة الإحصائيات) -->
        <div id="miniMapCard" class="card">
          <div class="ph">
            <div style="font-weight:800">Live-Karte (aktiver Auftrag)</div>
            <div class="small" id="mini-map-info">—</div>
          </div>
          <div class="pb">
  <div id="mini-map"></div>

  <!-- بطاقة الرحلة المصغرة -->
  <div id="mini-trip" class="trip-card" style="margin-top:10px">
    <div class="trip-grid">
      <div class="trip-main">
        <div class="trip-line">
          <span class="trip-label">Fahrer</span>
          <span id="miniTripDriver" class="trip-value">—</span>
        </div>
        <div class="trip-line">
          <span class="trip-label">Restaurant</span>
          <span id="miniTripRestaurant" class="trip-value">—</span>
        </div>
        <div class="trip-line">
          <span class="trip-label">Order</span>
          <span id="miniTripOrder" class="trip-value mono">—</span>
        </div>
      </div>

      <div class="trip-stats">
        <div class="chip mono" id="miniTripEta">ETA —:—</div>
        <div id="miniTripStatus" class="badge gray">—</div>
        <div class="chip" id="miniTripFee">Liefergebühr: —</div>
      </div>
    </div>
  </div>
</div>
    </section>

    <!-- ===== Restaurants ===== -->
    <section id="tab-restaurants" class="tab" hidden>
  <div id="rest-split" class="rest-split">
    <!-- اليسار: المعتمَدة -->
    <div class="rest-col">
      <div class="card">
        <div class="ph">
          <div style="font-weight:800">Approved Restaurants</div>
          <div class="badge" id="rest-appr-count">0</div>
        </div>
        <div class="pb">
          <div class="rest-filters">
            <input id="rest-appr-name" class="input" placeholder="Name…" />
            <input id="rest-appr-city" class="input" placeholder="City…" />
            <div class="row">
              <input id="rest-appr-from" type="date" class="input" />
              <input id="rest-appr-to"   type="date" class="input" />
            </div>
          </div>
          <div id="rest-approved-list" class="grid" style="grid-template-columns:1fr 1fr; gap:10px"></div>
        </div>
      </div>
    </div>

    <!-- مقبض السحب -->
    <div id="rest-sash" class="rest-sash" title="Drag to resize"></div>

    <!-- اليمين: قيد الاعتماد -->
    <div class="rest-col">
      <div class="card">
        <div class="ph">
          <div style="font-weight:800">Pending Approval</div>
          <div class="badge" id="rest-pend-count">0</div>
        </div>
        <div class="pb">
          <div class="rest-filters">
            <input id="rest-pend-name" class="input" placeholder="Name…" />
            <input id="rest-pend-city" class="input" placeholder="City…" />
            <div class="row">
              <input id="rest-pend-from" type="date" class="input" />
              <input id="rest-pend-to"   type="date" class="input" />
            </div>
          </div>
          <div id="rest-pending-list" class="grid" style="grid-template-columns:1fr; gap:10px"></div>
        </div>
      </div>
    </div>
  </div>
</section>


    <!-- ===== Drivers ===== -->
    <section id="tab-drivers" class="tab" hidden>
  <div id="drivers-cols">
    <!-- (يسار) جميع السائقين -->
    <div class="card col" id="drv-all-col">
      <div class="ph">
        <div style="font-weight:800" data-i18n="nav.drivers">Fahrer – Alle</div>
        <span class="badge gray"><span id="drv-all-count">0</span></span>
      </div>
      <div class="pb" id="drivers-all"></div>
    </div>

    <!-- (وسط) السائقون النشطون -->
    <div class="card col" id="drv-online-col">
      <div class="ph">
        <div style="font-weight:800">Online</div>
        <span class="badge green"><span id="drv-online-count">0</span></span>
      </div>
      <div class="pb" id="drivers-online"></div>
    </div>

    <!-- (يمين) طلبات سائقين جدد (بانتظار الموافقة) -->
    <div class="card col" id="drv-pending-col">
      <div class="ph">
        <div style="font-weight:800">Pending Drivers</div>
        <span class="badge gray"><span id="drv-pending-count">0</span></span>
      </div>
      <div class="pb" id="drivers-pending"></div>
    </div>
  </div>
</section>
<!-- ===== Fleets ===== -->
<section id="tab-fleets" class="tab" hidden>
  <div id="fleet-split" class="fleet-split">
    <!-- يسار: الأساطيل المعتمدة -->
    <div class="fleet-col">
      <div class="card" id="fleets-approved-wrap">
        <div class="ph">
          <div style="font-weight:800">Approved Fleets</div>
          <div class="badge" id="fleet-appr-count">0</div>
        </div>
        <div class="pb">
          <div class="fleet-filters">
            <input id="fleet-appr-name" class="input" placeholder="Name…" />
            <input id="fleet-appr-city" class="input" placeholder="City…" />
          </div>
          <div id="fleet-approved-list" class="grid" style="grid-template-columns:1fr; gap:10px"></div>
        </div>
      </div>
    </div>

    <!-- مقبض السحب -->
    <div id="fleet-sash" class="fleet-sash" title="Drag to resize"></div>

    <!-- يمين: الأساطيل قيد الاعتماد -->
    <div class="fleet-col">
      <div class="card" id="fleets-pending-wrap">
        <div class="ph">
          <div style="font-weight:800">Pending Fleets</div>
          <div class="badge" id="fleet-pend-count">0</div>
        </div>
        <div class="pb">
          <div class="fleet-filters">
            <input id="fleet-pend-name" class="input" placeholder="Name…" />
            <input id="fleet-pend-city" class="input" placeholder="City…" />
          </div>
          <div id="fleet-pending-list" class="grid" style="grid-template-columns:1fr; gap:10px"></div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- ===== Fleet Ops (Bulk Assign) ===== -->
<section id="tab-fleetx" class="tab" hidden>
  <div class="card">
    <div class="ph">
      <div style="font-weight:800" data-i18n="fleetx.title">إدارة الأساطيل – تجميع وإسناد</div>
      <div class="right row" style="gap:8px; flex-wrap: wrap">
        <input id="fleetx-city" class="input" style="height:36px" placeholder="City…" />
        <label class="small" style="display:flex;align-items:center;gap:6px">
          <input type="checkbox" id="fleetx-hide-assigned" checked>
          <span data-i18n="fleetx.filters.hideAssigned">إخفاء المعيّنة لأسطول</span>
        </label>
        <select id="fleetx-status" class="input" style="height:36px">
          <option value="Bearbeitung">Bearbeitung</option>
          <option value="Zugewiesen">Zugewiesen</option>
          <option value="Angenommen">Angenommen</option>
          <option value="Unterwegs">Unterwegs</option>
          <option value="Geliefert">Geliefert</option>
          <option value="Abgebrochen">Abgebrochen</option>
        </select>

        <span class="small" id="fleetx-selected" style="min-width:120px;text-align:center">0 selected</span>

        <select id="fleetx-fleet-select" class="input" style="height:36px; min-width:220px">
          <option value="">— Fleet —</option>
        </select>
        <button id="fleetx-assign"   class="btn"           data-i18n="fleetx.assign">إسناد المحدد</button>
        <button id="fleetx-unassign" class="btn secondary" data-i18n="fleetx.unassign">إلغاء الإسناد</button>
        <button id="fleetx-auto"     class="btn secondary" data-i18n="fleetx.autodist">توزيع ذكي</button>
      </div>
    </div>

    <div class="pb">
      <div id="fleetx-grid">
        <div class="fleetx-col">
          <div class="row" style="justify-content:space-between; margin-bottom:6px">
            <strong data-i18n="fleetx.orders">الطلبات</strong>
            <label class="small" style="display:flex;align-items:center;gap:6px">
              <input type="checkbox" id="fleetx-select-all">
              <span>Alle wählen</span>
            </label>
          </div>
          <div id="fleetx-orders" class="grid" style="gap:8px"></div>
        </div>

        <div class="fleetx-sash" title="Drag to resize"></div>

        <div class="fleetx-col">
          <div class="row" style="justify-content:space-between; margin-bottom:6px">
            <strong data-i18n="fleetx.fleets">الأساطيل</strong>
            <span class="badge" id="fleetx-fleet-count">0</span>
          </div>
          <div id="fleetx-fleets" class="grid" style="gap:8px"></div>
        </div>
      </div>
    </div>
  </div>
</section>

    <!-- ===== Orders Log ===== -->
    <section id="tab-orders" class="tab" hidden>
      <div class="card">
        <div class="ph">
          <div style="font-weight:800" data-i18n="nav.orders">Auftragsprotokoll</div>
          <input id="search" class="input" placeholder="Suche…" data-i18n-placeholder="search.placeholder" style="height:40px;border-radius:10px;border:1px solid rgba(0,0,0,.12)"/>
        </div>
        <div class="pb table" id="orders-log"></div>
      </div>
    </section>

    <!-- ===== Map ===== -->
    <section id="tab-map" class="tab" hidden>
      <div class="card">
        <div class="ph"><div style="font-weight:800" data-i18n="map.placeholder">Operationskarte</div></div>
        <div class="pb"><div id="gm"></div></div>
      </div>
    </section>
  </div>
</div>

<!-- ========= Order Details Modal ========= -->
<div id="order-modal" class="modal">
  <div class="box">
    <div class="row" style="justify-content:space-between">
      <strong data-i18n="order.details">Details</strong>
      <button id="order-close" class="btn secondary" data-i18n="common.close">Schließen</button>
    </div>
    <div id="order-details" style="margin-top:10px"></div>
  </div>
</div>

<!-- ========= User Details Modal ========= -->
<div id="user-modal" class="modal">
  <div class="box">
    <div class="row" style="justify-content:space-between">
      <strong id="user-title">Details</strong>
      <button id="user-close" class="btn secondary" data-i18n="common.close">Schließen</button>
    </div>
    <div id="user-details" style="margin-top:10px"></div>
  </div>
</div>

<!-- ========= Assign Sheet ========= -->
<div id="assign-sheet" class="modal right">
  <div class="box">
    <div style="font-weight:800;margin-bottom:8px" data-i18n="assign.title">Fahrer zuweisen</div>
    <div id="assign-order-box" class="small" style="margin-bottom:8px">—</div>
    <select id="assign-driver-select" style="width:100%;height:42px;border:1px solid #e5e7eb;border-radius:10px">
      <option value="">—</option>
    </select>
    <div class="row" style="justify-content:flex-end;margin-top:10px">
      <button id="assign-cancel" class="btn secondary" data-i18n="assign.cancel">Abbrechen</button>
      <button id="assign-confirm" class="btn" data-i18n="assign.confirm">Zuweisen</button>
    </div>
  </div>
</div>
<!-- ========= Export Modal ========= -->
<div id="export-modal" class="modal">
  <div class="box">
    <div class="row" style="justify-content:space-between">
      <strong>Export – Billing Report</strong>
      <button id="export-close" class="btn secondary">Schließen</button>
    </div>

    <div class="grid cols-2" style="margin-top:10px">
      <div>
        <div class="small">Restaurant</div>
        <select id="export-restaurant" style="width:100%;height:38px;border:1px solid #e5e7eb;border-radius:10px">
          <option value="">All</option>
        </select>
      </div>
	    <!-- [EXPORT] Driver filter -->
  <div style="grid-column:1">
    <div class="small">Driver</div>
    <select id="export-driver" style="width:100%;height:38px;border:1px solid #e5e7eb;border-radius:10px">
      <option value="">All</option>
    </select>
  </div>

      <div>
        <div class="small">Status</div>
        <select id="export-status" multiple size="6" style="width:100%;height:100%;border:1px solid #e5e7eb;border-radius:10px">
          <option>Bearbeitung</option>
          <option>Zugewiesen</option>
          <option>Angenommen</option>
          <option>Unterwegs</option>
          <option>Geliefert</option>
          <option>Abgebrochen</option>
        </select>
      </div>
      <div>
        <div class="small">From</div>
        <input id="export-from" type="date" style="width:100%;height:38px;border:1px solid #e5e7eb;border-radius:10px">
      </div>
      <div>
        <div class="small">To (inclusive)</div>
        <input id="export-to" type="date" style="width:100%;height:38px;border:1px solid #e5e7eb;border-radius:10px">
      </div>
    </div>
<!-- [CASH-EXPORT] خيار تصفية الكاش -->
<div style="grid-column: 1 / -1">
  <label class="small" style="display:flex;align-items:center;gap:6px">
    <input type="checkbox" id="export-cash-only">
    <span>Cash only</span>
  </label>
</div>

    <div style="margin-top:10px">
      <div class="small" style="margin-bottom:6px">Columns</div>
      <div id="export-cols" class="row" style="flex-wrap:wrap;gap:8px">
        <!-- يتم حقن الأعمدة افتراضيًا من JS -->
      </div>
    </div>

    <div class="row" style="justify-content:flex-end;margin-top:12px;gap:8px">
      <button id="export-run-csv" class="btn">⬇️ CSV</button>
      <button id="export-run-pdf" class="btn secondary">🖨️ PDF</button>
	  <!-- ضع هذا الزر بجانب أزرار CSV / PDF داخل المودال -->
<button id="export-run-xlsx" class="btn">📄 Excel</button>


    </div>
    <div id="export-msg" class="small" style="margin-top:8px;color:#6b7280"></div>
  </div>
</div>

<!-- ========= Sounds (ضع ملفاتك الفعلية هنا) ========= -->
<audio id="snd-restaurant" src="neu1.mp3" preload="auto"></audio>
<audio id="snd-driver"     src="neu1.mp3"   preload="auto"></audio>
<audio id="snd-order"      src="neu1.mp3"    preload="auto"></audio>
<audio id="snd-unterwegs"  src="neu1.mp3"   preload="auto"></audio>
<audio id="snd-geliefert"  src="neu1.mp3"   preload="auto"></audio>

<!-- Icons -->
<script src="https://unpkg.com/lucide@0.344.0/dist/umd/lucide.js"></script>

<script type="module">
/* ===== Firebase (align with driver & restaurant) ===== */
import { initializeApp, getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getAuth, onAuthStateChanged, signOut, signInWithEmailAndPassword,
  setPersistence, browserLocalPersistence
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import {
  getFirestore, collection, query, where, orderBy, limit, onSnapshot,
  doc, getDoc, setDoc, updateDoc, serverTimestamp, deleteDoc,
  getDocs, Timestamp
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

import {
  getDatabase, ref as rRef, onValue, update as rUpdate, set as rSet
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

// ===== Inline MapsCostGuard (no external import) =====
class MapsCostGuard{
  constructor(opts={}){
    this.map = opts.map || null;
    this.restPos = opts.restPos || null;
    this.geofenceMeters = Number(opts.geofenceMeters ?? 300);
    this.moveMinMeters  = Number(opts.moveMinMeters  ?? 500);
    this.throttleMs     = Number(opts.throttleMs     ?? 60000);
    this.bufferSec      = Number(opts.bufferSec      ?? 120);
    this.maxCalls       = Number(opts.maxCalls       ?? 30);

    this.onRoute     = opts.onRoute     || (()=>{});
    this.onCountdown = opts.onCountdown || (()=>{});
    this.onStop      = opts.onStop      || (()=>{});

    this._live = false;
    this._lastPos = null;
    this._lastCallAt = 0;
    this._callCount = 0;
    this._countdown = null;
    this._etaSec = 0;

    this._dirSvc = null;
    if(window.google?.maps) this._dirSvc = new google.maps.DirectionsService();
  }

  setLiveETA(flag){
    this._live = !!flag;
    if(!this._live){
      this._stopCountdown();
      this.onCountdown(null);
    }
  }

  set restPos(p){ this._restPos = p; }
  get restPos(){ return this._restPos; }

  onDriverPosition(pos){
    if(!this._live) return;
    if(!window.google?.maps) return;
    if(!this._dirSvc) this._dirSvc = new google.maps.DirectionsService();
    if(!this.restPos) return;

    // 1) geofence قرب المطعم
    if(this._distance(pos, this.restPos) <= this.geofenceMeters){
      this._stopCountdown();
      this.onStop({ reason:'geofenced' });
      return;
    }

    // 2) تحرّك كفاية عن آخر نقطة؟
    if(this._lastPos && this._distance(pos, this._lastPos) < this.moveMinMeters){
      // لا نعيد الطلب بلا داعٍ
      return;
    }

    // 3) ثروتل + سقف مكالمات
    const now = Date.now();
    if(now - this._lastCallAt < this.throttleMs) return;
    if(this._callCount >= this.maxCalls){
      this._stopCountdown();
      this.onStop({ reason:'maxcalls' });
      return;
    }

    // 4) اطلب Directions (السائق → المطعم)
    this._lastPos = pos;
    this._lastCallAt = now;
    this._callCount++;

    this._dirSvc.route({
      origin: pos,
      destination: this.restPos,
      travelMode: google.maps.TravelMode.DRIVING
    }, (res, status)=>{
      if(status!=='OK') return;
      const leg = res?.routes?.[0]?.legs?.[0];
      const distM = leg?.distance?.value ?? 0;
      const durS  = leg?.duration?.value ?? 0;

      // أبلغ الواجهة
      this.onRoute({ distanceMeters: distM, durationSec: durS, calls: this._callCount });

      // ابدأ عدّ تنازلي محلّي + بافر
      this._etaSec = Math.max(0, Number(durS) + this.bufferSec);
      this._startCountdown();
    });
  }

  // ===== helpers =====
  _distance(a,b){
    if(!window.google?.maps?.geometry?.spherical) return Infinity;
    const A = new google.maps.LatLng(a.lat, a.lng);
    const B = new google.maps.LatLng(b.lat, b.lng);
    return google.maps.geometry.spherical.computeDistanceBetween(A, B);
  }

  _startCountdown(){
    this._stopCountdown();
    this.onCountdown(this._etaSec);
    this._countdown = setInterval(()=>{
      this._etaSec = Math.max(0, this._etaSec - 1);
      this.onCountdown(this._etaSec);
      if(this._etaSec <= 0) this._stopCountdown();
    }, 1000);
  }

  _stopCountdown(){
    if(this._countdown){ clearInterval(this._countdown); this._countdown=null; }
  }
}
// ===== End Inline MapsCostGuard =====


const firebaseConfig = {
  apiKey: "AIzaSyD0g9T3amjuPodsLS6ZQkHYWrzV1UrX_QI",
  authDomain: "taussil-lieferservice-8bbe9.firebaseapp.com",
  projectId: "taussil-lieferservice-8bbe9",
  storageBucket: "taussil-lieferservice-8bbe9.firebasestorage.app",
  messagingSenderId: "583536892937",
  appId: "1:583536892937:web:5d5ff133de4d8b3b28ecd8",
  databaseURL: "https://taussil-lieferservice-8bbe9-default-rtdb.europe-west1.firebasedatabase.app"
};

let app; try{ app=getApp(); }catch{ app=initializeApp(firebaseConfig); }
const auth = getAuth(app);
const db   = getFirestore(app);
const rtdb = getDatabase(app);
await setPersistence(auth, browserLocalPersistence).catch(()=>{});

/* ===== i18n ===== */
const i18n = {
  de:{'brand.title':'Taussil Admin','brand.subtitle':'Leitzentrale',
      'nav.dashboard':'Dashboard','nav.restaurants':'Restaurants','nav.drivers':'Fahrer','nav.orders':'Auftragsprotokoll','nav.map':'Karte',
      'lang.label':'Sprache / Language / اللغة','controls.logout':'Abmelden',
      'dashboard.incomingTitle':'Eingehende Bestellungen','dashboard.incomingSub':'Bestellungen in Bearbeitung',
      'dashboard.activeTitle':'Laufende Lieferungen','dashboard.pieTitle':'Bestellstatus',
      'kpi.processing':'In Bearbeitung','kpi.cancelled':'Abgebrochen',
      'assign.title':'Fahrer zuweisen','assign.cancel':'Abbrechen','assign.confirm':'Zuweisen',
      'order.details':'Bestelldetails','common.close':'Schließen',
      'labels.restaurant':'Restaurant','labels.driver':'Fahrer','labels.platform':'Plattform','labels.pickup':'Abholzeit','labels.qty':'Menge','labels.price':'Preis','labels.code':'Code','labels.status':'Status','labels.distanceTotal':'Strecke gesamt (km)',
'labels.distanceBillable':'Abrechnungsstrecke (km)',
      'empty.noIncoming':'Derzeit keine neuen Bestellungen.','empty.noActive':'Aktuell keine aktiven Fahrten.','map.placeholder':'Operationskarte',
      'search.placeholder':'Suche… (Name, Telefon, Code)',
      // [TAUSSIL-APPROVAL-I18N-START]
      'approval.approve':'Genehmigen',
      'approval.reject':'Ablehnen', 'nav.fleets':'Flotten', 'nav.fleetOps':'Fleet Ops',
'fleetx.title':'Flotten – Sammelzuweisung',
'fleetx.filters.hideAssigned':'Bereits zugewiesene ausblenden',
'fleetx.assign':'Zuweisen',
'fleetx.unassign':'Zuweisung entfernen',
'fleetx.autodist':'Auto verteilen',
'fleetx.orders':'Bestellungen',
'fleetx.fleets':'Flotten',
'fleetx.emptyOrders':'Keine passenden Bestellungen.',
'fleetx.emptyFleets':'Keine genehmigten Flotten.','drivers.earningsToggle':'Einnahmen anzeigen',

      // [TAUSSIL-APPROVAL-I18N-END]
  },
  en:{'brand.title':'Taussil Admin','brand.subtitle':'Control Center',
      'nav.dashboard':'Dashboard','nav.restaurants':'Restaurants','nav.drivers':'Drivers','nav.orders':'Orders Log','nav.map':'Map',
      'lang.label':'Sprache / Language / اللغة','controls.logout':'Log out',
      'dashboard.incomingTitle':'Incoming Orders','dashboard.incomingSub':'Orders in processing',
      'dashboard.activeTitle':'Active Deliveries','dashboard.pieTitle':'Order Status',
      'kpi.processing':'Processing','kpi.cancelled':'Cancelled',
      'assign.title':'Assign Driver','assign.cancel':'Cancel','assign.confirm':'Confirm',
      'order.details':'Order Details','common.close':'Close',
      'labels.restaurant':'Restaurant','labels.driver':'Driver','labels.platform':'Platform','labels.pickup':'Pickup Time','labels.qty':'Quantity','labels.price':'Price','labels.code':'Code','labels.status':'Status', 'labels.distanceTotal':'Distance total (km)',
'labels.distanceBillable':'Billable distance (km)',
      'empty.noIncoming':'No new orders right now.','empty.noActive':'No active trips at the moment.','map.placeholder':'Operations map',
      'search.placeholder':'Search… (name, phone, code)',
      // [TAUSSIL-APPROVAL-I18N-START]
      'approval.approve':'Approve',
      'approval.reject':'Reject', 'nav.fleets':'Fleets', 'nav.fleetOps':'Fleet Ops',
'fleetx.title':'Fleets – Bulk Assignment',
'fleetx.filters.hideAssigned':'Hide already assigned',
'fleetx.assign':'Assign selected',
'fleetx.unassign':'Unassign',
'fleetx.autodist':'Auto-distribute',
'fleetx.orders':'Orders',
'fleetx.fleets':'Fleets',
'fleetx.emptyOrders':'No matching orders.',
'fleetx.emptyFleets':'No approved fleets.', 'drivers.earningsToggle':'Show earnings menu',

      // [TAUSSIL-APPROVAL-I18N-END]
  },
  ar:{'brand.title':'Taussil Admin','brand.subtitle':'لوحة التحكم',
      'nav.dashboard':'لوحة التحكم','nav.restaurants':'المطاعم','nav.drivers':'السائقون','nav.orders':'سجل الطلبات','nav.map':'الخريطة',
      'lang.label':'Sprache / Language / اللغة','controls.logout':'تسجيل الخروج',
      'dashboard.incomingTitle':'الطلبات الواردة','dashboard.incomingSub':'طلبات قيد المعالجة',
      'dashboard.activeTitle':'طلبات قيد التوصيل','dashboard.pieTitle':'حالة الطلبات',
      'kpi.processing':'قيد المعالجة','kpi.cancelled':'ملغي',
      'assign.title':'إسناد سائق','assign.cancel':'إلغاء','assign.confirm':'تأكيد الإسناد',
      'order.details':'تفاصيل الطلب','common.close':'إغلاق',
      'labels.restaurant':'المطعم','labels.driver':'السائق','labels.platform':'المنصة','labels.pickup':'وقت الاستلام','labels.qty':'الكمية','labels.price':'السعر','labels.code':'كود','labels.status':'الحالة', 'labels.distanceTotal':'المسافة الإجمالية (كم)',
'labels.distanceBillable':'المسافة القابلة للفوترة (كم)',
      'empty.noIncoming':'لا توجد طلبات جديدة حالياً.','empty.noActive':'لا توجد رحلات نشطة الآن.','map.placeholder':'خريطة العمليات',
      'search.placeholder':'بحث… (اسم، هاتف، كود)',
      // [TAUSSIL-APPROVAL-I18N-START]
      'approval.approve':'اعتماد',
      'approval.reject':'رفض', 'nav.fleets':'الأساطيل', 'nav.fleetOps':'إدارة الأساطيل',
'fleetx.title':'إدارة الأساطيل – تجميع وإسناد',
'fleetx.filters.hideAssigned':'إخفاء المعيّنة لأسطول',
'fleetx.assign':'إسناد المحدد',
'fleetx.unassign':'إلغاء الإسناد',
'fleetx.autodist':'توزيع ذكي',
'fleetx.orders':'الطلبات',
'fleetx.fleets':'الأساطيل',
'fleetx.emptyOrders':'لا توجد طلبات مطابقة.',
'fleetx.emptyFleets':'لا توجد أساطيل معتمدة.', 'drivers.earningsToggle':'إظهار أرباح السائق',
      // [TAUSSIL-APPROVAL-I18N-END]
  }
};
let currentLang='de';
const isRTL = (lng)=> lng==='ar';
function t(k){ const d=i18n[currentLang]||i18n.en; return d[k]||i18n.en[k]||k; }
function translatePage(){
  document.documentElement.lang=currentLang;
  document.documentElement.dir=isRTL(currentLang)?'rtl':'ltr';
  document.querySelectorAll('[data-i18n]').forEach(el=>{ el.textContent=t(el.getAttribute('data-i18n')); });
  document.querySelectorAll('[data-i18n-placeholder]').forEach(el=>{ el.setAttribute('placeholder', t(el.getAttribute('data-i18n-placeholder'))); });
  renderAll(); lucide.createIcons();
  ensureOrdersBulkUI();
  ensureExportBar(); // NEW
}

/* ===== State & helpers ===== */
const $ = (s)=>document.querySelector(s);
const platformChips = (arr)=> (Array.isArray(arr)?arr:[]).map(p=>`<span class="chip">${p}</span>`).join('');
function statusBadge(s){
  const map={ Bearbeitung:['gray','Bearbeitung'], Unterwegs:['blue','Unterwegs'], Geliefert:['green','Geliefert'], Abgebrochen:['rose','Abgebrochen'], Zugewiesen:['gray','Zugewiesen'], Angenommen:['blue','Angenommen'] };
  const [cls, label] = map[s] || ['gray', s||'-']; return `<span class="badge ${cls}">${label}</span>`;
}
const firstWord = (s)=> String(s||'').trim().split(/\s+/)[0]||'—';
const initialsOf = (nameOrEmail='')=>{
  const s = String(nameOrEmail||'').trim();
  if(!s) return 'D';
  const parts = s.split(/\s+/);
  if(parts.length===1){
    const p = parts[0].includes('@') ? parts[0].split('@')[0] : parts[0];
    return p.slice(0,2).toUpperCase();
  }
  return (parts[0][0] + (parts[1]?.[0]||'')).toUpperCase();
};
function getRestaurantDisplayName(rid){
  if(!rid) return 'All';
  const all = [...(restaurants||[]), ...(restaurantUsersApproved||[])];
  const row = all.find(r => r.id === rid);
  return row?.name || rid; // fallback لو ما انوجد
}

/* ===== Sounds (no 404, proper mute) ===== */
const sounds = {
  restaurant: $('#snd-restaurant'),
  driver:     $('#snd-driver'),
  order:      $('#snd-order'),
  unterwegs:  $('#snd-unterwegs'),
  geliefert:  $('#snd-geliefert'),
};
const SOUND_FILES = {
  restaurant: 'new_restaurant_request.mp3',
  driver:     'new_driver_request.mp3',
  order:      'new_order_received.mp3',
  unterwegs:  'status_to_unterwegs.mp3',
  geliefert:  'status_to_geliefert.mp3',
};
Object.entries(sounds).forEach(([k,a])=>{
  if(!a) return;
  if(!a.getAttribute('src')){ a.setAttribute('src', `./sounds/${SOUND_FILES[k]}`); }
  a.setAttribute('preload','auto');
});
let isMuted=false;
const LS_MUTE_KEY='admin:muted';
function playSound(key){ if(isMuted) return; const a=sounds[key]; if(!a) return; try{ a.currentTime=0; a.play().catch(()=>{});}catch(_){ } }
function setMuted(v){
  isMuted = !!v;
  try{ localStorage.setItem(LS_MUTE_KEY, isMuted?'1':'0'); }catch(_){}
  Object.values(sounds).forEach(a=>{ if(a){ a.muted = v; }});
  $('#btn-mute i')?.setAttribute('data-lucide', v?'volume-x':'volume-2');
  lucide.createIcons();
}
try{ setMuted(localStorage.getItem(LS_MUTE_KEY)==='1'); }catch(_){}

const ordersMap = new Map();
let orders=[], restaurants=[], drivers=[];
let fleetsApproved = [];
let unsubFleetsApproved = null;

/* NEW: source buffers + users listener */
let __fleets_from_docs = [];
let __fleets_from_users = [];
let unsubFleetsUsersApproved = null;

function normalizeFleetRow(id, x={}){
  const company = x.company || {};
  const addr    = x.address || {};
  const status  = String(x.status || '').toLowerCase();
  const approvedLike = (x.approved === true) || ['active','approved','enabled'].includes(status);
  if(!approvedLike) return null;

  return {
    id,
    name:  company.name || x.name || x.email || id,
    owner: [company.ownerFirst||'', company.ownerLast||''].join(' ').trim(),
    email: x.email || company.email || '',
    phone: company.phone || '',
    city:  addr.city || x.targetCity || x.city || '',
    driversCount: Number(x.driversCount || 0)
  };
}

function recomputeFleetsApproved(){
  const map = new Map();
  [...__fleets_from_docs, ...__fleets_from_users].forEach(r=>{
    if(!r) return;
    if(!map.has(r.id)) map.set(r.id, r);
  });
  fleetsApproved = Array.from(map.values());
  renderFleets?.();
}


/* [TAUSSIL-REST-APPROVED-STATE] */
let restaurantUsersApproved = []; // from users(role=restaurant, approved=true)

let presenceMap = {}; // uid -> true/false
const driverInfoById = new Map(); // id -> {firstName, fullName, phone}

/* ===== Map (big) ===== */
const GMAPS_API_KEY = 'AIzaSyDipzUmxEQmAjaDkn6xQ91ZhqnkPmgl-2o';
let gmap=null; const driverMarkers = new Map(); // uid -> google.maps.Marker
let mapControlsReady=false;
const MAP_STYLES = {
  mono: [{elementType:'geometry',stylers:[{saturation:-100},{lightness:10}]},{elementType:'labels.text.fill',stylers:[{color:'#4b4b4b'}]},{featureType:'road',stylers:[{saturation:-100},{lightness:30}]}],
};
function loadGmaps(){
  if(window.google?.maps) return Promise.resolve();
  return new Promise((resolve,reject)=>{
    const cb='gm_cb_'+Math.random().toString(36).slice(2);
    window[cb]=()=>{ delete window[cb]; resolve(); };
    const s=document.createElement('script');
    s.src=`https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(GMAPS_API_KEY)}&v=weekly&libraries=geometry&callback=${cb}`;

    s.async=true; s.defer=true; s.onerror=()=>{ delete window[cb]; reject(); };
    document.head.appendChild(s);
  });
}
function applyBigMapStyle(mode){
  if(!gmap || !window.google?.maps) return;
  if(mode==='satellite'){ gmap.setMapTypeId(google.maps.MapTypeId.SATELLITE); gmap.setOptions({styles:null}); }
  else if(mode==='mono'){ gmap.setMapTypeId(google.maps.MapTypeId.ROADMAP); gmap.setOptions({styles:MAP_STYLES.mono}); }
  else { gmap.setMapTypeId(google.maps.MapTypeId.ROADMAP); gmap.setOptions({styles:null}); }
}
function makeControlButton(text){
  const btn=document.createElement('button');
  btn.textContent=text;
  btn.className='gm-btn';
  btn.style.cssText='margin:8px;padding:6px 10px;border:1px solid #e5e7eb;border-radius:10px;background:#fff;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,.08);font:500 13px system-ui';
  return btn;
}
function ensureMapControls(){
  if(mapControlsReady || !gmap || !window.google?.maps) return;
  mapControlsReady=true;

  const focusBtn = makeControlButton('👀 Fahrer Online');
  focusBtn.onclick = ()=> fitOnlineDrivers();
  gmap.controls[google.maps.ControlPosition.TOP_LEFT].push(focusBtn);

  const wrap=document.createElement('div');
  wrap.style.cssText='margin:8px';
  const sel=document.createElement('select');
  sel.innerHTML = `<option value="std">Standard</option><option value="mono">Mono</option><option value="satellite">Satellite</option>`;
  sel.style.cssText='padding:6px 8px;border:1px solid #e5e7eb;border-radius:10px;background:#fff;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,.08);font:500 13px system-ui';
  sel.onchange=()=> applyBigMapStyle(sel.value);
  wrap.appendChild(sel);
  gmap.controls[google.maps.ControlPosition.TOP_RIGHT].push(wrap);
}
function driverMarkerIcon(isOnline){
  return {
    path: google.maps.SymbolPath.CIRCLE,
    fillColor: isOnline? '#16a34a' : '#9ca3af',
    fillOpacity: 0.95, strokeWeight:0, scale:12
  };
}
function updateMarkerLabel(mk, uid){
  const info = driverInfoById.get(uid) || {};
  const label = initialsOf(info.fullName || info.firstName || info.email || 'D');
  mk.setLabel({ text: label, color:'#fff', fontWeight:'700' });
  mk.setTitle(info.fullName || info.firstName || 'Driver');
}

/* ===== Assign panel on map (InfoWindow anchored to marker) ===== */
let assignInfoWindow = null;
async function assignDriverToOrderFromMap(orderId, driverId){
  const d = drivers.find(x=>x.id===driverId);
  if(!d) return;
  try{
    await updateDoc(doc(db,'orders', orderId), {
      driver:{ id:d.id, fullName:d.fullName||null, phone:d.phone||null, avatarUrl:d.avatarUrl||null },
      status:'Zugewiesen', updatedAt: serverTimestamp()
    }).catch(async ()=>{
      await setDoc(doc(db,'orders', orderId), {
        driver:{ id:d.id, fullName:d.fullName||null, phone:d.phone||null, avatarUrl:d.avatarUrl||null },
        status:'Zugewiesen', updatedAt: serverTimestamp()
      }, {merge:true});
    });
    await rUpdate(rRef(rtdb,`drivers_inbox/${d.id}`), { lastOrderAssigned: orderId, ts: Date.now() }).catch(()=>{});
    playSound('driver');    // مزامنة اسم/هاتف السائق إلى جميع الستوبز
    await propagateDriverToStops(orderId, { fullName: d.fullName, phone: d.phone });

  }catch(_){}
}
function openMapAssignPanel(driverId){
  if(!gmap || !window.google?.maps) return;
  const mk = driverMarkers.get(driverId);
  if(!mk) return;

  const incoming = orders.filter(o=> String(o.status||'').toLowerCase()==='bearbeitung');

  const wrap = document.createElement('div');
  wrap.style.cssText='min-width:280px;max-width:360px;font:14px system-ui;line-height:1.4';
  wrap.innerHTML = `
    <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:8px">
      <div style="font-weight:800">${t('assign.title')}</div>
      <button data-close style="border:0;background:#fff;cursor:pointer;font-size:16px;line-height:1">×</button>
    </div>
    <div class="small" style="margin-bottom:6px;opacity:.8">${(drivers.find(d=>d.id===driverId)?.fullName || 'Driver')}</div>
    <div id="assign-list"></div>
  `;
  const list = wrap.querySelector('#assign-list');
  if(incoming.length===0){
    list.innerHTML = `<div class="small" style="opacity:.8">${t('empty.noIncoming')}</div>`;
  }else{
    list.innerHTML = incoming.map(o=>{
      const plat = Array.isArray(o.platform)? o.platform.join(' / ') : (o.platform||'—');
      const rid  = (o.nr!=null? `#${o.nr}` : (o.shortCode||o.id||'—'));
      return `
        <div class="tr" style="display:flex;align-items:center;gap:8px;border:1px solid #e5e7eb;border-radius:10px;padding:8px;margin-bottom:8px">
          <div class="mono" style="min-width:82px">${rid}</div>
          <div style="flex:1">
            <div style="font-weight:700">${o.restaurant?.name||'-'}</div>
            <div class="small" style="opacity:.8">${plat}</div>
          </div>
          <button class="btn" data-assign="${o.id}" style="height:34px">${t('assign.confirm')}</button>
        </div>`;
    }).join('');
  }
  wrap.querySelector('[data-close]')?.addEventListener('click', ()=> assignInfoWindow?.close());
  wrap.querySelectorAll('[data-assign]')?.forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const oid = btn.getAttribute('data-assign');
      await assignDriverToOrderFromMap(oid, driverId);
      assignInfoWindow?.close();
    });
  });

  if(!assignInfoWindow){
    assignInfoWindow = new google.maps.InfoWindow({ maxWidth: 360, disableAutoPan: false });
  }
  assignInfoWindow.setContent(wrap);
  assignInfoWindow.open({ map: gmap, anchor: mk });
}

function fitOnlineDrivers(){
  if(!gmap || driverMarkers.size===0) return;
  const b = new google.maps.LatLngBounds();
  let any=false;
  driverMarkers.forEach((mk, uid)=>{
    if(presenceMap[uid]){
      const p = mk.getPosition(); if(!p) return;
      b.extend(p); any=true;
    }
  });
  if(any) gmap.fitBounds(b, {top:40,bottom:40,left:40,right:40});
}

async function initMap(){
  await loadGmaps().catch(()=>{});
  if(!window.google?.maps) return;
  const el = $('#gm'); if(!el) return;
  if(!gmap){
    gmap = new google.maps.Map(el, {center:{lat:54.3233,lng:10.1228}, zoom:12}); // Kiel-ish default
    ensureMapControls();
  }
  onValue(rRef(rtdb,'drivers_locations'), (snap)=>{
    const v=snap.val()||{};
    const still = new Set(Object.keys(v));
    driverMarkers.forEach((mk, uid)=>{ if(!still.has(uid)){ mk.setMap(null); driverMarkers.delete(uid); } });

    Object.entries(v).forEach(([uid,obj])=>{
      const {lat,lng}=obj||{}; if(!Number.isFinite(lat)||!Number.isFinite(lng)) return;
      let mk = driverMarkers.get(uid);
      const online = !!presenceMap[uid];
      if(!mk){
        mk = new google.maps.Marker({
          map:gmap,
          position:{lat,lng},
          icon: driverMarkerIcon(online),
          label: { text:'D', color:'#fff', fontWeight:'700' }
        });
        mk.addListener('click', ()=>{ openMapAssignPanel(uid); });
        driverMarkers.set(uid,mk);
      }else{
        mk.setPosition({lat,lng});
      }
      mk.setIcon(driverMarkerIcon(online));
      updateMarkerLabel(mk, uid);
    });
  });
}

/* ===== Mini Map (Dashboard) + Trip Card ===== */
let miniMap=null, miniDirService=null, miniDirRenderer=null;
let miniGuard = null;
let miniLastDriverPos = null;
let miniLastDrawnEtaSec = 0;

let miniDriverMarker=null, miniRestMarker=null, miniCustMarker=null;
let miniDrvUnsub=null, miniOrderUnsub=null;
let miniTrackedOrderId=null, miniTrackedDriverId=null;

let miniEtaSec=0, miniEtaUpdatedAt=0, miniTripTimer=null;

const miniInfo     = document.getElementById('mini-map-info');
const elTripDriver = document.getElementById('miniTripDriver');
const elTripRest   = document.getElementById('miniTripRestaurant');
const elTripOrder  = document.getElementById('miniTripOrder');
const elTripEta    = document.getElementById('miniTripEta');
const elTripStatus = document.getElementById('miniTripStatus');
const elTripFee    = document.getElementById('miniTripFee');

let miniOrder=null;
// === Cost guard binding for Mini Map ===






async function initMiniMap(){
  await loadGmaps().catch(()=>{});
  const el = document.getElementById('mini-map');
  if(!el || !window.google?.maps) return;
  if(!miniMap){
    miniMap = new google.maps.Map(el, {center:{lat:54.3233,lng:10.1228}, zoom:12, disableDefaultUI:false});
    miniDirService  = new google.maps.DirectionsService();
    miniDirRenderer = new google.maps.DirectionsRenderer({ map: miniMap, suppressMarkers:true, polylineOptions:{ strokeOpacity:.95, strokeWeight:5 } });
  }
 

}
function setMiniInfo(txt){ if(miniInfo) miniInfo.textContent = txt || '—'; }
function euro(v){ const n=Number(v); return Number.isFinite(n)? n.toFixed(2)+' €' : '—'; }
function fmtMMSS(sec){ const s=Math.max(0,Math.round(sec)); const m=Math.floor(s/60), r=s%60; return `${m}:${String(r).padStart(2,'0')}`; }
function stopMiniCountdown(){ if(miniTripTimer){ clearInterval(miniTripTimer); miniTripTimer=null; } }
function startMiniCountdown(){
  stopMiniCountdown();
  miniTripTimer = setInterval(()=>{
    if(!miniEtaSec||!miniEtaUpdatedAt){ if(elTripEta) elTripEta.textContent='ETA —:—'; return; }
    const remain = Math.max(0, miniEtaSec - (Date.now()-miniEtaUpdatedAt)/1000);
    if(elTripEta) elTripEta.textContent = 'ETA ' + fmtMMSS(remain);
    if(remain<=0) stopMiniCountdown();
  },1000);
}
function clearMiniMap(){
  try{ miniDrvUnsub?.(); }catch(_){}
  try{ miniOrderUnsub?.(); }catch(_){}
  miniDrvUnsub = miniOrderUnsub = null;

  // أوقف ETA المحلي + الحارس
  stopMiniCountdown();
  try{ miniGuard?.setLiveETA(false); }catch(_){}

  // امسح الـ Directions
  try{ miniDirRenderer?.setDirections({routes:[]}); }catch(_){}

  // فكّ كل الماركرز
  try{ miniDriverMarker?.setMap(null); }catch(_){}
  try{ miniRestMarker?.setMap(null); }catch(_){}
  try{ miniCustMarker?.setMap(null); }catch(_){}
  miniDriverMarker = miniRestMarker = miniCustMarker = null;

  // صفّر الحالة الظاهرة
  setMiniInfo('—');
  if(elTripEta)    elTripEta.textContent = 'ETA —:—';
  if(elTripDriver) elTripDriver.textContent = '—';
  if(elTripRest)   elTripRest.textContent = '—';
  if(elTripOrder)  elTripOrder.textContent = '—';
  if(elTripStatus){ elTripStatus.className='badge gray'; elTripStatus.textContent='—'; }
  if(elTripFee)    elTripFee.textContent = 'Liefergebühr: —';

  miniOrder = null;
  miniTrackedOrderId = miniTrackedDriverId = null;
  miniLastDriverPos = null;
  miniLastDrawnEtaSec = 0;
  miniEtaSec = 0;
  miniEtaUpdatedAt = 0;
}

function readFee(o){
  return o?.serviceFee
      ?? o?.deliveryFee
      ?? o?.fee
      ?? o?.delivery_fee
      ?? o?.liefergebuehr
      ?? o?.lieferGebuehr
      ?? 0;
}

/* ===== Distance & Fees helpers (safe) ===== */
function readServiceFee(o){
  try { return readFee(o); } catch { return 0; }
}
function readDistanceKm(o){
  if(!o || typeof o !== 'object') return 0;
  let v =
    o.distanceKm ?? o.distance_km ?? o.km ?? o.distance ??
    o.route?.distanceKm ?? o.route?.distance_km ?? o.route?.km ?? o.route?.distance ??
    o.meta?.distanceKm ?? o.meta?.km ?? o.meta?.distance;
  if (!Number.isFinite(v)) {
    const meters =
      o.route?.leg?.distance?.value ??
      o.route?.distance?.meters ??
      o.distance_m ?? o.distanceMeters;
    if (Number.isFinite(meters)) v = meters / 1000;
  }
  v = Number(v);
  return Number.isFinite(v) ? v : 0;
}
function readDistanceFee(o){
  if(!o || typeof o !== 'object') return 0;
  const v =
    o.distanceFee ?? o.distFee ?? o.route?.distanceFee ??
    o.pricing?.distanceFee ?? o.meta?.distanceFee;
  const n = Number(v);
  return Number.isFinite(n) ? n : 0;
}


function renderMiniTrip(o){
  if(!o){
    elTripDriver && (elTripDriver.textContent='—');
    elTripRest   && (elTripRest.textContent='—');
    elTripOrder  && (elTripOrder.textContent='—');
    elTripEta    && (elTripEta.textContent='ETA —:—');
    if(elTripStatus){ elTripStatus.className='badge gray'; elTripStatus.textContent='—'; }
    elTripFee && (elTripFee.textContent='Liefergebühr: —');
    return;
  }
  elTripDriver && (elTripDriver.textContent = o?.driver?.fullName || '—');
  elTripRest   && (elTripRest.textContent   = o?.restaurant?.name || '—');
  elTripOrder  && (elTripOrder.textContent  = (o.nr!=null? ('#'+o.nr) : (o.shortCode? ('#'+o.shortCode) : ('#'+(o.id||'—')))));
  if(elTripStatus){
    try{ elTripStatus.innerHTML = (typeof statusBadge==='function')? statusBadge(o?.status||'-') : (o?.status||'-'); }
    catch{ elTripStatus.textContent = o?.status||'-'; }
  }
  elTripFee && (elTripFee.textContent = 'Liefergebühr: ' + euro(readFee(o)));
}
function ensureMarker(map, marker, label){
  if(!marker) marker = new google.maps.Marker({ map, label });
  else marker.setMap(map);
  return marker;
}
function fitBoundsTo(...pos){
  const b = new google.maps.LatLngBounds();
  pos.filter(Boolean).forEach(p=> b.extend(new google.maps.LatLng(p.lat, p.lng)));
  if(!b.isEmpty()) miniMap.fitBounds(b, {top:40,bottom:40,left:40,right:40});
}
function drawMiniRoute(origin, dest){
  if(!origin || !dest || !miniDirService) return;
  miniDirService.route({ origin, destination: dest, travelMode: google.maps.TravelMode.DRIVING },
    (res, status)=>{
      if(status!=='OK') return;
      miniDirRenderer.setDirections(res);
      const leg = res.routes?.[0]?.legs?.[0];
      if(leg){
        const km  = (leg.distance?.value||0)/1000;
        const min = Math.round((leg.duration?.value||0)/60);
        setMiniInfo(`${km.toFixed(2)} km • ETA ${min} min`);
        miniEtaSec       = Math.max(0, Number(leg.duration?.value||0));
        miniEtaUpdatedAt = Date.now();
        startMiniCountdown();
        renderMiniTrip(miniOrder);
      }
    });
}
const miniGeocodeCache = new Map();
async function geocodeAddress(addr){
  if(!addr || !window.google?.maps) return null;
  if(miniGeocodeCache.has(addr)) return miniGeocodeCache.get(addr);
  return new Promise((resolve)=>{
    const g = new google.maps.Geocoder();
    g.geocode({address: addr}, (res,status)=>{
      if(status==='OK' && res[0]){
        const p=res[0].geometry.location; const out={lat:p.lat(),lng:p.lng()};
        miniGeocodeCache.set(addr,out); resolve(out);
      }else resolve(null);
    });
  });
}
async function openMiniMapForOrder(o){
  await initMiniMap(); if(!miniMap) return;

clearMiniMap();

  miniOrder = o||null;
  miniTrackedOrderId  = o?.id || null;
  miniTrackedDriverId = o?.driver?.id || null;
  renderMiniTrip(miniOrder);

  const restAddr = o?.restaurant?.address_text || o?.restaurant?.addressText || '';
  const restPos  = await geocodeAddress(restAddr);

  // فعّل/حدّث الحارس
  if (!miniGuard) {
    miniGuard = new MapsCostGuard({
      geofenceMeters: 300,
      moveMinMeters: 400,
      throttleMs: 60_000,      // مرّة/دقيقة
      bufferSec: 120,          // دقيقتان بافر
      maxCalls: 40,            // سقف آمن
      onRoute: ({ distanceMeters, durationSec }) => {
        // حدّث ETA المحلي
        miniEtaSec = Math.max(0, Number(durationSec) + 120);
        miniEtaUpdatedAt = Date.now();
        startMiniCountdown();
        setMiniInfo(`${(distanceMeters/1000).toFixed(2)} km • ETA ${(durationSec/60|0)} min`);

        // ارسم المسار فقط إذا تغيّر الـ ETA بشكل ملحوظ
        if (Math.abs(durationSec - miniLastDrawnEtaSec) >= 60 && miniLastDriverPos && restPos) {
          miniLastDrawnEtaSec = durationSec;
          drawMiniRoute(miniLastDriverPos, restPos);
        }
      },
      onCountdown: (sec) => { if (elTripEta) elTripEta.textContent = 'ETA ' + fmtMMSS(sec ?? 0); },
      onStop: ({ reason }) => {
        setMiniInfo(reason === 'geofenced' ? 'Driver at restaurant' : 'ETA paused');
        stopMiniCountdown();
      }
    });
  }
  miniGuard.restPos = restPos;
  miniGuard.setLiveETA(true);

  const dropPos = o?.dropoffPos || o?.to || o?.customer?.pos || null;

  // markers
  if(restPos){
    miniRestMarker = ensureMarker(miniMap, miniRestMarker, 'R');
    miniRestMarker.setPosition(restPos);
  }else if(miniRestMarker){ miniRestMarker.setMap(null); }

  if(dropPos && Number.isFinite(dropPos.lat) && Number.isFinite(dropPos.lng)){
    miniCustMarker = ensureMarker(miniMap, miniCustMarker, 'C');
    miniCustMarker.setPosition(dropPos);
  }else if(miniCustMarker){ miniCustMarker.setMap(null); }

  // تتبّع موقع السائق
  if(miniTrackedDriverId){
    const ref = rRef(rtdb, `drivers_locations/${miniTrackedDriverId}`);
    miniDrvUnsub = onValue(ref, (snap)=>{
      const v=snap.val()||{}; const lat=Number(v.lat), lng=Number(v.lng);
      if(Number.isFinite(lat)&&Number.isFinite(lng)){
        const dPos={lat,lng};
        miniDriverMarker = ensureMarker(miniMap, miniDriverMarker, 'D');
        miniDriverMarker.setPosition(dPos);

        // مرّر الموقع للحارس (هو يتكفّل بطلب Directions بثروتل)
        miniLastDriverPos = dPos;
        miniGuard?.onDriverPosition(dPos);

        const bounds = new google.maps.LatLngBounds();
        bounds.extend(new google.maps.LatLng(dPos.lat, dPos.lng));
        if(restPos) bounds.extend(new google.maps.LatLng(restPos.lat, restPos.lng));
        if(miniCustMarker){
          const p=miniCustMarker.getPosition().toJSON();
          bounds.extend(new google.maps.LatLng(p.lat, p.lng));
        }
        if(!bounds.isEmpty()) miniMap.fitBounds(bounds, {top:40,bottom:40,left:40,right:40});
      }
    });

  }else{
    setMiniInfo('—');
    if(restPos) fitBoundsTo(restPos, miniCustMarker? miniCustMarker.getPosition().toJSON(): null);
  }

  // راقب تغيّر وثيقة الطلب
  if(miniTrackedOrderId){
    miniOrderUnsub = onSnapshot(doc(db,'orders', miniTrackedOrderId), (ds)=>{
      if(!ds.exists()) return;
      miniOrder = { id: ds.id, ...ds.data() };
      renderMiniTrip(miniOrder);

      // إذا تغيّر السائق، أعد توصيل مستمع الموقع
      const newDid = miniOrder?.driver?.id || null;
      if(newDid && newDid !== miniTrackedDriverId){
        miniTrackedDriverId = newDid;
        try{ miniDrvUnsub?.(); }catch(_){}
        const ref = rRef(rtdb, `drivers_locations/${miniTrackedDriverId}`);
        miniDrvUnsub = onValue(ref, (snap)=>{
          const v=snap.val()||{}; const lat=Number(v.lat), lng=Number(v.lng);
          if(Number.isFinite(lat)&&Number.isFinite(lng)){
            const dPos={lat,lng};
            miniDriverMarker = ensureMarker(miniMap, miniDriverMarker, 'D');
            miniDriverMarker.setPosition(dPos);
            miniLastDriverPos = dPos;
            miniGuard?.onDriverPosition(dPos);
          }
        });
      }

      // أوقف الحارس عند انتهاء/إلغاء الرحلة
      const st = String(miniOrder?.status||'').toLowerCase();
     if(st==='geliefert' || st==='abgebrochen'){
   clearMiniMap();
 }
    });
  }
}

function bindMiniMapRowClicks(){
  const wrap = document.getElementById('active-list');
  if(!wrap) return;
  wrap.querySelectorAll('[data-mini-map]').forEach(tr=>{
    tr.style.cursor='pointer';
    tr.addEventListener('click',(ev)=>{
      if(ev.target.closest('button,select')) return;
      const id = tr.getAttribute('data-mini-map');
      const o = orders.find(x=>x.id===id);
      if(o) openMiniMapForOrder(o);
    });
  });
}

/* ===== Rendering ===== */
function renderDashboard(){
  const incoming = orders.filter(o=>(o.status||'').toLowerCase()==='bearbeitung');
  const active   = orders.filter(o=>['unterwegs','angenommen','zugewiesen','assigned'].includes(String(o.status||'').toLowerCase()));

  const ic = document.getElementById('incoming-count'); if (ic) ic.textContent = incoming.length;

  const incWrap = $('#incoming-list');
  if(incWrap){
    incWrap.innerHTML = incoming.map(o=>`
      <div class="tr ${isCashOrder(o)?'cash-row':''}">

        <!-- Restaurant -->
        <div class="flex">
          <img class="logo" src="${o.restaurant?.logoUrl||''}"/>
          <div>
            <div style="font-weight:700">${o.restaurant?.name||'-'}</div>
            <div class="small">${o.restaurant?.phone||''}</div>
          </div>
        </div>

        <!-- Platform -->
        <div class="order-platform">${platformChips(o.platform)}</div>

        <!-- Qty -->
        <div class="order-qty mono">x${Number(o.qty||0)}</div>

        <!-- Price -->
        <div class="order-price ${isCashOrder(o)?'cash-price':''}">
  ${Number.isFinite(Number(o.price))? Number(o.price).toFixed(2)+' €':'—'}
</div>


        <!-- Pickup -->
        <div class="order-pickup"><i data-lucide="clock"></i> ${o.pickupTime||'—'}</div>

        <!-- Actions -->
        <div class="row-actions">
          <label style="display:flex;align-items:center;gap:6px">
            <input type="checkbox" class="order-select" data-id="${o.id}"><span class="small">Select</span>
          </label>
          <button class="btn secondary" data-order-details="${o.id}" data-i18n="order.details">${t('order.details')}</button>
          <button class="btn" data-assign="${o.id}" data-i18n="assign.confirm">${t('assign.confirm')}</button>
        </div>
      </div>`).join('') || `<div class="small">${t('empty.noIncoming')}</div>`;
  }

  const aWrap = $('#active-list');
  if(aWrap){
    aWrap.innerHTML = active.map(o=>`
      <div class="tr ${isCashOrder(o)?'cash-row':''}" data-mini-map="${o.id}">

        <!-- Driver -->
        <div class="flex">
          ${o.driver?.avatarUrl? `<img class="avatar" src="${o.driver.avatarUrl}">`:`<div class="avatar"></div>`}
          <div>
            <div style="font-weight:700">${o.driver?.fullName||'-'}</div>
            <div class="sub">${o.driver?.phone||'—'}</div>
          </div>
        </div>

        <!-- Status -->
        <div>${statusBadge(o.status)}</div>

        <!-- Actions -->
        <div class="row-actions">
          <label style="display:flex;align-items:center;gap:6px">
            <input type="checkbox" class="order-select" data-id="${o.id}"><span class="small">Select</span>
          </label>
          <button class="btn secondary" data-order-details="${o.id}">${t('order.details')}</button>
          <div class="dropdown">
            <select data-update-status="${o.id}">
              <option value="">${t('labels.status')}…</option>
              <option value="Unterwegs">Unterwegs</option>
              <option value="Geliefert">Geliefert</option>
              <option value="Abgebrochen">Abgebrochen</option>
            </select>
          </div>
        </div>
      </div>
    `).join('') || `<div class="sub">${t('empty.noActive')}</div>`;
  }

  attachRowHandlers();
  bindMiniMapRowClicks();
  bindOrderSelectionHandlers();
  ensureExportBar(); // كما هو
}

/* ===== [TAUSSIL-REST-APPROVED-RENDER-START] ===== */
function renderRestaurants(){
  const wrap = document.getElementById('rest-approved-list');
  const cnt  = document.getElementById('rest-appr-count');
  if(!wrap || !cnt) return;

  // دمج مصدرين: restaurants (collection) + restaurantUsersApproved (users approved= true)
  const base = Array.isArray(restaurants) ? restaurants : [];
  const extras = (restaurantUsersApproved||[]).map(u=>({
    id: u.id,
    name: u.name || u.id,
    phone: u.phone || '',
    address: u.address || '',
    logoUrl: u.logoUrl || '',
    createdAt: u.createdAt || u.approvedAt || null
  }));

  // استخدم الخريطة لمنع التكرار
  const byId = new Map(base.map(r => [r.id, r]));
  const merged = base.concat(extras.filter(x => !byId.has(x.id)));

  // فلاتر اليسار
  const fName = (document.getElementById('rest-appr-name')?.value||'').trim().toLowerCase();
  const fCity = (document.getElementById('rest-appr-city')?.value||'').trim().toLowerCase();
  const fFrom = document.getElementById('rest-appr-from')?.value || '';
  const fTo   = document.getElementById('rest-appr-to')?.value   || '';

  const fromD = fFrom ? new Date(fFrom) : null;
  const toD   = fTo   ? new Date(fTo+'T23:59:59') : null;

  const getCity = (row)=>{
    const txt = row.address || '';
    // محاولة بسيطة لاستخراج المدينة من نص العنوان
    const parts = String(txt).split(',').map(s=>s.trim());
    return (parts[parts.length-1] || '').toLowerCase();
  };
  const getCreatedTs = (row)=>{
    const ts = row.createdAt || null;
    if(!ts) return null;
    return ts.toDate ? ts.toDate() : (ts instanceof Date ? ts : null);
  };

  let rows = merged.filter(r=>{
    const nm = String(r.name||'').toLowerCase();
    const city = getCity(r);
    const inName = !fName || nm.includes(fName);
    const inCity = !fCity || city.includes(fCity);

    const ct = getCreatedTs(r);
    const inDate = (!fromD && !toD) ||
                   (!ct ? true :
                     ((!fromD || ct>=fromD) && (!toD || ct<=toD)));

    return inName && inCity && inDate;
  });

  cnt.textContent = rows.length;

  wrap.innerHTML = rows.map(r=>`
    <div class="card" style="padding:10px">
      <div class="flex">
        <img class="logo" src="${r.logoUrl||''}"/>
        <div>
          <div style="font-weight:800">${r.name}</div>
          <div class="small">${r.phone||''}</div>
          <div class="small">${r.address||''}</div>
        </div>
        <span class="right"></span>
        <button class="btn secondary"
        data-user-details
        data-kind="restaurant"
        data-id="${r.id}">
  ${t('details')}
</button>

      </div>
    </div>
  `).join('') || `<div class="small" style="opacity:.7">No approved restaurants.</div>`;

  attachRowHandlers();
}

/* ===== [TAUSSIL-REST-APPROVED-RENDER-END] ===== */

function renderDrivers(){
  const wrap = $('#drivers-grid'); if(!wrap) return;
  wrap.innerHTML = drivers.map(d=>{
    const online = !!presenceMap[d.id];
    return `
    <div class="card" style="padding:12px">
      <div class="flex">
        <img class="avatar" src="${d.avatarUrl||''}"/>
        <div>
          <div style="font-weight:800">${d.fullName}</div>
          <div class="small">${d.phone||''}</div>
          <div class="small">Status: ${online? '<b style="color:#16a34a">Online</b>' : 'Offline'}</div>
        </div>
        <span class="right"></span>
        <button class="btn secondary"
        data-user-details
        data-kind="driver"
        data-id="${d.id}">
  ${t('details')||'Details'}
</button>


      </div>
    </div>`;
  }).join('');
  attachRowHandlers();

  if(window.google?.maps){
    driverMarkers.forEach((mk, uid)=> updateMarkerLabel(mk, uid));
  }
}
function renderOrdersLog(){
  const wrap = $('#orders-log'); if(!wrap) return;
  wrap.innerHTML = orders.map(o=>`
  <div class="tr ${isCashOrder(o)?'cash-row':''}">

      <div class="select"><input type="checkbox" class="order-select" data-id="${o.id}"></div>

      <div class="order-code mono">#${o.nr!=null? o.nr : (o.shortCode||'—')}</div>

      <div class="order-restaurant flex">
        <img class="logo" src="${o.restaurant?.logoUrl||''}"/>
        <div>
          <div style="font-weight:700">${o.restaurant?.name||'-'}</div>
          <div class="small">${o.restaurant?.phone||''}</div>
        </div>
      </div>

      <div class="order-driver">
        ${
          o.driver
           ? `<div><div style="font-weight:700">${o.driver.fullName||''}</div><div class="small">${o.driver.phone||''}</div></div>`
           : '<span class="small">-</span>'
        }
      </div>

      <div class="order-platform">${platformChips(o.platform)}</div>

      <div class="order-qty mono">x${Number(o.qty||0)}</div>

      <div class="order-actions">
        ${statusBadge(o.status)}
        <button class="btn secondary" data-order-details="${o.id}" data-i18n="order.details">${t('order.details')}</button>
      </div>
    </div>
  `).join('');
  attachRowHandlers();
  bindOrderSelectionHandlers();
  ensureExportBar(); // يبقى كما هو
}

function attachRowHandlers(){
  document.querySelectorAll('[data-order-details]').forEach(btn=>{
    btn.onclick=()=>{ const id=btn.getAttribute('data-order-details'); const o=orders.find(x=>x.id===id); if(o) openOrderModal(o); };
  });
  document.querySelectorAll('[data-assign]').forEach(btn=>{
    btn.onclick=()=>{ const id=btn.getAttribute('data-assign'); const o=orders.find(x=>x.id===id); if(o) openAssignSheet(o); };
  });
  document.querySelectorAll('select[data-update-status]').forEach(sel=>{
    sel.onchange=async ()=>{ const id=sel.getAttribute('data-update-status'); const val=sel.value; if(!val) return; await changeStatus(id,val); sel.value=''; };
  });
  lucide.createIcons();
}

/* ===== Modals ===== */
const orderModal   = $('#order-modal');
const orderDetails = $('#order-details');
$('#order-close')?.addEventListener('click',()=>orderModal?.classList.remove('open'));

async function openOrderModal(o){
  if(!orderDetails || !orderModal) return;

  const nrTxt   = (o.nr!=null? `#${o.nr}` : (o.shortCode? `#${o.shortCode}` : `#${o.id||'—'}`));
  const price   = Number.isFinite(Number(o.price)) ? Number(o.price) : 0;
  const sFee    = Number(readServiceFee(o)) || 0;
  const dFee    = Number(readDistanceFee(o)) || 0;

  let km = readDistanceKm(o);   // قد تكون null
  // Placeholder إلى أن نحسب المسافة إن كانت مفقودة
  let kmBoxHtml = `<div class="small">Distance</div><div class="mono">—</div>`;

  // ملتي ستوب سنملأه بعد جلب stops
  let stopsHtml = `<div class="small" style="opacity:.7">—</div>`;

  // قالب أساسي
  orderDetails.innerHTML = `
        <div>
        <div class="small" data-i18n="labels.distanceTotal">${t('labels.distanceTotal')}</div>
        ${fmtKm(readDistanceTotalKm(o))}
      </div>
      <div>
        <div class="small" data-i18n="labels.distanceBillable">${t('labels.distanceBillable')}</div>
        ${fmtKm(readDistanceBillableKm(o))}
      </div>

    <div class="grid cols-2" style="row-gap:12px">
      <!-- Overview -->
      <div>
        <div class="small">${t('labels.code')}</div>
        <div class="mono">${nrTxt}</div>
      </div>
      <div>
        <div class="small">${t('labels.status')}</div>
        ${statusBadge(o.status)}
      </div>

      <div>
        <div class="small">${t('labels.restaurant')}</div>
        <div class="flex">
          <img class="logo" src="${o.restaurant?.logoUrl||''}"/>
          <div>
            <div style="font-weight:800">${o.restaurant?.name||'-'}</div>
            <div class="small">${o.restaurant?.phone||''}</div>
            <div class="small" title="${o.restaurant?.address_text||o.restaurant?.addressText||''}">
              ${(o.restaurant?.address_text||o.restaurant?.addressText||'').split(',').slice(0,2).join(', ')}
            </div>
          </div>
        </div>
      </div>

      <div>
        <div class="small">${t('labels.driver')}</div>
        ${
          o.driver
            ? `<div class="flex">
                 ${o.driver.avatarUrl? `<img class="avatar" src="${o.driver.avatarUrl}">`:''}
                 <div>
                   <div style="font-weight:800">${o.driver.fullName||''}</div>
                   <div class="small">${o.driver.phone||''}</div>
                 </div>
               </div>`
            : '<div class="small">-</div>'
        }
      </div>

      <div>
        <div class="small">${t('labels.platform')}</div>
        ${platformChips(o.platform)}
      </div>

      <div>
        <div class="small">${t('labels.pickup')}</div>
        ${o.pickupTime||'—'}
      </div>

      <div>
        <div class="small">${t('labels.qty')}</div>
        <div class="mono">x${Number(o.qty||0)}</div>
      </div>

      <div>
  <div class="small">${t('labels.price')}</div>
  <div class="${isCashOrder(o)?'cash-price':''}">${price.toFixed(2)} €</div>
</div>
<!-- [CASH] Payment & Cash Due -->
<div>
  <div class="small">${t('labels.payment')||'Payment'}</div>
  <div>${isCashOrder(o) ? (t('payment.cash')||'Cash') : (t('payment.online')||'Online')}</div>
</div>
<div>
  <div class="small">${t('labels.cashDue')||'Cash to collect'}</div>
  <div>${isCashOrder(o) ? (readCashDueEUR(o).toFixed(2)+' €') : '—'}</div>
</div>


      <!-- Fees -->
      <div>
        <div class="small">Service Fee</div>
        <div>${sFee.toFixed(2)} €</div>
      </div>
      <div>
        <div class="small">Distance Fee</div>
        <div>${dFee ? dFee.toFixed(2)+' €' : '—'}</div>
      </div>

      <!-- Distance (km) -->
      <div id="od-dist-box">${kmBoxHtml}</div>
      <div>
        <div class="small">Total (Price + Fees)</div>
        <div style="font-weight:800">${(price + sFee + dFee).toFixed(2)} €</div>
      </div>

      <!-- Customer / Drop-off -->
      <div style="grid-column:1/-1; border-top:1px solid #e5e7eb; padding-top:8px">
        <div class="row" style="gap:20px; align-items:flex-start">
          <div style="flex:1">
            <div class="small">Customer</div>
            <div style="font-weight:700">${o.customer?.name || o.toName || '-'}</div>
            <div class="small">${o.customer?.phone || o.toPhone || ''}</div>
            <div class="small" title="${o.customer?.address_text || o.toAddress || ''}">
              ${(o.customer?.address_text || o.toAddress || '').split(',').slice(0,2).join(', ')}
            </div>
          </div>
          <div style="flex:1">
            <div class="small">Notes</div>
            <div class="small" style="white-space:pre-wrap">${o.notes || o.comment || '—'}</div>
          </div>
        </div>
      </div>

      <!-- Multi-stops (إن وجدت) -->
      <div style="grid-column:1/-1">
        <div class="small" style="margin-bottom:4px">Stops</div>
        <div id="od-stops">${stopsHtml}</div>
      </div>
    </div>

    <!-- Actions -->
    <div class="row" style="justify-content:flex-end;gap:8px;margin-top:12px">
      <select id="order-status-select" style="height:40px;border-radius:10px;border:1px solid #e5e7eb">
        <option value="">${t('labels.status')}…</option>
        <option value="Bearbeitung">Bearbeitung</option>
        <option value="Zugewiesen">Zugewiesen</option>
        <option value="Angenommen">Angenommen</option>
        <option value="Unterwegs">Unterwegs</option>
        <option value="Geliefert">Geliefert</option>
        <option value="Abgebrochen">Abgebrochen</option>
      </select>
      <button class="btn" id="order-status-apply" data-i18n="assign.confirm">${t('assign.confirm')}</button>
    </div>
    <div class="small" style="margin-top:6px">
      ${(o.updatedAt?.toDate?.()? o.updatedAt.toDate(): (o.createdAt?.toDate?.()? o.createdAt.toDate(): null))?.toLocaleString() || ''}
    </div>
  `;

  orderModal.classList.add('open');
document.body.classList.add('modal-open'); // قفل خلفية الصفحة

  $('#order-status-apply').onclick = async ()=>{
    const val = $('#order-status-select').value; if(!val) return;
    await changeStatus(o.id, val); orderModal.classList.remove('open');
  };
  lucide.createIcons();

  // 1) حساب/عرض Distance KM (إن كانت غير موجودة بالداتا)
  if(km == null){
    const kmCalc = await calcRouteDistanceKm(o);
    const kmBox = $('#od-dist-box');
    if(kmBox){
      kmBox.innerHTML = `
        <div class="small">Distance</div>
        <div class="mono">${kmCalc!=null ? kmCalc.toFixed(2)+' km' : '—'}</div>
      `;
    }
  }else{
    const kmBox = $('#od-dist-box');
    if(kmBox){
      kmBox.innerHTML = `
        <div class="small">Distance</div>
        <div class="mono">${Number(km).toFixed(2)} km</div>
      `;
    }
  }

  // 2) جلب Stops للملتي-أوردر (لو موجودة)
  try{
    const col = collection(db, 'orders', o.id, 'stops');
    const snap = await getDocs(col);
    const list = snap.docs.map(d => ({ id:d.id, ...d.data() }));
    const box  = $('#od-stops');
    if(box){
      if(!list.length){ box.innerHTML = `<div class="small" style="opacity:.7">—</div>`; }
      else{
        box.innerHTML = list.map((s,i)=>`
          <div class="tr" style="display:flex;gap:10px;align-items:flex-start;border:1px solid #e5e7eb;border-radius:10px;padding:8px;margin-bottom:8px">
            <div class="badge gray">#${i+1}</div>
            <div style="flex:1;min-width:0">
              <div style="font-weight:700;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">
                ${s.name || s.fullName || s.customerName || ('Stop '+(i+1))}
              </div>
              <div class="small">${s.phone || ''}</div>
              <div class="small" title="${s.address_text || s.addressText || ''}">
                ${(s.address_text || s.addressText || '').split(',').slice(0,2).join(', ')}
              </div>
            </div>
            <div class="right small">${s.status ? statusBadge(s.status) : ''}</div>
          </div>
        `).join('');
      }
    }
  }catch(_){}
}


const userModal = $('#user-modal');
const userTitle = $('#user-title');
const userDetailsBox = $('#user-details');
$('#user-close')?.addEventListener('click',()=>userModal?.classList.remove('open'));

function esc(s){ return String(s ?? '').replace(/[<>&]/g, c=>({ '<':'&lt;','>':'&gt;','&':'&amp;' }[c])); }
function fmtAny(v){
  // تحويل Timestamps وإلا طباعة قيمة بسيطة
  try{
    if (v?.toDate) return v.toDate().toLocaleString();
    if (v instanceof Date) return v.toLocaleString();
  }catch(_){}
  if (typeof v === 'object' && v!==null) return JSON.stringify(v, null, 2);
  return String(v ?? '—');
}
function kv(label, value){
  return `
    <div class="row" style="align-items:flex-start; gap:8px; border-bottom:1px solid #e5e7eb; padding:6px 0">
      <div class="small" style="min-width:140px; opacity:.7">${esc(label)}</div>
      <div class="mono" style="white-space:pre-wrap">${esc(fmtAny(value))}</div>
    </div>`;
}
// === Fleet: cascade fetch from fleet/, fleets/, users(role=fleet) ===
async function getFleetDocCascade(id){
  let src = '', raw = {};

  // A) try 'fleet/{id}'
  try{
    const ds = await getDoc(doc(db,'fleet', id));
    if(ds.exists()){ src='fleet'; raw = ds.data()||{}; }
  }catch(_){}

  // B) try 'fleets/{id}'
  if(!src){
    try{
      const ds2 = await getDoc(doc(db,'fleets', id));
      if(ds2.exists()){ src='fleets'; raw = ds2.data()||{}; }
    }catch(_){}
  }

  // C) fallback: users/{id} with role=fleet
  if(!src){
    try{
      const u = await getDoc(doc(db,'users', id));
      if(u.exists()){
        const usr = u.data()||{};
        if(String(usr.role||'').toLowerCase()==='fleet'){
          const app = usr.fleetApplication || {};
          const company = app.company || usr.company || {};
          raw = {
            approved: usr.approved===true,
            status: usr.status || (usr.approved===true ? 'active':'pending'),
            email: usr.email || company.email || '',
            company: {
              name: company.name || usr.name || usr.email || id,
              ownerFirst: company.ownerFirst || '',
              ownerLast:  company.ownerLast  || '',
              phone: company.phone || usr.phone || ''
            },
            address: app.address || { city: (app.targetCity || usr.city || '') },
            targetCity: app.targetCity || usr.targetCity || '',
            driversCount: Number(app.driversCount || 0),
            createdAt: usr.createdAt || null,
            updatedAt: usr.updatedAt || null
          };
          src='users';
        }
      }
    }catch(_){}
  }

  return { src, data: raw };
}

async function openEntityDetails(kind, id){
  if(!userModal || !userTitle || !userDetailsBox) return;

  let ds=null, data=null, title='Details', img='', name='';

  if (kind === 'driver'){
  ds = await getDoc(doc(db,'users', id));
  data = ds.exists()? ds.data() : null;
  title = (currentLang==='ar'?'تفاصيل السائق': (currentLang==='de'?'Fahrerdetails':'Driver Details'));
  img = data?.avatarUrl || '';
  name = data?.fullName || [data?.firstName, data?.lastName].filter(Boolean).join(' ') || data?.name || data?.email || id;
} else if (kind === 'fleet'){
  const got = await getFleetDocCascade(id);
  const fleetData = got?.data || null;   // ← بدل data إلى fleetData

  userTitle.textContent = (currentLang==='ar'?'تفاصيل الأسطول'
                          : (currentLang==='de'?'Flotten-Details':'Fleet Details'));

  if(!fleetData){
    userDetailsBox.innerHTML = `<div class="small" style="opacity:.7">Not found</div>`;
    userModal.classList.add('open');
    document.body.classList.add('modal-open');
    return; // ← مهم
  }

  const company = fleetData.company || {};
  const addr    = fleetData.address || {};
  const name    = company.name || fleetData.name || fleetData.email || id;
  const owner   = [company.ownerFirst||'', company.ownerLast||''].join(' ').trim();
  const phone   = company.phone || fleetData.phone || fleetData.contactPhone || '';
  const email   = fleetData.email || company.email || '';
  const city    = addr.city || fleetData.targetCity || fleetData.city || '';
  const drvCnt  = Number(fleetData.driversCount || 0);
  const status  = fleetData.status || (fleetData.approved===true ? 'active' : 'pending');
  const approved= (fleetData.approved===true) || ['active','approved','enabled'].includes(String(status||'').toLowerCase());
  const created = fleetData.createdAt?.toDate ? fleetData.createdAt.toDate()
                  : (fleetData.createdAt instanceof Date ? fleetData.createdAt : null);
  const updated = fleetData.updatedAt?.toDate ? fleetData.updatedAt.toDate()
                  : (fleetData.updatedAt instanceof Date ? fleetData.updatedAt : null);

  const head = `
    <div class="flex" style="gap:10px; align-items:center; margin-bottom:8px">
      <div class="logo" style="width:26px;height:26px;border-radius:6px;background:#f3f4f6"></div>
      <div>
        <div style="font-weight:800">${esc(name)}</div>
        ${owner ? `<div class="small" style="opacity:.8">${esc(owner)}</div>` : ''}
        ${phone ? `<div class="small"><a href="tel:${esc(phone)}">${esc(phone)}</a></div>` : ''}
        ${email ? `<div class="small"><a href="mailto:${esc(email)}">${esc(email)}</a></div>` : ''}
      </div>
    </div>`;

  const common =
      kv('Fleet ID', id) +
      (owner   ? kv('Owner', owner) : '') +
      (city    ? kv('City', city) : '') +
      kv('Drivers Count', String(drvCnt)) +
      kv('Approved', String(approved)) +
      kv('Status', status) +
      (fleetData.targetCity ? kv('Target City', fleetData.targetCity) : '') +
      (created ? kv('CreatedAt', created) : '') +
      (updated ? kv('UpdatedAt', updated) : '');

  const rawDump = `
    <div style="margin-top:10px">
      <div class="small" style="opacity:.7; margin-bottom:4px">Raw fleet document (${esc(got.src||'—')})</div>
      <pre class="small mono" style="background:#f8fafc; border:1px solid #e5e7eb; border-radius:8px; padding:8px; max-height:260px; overflow:auto">${esc(JSON.stringify(fleetData, null, 2))}</pre>
    </div>`;

  userDetailsBox.innerHTML = head + common + rawDump;
  userModal.classList.add('open');
  document.body.classList.add('modal-open');
  return; // ← مهم جدًا كي لا يكمل للبلوك العام


} else {
  // restaurant: جرّب restaurants ثم users كاحتياط
  ds = await getDoc(doc(db,'restaurants', id));
  if(ds.exists()){
    data = ds.data();
  } else {
    const u = await getDoc(doc(db,'users', id));
    data = u.exists()? u.data() : null;
  }
  title = (currentLang==='ar'?'تفاصيل المطعم': (currentLang==='de'?'Restaurantdetails':'Restaurant Details'));
  img = data?.logoUrl || '';
  name = data?.name || data?.restName || data?.email || id;
}


  userTitle.textContent = title;
  if(!data){
    userDetailsBox.innerHTML = `<div class="small" style="opacity:.7">Not found</div>`;
    userModal.classList.add('open'); return;
  }

  // استنباط رقم الهاتف من أشهر الحقول الممكنة
  const phone = data.phone ?? data.contactPhone ?? data.company?.phone ?? data.ownerPhone ?? '';

  // استنباط البريد
  const email = data.email ?? data.company?.email ?? '';

  // عنوان/مدينة
  const address = data.address_text ?? data.addressText ?? data.address ?? data.company?.address ?? '';
  const city    = data.city ?? data.address?.city ?? data.company?.address?.city ?? '';

  // تواريخ / حالة
  const approved = (data.approved === true);
  const status   = data.status ?? '';
  const created  = data.createdAt?.toDate ? data.createdAt.toDate() : (data.createdAt instanceof Date ? data.createdAt : null);
  const updated  = data.updatedAt?.toDate ? data.updatedAt.toDate() : (data.updatedAt instanceof Date ? data.updatedAt : null);

  // رأس المودال
  const head = `
    <div class="flex" style="gap:10px; align-items:center; margin-bottom:8px">
      ${img ? `<img class="${kind==='driver'?'avatar':'logo'}" src="${esc(img)}">` : `<div class="${kind==='driver'?'avatar':'logo'}" style="background:#f3f4f6"></div>`}
      <div>
        <div style="font-weight:800">${esc(name)}</div>
        ${phone ? `<div class="small"><a href="tel:${esc(phone)}">${esc(phone)}</a></div>` : ''}
        ${email ? `<div class="small"><a href="mailto:${esc(email)}">${esc(email)}</a></div>` : ''}
      </div>
    </div>`;

  // حقول شائعة
  const common =
      kv('ID', id) +
      (phone ? kv('Phone', phone) : '') +
      (email ? kv('Email', email) : '') +
      (address ? kv('Address', address) : '') +
      (city ? kv('City', city) : '') +
      kv('Approved', String(approved)) +
      kv('Status', status) +
      (created ? kv('CreatedAt', created) : '') +
      (updated ? kv('UpdatedAt', updated) : '');

  // Dump كل الداتا (كما هي)
  const jsonDump = `
    <div style="margin-top:10px">
      <div class="small" style="opacity:.7; margin-bottom:4px">Raw document</div>
      <pre class="small mono" style="background:#f8fafc; border:1px solid #e5e7eb; border-radius:8px; padding:8px; max-height:260px; overflow:auto">${esc(JSON.stringify(data, null, 2))}</pre>
    </div>`;

  userDetailsBox.innerHTML = head + common + jsonDump;
  userModal.classList.add('open');
}

/* إبقاء الدالة القديمة كـ fallback للزر القديم (لا تزيلها إن عندك أماكن لسه تستعملها) */
function openUserModal(payload){
  // إذا وصلنا لهون، بنعرض على الأقل الاسم/الهاتف/الصورة القديمة
  if(!userModal||!userTitle||!userDetailsBox) return;
  if(payload.kind==='driver'){
    userTitle.textContent = currentLang==='ar'?'تفاصيل السائق':(currentLang==='de'?'Fahrerdetails':'Driver Details');
    userDetailsBox.innerHTML = `<div class="flex"><img class="avatar" src="${payload.avatarUrl||''}"/><div><div style="font-weight:800">${payload.fullName||''}</div><div class="small">${payload.phone||''}</div></div></div>`;
  }else{
    userTitle.textContent = currentLang==='ar'?'تفاصيل المطعم':(currentLang==='de'?'Restaurantdetails':'Restaurant Details');
    userDetailsBox.innerHTML = `<div class="flex"><img class="logo" src="${payload.logoUrl||''}"/><div><div style="font-weight:800">${payload.name||''}</div><div class="small">${payload.phone||''}</div></div></div>`;
  }
  userModal.classList.add('open');
}
async function openFleetDriversModal(fleetId){
  if(!userModal || !userTitle || !userDetailsBox) return;
  userTitle.textContent = 'Fleet Drivers';

  let rows = [];
  try{
    const qy = query(collection(db,'users'), where('role','==','driver'), where('fleetId','==', fleetId), limit(200));
    const snap = await getDocs(qy);
    rows = snap.docs.map(d=>({id:d.id, ...d.data()}));
  }catch(e){
    const snap = await getDocs(query(collection(db,'users'), where('role','==','driver'), limit(400)));
    rows = snap.docs.map(d=>({id:d.id, ...d.data()})).filter(u=> (u.fleetId===fleetId));
  }

  if(!rows.length){
    userDetailsBox.innerHTML = `<div class="small" style="opacity:.7">No drivers in this fleet.</div>`;
    userModal.classList.add('open'); return;
  }

  userDetailsBox.innerHTML = rows.map(u=>{
    const full = u.fullName || [u.firstName,u.lastName].filter(Boolean).join(' ') || u.name || u.email || u.id;
    const phone= u.phone || '';
    return `
      <div class="drv-row" style="border:1px solid #e5e7eb;border-radius:10px;padding:8px;margin-bottom:8px">
        <div class="who" style="display:flex;gap:10px;align-items:center;min-width:0">
          ${u.avatarUrl? `<img class="avatar" src="${u.avatarUrl}">`:`<div class="avatar" style="background:#f3f4f6"></div>`}
          <div>
            <div class="name" style="font-weight:800">${full}</div>
            <div class="meta">${phone}</div>
          </div>
        </div>
        <div class="actions">
          <button class="btn secondary" data-user-details data-kind="driver" data-id="${u.id}">${t('details')||'Details'}</button>
        </div>
      </div>
    `;
  }).join('');
  userModal.classList.add('open');
}

// Click: open drivers of a fleet
document.addEventListener('click', (e)=>{
  const btn = e.target.closest('[data-fleet-drivers]');
  if(btn){
    const fid = btn.getAttribute('data-fleet-drivers');
    openFleetDriversModal(fid);
  }
});

document.addEventListener('click', async (e)=>{
  const ud = e.target.closest('[data-user-details]');
  if(!ud) return;

  // الشكل الجديد: data-kind + data-id
  const kind = ud.getAttribute('data-kind');
  const id   = ud.getAttribute('data-id');
  if (kind && id) {
    openEntityDetails(kind, id);
    return;
  }

  // fallback للشكل القديم (لو بقي شيء منه)
  try {
    const payload = JSON.parse(ud.getAttribute('data-user-details'));
    openUserModal(payload);
  } catch(_){}
});


/* ===== Assign Sheet (كما في ملفك) ===== */
const assignSheet   = $('#assign-sheet');
const assignBox     = $('#assign-order-box');
const assignSelect  = $('#assign-driver-select');
$('#assign-cancel')?.addEventListener('click',()=>assignSheet?.classList.remove('open'));
$('#assign-confirm')?.addEventListener('click', async ()=>{
  const oid = assignSheet?.dataset.oid; const val=assignSelect?.value; if(!oid || !val) return;
  const d = drivers.find(x=>x.id===val); if(!d) return;
  try{
    await updateDoc(doc(db,'orders', oid), {
      driver:{ id:d.id, fullName:d.fullName||null, phone:d.phone||null, avatarUrl:d.avatarUrl||null },
      status:'Zugewiesen', updatedAt: serverTimestamp()
    }).catch(async ()=>{
      await setDoc(doc(db,'orders', oid), {
        driver:{ id:d.id, fullName:d.fullName||null, phone:d.phone||null, avatarUrl:d.avatarUrl||null },
        status:'Zugewiesen', updatedAt: serverTimestamp()
      }, {merge:true});
    });
    await rUpdate(rRef(rtdb,`drivers_inbox/${d.id}`), { lastOrderAssigned: oid, ts: Date.now() }).catch(()=>{});
    playSound('driver');    await propagateDriverToStops(oid, { fullName: d.fullName, phone: d.phone });

  }finally{ assignSheet?.classList.remove('open'); }
});
function openAssignSheet(o){
  if(!assignSheet||!assignBox||!assignSelect) return;
  assignSheet.dataset.oid = o.id;
  assignBox.textContent = `#${o.nr!=null?o.nr:o.id} · ${o.restaurant?.name||'-'}`;
  assignSelect.innerHTML = '<option value=""></option>' + drivers.map(d=>{
    const tag = presenceMap[d.id] ? ' (Online)' : ' (Offline)';
    return `<option value="${d.id}">${d.fullName} — ${d.phone||''}${tag}</option>`;
  }).join('');
  assignSheet.classList.add('open');
}
// === [TAUSSIL-STOPS-PROPAGATION-START] ===
async function propagateDriverToStops(orderId, driver){
  try{
    const stopColRef = collection(db, 'orders', orderId, 'stops');
    const snap = await getDocs(stopColRef);
    if (snap.empty) return;
    const payload = {
      fullName: driver?.fullName ?? null,
      phone: driver?.phone ?? null,
      updatedAt: serverTimestamp()
    };
    await Promise.all(
      snap.docs.map(d => 
        updateDoc(d.ref, payload).catch(() => setDoc(d.ref, payload, { merge:true }))
      )
    );
  }catch(e){ console.warn('propagateDriverToStops failed:', e?.code||e); }
}

async function propagateStatusToStops(orderId, status){
  try{
    const stopColRef = collection(db, 'orders', orderId, 'stops');
    const snap = await getDocs(stopColRef);
    if (snap.empty) return;
    const payload = { status: status || 'Bearbeitung', updatedAt: serverTimestamp() };
    await Promise.all(
      snap.docs.map(d => 
        updateDoc(d.ref, payload).catch(() => setDoc(d.ref, payload, { merge:true }))
      )
    );
  }catch(e){ console.warn('propagateStatusToStops failed:', e?.code||e); }
}
// === [TAUSSIL-STOPS-PROPAGATION-END] ===

/* ===== Actions ===== */
async function changeStatus(orderId, next){
  try{
    await updateDoc(doc(db,'orders', orderId), { status: next, updatedAt: serverTimestamp() });
  }catch(_){
    await setDoc(doc(db,'orders', orderId), { status: next, updatedAt: serverTimestamp() }, { merge:true });
  }
    // مزامنة الحالة إلى الستوبز
  await propagateStatusToStops(orderId, next);

  if(next==='Unterwegs') playSound('unterwegs');
  if(next==='Geliefert') playSound('geliefert');
  renderAll();
}
// Force driver desired online/offline from admin
// Force driver desired online/offline from admin (نكتب presence + control)
async function setDriverDesired(uid, desired){
  const ts = Date.now();
  try{
    if(desired === false){
      // إطفاء ناعم + إشارة واضحة لتطبيق السائق
      await rSet( rRef(rtdb, `drivers_control/${uid}/forceOfflineUntil`), ts );
    }else{
      // تشغيل: رغبة = true + تنظيف أي أعلام سابقة
      await rSet( rRef(rtdb, `drivers_control/${uid}/clear`), true );
    }

    await rUpdate( rRef(rtdb, `drivers_presence/${uid}`), {
      desired: !!desired,
      adminTs: ts
    });
  }catch(e){
    console.warn('setDriverDesired failed:', e?.code||e);
    alert('فشل الأمر ('+(e?.code||e?.message||'')+'). تأكد أن حساب الأدمن مسموح له بالكتابة.');
    throw e;
  }
}


function drvRowHtml(d){
  const phone  = d.phone || '';
  const avatar = d.avatarUrl ? `<img class="avatar" src="${d.avatarUrl}">` : `<div class="avatar" style="background:#f3f4f6"></div>`;
  const isOnline = !!presenceMap[d.id]; // يحسب من RTDB كما هو عندك
  const toggleBtn = `
    <button class="btn ${isOnline ? '' : 'secondary'}"
            data-driver-offline="${d.id}"
            data-state="${isOnline ? 'online' : 'offline'}">
      ${isOnline ? t('Off') : t('On')}
    </button>`;

  const earningsToggle = `
    <label class="small" style="display:flex;align-items:center;gap:6px">
      <input type="checkbox" class="drv-earnings-toggle" data-id="${d.id}" ${d.showEarnings ? 'checked':''}>
      <span data-i18n="drivers.earningsToggle">${t('drivers.earningsToggle')}</span>
    </label>
  `;

  return `
    <div class="drv-row">
      <div class="who" style="display:flex;gap:10px;align-items:center;min-width:0">
        ${avatar}
        <div>
          <div class="name">${d.fullName || d.name || d.email || d.id}</div>
          <div class="meta">${phone}</div>
        </div>
      </div>
      <div class="actions">
        ${toggleBtn}
        ${earningsToggle}
        <button class="btn secondary"
                data-user-details
                data-kind="driver"
                data-id="${d.id}">
          ${t('details')||'Details'}
        </button>
      </div>
    </div>`;
}


function drvRowOnlineHtml(d){
  const base = drvRowHtml(d);
  return base.replace(
    '</div></div>',
    `<button class="btn primary" data-assign-driver="${d.id}">Assign</button></div></div>`
  );
}


function drvRowPendingHtml(u){
  const name  = u.firstName ? (u.firstName + (u.lastName? (' ' + u.lastName):'')) : (u.name||u.email||u.id);
  const phone = u.phone || '';
  return `
  <div class="drv-row">
    <div class="who" style="min-width:0">
      <div class="name">${name}</div>
      <div class="meta">${phone}</div>
    </div>
    <div class="actions">
      <button class="btn secondary"
              data-user-details
              data-kind="driver"
              data-id="${u.id}">
        ${t('details')||'Details'}
      </button>
      <button class="btn" data-approve-driver="${u.id}">${t('approval.approve')||'Approve'}</button>
      <button class="btn secondary" data-reject-driver="${u.id}">${t('approval.reject')||'Reject'}</button>
    </div>
  </div>`;
}


function renderDriversColumns(){
  // All
  const allEl = document.getElementById('drivers-all');
  const allCnt= document.getElementById('drv-all-count');
  if(allEl){
    allEl.innerHTML = (drivers||[]).map(d=>drvRowHtml(d)).join('') || `<div class="small" style="opacity:.7">—</div>`;
    if(allCnt) allCnt.textContent = (drivers||[]).length;
  }

  // Online
  const onlineEl = document.getElementById('drivers-online');
  const onlineCnt= document.getElementById('drv-online-count');
  if(onlineEl){
    const online = (drivers||[]).filter(d => !!presenceMap[d.id]);
    onlineEl.innerHTML = online.map(d=>drvRowOnlineHtml(d)).join('') || `<div class="small" style="opacity:.7">—</div>`;
    if(onlineCnt) onlineCnt.textContent = online.length;
  }

  // Pending (from pendingDrivers state)
  const pendEl = document.getElementById('drivers-pending');
  const pendCnt= document.getElementById('drv-pending-count');
  if(pendEl){
    const pendingList = (pendingDrivers||[]).filter(u => String(u.status||'pending').toLowerCase() !== 'rejected');
    pendEl.innerHTML = pendingList.length ? pendingList.map(u=>drvRowPendingHtml(u)).join('') : `<div class="small" style="opacity:.7">No pending drivers</div>`;
    if(pendCnt) pendCnt.textContent = pendingList.length;
  }

  lucide.createIcons?.();
}

/* استبدال renderDrivers الافتراضية بعارض الأعمدة عند وجود تبويب الأعمدة */
const __origRenderDrivers = renderDrivers;
renderDrivers = function(){
  if(document.getElementById('drivers-cols')){
    renderDriversColumns();
  }else{
    __origRenderDrivers.apply(this, arguments);
  }
};

/* زر Assign (يفتح مودال الإسناد الموجود عندك سابقًا) */
document.addEventListener('click', (e)=>{
  const btn = e.target.closest('[data-assign-driver]');
  if(btn){
    const driverId = btn.getAttribute('data-assign-driver');
    // إن كان لديك openAssignDriverModal من الخطوة السابقة استخدمه:
    if(typeof openAssignDriverModal === 'function'){
      openAssignDriverModal(driverId);
    }
  }
});
// Toggle desired (admin) for a driver (Go offline / Allow online)
document.addEventListener('click', async (e)=>{
  const btn = e.target.closest('[data-driver-offline]');
  if(!btn) return;

  const uid   = btn.getAttribute('data-driver-offline');
  const state = btn.getAttribute('data-state'); // 'online' أو 'offline'
  const nextDesired = (state === 'online') ? false : true; // online→أوفلاين, offline→سماح بالأونلاين

  btn.disabled = true;
  const oldText = btn.textContent;
  try{
    btn.textContent = '…';
    await setDriverDesired(uid, nextDesired);
  }finally{
    btn.disabled = false;
    btn.textContent = oldText;
    // سيُعاد الرسم تلقائيًا من مستمع drivers_presence في RTDB
  }
});

// حفظ إظهار/إخفاء الأرباح لكل سائق
document.addEventListener('change', async (e)=>{
  const ch = e.target.closest('.drv-earnings-toggle');
  if(!ch) return;

  const uid = ch.getAttribute('data-id');
  const val = !!ch.checked;
  ch.disabled = true;
  try{
    // نكتب للمسار الأساسي + مسارات توافق
    await updateDoc(doc(db,'users', uid), {
      'ui.showEarnings': val,
      'features.earningsVisible': val,
      showEarnings: val,
      updatedAt: serverTimestamp()
    });
  }catch(_){
    await setDoc(doc(db,'users', uid), {
      ui: { showEarnings: val },
      features: Object.assign({}, (await (async()=>{ try{ const s=await getDoc(doc(db,'users',uid)); return (s.exists()? s.data()?.features : {})||{}; }catch(_){ return {}; } })()), { earningsVisible: val }),
      showEarnings: val,
      updatedAt: serverTimestamp()
    }, { merge:true });
  }finally{
    ch.disabled = false;
  }
});

/* ===== Search ===== */
$('#search')?.addEventListener('input',(e)=>{
  const q=(e.target.value||'').trim().toLowerCase();
  const wrap = $('#orders-log'); if(!wrap) return;
  const list = !q? orders : orders.filter(o=>
    String(o.shortCode||'').toLowerCase().includes(q) ||
    String(o.nr||'').toLowerCase().includes(q) ||
    String(o.restaurant?.name||'').toLowerCase().includes(q) ||
    String(o.restaurant?.phone||'').toLowerCase().includes(q) ||
    (o.driver && (String(o.driver.fullName||'').toLowerCase().includes(q) || String(o.driver.phone||'').toLowerCase().includes(q)))
  );
  wrap.innerHTML = list.map(o=>`
    <div class="tr">
      <div><input type="checkbox" class="order-select" data-id="${o.id}"></div>
      <div class="mono">#${o.nr!=null? o.nr : (o.shortCode||'—')}</div>
      <div class="flex"><img class="logo" src="${o.restaurant?.logoUrl||''}"/><div><div style="font-weight:700">${o.restaurant?.name||'-'}</div><div class="small">${o.restaurant?.phone||''}</div></div></div>
      <div>${o.driver? `<div><div style="font-weight:700">${o.driver.fullName||''}</div><div class="small">${o.driver.phone||''}</div></div>` : '<span class="small">-</span>'}</div>
      <div>${platformChips(o.platform)}</div>
      <div class="mono" style="text-align:center">x${Number(o.qty||0)}</div>
      <div class="flex right">${statusBadge(o.status)} <button class="btn secondary" data-order-details="${o.id}" data-i18n="order.details">${t('order.details')}</button></div>
    </div>`).join('');
  attachRowHandlers();
  bindOrderSelectionHandlers();
  ensureExportBar(); // NEW
});

/* ===== Top bar events ===== */
$('#btn-mute')?.addEventListener('click',()=>setMuted(!isMuted));
$('#lang')?.addEventListener('change',()=>{ currentLang=$('#lang').value; translatePage(); });
$('#nav')?.addEventListener('click',(e)=>{
  const btn=e.target.closest('button[data-tab]'); if(!btn) return;
  document.querySelectorAll('.nav button').forEach(b=>b.classList.toggle('active', b===btn));
  const tab=btn.getAttribute('data-tab');
  document.querySelectorAll('.tab').forEach(t=>t.hidden=true);
  $('#tab-'+tab).hidden=false;
    if(tab==='map')   initMap();
  if(tab==='fleets') renderFleets();
    if(tab==='fleetx') renderFleetX_Safe();
});


/* ===== Login / Logout Gate ===== */
const adminAuth = $('#adminAuth');
const adEmail   = $('#adEmail');
const adPass    = $('#adPass');
const adLoginBtn= $('#adLoginBtn');
const adMsg     = $('#adMsg');

function showAdminAuth(show=true, msg=''){
  if(adminAuth) adminAuth.style.display = show? 'flex':'none';
  if(adMsg) adMsg.textContent = msg || '';
}
adLoginBtn?.addEventListener('click', async ()=>{
  if(adMsg) adMsg.textContent='';
  const email=(adEmail?.value||'').trim(); const pass=(adPass?.value||'');
  if(!email || !pass){ if(adMsg) adMsg.textContent='Bitte E-Mail & Passwort eingeben.'; return; }
  adLoginBtn.disabled=true;
  try{ await signInWithEmailAndPassword(auth, email, pass); }
  catch(e){ if(adMsg) adMsg.textContent = (e?.code==='auth/invalid-credential')? 'Falsche Zugangsdaten.' : ('Fehler: '+(e?.code||'')); }
  finally{ adLoginBtn.disabled=false; }
});
$('#btn-logout')?.addEventListener('click', async ()=>{
  try{ await signOut(auth); }catch(_){}
  detachRealtime();
  showAdminAuth(true);
});

/* ===== Realtime bindings (approved admin only) ===== */
let unsubOrders=null, unsubRestaurants=null, unsubDrivers=null, presenceUnsub=null;
/* [TAUSSIL-REST-APPROVED-UNSUB] */
let unsubRestaurantUsersApproved = null;

function detachRealtime(){
  try{ unsubOrders?.(); }catch(_){}
  try{ unsubRestaurants?.(); }catch(_){}
  try{ unsubDrivers?.(); }catch(_){}
  try{ presenceUnsub?.(); }catch(_){}
  try{ unsubPendingFleets?.(); }catch(_){}
unsubPendingFleets = null;
pendingFleets = [];
/* NEW: fleets approved listeners cleanup */
try{ unsubFleetsApproved?.(); }catch(_){}
try{ unsubFleetsUsersApproved?.(); }catch(_){}
unsubFleetsApproved = null;
unsubFleetsUsersApproved = null;
__fleets_from_docs = [];
__fleets_from_users = [];
fleetsApproved = [];




  /* [TAUSSIL-REST-APPROVED-DETACH] */
  try{ unsubRestaurantUsersApproved?.(); }catch(_){}
  unsubOrders=unsubRestaurants=unsubDrivers=presenceUnsub=null;
  unsubRestaurantUsersApproved = null;

  ordersMap.clear(); orders=[]; restaurants=[]; drivers=[];
  restaurantUsersApproved = [];
  presenceMap={};
  renderAll();
}
async function bindRealtimeOnce(){
  if (unsubOrders || unsubRestaurants || unsubDrivers) return;

  unsubOrders = onSnapshot(
    query(collection(db,'orders'), orderBy('updatedAt','desc'), limit(200)),
    (snap)=>{
      snap.docChanges().forEach(ch=>{
        const id=ch.doc.id; const data=ch.doc.data()||{}; const prev=ordersMap.get(id);
        if(ch.type==='removed'){ ordersMap.delete(id); return; }
        ordersMap.set(id,data);
        if(ch.type==='added' && (data.status||'').toLowerCase()==='bearbeitung') playSound('order');
        if(ch.type==='modified'){
          const before=(prev?.status||'').toLowerCase(); const now=(data.status||'').toLowerCase();
          if(before!==now){ if(now==='unterwegs') playSound('unterwegs'); if(now==='geliefert') playSound('geliefert'); }
        }
      });
      orders = Array.from(ordersMap.entries()).map(([id,o])=>({id,...o}));
      renderAll();
    },
    (err)=>console.warn('orders listener error:', err?.code||err)
  );

  unsubRestaurants = onSnapshot(
    query(collection(db,'restaurants'), limit(100)),
    (snap)=>{
      restaurants = snap.docs.map(d=>{
        const r=d.data()||{};
        return { id:d.id, name:r.name||d.id, phone:r.phone||'', address:r.address_text||r.addressText||'', logoUrl:r.logoUrl||'' };
      });
      renderRestaurants();
    }
  );

  /* [TAUSSIL-REST-APPROVED-LISTENER-START] */
  if(!unsubRestaurantUsersApproved){
    unsubRestaurantUsersApproved = onSnapshot(
      // شرط role فقط، ونفلتر approved على الواجهة لتجنّب فهرس مركّب
      query(collection(db,'users'), where('role','==','restaurant'), limit(200)),
      (snap)=>{
        const rows = snap.docs.map(d => {
          const u = d.data() || {};
          return {
            id: d.id,
            approved: u.approved === true,
            name: u.name || u.displayName || u.firstName || u.email || d.id,
            phone: u.phone || '',
            address: u.address_text || u.addressText || '',
            logoUrl: u.logoUrl || ''
          };
        });
        restaurantUsersApproved = rows.filter(r => r.approved);
        renderRestaurants();
      },
      (err)=> console.warn('restaurant users listener error:', err?.code||err)
    );
  }
  /* [TAUSSIL-REST-APPROVED-LISTENER-END] */

  unsubDrivers = onSnapshot(
  query(collection(db,'users'), where('role','==','driver'), where('approved','==', true), limit(200)),
  (snap)=>{
    drivers = snap.docs.map(d=>{
      const u=d.data()||{};
      const full = (u.firstName&&u.lastName)? `${u.firstName} ${u.lastName}` : (u.name||u.email||d.id);
      driverInfoById.set(d.id, { firstName: u.firstName || firstWord(full), fullName: full, phone: u.phone||'', email:u.email||'' });

      // قراءة العلم من أكثر من مسار للتوافق للخلف
      const showEarnings =
        !!(u?.ui?.showEarnings ?? u?.features?.earningsVisible ?? u?.showEarnings ?? false);

      return {
        id: d.id,
        fullName: full,
        phone: u.phone||'',
        avatarUrl: u.avatarUrl||'',
        showEarnings
      };
    });
    renderDrivers();
  }
);

/* ===== Fleets (approved) — docs + users fallback ===== */
if(!unsubFleetsApproved){
  try{
    // 3a) من collection('fleet') أو 'fleets' بدون where (نرشّح محليًا)
    const fleetCol1 = collection(db, 'fleet');
    const fleetCol2 = collection(db, 'fleets'); // لو كنت تستخدم جمع بصيغة الجمع

    const onSnapDocs = (snap)=>{
      __fleets_from_docs = snap.docs
        .map(d => normalizeFleetRow(d.id, d.data()||{}))
        .filter(Boolean);
      recomputeFleetsApproved();
    };

    // اسم المجموعة أيًا كان سيعيد نتيجة (فارغة أو ممتلئة) بدون خطأ
    unsubFleetsApproved = onSnapshot(query(fleetCol1, limit(500)), onSnapDocs, (err)=>console.warn('fleet listener error:', err?.code||err));
    // مستمع ثانٍ اختياري لـ 'fleets' إن كانت هي المجموعة الفعلية لديك
    onSnapshot(query(fleetCol2, limit(500)), onSnapDocs, ()=>{});
  }catch(e){ console.warn('fleets docs wiring failed', e?.code||e); }
}

if(!unsubFleetsUsersApproved){
  try{
    // 3b) fallback: مستخدمون role=fleet, approved=true
    unsubFleetsUsersApproved = onSnapshot(
      query(collection(db,'users'), where('role','==','fleet'), where('approved','==', true), limit(500)),
      (snap)=>{
        __fleets_from_users = snap.docs.map(d=>{
          const u  = d.data()||{};
          const app= u.fleetApplication || {};
          // نولّد شكل مماثل لوثائق fleet
          return normalizeFleetRow(d.id, {
            approved: true,
            email: u.email || '',
            company: {
              name: app.company?.name || u.company?.name || u.name || u.email || d.id,
              ownerFirst: app.company?.ownerFirst || '',
              ownerLast:  app.company?.ownerLast  || '',
              phone:      app.company?.phone || u.phone || ''
            },
            address: app.address || { city: app.targetCity || '' },
            driversCount: app.driversCount || 0
          });
        }).filter(Boolean);
        recomputeFleetsApproved();
      },
      (err)=> console.warn('fleets users listener error:', err?.code||err)
    );
  }catch(e){ console.warn('fleets users wiring failed', e?.code||e); }
}


  presenceUnsub = onValue(rRef(rtdb,'drivers_presence'), (snap)=>{
    const val=snap.val()||{}; const m={};
    Object.entries(val).forEach(([uid, obj])=>{
      const online = !!(obj && obj.online===true && obj.desired!==false);
      m[uid]=online;
    });
    presenceMap = m;

    if(window.google?.maps){
      driverMarkers.forEach((mk, uid)=>{
        mk.setIcon(driverMarkerIcon(!!presenceMap[uid]));
      });
    }
    renderDrivers();
  });
}

/* ===== Orders bulk delete (UI + logic) ===== */
const selectedOrders = new Set();
function ensureOrdersBulkUI(){
  const logWrap = $('#orders-log');
  if(!logWrap) return;
  if($('#orders-bulk-bar')) return;

  const bar=document.createElement('div');
  bar.id='orders-bulk-bar';
  bar.style.cssText='display:flex;gap:10px;align-items:center;justify-content:space-between;margin:8px 0;padding:8px;border:1px solid #e5e7eb;border-radius:10px;background:#fafafa';
  bar.innerHTML = `
    <div style="display:flex;align-items:center;gap:10px">
      <label style="display:flex;align-items:center;gap:6px"><input type="checkbox" id="orders-select-all"><span>Alle wählen</span></label>
      <span class="small" id="orders-selected-count" style="opacity:.8">0 ausgewählt</span>
    </div>
    <div style="display:flex;gap:8px">
      <button class="btn" id="orders-delete-selected" disabled>🗑 Löschen</button>
    </div>
  `;
  logWrap.parentElement?.insertBefore(bar, logWrap);
  $('#orders-select-all').addEventListener('change', (e)=> selectAllOrders(e.target.checked));
  $('#orders-delete-selected').addEventListener('click', deleteSelectedOrders);
  updateBulkBar();
}
function updateBulkBar(){
  const cntEl = $('#orders-selected-count');
  const delBtn= $('#orders-delete-selected');
  if(cntEl) cntEl.textContent = `${selectedOrders.size} ausgewählt`;
  if(delBtn) delBtn.disabled = selectedOrders.size===0;
}
function bindOrderSelectionHandlers(){
  document.querySelectorAll('input.order-select').forEach(ch=>{
    ch.onchange = ()=> { const id=ch.getAttribute('data-id'); if(!id) return; if(ch.checked) selectedOrders.add(id); else selectedOrders.delete(id); updateBulkBar(); };
  });
}
function selectAllOrders(flag){
  selectedOrders.clear();
  document.querySelectorAll('input.order-select').forEach(ch=>{
    ch.checked = !!flag;
    const id=ch.getAttribute('data-id'); if(flag && id) selectedOrders.add(id);
  });
  updateBulkBar();
}
async function deleteSelectedOrders(){
  if(selectedOrders.size===0) return;
  const ok = confirm(`Bestätigen: ${selectedOrders.size} Auftrag/⎯e löschen? Diese Aktion ist dauerhaft.`);
  if(!ok) return;
  const ids=[...selectedOrders];
  for(const id of ids){
    try{ await deleteDoc(doc(db,'orders', id)); }catch(e){ console.warn('delete fail', id, e); }
  }
  selectedOrders.clear();
  updateBulkBar();
}

/* ===== Export & Print (CSV + Print/PDF) ===== */
/* ===== Print & CSV — Report Tables (Invoices-ready) ===== */

/* 1) CSS الطباعة والتقرير */
function ensurePrintStyles(){
  if (document.getElementById('taussil-print-css')) return;
  const css = `
#print-report{
  display:none;
  padding:16px;
  font:11px/1.3 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  color:#111827;
}
#print-report h1{ font-size:16px; margin:0 0 8px; }
#print-report .meta{ font-size:10px; color:#6b7280; margin-bottom:8px; }
#print-report table{ width:100%; border-collapse:collapse; table-layout:fixed; }
#print-report th, #print-report td{
  border:1px solid #e5e7eb;
  padding:4px 6px;
  vertical-align:top;
  white-space:nowrap;           /* سطر واحد */
  overflow:hidden; text-overflow:ellipsis;
  font-size:11px;
}
#print-report th{
  background:#f8fafc;
  text-align:left;
  font-weight:700;
}
#print-report td.num, #print-report th.num{ text-align:right; }
#print-report tfoot td{ font-weight:700; background:#f9fafb; }

@media print{
  body > *:not(#print-report){ display:none !important; }
  #print-report{ display:block !important; }
  thead{ display:table-header-group; }
  tr{ page-break-inside:avoid; }
}
  `.trim();
  const style=document.createElement('style');
  style.id='taussil-print-css';
  style.textContent=css;
  document.head.appendChild(style);
}


/* 2) أدوات تنسيق */
function fmtNum(n){ const x=Number(n); return Number.isFinite(x)? x.toFixed(2) : ''; }
function fmtTsLatn(ts, locale='de-DE'){
  try{
    const d = ts?.toDate ? ts.toDate()
      : (ts instanceof Date ? ts
      : (typeof ts==='number' ? new Date(ts) : null));
    if(!d) return '';
    return new Intl.DateTimeFormat(locale, {
      year:'numeric', month:'2-digit', day:'2-digit',
      hour:'2-digit', minute:'2-digit',
      numberingSystem:'latn', hour12:false
    }).format(d);
  }catch(_){ return ''; }
}
// [DISTANCE-HELPERS-START]
function readDistanceTotalKm(o){
  const v = o?.distance_km_total
        ?? o?.distance?.km_total
        ?? o?.distanceTotalKm
        ?? o?.distance_km
        ?? o?.distanceKm
        ?? null;
  const n = Number(v);
  return Number.isFinite(n) ? n : 0;
}
function readDistanceBillableKm(o){
  const v = o?.distance_km_billable
        ?? o?.distance?.km_billable
        ?? o?.distanceBillableKm
        ?? null;
  const n = Number(v);
  return Number.isFinite(n) ? n : 0;
}
function fmtKm(n){
  const x = Number(n);
  return Number.isFinite(x) ? x.toFixed(2) + ' km' : '—';
}
async function calcRouteDistanceKm(o){
  try{
    // 1) لو موجودة مسافة في الداتا بأي شكل، استخدمها
    const kmInline = readDistanceKm(o);
    if (kmInline && Number.isFinite(kmInline)) return kmInline;

    // 2) إن ما في Google أو ما في عناوين، ارجع null
    if (!window.google?.maps) return null;
    const restAddr = o?.restaurant?.address_text || o?.restaurant?.addressText || '';
    const dropAddr = o?.customer?.address_text   || o?.toAddress || '';
    if(!restAddr || !dropAddr) return null;

    // 3) Geocode بسيط ثم Directions
    const g = new google.maps.Geocoder();
    const geocode = (address)=> new Promise(res=>{
      g.geocode({address}, (r, s)=> res(s==='OK' && r[0] ? r[0].geometry.location : null));
    });
    const A = await geocode(restAddr);
    const B = await geocode(dropAddr);
    if(!A || !B) return null;

    const svc = new google.maps.DirectionsService();
    const route = await new Promise(res=>{
      svc.route({origin:A, destination:B, travelMode:google.maps.TravelMode.DRIVING},
        (r, s)=> res(s==='OK' ? r : null));
    });
    const leg = route?.routes?.[0]?.legs?.[0] || null;
    const meters = leg?.distance?.value;
    return Number.isFinite(meters) ? meters/1000 : null;
  }catch(_){ return null; }
}
/* ===== [CASH-HELPERS] Payment & Cash ===== */
function paymentMethodRaw(o){
  return String(
    o?.payment?.method ??
    o?.payment?.type ??
    o?.paymentMethod ??
    o?.payMethod ??
    o?.paytype ??
    o?.zahlung ??
    o?.zahlungsmethode ??
    ''
  ).toLowerCase();
}
function isCashOrder(o){
  const m = paymentMethodRaw(o);
  if (m.includes('bar') || m.includes('cash') || m.includes('cod')) return true;
  if (o?.cash === true || o?.isCash === true || o?.cod === true) return true;
  return false;
}
function readOrderTotalEUR(o){
  const v = o?.total ?? o?.totalPrice ?? o?.grandTotal ??
            o?.amount ?? o?.priceTotal ?? o?.sum ?? o?.price;
  const n = Number(v);
  return Number.isFinite(n) ? n : 0;
}
function readCashDueEUR(o){
  // حاول استعمال حقل صريح إن وُجد
  const explicit = o?.cashDue ?? o?.amountDue ?? o?.amount_cash ??
                   o?.cash_amount ?? o?.amountToCollect ?? o?.toCollect;
  const en = Number(explicit);
  if (Number.isFinite(en)) return en;

  // خلاف ذلك: إن وُجد total استخدمه؛ وإلا price + (serviceFee + distanceFee)
  const total = readOrderTotalEUR(o);
  if (total) return total;

  const price = Number(o?.price) || 0;
  const sFee  = Number(readServiceFee(o)) || 0;
  const dFee  = Number(readDistanceFee(o)) || 0;
  return price + sFee + dFee;
}

// [DISTANCE-HELPERS-END]

function getAllOrdersLoaded(){ return Array.isArray(orders)? orders : []; }
function getVisibleOrderIds(){
  const wrap = document.getElementById('orders-log');
  if(!wrap) return [];
  return Array.from(wrap.querySelectorAll('.tr input.order-select[data-id]'))
    .map(el => el.getAttribute('data-id')).filter(Boolean);
}
function getVisibleOrders(){
  const ids = getVisibleOrderIds();
  if(ids.length===0) return [];
  const map = new Map(orders.map(o=>[o.id,o]));
  return ids.map(id => map.get(id)).filter(Boolean);
}
/* 4) CSV عام */
function exportCsv(rows, filenameTag){
  const headers = [
    'NrOrCode','OrderId','Restaurant','RestaurantPhone','Driver','DriverPhone',
    'Platform','Qty','PriceEUR','DeliveryFeeEUR','Status','PickupTime','CreatedAt','UpdatedAt',
    'Payment','CashDueEUR',
    'DistanceKmBillable','DistanceKmTotal','DistanceFeeEUR','ServiceFeeEUR'
  ];

  const esc = v => {
    if (v === null || v === undefined) return '';
    const s = String(v).replace(/"/g,'""');
    return /[",\n]/.test(s) ? `"${s}"` : s;
  };
  const toFixedOrEmpty = (n)=> Number.isFinite(n)? n.toFixed(2) : '';

  const rec = (o) => {
    const nrOr   = (o.nr!=null? `#${o.nr}` : (o.shortCode || (o.id || '')));
    const plat   = Array.isArray(o.platform)? o.platform.join(' / ') : (o.platform||'');
    const price  = Number.isFinite(Number(o.price)) ? Number(o.price).toFixed(2) : '';
    const _del = Number(
  o?.deliveryFee ??
  o?.delivery_fee ??
  o?.liefergebuehr ?? o?.lieferGebuehr ??
  o?.feeDelivery ??
  o?.pricing?.deliveryFee ?? o?.meta?.deliveryFee ??
  (o?.serviceFee == null ? o?.fee : null)
);
const delFee = Number.isFinite(_del) ? _del.toFixed(2) : '';

    const pay    = isCashOrder(o) ? 'cash' : (paymentMethodRaw(o)||'online');
    const cash   = isCashOrder(o) ? Number(readCashDueEUR(o)).toFixed(2) : '';

    const distBill  = toFixedOrEmpty(Number(readDistanceBillableKm(o)));
    const distTotal = toFixedOrEmpty(Number(readDistanceTotalKm(o)));
    const distFee   = toFixedOrEmpty(Number(readDistanceFee(o)));
    const svcFee    = toFixedOrEmpty(Number(readServiceFee(o)));

    return [
      nrOr, o.id||'', o.restaurant?.name||'', o.restaurant?.phone||'',
      o.driver?.fullName||'', o.driver?.phone||'',
      plat, Number(o.qty||0), price, delFee, o.status||'',
      o.pickupTime||'', fmtTsLatn(o.createdAt), fmtTsLatn(o.updatedAt),
      pay, cash,
      distBill, distTotal, distFee, svcFee
    ].map(esc).join(',');
  };

  const csv = [headers.join(','), ...rows.map(rec)].join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url  = URL.createObjectURL(blob);
  const a = document.createElement('a');
  const tag = filenameTag || new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
  a.href = url; a.download = `taussil-orders_${tag}.csv`;
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}


/* 5) شريط الأزرار */
function ensureExportBar(){
  const logWrap = document.getElementById('orders-log');
  if(!logWrap) return;

  let bar = document.getElementById('orders-export-bar');
  if(!bar){
    bar = document.createElement('div');
    bar.id = 'orders-export-bar';
    bar.style.cssText = 'display:flex;gap:8px;align-items:center;justify-content:flex-end;margin:8px 0;';
    bar.innerHTML = `<button id="btn-export-open" class="btn">📦 Export…</button>`;
    logWrap.parentElement?.insertBefore(bar, logWrap);
  }
/* ===== Export & Print – wiring (Cash filter + columns) ===== */
const EXPORT_COLS_DEF = [
  { id:'nr',        label:'NrOrCode',        get:o => (o.nr!=null? `#${o.nr}` : (o.shortCode || o.id || '')) },
  { id:'orderId',   label:'OrderId',         get:o => o.id || '' },
  { id:'rest',      label:'Restaurant',      get:o => o.restaurant?.name || '' },
  { id:'restPhone', label:'RestaurantPhone', get:o => o.restaurant?.phone || '' },
  { id:'driver',    label:'Driver',          get:o => o.driver?.fullName || '' },
  { id:'driverTel', label:'DriverPhone',     get:o => o.driver?.phone || '' },
  { id:'platform',  label:'Platform',        get:o => Array.isArray(o.platform)? o.platform.join(' / ') : (o.platform||'') },
  { id:'qty',       label:'Qty',             get:o => Number(o.qty||0) },
  { id:'price',     label:'PriceEUR',        get:o => Number.isFinite(Number(o.price)) ? Number(o.price).toFixed(2) : '' },

  // لا نزيل "DeliveryFeeEUR" القديمة (تجميعية)، فقط نضيف حقول أدق أدناه
  { id:'fee', label:'DeliveryFeeEUR',  get:o => {
  const n = Number(
    o?.deliveryFee ??
    o?.delivery_fee ??
    o?.liefergebuehr ?? o?.lieferGebuehr ??
    o?.feeDelivery ??
    o?.pricing?.deliveryFee ?? o?.meta?.deliveryFee ??
    (o?.serviceFee == null ? o?.fee : null) // توافق قديم فقط إذا ما في serviceFee
  );
  return Number.isFinite(n) ? n.toFixed(2) : '';
}},


  { id:'status',    label:'Status',          get:o => o.status || '' },
  { id:'pickup',    label:'PickupTime',      get:o => o.pickupTime || '' },
  { id:'created',   label:'CreatedAt',       get:o => fmtTsLatn(o.createdAt) },
  { id:'updated',   label:'UpdatedAt',       get:o => fmtTsLatn(o.updatedAt) },

  // الدفع والكاش
  { id:'payment',   label:'Payment',         get:o => isCashOrder(o)? 'cash' : (paymentMethodRaw(o)||'online') },
  { id:'cashdue',   label:'CashDueEUR',      get:o => isCashOrder(o)? Number(readCashDueEUR(o)).toFixed(2) : '' },

  // ===== الحقول الجديدة المطلوبة =====
  { id:'distBill',  label:'DistanceKmBillable', get:o => {
      const n = Number(readDistanceBillableKm(o)); return Number.isFinite(n)? n.toFixed(2) : '';
    }
  },
  { id:'distTotal', label:'DistanceKmTotal',    get:o => {
      const n = Number(readDistanceTotalKm(o)); return Number.isFinite(n)? n.toFixed(2) : '';
    }
  },
  { id:'distFee',   label:'DistanceFeeEUR',     get:o => {
      const n = Number(readDistanceFee(o));     return Number.isFinite(n)? n.toFixed(2) : '';
    }
  },
  { id:'svcFee',    label:'ServiceFeeEUR',      get:o => {
      const n = Number(readServiceFee(o));      return Number.isFinite(n)? n.toFixed(2) : '';
    }
  },
];


function uniqueRestaurantsFromOrders(){
  const set = new Set();
  (orders||[]).forEach(o=>{
    const nm = o?.restaurant?.name;
    if(nm) set.add(nm);
  });
  return Array.from(set).sort((a,b)=>a.localeCompare(b));
}
// [EXPORT] جمع السائقين من الطلبات الظاهرة
function uniqueDriversFromOrders(){
  const map = new Map();
  (orders||[]).forEach(o=>{
    const d = o?.driver;
    if(d?.id){
      const name = d.fullName || d.name || d.email || d.id;
      if(!map.has(d.id)) map.set(d.id, name);
    }
  });
  return Array.from(map.entries())
    .map(([id,name])=>({id,name}))
    .sort((a,b)=> a.name.localeCompare(b.name));
}

function fillExportRestaurantSelect(){
  const sel = document.getElementById('export-restaurant');
  if(!sel) return;
  const last = sel.value; // حاول الحفاظ على الاختيار
  const names = uniqueRestaurantsFromOrders();
  sel.innerHTML = `<option value="">All</option>` + names.map(n=>`<option>${n}</option>`).join('');
  if(names.includes(last)) sel.value = last;
}
function collectExportFilters(){
  const rest   = document.getElementById('export-restaurant')?.value || '';
  const driver = document.getElementById('export-driver')?.value || '';
  const cashOnly = !!document.getElementById('export-cash-only')?.checked;
  const from = document.getElementById('export-from')?.value || '';
  const to   = document.getElementById('export-to')?.value   || '';
  const stSel = document.getElementById('export-status');
  const statuses = stSel ? Array.from(stSel.selectedOptions).map(o=>o.value) : [];
  return { rest, driver, cashOnly, from, to, statuses };
}


function fillExportDriverSelect(){
  const sel = document.getElementById('export-driver');
  if(!sel) return;
  const last = sel.value;
  const drivers = uniqueDriversFromOrders();
  sel.innerHTML = `<option value="">All</option>` +
    drivers.map(d=>`<option value="${d.id}">${d.name}</option>`).join('');
  if(drivers.some(d=> d.id===last)) sel.value = last;
}

function fillExportColsUI(){
  const host = document.getElementById('export-cols');
  if(!host) return;
  // افتراضيًا: كل الأعمدة مفعّلة
  host.innerHTML = EXPORT_COLS_DEF.map(c => `
    <label class="small" style="display:flex;align-items:center;gap:6px">
      <input type="checkbox" data-col="${c.id}" checked> <span>${c.label}</span>
    </label>
  `).join('');
}



function tsFromDateStringInclusiveEnd(dateStr){
  if(!dateStr) return null;
  const d = new Date(dateStr + 'T23:59:59');
  return d.getTime();
}

function orderMatchesFilters(o, f){
  // مطعم
  if(f.rest && (o?.restaurant?.name || '') !== f.rest) return false;
    // سائق (القيمة = driver.id)
  if(f.driver){
    if((o?.driver?.id || '') !== f.driver) return false;
  }

  // كاش؟
  if(f.cashOnly && !isCashOrder(o)) return false;
  // حالة
  if(f.statuses && f.statuses.length){
    if(!f.statuses.includes(o?.status || '')) return false;
  }
  // تاريخ (على createdAt)
  const createdMs = (()=> {
    try{
      const c = o?.createdAt;
      if(c?.toDate) return c.toDate().getTime();
      if(c instanceof Date) return c.getTime();
      if(typeof c === 'number') return c;
    }catch(_){}
    return null;
  })();
  if(f.from){
    const fromMs = new Date(f.from).getTime();
    if(createdMs && createdMs < fromMs) return false;
  }
  if(f.to){
    const toMs = tsFromDateStringInclusiveEnd(f.to);
    if(createdMs && createdMs > toMs) return false;
  }
  return true;
}

function filterOrdersForExport(){
  const f = collectExportFilters();
  const all = Array.isArray(orders)? orders : [];
  return all.filter(o => orderMatchesFilters(o, f));
}

function selectedExportColIds(){
  const boxes = document.querySelectorAll('#export-cols input[type="checkbox"][data-col]');
  const ids = Array.from(boxes).filter(b=>b.checked).map(b=>b.getAttribute('data-col'));
  return ids.length ? ids : EXPORT_COLS_DEF.map(c=>c.id);
}

function buildPrintReport(rows, colIds){
  ensurePrintStyles();
  let host = document.getElementById('print-report');
  if(!host){
    host = document.createElement('div');
    host.id = 'print-report';
    document.body.appendChild(host);
  }
  const cols = EXPORT_COLS_DEF.filter(c => colIds.includes(c.id));
  const thead = `<tr>${cols.map(c=>`<th>${c.label}</th>`).join('')}</tr>`;
  const tbody = rows.map(o=>{
    const numericIds = ['qty','price','fee','cashdue','distBill','distTotal','distFee','svcFee'];
const tds = cols.map(c=>`<td class="${numericIds.includes(c.id)?'num':''}">${c.get(o)}</td>`).join('');

    return `<tr>${tds}</tr>`;
  }).join('');
  host.innerHTML = `
    <h1>Orders Report</h1>
    <div class="meta">${rows.length} rows • ${new Date().toLocaleString()}</div>
    <table><thead>${thead}</thead><tbody>${tbody}</tbody></table>
  `;
}

let __exportHandlersBound = false;
function openExportModal(){
  fillExportRestaurantSelect();
  fillExportDriverSelect();
  fillExportColsUI();
  document.getElementById('export-modal')?.classList.add('open');

  if(!__exportHandlersBound){
    __exportHandlersBound = true;

    document.getElementById('export-close')?.addEventListener('click', ()=>{
      document.getElementById('export-modal')?.classList.remove('open');
    });

    // CSV
    document.getElementById('export-run-csv')?.addEventListener('click', ()=>{
      const rows = filterOrdersForExport();
      exportCsv(rows); // يستخدم الأعمدة الثابتة + يشمل Payment/CashDue
      const msg = document.getElementById('export-msg');
      if(msg) msg.textContent = `${rows.length} rows exported (CSV).`;
    });

    // PDF / Print
    document.getElementById('export-run-pdf')?.addEventListener('click', ()=>{
      const rows = filterOrdersForExport();
      const colIds = selectedExportColIds();
      buildPrintReport(rows, colIds);
      window.print();
    });

    // Excel (حل بسيط: HTML-as-Excel، بدون مكتبات خارجية)
    document.getElementById('export-run-xlsx')?.addEventListener('click', ()=>{
      const rows = filterOrdersForExport();
      const colIds = selectedExportColIds();
      const cols = EXPORT_COLS_DEF.filter(c => colIds.includes(c.id));

      // ابني HTML table كملف xls (يفتح في إكسل)
      const thead = `<tr>${cols.map(c=>`<th>${c.label}</th>`).join('')}</tr>`;
      const tbody = rows.map(o=>{
        const tds = cols.map(c=>`<td>${c.get(o)}</td>`).join('');
        return `<tr>${tds}</tr>`;
      }).join('');
      const html = `<table>${thead}${tbody}</table>`;
      const blob = new Blob([html], {type:'application/vnd.ms-excel'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `taussil-orders_${new Date().toISOString().slice(0,10)}.xls`;
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);

      const msg = document.getElementById('export-msg');
      if(msg) msg.textContent = `${rows.length} rows exported (Excel).`;
    });
  }
}

  const btn = document.getElementById('btn-export-open');
  if(btn) btn.onclick = openExportModal;
}



/* ===== Pending Approvals (Admin Inbox) ===== */
let pendingDrivers = [];
let pendingRestaurantUsers = [];   // users with role == 'restaurant' & approved == false
let pendingRestaurantDocs  = [];   // restaurants collection with approved == false

let unsubPendingDrv=null, unsubPendingRestUsers=null, unsubPendingRestDocs=null;
// === FLEET pending state ===
let pendingFleets = [];
let unsubPendingFleets = null;

/* UI containers (injected above drivers/restaurants grids) */
function ensurePendingUI(){
  const dgrid = document.getElementById('drivers-grid');
  if(dgrid && !document.getElementById('pending-drivers-wrap')){
    const wrap = document.createElement('div');
    wrap.id = 'pending-drivers-wrap';
    wrap.style.cssText='margin:10px 0; padding:10px; border:1px solid #e5e7eb; border-radius:10px; background:#fff';
    wrap.innerHTML = `
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
        <strong>Driver approvals</strong>
        <span id="pending-drivers-count" class="badge gray">0</span>
      </div>
      <div id="pending-drivers" style="display:grid; gap:8px"></div>
    `;
    dgrid.parentElement?.insertBefore(wrap, dgrid);
  }

  const rgrid = document.getElementById('restaurants-grid');
  if(rgrid && !document.getElementById('pending-restaurants-wrap')){
    const wrap = document.createElement('div');
    wrap.id = 'pending-restaurants-wrap';
    wrap.style.cssText='margin:10px 0; padding:10px; border:1px solid #e5e7eb; border-radius:10px; background:#fff';
    wrap.innerHTML = `
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
        <strong>Restaurant approvals</strong>
        <span id="pending-restaurants-count" class="badge gray">0</span>
      </div>
      <div id="pending-restaurants" style="display:grid; gap:8px"></div>
    `;
    rgrid.parentElement?.insertBefore(wrap, rgrid);
  }
}
// === Fleet lead approvals box ===
const fleetsGridAnchor = document.getElementById('drivers-grid') || document.getElementById('restaurants-grid');
if (fleetsGridAnchor && !document.getElementById('pending-fleets-wrap')) {
  const wrap = document.createElement('div');
  wrap.id = 'pending-fleets-wrap';
  wrap.style.cssText='margin:10px 0; padding:10px; border:1px solid #e5e7eb; border-radius:10px; background:#fff';
  wrap.innerHTML = `
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
      <strong>Fleet lead approvals</strong>
      <span id="pending-fleets-count" class="badge gray">0</span>
    </div>
    <div id="pending-fleets" style="display:grid; gap:8px"></div>
  `;
  fleetsGridAnchor.parentElement?.insertBefore(wrap, fleetsGridAnchor);
}

/* ===== [TAUSSIL-APPROVAL-UI-DRIVERS-START] ===== */
function renderPendingDrivers(){
  const list = document.getElementById('pending-drivers');
  const cnt  = document.getElementById('pending-drivers-count');
  if(!list || !cnt) return;
  const rows = (pendingDrivers||[]).filter(u => String(u.status||'pending').toLowerCase() !== 'rejected');
  cnt.textContent = rows.length;

  list.innerHTML = rows.length ? rows.map(u=>`
    <div class="tr" style="display:flex;align-items:center;gap:10px;border:1px solid #e5e7eb;border-radius:10px;padding:8px">
      <div class="avatar" style="width:28px;height:28px;background:#f3f4f6;border-radius:50%"></div>
      <div style="flex:1;min-width:0">
        <div style="font-weight:700">${u.firstName? (u.firstName + (u.lastName? (' ' + u.lastName) : '')) : (u.name||u.email||u.id)}</div>
        <div class="small" style="opacity:.8">${u.phone||''}</div>
      </div>
      <div style="display:flex;gap:6px">
        <button class="btn"           data-approve-driver="${u.id}" style="height:32px">${t('approval.approve')}</button>
        <button class="btn secondary" data-reject-driver="${u.id}"  style="height:32px">${t('approval.reject')}</button>
      </div>
    </div>
  `).join('') : `<div class="small" style="opacity:.7">No pending drivers</div>`;
}
/* ===== [TAUSSIL-APPROVAL-UI-DRIVERS-END] ===== */

/* ===== [TAUSSIL-APPROVAL-UI-RESTS-START] ===== */
function renderPendingRestaurants(){
  const list = document.getElementById('rest-pending-list');
  const cnt  = document.getElementById('rest-pend-count');
  if(!list || !cnt) return;

  // نجمع من مصدرين: users(role=restaurant, approved=false) + restaurants(approved=false)
  const users = (pendingRestaurantUsers||[]).map(u=>({
    kind: 'user',
    id: u.id,
    name: u.name || u.displayName || u.email || u.id,
    phone: u.phone || '',
    email: u.email || '',
    address: u.address_text || u.address || '',
    createdAt: u.createdAt || null
  }));

  const docs = (pendingRestaurantDocs||[]).map(r=>({
    kind: 'doc',
    id: r.id,
    name: r.name || r.id,
    phone: r.phone || '',
    email: r.email || '',
    address: r.address_text || r.address || '',
    createdAt: r.createdAt || null
  }));

  let rows = users.concat(docs);

  // فلاتر اليمين
  const fName = (document.getElementById('rest-pend-name')?.value||'').trim().toLowerCase();
  const fCity = (document.getElementById('rest-pend-city')?.value||'').trim().toLowerCase();
  const fFrom = document.getElementById('rest-pend-from')?.value || '';
  const fTo   = document.getElementById('rest-pend-to')?.value   || '';
  const fromD = fFrom ? new Date(fFrom) : null;
  const toD   = fTo   ? new Date(fTo+'T23:59:59') : null;

  const getCity = (row)=>{
    const txt = row.address || '';
    const parts = String(txt).split(',').map(s=>s.trim());
    return (parts[parts.length-1] || '').toLowerCase();
  };
  const getCreatedTs = (row)=>{
    const ts = row.createdAt || null;
    return ts?.toDate ? ts.toDate() : (ts instanceof Date ? ts : null);
  };

  rows = rows
    .filter(x=>{
      const nm = String(x.name||'').toLowerCase();
      const city = getCity(x);
      const inName = !fName || nm.includes(fName);
      const inCity = !fCity || city.includes(fCity);
      const ct = getCreatedTs(x);
      const inDate = (!fromD && !toD) ||
                     (!ct ? true :
                       ((!fromD || ct>=fromD) && (!toD || ct<=toD)));
      // استثناء من تم رفضهم
      const status = String(x.status||'pending').toLowerCase();
      const notRejected = status !== 'rejected';
      return inName && inCity && inDate && notRejected;
    });

  cnt.textContent = rows.length;

  list.innerHTML = rows.length ? rows.map(x=>`
    <div class="card" style="padding:10px">
      <div class="flex">
        <div class="logo" style="width:26px;height:26px;border-radius:6px;background:#f3f4f6"></div>
        <div style="min-width:0">
          <div style="font-weight:800;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${x.name}</div>
          <div class="small" style="opacity:.8">${x.phone || x.email || ''}</div>
          <div class="small" style="opacity:.8">${x.address || ''}</div>
        </div>
        <span class="right"></span>
        ${
          x.kind==='user'
          ? `
            <button class="btn"           data-approve-restaurant-user="${x.id}" style="height:32px">Approve</button>
            <button class="btn secondary" data-reject-restaurant-user="${x.id}"  style="height:32px">Reject</button>
          `
          : `
            <button class="btn"           data-approve-restaurant-doc="${x.id}"  style="height:32px">Approve</button>
            <button class="btn secondary" data-reject-restaurant-doc="${x.id}"   style="height:32px">Reject</button>
          `
        }
      </div>
    </div>
  `).join('') : `<div class="small" style="opacity:.7">No pending restaurants.</div>`;
}
// Approved filters
['rest-appr-name','rest-appr-city','rest-appr-from','rest-appr-to']
  .forEach(id => document.getElementById(id)?.addEventListener('input', renderRestaurants));

// Pending filters
['rest-pend-name','rest-pend-city','rest-pend-from','rest-pend-to']
  .forEach(id => document.getElementById(id)?.addEventListener('input', renderPendingRestaurants));
  // Fleets filters
['fleet-appr-name','fleet-appr-city','fleet-pend-name','fleet-pend-city']
  .forEach(id => document.getElementById(id)?.addEventListener('input', renderFleets));

// Splitter drag (Restaurants tab)
(function enableRestaurantSplitter(){
  const host = document.getElementById('rest-split');
  const sash = document.getElementById('rest-sash');
  if(!host || !sash) return;

  let down=false, startX=0, startLeft=0, total=0;

  function parseCols(){
    const cs = getComputedStyle(host).gridTemplateColumns.split(' ');
    // نتوقع: [colLeft, '6px', colRight]
    return cs;
  }

  sash.addEventListener('pointerdown', (e)=>{
    down = true;
    sash.setPointerCapture(e.pointerId);
    startX = e.clientX;
    const rect = host.getBoundingClientRect();
    total = rect.width;
    // احصل على عرض العمود الأيسر الحالي
    const leftEl = host.children[0];
    startLeft = leftEl.getBoundingClientRect().width;
  });

  sash.addEventListener('pointermove', (e)=>{
    if(!down) return;
    const dx = e.clientX - startX;
    let newLeft = Math.max(200, Math.min(total-200, startLeft + dx)); // حدود دنيا
    const leftFr = (newLeft/total)*100;
    host.style.gridTemplateColumns = `${leftFr}% 6px ${100-leftFr}%`;
  });

  const stop = ()=>{ down=false; try{ sash.releasePointerCapture?.(); }catch(_){ } };
  sash.addEventListener('pointerup', stop);
  sash.addEventListener('pointercancel', stop);
})();
// Splitter drag (Fleets tab)
(function enableFleetSplitter(){
  const host = document.getElementById('fleet-split');
  const sash = document.getElementById('fleet-sash');
  if(!host || !sash) return;

  let down=false, startX=0, startLeft=0, total=0;

  sash.addEventListener('pointerdown', (e)=>{
    down = true;
    sash.setPointerCapture(e.pointerId);
    startX = e.clientX;
    const rect = host.getBoundingClientRect();
    total = rect.width;
    const leftEl = host.children[0];
    startLeft = leftEl.getBoundingClientRect().width;
  });

  sash.addEventListener('pointermove', (e)=>{
    if(!down) return;
    const dx = e.clientX - startX;
    let newLeft = Math.max(200, Math.min(total-200, startLeft + dx));
    const leftFr = (newLeft/total)*100;
    host.style.gridTemplateColumns = `${leftFr}% 6px ${100-leftFr}%`;
  });

  const stop = ()=>{ down=false; try{ sash.releasePointerCapture?.(); }catch(_){ } };
  sash.addEventListener('pointerup', stop);
  sash.addEventListener('pointercancel', stop);
})();

// === Fleet pending renderer ===
function renderPendingFleets(){
  const list = document.getElementById('pending-fleets');
  const cnt  = document.getElementById('pending-fleets-count');
  if(!list || !cnt) return;

  const rows = (pendingFleets||[]);
  cnt.textContent = rows.length;

  list.innerHTML = rows.length ? rows.map(u => {
    const app = u.fleetApplication || {};
    const company = app.company || {};
    const addr = app.address || {};
    const orgName = company.name || '(—)';
    const owner   = [company.ownerFirst||'', company.ownerLast||''].join(' ').trim();
    const email   = u.email || company.email || '';
    const phone   = company.phone || '';
    const city    = addr.city || '';
    const drivers = Number(app.driversCount||0);

    return `
      <div class="tr" style="display:flex;align-items:center;gap:10px;border:1px solid #e5e7eb;border-radius:10px;padding:8px">
        <div style="flex:1;min-width:0">
          <div style="font-weight:700">${orgName}${owner? ' — '+owner : ''}</div>
          <div class="small" style="opacity:.8">${email}${phone? ' · '+phone : ''}</div>
          <div class="small" style="opacity:.8">${city} • Drivers: ${drivers}</div>
        </div>
        <div style="display:flex;gap:6px">
          <button class="btn"           data-approve-fleet="${u.id}" style="height:32px">${t('approval.approve')||'Approve'}</button>
          <button class="btn secondary" data-reject-fleet="${u.id}"  style="height:32px">${t('approval.reject')||'Reject'}</button>
        </div>
      </div>
    `;
  }).join('') : `<div class="small" style="opacity:.7">No pending fleet leads</div>`;
}
function renderFleetsApproved(){
  const list = document.getElementById('fleet-approved-list');
  const cnt  = document.getElementById('fleet-appr-count');
  if(!list || !cnt) return;
  const fName = (document.getElementById('fleet-appr-name')?.value||'').trim().toLowerCase();
  const fCity = (document.getElementById('fleet-appr-city')?.value||'').trim().toLowerCase();
  const rows = (fleetsApproved||[]).filter(f=>{
    const inName = !fName || String(f.name||'').toLowerCase().includes(fName);
    const inCity = !fCity || String(f.city||'').toLowerCase().includes(fCity);
    return inName && inCity;
  });
  cnt.textContent = rows.length;
  list.innerHTML = rows.length ? rows.map(f=>`
    <div class="card" style="padding:10px">
      <div class="flex" style="align-items:flex-start">
        <div style="flex:1;min-width:0">
          <div style="font-weight:800;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${f.name}</div>
          <div class="small" style="opacity:.8">${[f.owner, f.phone].filter(Boolean).join(' · ')}</div>
          <div class="small" style="opacity:.8">${[f.email, f.city].filter(Boolean).join(' · ')}</div>
        </div>
        <span class="right"></span>
        <div class="row" style="gap:6px;flex-wrap:wrap">
          <button class="btn secondary" data-user-details data-kind="fleet" data-id="${f.id}">${t('details')||'Details'}</button>
          <button class="btn" data-fleet-drivers="${f.id}">Drivers</button>
        </div>
      </div>
    </div>
  `).join('') : `<div class="small" style="opacity:.7">No approved fleets.</div>`;
}
function renderFleetsPending(){
  const list = document.getElementById('fleet-pending-list');
  const cnt  = document.getElementById('fleet-pend-count');
  if(!list || !cnt) return;
  const fName = (document.getElementById('fleet-pend-name')?.value||'').trim().toLowerCase();
  const fCity = (document.getElementById('fleet-pend-city')?.value||'').trim().toLowerCase();
  const rows = (pendingFleets||[]).filter(u=>{
    const app = u.fleetApplication || {};
    const company = app.company || {};
    const addr = app.address || {};
    const name = company.name || u.name || u.email || u.id;
    const city = addr.city || app.targetCity || '';
    const inName = !fName || String(name||'').toLowerCase().includes(fName);
    const inCity = !fCity || String(city||'').toLowerCase().includes(fCity);
    const notRejected = String(u.status||'pending').toLowerCase() !== 'rejected';
    return inName && inCity && notRejected;
  });
  cnt.textContent = rows.length;
  list.innerHTML = rows.length ? rows.map(u=>{
    const app = u.fleetApplication || {};
    const company = app.company || {};
    const addr = app.address || {};
    const orgName = company.name || u.name || u.email || u.id;
    const owner   = [company.ownerFirst||'', company.ownerLast||''].join(' ').trim();
    const email   = u.email || company.email || '';
    const phone   = company.phone || '';
    const city    = addr.city || app.targetCity || '';
    const drivers = Number(app.driversCount||0);
    return `
      <div class="card" style="padding:10px">
        <div class="flex">
          <div style="flex:1;min-width:0">
            <div style="font-weight:800;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${orgName}${owner? ' — '+owner : ''}</div>
            <div class="small" style="opacity:.8">${[email, phone].filter(Boolean).join(' · ')}</div>
            <div class="small" style="opacity:.8">${city} • Drivers: ${drivers}</div>
          </div>
          <span class="right"></span>
          <div class="row" style="gap:6px;flex-wrap:wrap">
            <button class="btn"           data-approve-fleet="${u.id}">${t('approval.approve')||'Approve'}</button>
            <button class="btn secondary" data-reject-fleet="${u.id}">${t('approval.reject')||'Reject'}</button>
            <button class="btn secondary" data-user-details data-kind="fleet" data-id="${u.id}">${t('details')||'Details'}</button>
          </div>
        </div>
      </div>
    `;
  }).join('') : `<div class="small" style="opacity:.7">No pending fleets.</div>`;
}
function renderFleets(){
  if(!document.getElementById('tab-fleets')) return;
  renderFleetsApproved();
  renderFleetsPending();
}
/* ===== [TAUSSIL-APPROVAL-UI-RESTS-END] ===== */
/* ===== Approve/Reject actions (WRITE BOTH approved + status) ===== */
/* ===== [TAUSSIL-APPROVAL-REPO-START] ===== */
async function approveDriver(uid){
  const adminUid = auth.currentUser?.uid || null;
  const basePayload = {
    approved: true,
    status: 'active',
    approvedAt: serverTimestamp(),
    approvedBy: adminUid,
    updatedAt: serverTimestamp()
  };

  try {
    // (1) فعّل المستخدم
    try { await updateDoc(doc(db,'users', uid), basePayload); }
    catch(_) { await setDoc(doc(db,'users', uid), basePayload, { merge:true }); }

    // (2) اقرأ المستخدم لمعرفة الإيميل وربما fleetId
    const uSnap = await getDoc(doc(db,'users', uid));
    if(!uSnap.exists()){
      console.warn('approveDriver: user not found', uid);
      alert('لم يتم العثور على المستخدم.');
      return;
    }
    const u = uSnap.data() || {};
    let fleetId = u.fleetId || null;

    // (3) إن لم يوجد fleetId على المستخدم، استخرجه من driversIndex (بالبريد)
    if(!fleetId){
      const eLower = emailNorm(u.email || '');
      if(!eLower){
        alert('لا يوجد fleetId ولا بريد على المستخدم. تعذر تحديد الأسطول.');
        return;
      }
      const key = await sha256Hex(eLower);
      const idxSnap = await getDoc(doc(db,'driversIndex', key));
      if(idxSnap.exists()){
        const idx = idxSnap.data() || {};
        if (idx.fleetId) fleetId = idx.fleetId;
      }
      if(!fleetId){
        alert('تعذر تحديد الأسطول من driversIndex. تأكد أن الدعوة أنشأت driversIndex بشكل صحيح.');
        return;
      }
      // حفظ fleetId على المستخدم لمرات قادمة
      await setDoc(doc(db,'users', uid), { fleetId, updatedAt: serverTimestamp() }, { merge:true });
    }

    // (4) مرآة السائق تحت وثيقة الأسطول
    await setDoc(
      doc(db,'fleet', fleetId, 'drivers', uid),
      {
        uid,
        firstName: u.firstName ?? null,
        lastName:  u.lastName  ?? null,
        phone:     u.phone     ?? null,
        email:     u.email     ?? null,
        approved:  true,
        active:    true,
        deleted:   false,
        createdAt: u.createdAt ?? serverTimestamp(),
        updatedAt: serverTimestamp()
      },
      { merge:true }
    );

    // (5) حدّث driversIndex → active
    const eLower = emailNorm(u.email || '');
    if(eLower){
      const key = await sha256Hex(eLower);
      await setDoc(
        doc(db,'driversIndex', key),
        {
          emailLower: eLower,
          fleetId,
          uid,
          state: 'active',
          lock: { type:'approval', ref:`fleet/${fleetId}/drivers/${uid}`, updatedAt: serverTimestamp() }
        },
        { merge:true }
      );
    }

    console.log('approveDriver done → fleet/%s/drivers/%s', fleetId, uid);
    alert('تمت الموافقة وربط السائق بأسطوله بنجاح.');
  } catch (e) {
    console.error('approveDriver failed:', (e && e.code) || e);
    alert('فشل التفعيل: ' + (e?.code || e?.message || e));
  }
}


async function rejectDriver(uid){
  const adminUid = auth.currentUser?.uid || null;
  const payload = {
    approved: false,
    status: 'rejected',
    rejectedAt: serverTimestamp(),
    rejectedBy: adminUid,
    updatedAt: serverTimestamp()
  };
  try{ await updateDoc(doc(db,'users', uid), payload); }
  catch(_){ await setDoc(doc(db,'users', uid), payload, { merge:true }); }
}
async function approveRestaurantUser(uid){
  const adminUid = auth.currentUser?.uid || null;
  const payload = {
    approved: true,
    status: 'active',
    approvedAt: serverTimestamp(),
    approvedBy: adminUid,
    updatedAt: serverTimestamp()
  };
  try { await updateDoc(doc(db,'users', uid), payload); }
  catch (_) { await setDoc(doc(db,'users', uid), payload, { merge:true }); }

  // INSERT👇 (بلوك النسخ إلى restaurants)
  try {
    const uSnap = await getDoc(doc(db, "users", uid));
    if (uSnap.exists()) {
      const u = uSnap.data() || {};
      await setDoc(
        doc(db, "restaurants", uid),
        {
          id: uid,
          // الاسم من restName وإن لم يوجد نأخذ الجزء قبل @ من الإيميل
          name: u.restName ?? (u.email ? u.email.split("@")[0] : uid),
          // إضافة حقول الإيميل والهاتف صراحةً
          email: u.email ?? "",
          phone: u.phone ?? "",
          // واجهتك تقرأ address_text أو addressText
          address_text: u.address_text ?? "",
          logoUrl: u.logoUrl ?? "",
          approved: true,
          status: "active",
          createdAt: u.createdAt ?? serverTimestamp(),
          updatedAt: serverTimestamp(),
        },
        { merge: true }
      );
      console.log("Mirrored → restaurants/", uid);
    }
  } catch (e) {
    console.warn("Mirror write failed:", (e && e.code) || e);
  }
  // END
}
// ===== Helpers: email normalize + sha256 (للـ driversIndex) =====
const emailNorm = (s)=> String(s||'').trim().toLowerCase();
async function sha256Hex(str){
  const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(str));
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}

/* ===================== Fleet Ops (Bulk) — BEGIN ===================== */
/* state (isolated) */
const fleetx = {
  selected: new Set(),   // order IDs
  lastRenderTag: 0
};
const $fx = (s)=>document.querySelector(s);

/* small utils (isolated) */
function fleetx_normCity(txt){
  return String(txt||'').trim().toLowerCase();
}
function fleetx_cityFromOrder(o){
  const a = o?.restaurant?.address_text || o?.restaurant?.addressText || '';
  const parts = String(a).split(',').map(s=>s.trim());
  return parts.length ? parts[parts.length-1] : '';
}
function fleetx_orderCode(o){
  return (o.nr!=null? '#'+o.nr : (o.shortCode? '#'+o.shortCode : '#'+(o.id||'—')));
}
function fleetx_updateSelectedBadge(){
  const el = $fx('#fleetx-selected');
  if(el) el.textContent = `${fleetx.selected.size} selected`;
}
function fleetx_resetSelection(){
  fleetx.selected.clear();
  const box = $fx('#fleetx-orders');
  if(box) box.querySelectorAll('input[type=checkbox][data-oid]').forEach(ch=> ch.checked=false);
  const all = $fx('#fleetx-select-all'); if(all) all.checked=false;
  fleetx_updateSelectedBadge();
}

/* filters read */
function fleetx_filters(){
  return {
    city: fleetx_normCity($fx('#fleetx-city')?.value||''),
    status: ($fx('#fleetx-status')?.value || 'Bearbeitung'),
    hideAssigned: !!$fx('#fleetx-hide-assigned')?.checked,
  };
}

/* data builders (read from existing global state: orders, fleetsApproved) */
function fleetx_visibleOrders(){
  const f = fleetx_filters();
  let rows = Array.isArray(orders) ? orders.slice() : [];
  // status filter
  rows = rows.filter(o => String(o.status||'').toLowerCase() === f.status.toLowerCase());
  // city filter (optional)
  if(f.city){
    rows = rows.filter(o => fleetx_normCity(fleetx_cityFromOrder(o)).includes(f.city));
  }
  // hide assigned to a fleet
  if(f.hideAssigned){
    rows = rows.filter(o => !o.fleet || !o.fleet.id);
  }
  // newest first (already sorted globally, but keep)
  return rows;
}

function fleetx_visibleFleets(){
  // fleetsApproved موجودة مسبقًا (موحّدة من وثائق ومستخدمين)
  return Array.isArray(fleetsApproved) ? fleetsApproved.slice() : [];
}

/* rendering */
function fleetx_renderOrders(){
  const host = $fx('#fleetx-orders'); if(!host) return;
  const rows = fleetx_visibleOrders();
  if(!rows.length){
    host.innerHTML = `<div class="small" style="opacity:.7" data-i18n="fleetx.emptyOrders">لا توجد طلبات مطابقة.</div>`;
    return;
  }
  host.innerHTML = rows.map(o=>{
    const rid = o?.restaurant?.id || '';
    const name= o?.restaurant?.name || rid || '—';
    const city= fleetx_cityFromOrder(o) || '—';
    const plat= Array.isArray(o.platform)? o.platform.join(' / ') : (o.platform||'—');
    const qty = Number(o.qty||0);
    const fee = Number(o.price||0);
    const assigned = o?.fleet?.name ? `<span class="chip">Fleet: ${o.fleet.name}</span>` : '';
    return `
      <div class="fx-row">
        <input type="checkbox" data-oid="${o.id}">
        <div class="mono" style="min-width:84px">${fleetx_orderCode(o)}</div>
        <div style="flex:1;min-width:0">
          <div style="font-weight:700;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${name}</div>
          <div class="small" style="opacity:.8">${city} · ${plat} ${assigned}</div>
        </div>
        <div class="badge">${'x'+qty}</div>
        <div class="mono" style="min-width:70px;text-align:right">${fee.toFixed? fee.toFixed(2): fee} €</div>
      </div>`;
  }).join('');

  // bind selection
  host.querySelectorAll('input[type=checkbox][data-oid]').forEach(ch=>{
    ch.onchange = ()=> {
      const id = ch.getAttribute('data-oid');
      if(ch.checked) fleetx.selected.add(id); else fleetx.selected.delete(id);
      fleetx_updateSelectedBadge();
    };
  });
}

function fleetx_renderFleets(){
  const host = $fx('#fleetx-fleets'); if(!host) return;
  const rows = fleetx_visibleFleets();
  const cnt  = $fx('#fleetx-fleet-count'); if(cnt) cnt.textContent = rows.length;

  // عداد الطلبات المعيّنة لكل أسطول (عملي، محليًا)
  const assignedMap = new Map();
  (Array.isArray(orders)? orders: []).forEach(o=>{
    const fid = o?.fleet?.id;
    if(!fid) return;
    assignedMap.set(fid, 1 + (assignedMap.get(fid)||0));
  });

  // تعبئة قائمة اختيار الأسطول في الشريط
  const sel = $fx('#fleetx-fleet-select');
  if(sel && sel.options.length<=1){
    rows.forEach(f=>{
      const opt = document.createElement('option');
      opt.value = f.id; opt.textContent = `${f.name || f.id}${f.city? (' · '+f.city):''}`;
      sel.appendChild(opt);
    });
  }

  if(!rows.length){
    host.innerHTML = `<div class="small" style="opacity:.7" data-i18n="fleetx.emptyFleets">لا توجد أساطيل معتمدة.</div>`;
    return;
  }

  host.innerHTML = rows.map(f=>{
    const asg = assignedMap.get(f.id)||0;
    return `
      <div class="fx-row" style="justify-content:space-between">
        <div style="min-width:0">
          <div style="font-weight:700;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${f.name||f.id}</div>
          <div class="small" style="opacity:.8">${[f.city, f.email, f.phone].filter(Boolean).join(' · ')}</div>
        </div>
        <div class="row" style="gap:6px;align-items:center">
          <span class="badge">Orders: ${asg}</span>
          <button class="btn secondary" data-user-details data-kind="fleet" data-id="${f.id}">${t('details')||'Details'}</button>
        </div>
      </div>`;
  }).join('');
}

function renderFleetX(){
  if($fx('#tab-fleetx')?.hidden) return;  // لا ترسم إن التبويب مخفي
  fleetx_renderOrders();
  fleetx_renderFleets();
  fleetx_updateSelectedBadge();
  // icons
  try{ lucide.createIcons(); }catch(_){}
}

/* actions */
async function fleetx_assignSelected(){
  const ids = [...fleetx.selected];
  if(!ids.length){ alert('No orders selected'); return; }
  const sel = $fx('#fleetx-fleet-select');
  const fid = sel?.value || '';
  if(!fid){ alert('Select a fleet'); return; }

  const f = (Array.isArray(fleetsApproved)? fleetsApproved: []).find(x=>x.id===fid);
  const payload = {
    fleet: { id: fid, name: f?.name || null, city: f?.city || null },
    updatedAt: serverTimestamp()
  };

  // تعيين جماعي (بدون writeBatch لتجنّب تعديل الاستيرادات)
  await Promise.all(ids.map(id => 
    updateDoc(doc(db,'orders', id), payload).catch(()=>
      setDoc(doc(db,'orders', id), payload, {merge:true})
    )
  ));
  fleetx_resetSelection();
  renderFleetX();
}

async function fleetx_unassignSelected(){
  const ids = [...fleetx.selected];
  if(!ids.length){ alert('No orders selected'); return; }

  // نستخدم fleet:null (لا نضيف deleteField لتجنّب تغيير الاستيرادات)
  const payload = { fleet: null, updatedAt: serverTimestamp() };
  await Promise.all(ids.map(id => 
    updateDoc(doc(db,'orders', id), payload).catch(()=>
      setDoc(doc(db,'orders', id), payload, {merge:true})
    )
  ));
  fleetx_resetSelection();
  renderFleetX();
}

function fleetx_roundRobin(arr, k){ // مولّد indices 0..k-1
  let i=0; return ()=> { if(!k) return -1; const r = arr[i%k]; i++; return r; };
}

async function fleetx_autoDistribute(){
  // 1) اختر الطلبات المرئية كمدخل (مع احترام الفلاتر)
  const rows = fleetx_visibleOrders();
  if(!rows.length){ alert('No orders to distribute'); return; }

  // 2) جهّز الأساطيل حسب المدينة
  const fleets = fleetx_visibleFleets();
  if(!fleets.length){ alert('No fleets available'); return; }

  // group orders by city
  const byCity = new Map();
  rows.forEach(o=>{
    const c = fleetx_normCity(fleetx_cityFromOrder(o));
    if(!byCity.has(c)) byCity.set(c, []);
    byCity.get(c).push(o);
  });

  // 3) توزيع بسيط Round-Robin داخل كل مدينة
  const plan = []; // {orderId, fleet}
  const citySumm = []; // preview summary
  byCity.forEach((ordersInCity, cityKey)=>{
    const cityFleets = fleets.filter(f => fleetx_normCity(f.city) === cityKey);
    const pool = cityFleets.length ? cityFleets : fleets; // fallback: كل الأساطيل
    const take = fleetx_roundRobin(pool, pool.length);
    const counts = new Map();
    ordersInCity.forEach(o=>{
      const f = take();
      if(!f) return;
      plan.push({ oid:o.id, fleet: f });
      counts.set(f.id, 1 + (counts.get(f.id)||0));
    });
    // summary
    const line = `${cityKey || '(no city)'} → ` + (pool.length
      ? [...counts.entries()].map(([fid,cnt])=>{
          const fn = pool.find(x=>x.id===fid)?.name || fid;
          return `${fn}: ${cnt}`;
        }).join(' · ')
      : 'No fleets');
    citySumm.push(line);
  });

  if(!plan.length){ alert('No distribution could be prepared'); return; }

  // 4) تأكيد بسيط
  const ok = confirm(`Auto-distribute preview:\n\n` + citySumm.join('\n') + `\n\nApply?`);
  if(!ok) return;

  // 5) تنفيذ
  await Promise.all(plan.map(p=>{
    const payload = {
      fleet: { id: p.fleet.id, name: p.fleet.name || null, city: p.fleet.city || null },
      updatedAt: serverTimestamp()
    };
    return updateDoc(doc(db,'orders', p.oid), payload).catch(()=>
      setDoc(doc(db,'orders', p.oid), payload, {merge:true})
    );
  }));

  fleetx_resetSelection();
  renderFleetX();
}

/* events wiring (isolated) */
['#fleetx-city','#fleetx-status','#fleetx-hide-assigned'].forEach(sel=>{
  document.addEventListener('input', (e)=>{
    if(e.target && e.target.matches(sel)) renderFleetX();
  });
});
document.addEventListener('change', (e)=>{
  if(e.target && e.target.matches('#fleetx-select-all')){
    const check = e.target.checked;
    const box = $fx('#fleetx-orders');
    if(box){
      box.querySelectorAll('input[type=checkbox][data-oid]').forEach(ch=>{
        ch.checked = check;
        const id = ch.getAttribute('data-oid');
        if(check) fleetx.selected.add(id); else fleetx.selected.delete(id);
      });
    }
    fleetx_updateSelectedBadge();
  }
});

$fx('#fleetx-assign')   ?.addEventListener('click', fleetx_assignSelected);
$fx('#fleetx-unassign') ?.addEventListener('click', fleetx_unassignSelected);
$fx('#fleetx-auto')     ?.addEventListener('click', fleetx_autoDistribute);

/* splitter drag (same pattern as others) */
(function fleetx_enableSplitter(){
  const host = $fx('#fleetx-grid'); const sash = host?.querySelector('.fleetx-sash');
  if(!host || !sash) return;
  let down=false, startX=0, startLeft=0, total=0;
  sash.addEventListener('pointerdown', (e)=>{
    down=true; sash.setPointerCapture(e.pointerId);
    startX=e.clientX; const rect=host.getBoundingClientRect(); total=rect.width;
    const leftEl = host.children[0]; startLeft = leftEl.getBoundingClientRect().width;
  });
  sash.addEventListener('pointermove', (e)=>{
    if(!down) return; const dx=e.clientX-startX;
    let newLeft = Math.max(200, Math.min(total-200, startLeft+dx));
    const leftFr=(newLeft/total)*100; host.style.gridTemplateColumns = `${leftFr}% 6px ${100-leftFr}%`;
  });
  const stop=()=>{ down=false; try{sash.releasePointerCapture?.();}catch(_){ } };
  sash.addEventListener('pointerup', stop);
  sash.addEventListener('pointercancel', stop);
})();

/* expose renderer into global cycle safely */
function renderFleetX_Safe(){
  try{ renderFleetX(); }catch(_){}
}
/* ====================== Fleet Ops (Bulk) — END ====================== */

async function rejectRestaurantUser(uid){
  const adminUid = auth.currentUser?.uid || null;
  const payload = {
    approved: false,
    status: 'rejected',
    rejectedAt: serverTimestamp(),
    rejectedBy: adminUid,
    updatedAt: serverTimestamp()
  };
  try{ await updateDoc(doc(db,'users', uid), payload); }
  catch(_){ await setDoc(doc(db,'users', uid), payload, { merge:true }); }
}
async function approveRestaurantDoc(id){
  const adminUid = auth.currentUser?.uid || null;
  const payload = {
    approved: true,
    status: 'active',
    approvedAt: serverTimestamp(),
    approvedBy: adminUid,
    updatedAt: serverTimestamp()
  };
  try{ await updateDoc(doc(db,'restaurants', id), payload); }
  catch(_){ await setDoc(doc(db,'restaurants', id), payload, { merge:true }); }
}
async function rejectRestaurantDoc(id){
  const adminUid = auth.currentUser?.uid || null;
  const payload = {
    approved: false,
    status: 'rejected',
    rejectedAt: serverTimestamp(),
    rejectedBy: adminUid,
    updatedAt: serverTimestamp()
  };
  try{ await updateDoc(doc(db,'restaurants', id), payload); }
  catch(_){ await setDoc(doc(db,'restaurants', id), payload, { merge:true }); }
}
// === Fleet lead approval actions ===
async function approveFleet(uid){
  try{
    const userRef = doc(db,'users', uid);
    const uSnap = await getDoc(userRef);
    if(!uSnap.exists()){ alert('User not found'); return; }
    const u = uSnap.data() || {};
    const app = u.fleetApplication || {};
    const company = app.company || null;
    const address = app.address || null;
    // إنشاء/دمج بطاقة الأسطول
    await setDoc(doc(db,'fleet', uid), {
      uid,
      email: u.email || (company && company.email) || null,
      status: 'active',
      driversCount: Number(app.driversCount||0),
      company,
      address,
      targetCity: app.targetCity || null,
      createdAt: u.createdAt || serverTimestamp(),
      approvedAt: serverTimestamp(),
      updatedAt: serverTimestamp()
    }, { merge:true });
    // تحديث المستخدم للموافقة
    await updateDoc(userRef, {
      approved: true,
      status: 'active',
      updatedAt: serverTimestamp()
    });
    alert('Fleet approved.');
  }catch(e){
    console.error(e);
    alert('Approve failed: ' + (e?.message || e));
  }
}
async function rejectFleet(uid){
  try{
    await setDoc(doc(db,'users', uid), {
      approved: false,
      status: 'rejected',
      rejectedAt: serverTimestamp(),
      rejectedBy: auth.currentUser?.uid || null,
      updatedAt: serverTimestamp()
    }, { merge:true });
    alert('Fleet rejected.');
  }catch(e){
    console.error(e);
    alert('Reject failed: ' + (e?.message || e));
  }
}
/* ===== [TAUSSIL-APPROVAL-REPO-END] ===== */
/* Click handlers (delegated) */
/* ===== [TAUSSIL-APPROVAL-BIND-START] ===== */
document.addEventListener('click', (e)=>{
  const b1 = e.target.closest('[data-approve-driver]');
  if(b1){ approveDriver(b1.getAttribute('data-approve-driver')); }
  const b1r = e.target.closest('[data-reject-driver]');
  if(b1r){ rejectDriver(b1r.getAttribute('data-reject-driver')); }
  const b2 = e.target.closest('[data-approve-restaurant-user]');
  if(b2){ approveRestaurantUser(b2.getAttribute('data-approve-restaurant-user')); }
  const b2r = e.target.closest('[data-reject-restaurant-user]');
  if(b2r){ rejectRestaurantUser(b2r.getAttribute('data-reject-restaurant-user')); }
  const b3 = e.target.closest('[data-approve-restaurant-doc]');
  if(b3){ approveRestaurantDoc(b3.getAttribute('data-approve-restaurant-doc')); }
  const b3r = e.target.closest('[data-reject-restaurant-doc]');
  if(b3r){ rejectRestaurantDoc(b3r.getAttribute('data-reject-restaurant-doc')); }
  // Fleet buttons
// Fleet buttons
const af = e.target.closest('[data-approve-fleet]');
if(af){ approveFleet(af.getAttribute('data-approve-fleet')); }
const rf = e.target.closest('[data-reject-fleet]');
if(rf){ rejectFleet(rf.getAttribute('data-reject-fleet')); }
});
/* ===== [TAUSSIL-APPROVAL-BIND-END] ===== */
/* Realtime listeners for pending */
async function bindPendingRealtime(){
  ensurePendingUI();
  if(!unsubPendingDrv){
  unsubPendingDrv = onSnapshot(
    // لا نقيّد approved == false — نجلب كل السائقين ثم نرشّح محلياً
    query(collection(db,'users'), where('role','==','driver'), limit(200)),
    (snap)=>{
      const all = snap.docs.map(d=>({id:d.id, ...d.data()}));
      // pending = كل من ليس approved === true (واستبعاد المرفوضين)
      pendingDrivers = all.filter(u =>
        u.approved !== true &&
        String(u.status||'pending').toLowerCase() !== 'rejected'
      );

      // التحديث الصحيح للواجهة: هذا يرسم عمود "Pending Drivers" (#drivers-pending)
      renderDrivers();

      // رن جرس فقط عندما يدخل سجل جديد ضمن فئة pending
      snap.docChanges().forEach(ch=>{
        if(ch.type==='added'){
          const u = { id: ch.doc.id, ...ch.doc.data() };
          if(u.approved !== true &&
             String(u.status||'pending').toLowerCase() !== 'rejected'){
            playSound('driver');
          }
        }
      });
    }
  );
}

  if(!unsubPendingRestUsers){
    unsubPendingRestUsers = onSnapshot(
      query(collection(db,'users'), where('role','==','restaurant'), where('approved','==', false), limit(200)),
      (snap)=>{
        /* ===== [TAUSSIL-APPROVAL-FILTER-PENDING-RESTUSERS-START] ===== */
        pendingRestaurantUsers = snap.docs
          .map(d=>({id:d.id, ...d.data()}))
          .filter(u => String(u.status||'pending').toLowerCase() !== 'rejected');
        /* ===== [TAUSSIL-APPROVAL-FILTER-PENDING-RESTUSERS-END] ===== */
        renderPendingRestaurants();
        snap.docChanges().forEach(ch=>{ if(ch.type==='added') playSound('restaurant'); });
      }
    );
  }
  if(!unsubPendingRestDocs){
    try{
      unsubPendingRestDocs = onSnapshot(
        query(collection(db,'restaurants'), where('approved','==', false), limit(200)),
        (snap)=>{
          /* ===== [TAUSSIL-APPROVAL-FILTER-PENDING-RESTDOCS-START] ===== */
          pendingRestaurantDocs = snap.docs
            .map(d=>({id:d.id, ...d.data()}))
            .filter(r => String(r.status||'pending').toLowerCase() !== 'rejected');
          /* ===== [TAUSSIL-APPROVAL-FILTER-PENDING-RESTDOCS-END] ===== */
          renderPendingRestaurants();
          snap.docChanges().forEach(ch=>{ if(ch.type==='added') playSound('restaurant'); });
        }
      );
    }catch(_){
      // إذا ما في حقل approved بالمجموعة، تجاهل هذا السماع
    }
  }
  // Fleet applications (pending)
// Fleet users pending (from users: role=fleet, approved=false)
// Fleet users pending (client-side filter; no approved==false in query)
if(!unsubPendingFleets){
  const likeFleet = (role)=>{
    const r = String(role||'').toLowerCase();
    return r==='fleet' || r==='fleet_lead' || r==='lead';
  };

  unsubPendingFleets = onSnapshot(
    // نأتي بآخر المستخدمين (بدون شرط approved) ثم نرشّح محليًا
    query(collection(db,'users'), orderBy('createdAt','desc'), limit(400)),
    (snap)=>{
      const all = snap.docs.map(d => ({ id:d.id, ...d.data() }));

      // pending = دور أسطول & not approved===true & ليس مرفوض
      pendingFleets = all.filter(u =>
        likeFleet(u.role) &&
        u.approved !== true &&
        String(u.status||'pending').toLowerCase() !== 'rejected'
      );

      // حدّث واجهة تبويب الأساطيل (Approved + Pending)
      renderFleets();

      // رن الجرس فقط عند دخول سجل جديد ضمن pending
      snap.docChanges().forEach(ch=>{
        if(ch.type === 'added'){
          const u = { id: ch.doc.id, ...ch.doc.data() };
          if(likeFleet(u.role) &&
             u.approved !== true &&
             String(u.status||'pending').toLowerCase() !== 'rejected'){
            playSound('restaurant'); // نفس صوت المطاعم
          }
        }
      });
    },
    (err)=> console.warn('fleets listener error:', err?.code||err)
  );
}


}
/* دمج مع دورة الرسم الحالية */
const _origRenderDrivers = renderDrivers;
renderDrivers = function(){
  _origRenderDrivers.apply(this, arguments);
  ensurePendingUI();
  renderPendingDrivers();
  renderPendingFleets(); 
};
const _origRenderRestaurants = renderRestaurants;
renderRestaurants = function(){
  _origRenderRestaurants.apply(this, arguments);
  ensurePendingUI();
  renderPendingRestaurants();
  renderPendingFleets(); 
};
/* ===== Auth guard ===== */
onAuthStateChanged(auth, async (user)=>{
  if(!user){ detachRealtime(); showAdminAuth(true); return; }
  let ok=false;
  try{
    const ds = await getDoc(doc(db,'users', user.uid));
    if(ds.exists()){
      const u=ds.data()||{};
      ok = (u.role==='admin' && u.approved===true);
    }
  }catch(_){}
  if(!ok){
    try{ await signOut(auth); }catch(_){}
    detachRealtime();
    showAdminAuth(true, currentLang==='ar'?'هذا الحساب غير مخوّل كآدمن.':'Dieser Account ist kein Admin.');
    return;
  }
  showAdminAuth(false);
  bindRealtimeOnce();
  bindPendingRealtime(); // NEW: attach pending approvals listeners
});
/* ===== Init ===== */
function renderAll(){
  renderDashboard();
  renderRestaurants();
  renderDrivers();
  renderFleets();        // ← NEW
  renderOrdersLog();
  ensureOrdersBulkUI();
  ensureExportBar(); // NEW
  renderFleetX_Safe();
}
setMuted(isMuted);
translatePage();
lucide.createIcons();
initMiniMap().catch(()=>{});
/* ===== Smart Export (Billing) ===== */
/* ===== Smart Export (Billing) — XLSX (Excel) lazy loader & exporter ===== */
/* 1) Loader كسول للـ XLSX — لا يوقف الملف لو فشل */
let __xlsxMod = null;
async function loadXLSX(){
  if(__xlsxMod) return __xlsxMod;
  try {
    // المحاولة الأولى: unpkg (نسخة .mjs)
    __xlsxMod = await import("https://unpkg.com/xlsx@0.19.3/xlsx.mjs");
    return __xlsxMod;
  } catch(e1){
    console.warn("Primary XLSX import failed, trying fallback...", e1);
    try {
      // المحاولة الثانية: آخر نسخة على jsDelivr
      __xlsxMod = await import("https://cdn.jsdelivr.net/npm/xlsx/xlsx.mjs");
      return __xlsxMod;
    } catch(e2){
      console.error("Both XLSX imports failed", e2);
      return null;
    }
  }
}
/* 2) دالة البناء (لا تعتمد على متغيّر عام؛ نمرّر XLSX صراحةً) */
function buildXlsxCustom(mappedRows, cols, metaText, fileTag, XLSX){
  if(!XLSX || !XLSX.utils){
    console.warn('XLSX ESM not loaded');
    if (typeof exportMsg !== 'undefined' && exportMsg) exportMsg.textContent = 'Excel engine failed to load';
    return;
  }
  // AoA = meta + blank + headers + data + totals
  const headerLine = [metaText || ''];
  const blank = [''];
  const headers = cols.map(c => c.label);
  const dataRows = mappedRows.map(r => cols.map(c => r[c.key] ?? ''));
  // Totals (مرتبطة بالأعمدة المختارة)
  const ordersCount = mappedRows.length;
  let sumQty=0, sumPrice=0, sumFee=0;
  mappedRows.forEach(r=>{ sumQty+=Number(r.qty||0); sumPrice+=Number(r.price||0); sumFee+=Number(r.fee||0); });
  const totalsRow = cols.map((c, idx)=>{
    if(idx===0)          return 'Totals';
    if(c.key==='id')     return ordersCount;
    if(c.key==='qty')    return sumQty;
    if(c.key==='price')  return Number(sumPrice.toFixed(2)); // سننسّق € لاحقًا
    if(c.key==='fee')    return Number(sumFee.toFixed(2));   // سننسّق € لاحقًا
    return '';
  });
  const aoa = [headerLine, blank, headers, ...dataRows, totalsRow];
  // إنشاء الورقة
  const ws = XLSX.utils.aoa_to_sheet(aoa);
  // عرض أعمدة منطقي
  const colWidths = cols.map(c=>{
    if(c.key==='created') return { wch: 22 };
    if(['price','fee'].includes(c.key)) return { wch: 12 };
    if(c.key==='qty') return { wch: 6 };
    return { wch: 16 };
  });
  // ميتا + سطر فاصل + أعمدة البيانات
  ws['!cols'] = [{ wch: 40 }, { wch: 6 }, ...colWidths];
  // تنسيق € لصف التوتال للأعمدة المالية
  const range = XLSX.utils.decode_range(ws['!ref']);
  const lastRow = range.e.r; // صف التوتال
  cols.forEach((c, i)=>{
    if(c.key==='price' || c.key==='fee'){
      const cellAddr = XLSX.utils.encode_cell({ r: lastRow, c: 2 + i }); // +2 بسبب الميتا+الفاصل
      if(ws[cellAddr]) ws[cellAddr].z = '#,##0.00 "€"';
    }
  });
  // إنشاء Workbook وحفظ الملف
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Billing');
  const tag = fileTag || new Date().toISOString().slice(0,10);
  XLSX.writeFile(wb, `taussil_billing_${tag}.xlsx`, { bookType:'xlsx' });
}
/* 3) مستمع زر Excel — يُحمّل XLSX عند الطلب ثم يصدّر */
document.getElementById('export-run-xlsx')?.addEventListener('click', async ()=>{
  // يفترض وجود عناصر ودوال منظومة التصدير لديك:
  // exportMsg, exportRest, exportFrom, exportTo
  // readSelectedStatuses, readSelectedCols
  // queryOrdersForExport, mapRow, fmtTsLatn, getRestaurantDisplayName
  if (typeof exportMsg !== 'undefined' && exportMsg) exportMsg.textContent = 'Building Excel…';
  // التحقق من الفترة
  const rid   = exportRest?.value || '';
  const fromD = exportFrom?.value ? new Date(exportFrom.value) : null;
  const toD   = exportTo?.value   ? new Date(exportTo.value + 'T23:59:59') : null;
  if(!fromD || !toD){
    if (exportMsg) exportMsg.textContent='Bitte Zeitraum wählen';
    return;
  }
  // قراءة الفلاتر والأعمدة
  const sts   = readSelectedStatuses();
  const cols  = readSelectedCols();
  if(!cols.length){
    if (exportMsg) exportMsg.textContent='Select at least one column';
    return;
  }
  // تحميل XLSX كسولًا
  const XLSX = await loadXLSX();
  if(!XLSX){
    if (exportMsg) exportMsg.textContent='Excel engine failed to load';
    return;
  }
  // جلب البيانات من Firestore (الدالة موجودة سابقًا عندك)
  const rows = await queryOrdersForExport({
    restaurantId: rid || null,
    fromDate: fromD,
    toDate: toD,
    statuses: sts
  });
  const mapped = rows.map(mapRow);
  // ميتا التقرير (عنوان أعلى الشيت)
  const restName = getRestaurantDisplayName(rid || '');
  const fromTxt  = fmtTsLatn(fromD);
  const toTxt    = fmtTsLatn(toD);
  const stsLabel = sts.length ? sts.join(', ') : 'All';
  const meta = `Restaurant: ${restName} • Period: ${fromTxt} → ${toTxt} • Status: ${stsLabel}`;
  // بناء وحفظ Excel
  buildXlsxCustom(
    mapped,
    cols,
    meta,
    `${exportFrom.value}_${exportTo.value}${rid?('_'+rid):''}`,
    XLSX
  );

  if (exportMsg) exportMsg.textContent = `Excel generated: ${mapped.length} rows`;
});
/* ===== End XLSX Export ===== */
const exportModal = document.getElementById('export-modal');
const exportClose = document.getElementById('export-close');
const exportRest  = document.getElementById('export-restaurant');
const exportStatus= document.getElementById('export-status');
const exportFrom  = document.getElementById('export-from');
const exportTo    = document.getElementById('export-to');
const exportCols  = document.getElementById('export-cols');
const exportMsg   = document.getElementById('export-msg');
const EXPORT_COL_DEFS = [
  {key:'nr',         label:'Nr/Code'},
  {key:'id',         label:'OrderId'},
  {key:'restaurant', label:'Restaurant'},
  {key:'restPhone',  label:'Rest.Phone'},
  {key:'driver',     label:'Driver'},
  {key:'drvPhone',   label:'Driver.Phone'},
  {key:'platform',   label:'Platform'},
  {key:'qty',        label:'Qty'},
  {key:'price',      label:'Price €'},
  {key:'fee',        label:'Service Fee €'},   // ← rename
    {key:'distTotal', label:'Dist.Total km'},
  {key:'distBill',  label:'Dist.Billable km'},
  {key:'distKm',     label:'Distance km'},     // ← NEW
  {key:'distFee',    label:'Distance Fee €'},  // ← NEW (اختياري)
  {key:'status',     label:'Status'},
  {key:'pickup',     label:'Pickup'},
  {key:'created',    label:'Created'},
  {key:'updated',    label:'Updated'},
];
function openExportModal(){
  // تعبئة المطاعم
  if(exportRest && exportRest.options.length <= 1){
    const seen = new Set();
    [...(restaurants||[]), ...(restaurantUsersApproved||[])]
      .forEach(r=>{
        const id = r.id;
        if(!id || seen.has(id)) return;
        seen.add(id);
        const name = r.name || id;
        const opt = document.createElement('option');
        opt.value = id; opt.textContent = name;
        exportRest.appendChild(opt);
      });
  }
  // تعبئة الأعمدة (مع اختيار افتراضي)
  if(exportCols && !exportCols.dataset.ready){
    exportCols.dataset.ready = '1';
    const defaultOn = new Set(['nr','id','restaurant','qty','price','fee','status','created','updated']);
    EXPORT_COL_DEFS.forEach(c=>{
      const id = 'col_'+c.key;
      const wrap = document.createElement('label');
      wrap.style.cssText='display:flex;align-items:center;gap:6px;border:1px solid #e5e7eb;padding:4px 8px;border-radius:10px;background:#fff';
      wrap.innerHTML = `<input type="checkbox" id="${id}" ${defaultOn.has(c.key)?'checked':''}> <span>${c.label}</span>`;
      exportCols.appendChild(wrap);
    });
  }
  // افتراض الفترة = هذا الشهر
  const today = new Date();
  const y = today.getFullYear(), m = String(today.getMonth()+1).padStart(2,'0');
  exportFrom.value = `${y}-${m}-01`;
  exportTo.value   = `${y}-${m}-${String(new Date(y, Number(m), 0).getDate()).padStart(2,'0')}`;
  exportMsg.textContent = 'Select filters then export.';
  exportModal.classList.add('open');
}
exportClose?.addEventListener('click', ()=> exportModal.classList.remove('open'));

function readSelectedStatuses(){
  return Array.from(exportStatus?.selectedOptions || []).map(o=>o.value);
}
function readSelectedCols(){
  const picks = [];
  EXPORT_COL_DEFS.forEach(c=>{
    const el = document.getElementById('col_'+c.key);
    if(el && el.checked) picks.push(c);
  });
  return picks;
}
function toEndOfDay(ts){ const d = new Date(ts); d.setHours(23,59,59,999); return d; }
async function queryOrdersForExport({restaurantId, fromDate, toDate, statuses}){
  const colRef = collection(db,'orders');
  // الأساس: مدى التاريخ + ترتيب
  let baseQ = query(
    colRef,
    where('createdAt','>=', Timestamp.fromDate(fromDate)),
    where('createdAt','<=', Timestamp.fromDate(toDate)),
    orderBy('createdAt','asc')
  );
  // إن وُجد مطعم، فلتر بالسيرفر أولاً (الأفضل) – قد يطلب Index
  let qy = baseQ;
  if (restaurantId) {
    qy = query(baseQ, where('restaurant.id','==', restaurantId));
  }
  try {
    const snap = await getDocs(qy);
    let rows = snap.docs.map(d => ({ id: d.id, ...d.data() }));

    // فلترة الحالة على العميل (multi-select)
    if (statuses && statuses.length) {
      const want = new Set(statuses.map(s => String(s||'').toLowerCase()));
      rows = rows.filter(o => want.has(String(o.status||'').toLowerCase()));
    }
    return rows;
  } catch (e) {
    // إذا احتاج Index، نعمل Fallback: نجلب بالمدى فقط ثم نفلتر المطعم محليًا
    if (e?.code === 'failed-precondition') {
      console.warn('[Export] Missing index; using client-side filter fallback.');
      const snap = await getDocs(baseQ);
      let rows = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      if (restaurantId) {
        rows = rows.filter(o => (o.restaurant?.id || o.restaurantId) === restaurantId);
      }
      if (statuses && statuses.length) {
        const want = new Set(statuses.map(s => String(s||'').toLowerCase()));
        rows = rows.filter(o => want.has(String(o.status||'').toLowerCase()));
      }
      return rows;
    }
    throw e;
  }
}
function mapRow(o){
  const km   = readDistanceKm(o);
  const sFee = Number(readServiceFee(o)) || 0;
  const dFee = Number(readDistanceFee(o)) || 0;
  return {
    nr: (o.nr!=null? `#${o.nr}` : (o.shortCode||o.id||'')),
    id: o.id||'',
    restaurant: o.restaurant?.name||'',
    restPhone: o.restaurant?.phone||'',
    driver: o.driver?.fullName||'',
    drvPhone: o.driver?.phone||'',
    platform: Array.isArray(o.platform)? o.platform.join(' / ') : (o.platform||''),
    qty: Number(o.qty||0),
    price: fmtNum(o.price),
    fee: fmtNum(sFee), 	// Service Fee
	    distTotal: fmtNum(readDistanceTotalKm(o)),
    distBill:  fmtNum(readDistanceBillableKm(o)),
    distKm: km!=null ? Number(km).toFixed(2) : '',  // Distance KM
    distFee: dFee ? dFee.toFixed(2) : '',           // Distance Fee (optional)
    status: o.status||'',
    pickup: o.pickupTime||'',
    created: fmtTsLatn(o.createdAt),
    updated: fmtTsLatn(o.updatedAt),
  };
}
function buildCsvCustom(rows, cols, tag){
  const headers = cols.map(c=>c.label).join(',');
  const esc = v => {
    if (v===null||v===undefined) return '';
    const s = String(v).replace(/"/g,'""');
    return /[",\n]/.test(s) ? `"${s}"` : s;
  };
  const lines = rows.map(r => cols.map(c => esc(r[c.key] ?? '')).join(','));
  const csv = [headers, ...lines].join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url  = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `taussil-billing_${tag||Date.now()}.csv`;
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}
function buildPrintableReportCustom(mappedRows, cols, metaText){
  ensurePrintStyles();
  let host = document.getElementById('print-report');
  if(host) host.remove();
  host = document.createElement('div');
  host.id = 'print-report';
  const esc = s => String(s ?? '').replace(/[<>&]/g, c=>({ '<':'&lt;','>':'&gt;','&':'&amp;' }[c]));
  // حساب الإجماليات
  const ordersCount = mappedRows.length;
  let sumQty = 0, sumPrice = 0, sumFee = 0;
  mappedRows.forEach(r=>{
    sumQty   += Number(r.qty||0);
    sumPrice += Number(r.price||0);
    sumFee   += Number(r.fee||0);
  });
  // الرؤوس
  const thead = `<tr>${cols.map(c=>`<th${(['qty','price','fee'].includes(c.key)?' class="num"':'')}>${esc(c.label)}</th>`).join('')}</tr>`;
  // الجسم
  const tbody = mappedRows.map(r=>`<tr>${
    cols.map(c=>{
      const val = r[c.key] ?? '';
      const cls = (['qty','price','fee'].includes(c.key)? ' class="num"' : '');
      return `<td${cls}>${esc(val)}</td>`;
    }).join('')
  }</tr>`).join('');
  // تذييل: Totals ديناميكي لكل الأعمدة المختارة
  const tfootCells = cols.map((c, idx)=>{
    if(idx===0){
      return `<td>Totals (Orders: ${ordersCount})</td>`;
    }
    if(c.key==='qty')   return `<td class="num">${sumQty}</td>`;
    if(c.key==='price') return `<td class="num">${sumPrice.toFixed(2)}</td>`;
    if(c.key==='fee')   return `<td class="num">${sumFee.toFixed(2)}</td>`;
    return `<td></td>`;
  }).join('');
  const tfoot = `<tr>${tfootCells}</tr>`;
  // تجميع
  host.innerHTML = `
    <h1>${esc(currentLang==='ar' ? 'تقرير الفوترة' : (currentLang==='de' ? 'Abrechnungsbericht' : 'Billing Report'))}</h1>
    <div class="meta">${esc(metaText || '')} • Rows: ${ordersCount}</div>
    <table>
      <thead>${thead}</thead>
      <tbody>${tbody}</tbody>
      <tfoot>${tfoot}</tfoot>
    </table>
  `;
  document.body.appendChild(host);
  const cleanup = ()=>{ host?.remove(); window.removeEventListener('afterprint', cleanup); };
  window.addEventListener('afterprint', cleanup);
  window.print();
}
async function runExport(kind){
  try{
    exportMsg.textContent = 'Loading…';
    const rid   = exportRest.value || '';
    const fromD = exportFrom.value ? new Date(exportFrom.value) : null;
    const toD   = exportTo.value   ? toEndOfDay(new Date(exportTo.value)) : null;
    if(!fromD || !toD){ exportMsg.textContent='Bitte Zeitraum wählen'; return; }
    const sts   = readSelectedStatuses();
    const cols  = readSelectedCols();
    if(!cols.length){ exportMsg.textContent='Select at least one column'; return; }
    const rows = await queryOrdersForExport({ restaurantId: rid || null, fromDate: fromD, toDate: toD, statuses: sts });
    const mapped = rows.map(mapRow);
    const restName = getRestaurantDisplayName(rid || '');
const stsLabel = sts.length ? sts.join(', ') : 'All';
const fromTxt  = fmtTsLatn(fromD);
const toTxt    = fmtTsLatn(toD);
const meta = `Restaurant: ${restName} • Period: ${fromTxt} → ${toTxt} • Status: ${stsLabel}`;
    if(kind==='csv'){
      buildCsvCustom(mapped, cols, `${exportFrom.value}_${exportTo.value}${rid?('_'+rid):''}`);
      exportMsg.textContent = `CSV generated: ${mapped.length} rows`;
    }else{
      buildPrintableReportCustom(mapped, cols, meta);
      exportMsg.textContent = `PDF ready: ${mapped.length} rows`;
    }
  }catch(e){
    console.warn(e);
    exportMsg.textContent = 'Export failed. Check console.';
  }
}
document.getElementById('export-run-csv')?.addEventListener('click', ()=> runExport('csv'));
document.getElementById('export-run-pdf') ?.addEventListener('click', ()=> runExport('pdf'));
</script>
</body>
</html>
