ORDERS_UNSUB = onSnapshot(
  query(collection(db,'orders'),
    where('restaurant.id','==', RESTAURANT_ID),
    orderBy('updatedAt','desc'),
    limit(8)),
  (snap)=>{
    if(!lastList) return;
    if(snap.empty){
      lastList.innerHTML = `<div class="rowx"><span>— Keine Daten —</span></div>`;
      return;
    }

    // ابْنِ الصفوف (نستخدم codSum مباشرة و نزرع الكاش)
    const rowsHtml = snap.docs.map(d=>{
      const o = d.data()||{};
      const plat = Array.isArray(o.platform)? o.platform.join(' / ') : (o.platform||'—');
      const qty  = Number(o.qty||o.stops_total||0) || 0;
      const nr   = (o.nr!=null ? `#${o.nr}` : '');
      const preisNum = Number(o.price||0);

      const isSingle  = qty <= 1;
      const codSingle = !!(o?.payment?.cod);
      const codCount  = Number(o?.payment?.codCount || 0);
      const codAny    = codSingle || codCount > 0;

      // مصدر موحّد: codSum في الدوك، وإلا من الكاش، وإلا لاحقًا via fetch
      let codMulti = 0;
      const codSumDoc = Number(o?.payment?.codSum || 0);
      if (!isSingle && codAny){
        if (codSumDoc > 0){
          codMulti = codSumDoc;
          if (!COD_CACHE.has(d.id)) COD_CACHE.set(d.id, Math.round(codSumDoc*100)/100);
        } else if (COD_CACHE.has(d.id)){
          codMulti = Number(COD_CACHE.get(d.id) || 0);
        } else {
          fetchOrderCodSum(d.id);
        }
      }

      const cashTag = (codMulti > 0)
        ? ` <span class="cash-note">(Bar: ${money(codMulti)})</span>`
        : '';

      const preisHtml = `<span class="${(isSingle && codSingle) ? 'money--cod' : ''}">${money(preisNum)}</span>${cashTag}`;

      const codBadge  = (!isSingle && codAny)
        ? `<div class="tag" style="background:#fee2e2;border-color:#ef4444;color:#b91c1c">Bar x${codCount}</div>`
        : (isSingle && codSingle)
          ? `<div class="tag" style="background:#fee2e2;border-color:#ef4444;color:#b91c1c">Bar</div>`
          : '';
const statusTxt = (o.status || '—');

      return `<div class="rowx" data-oid="${d.id}" data-status="${o.status||''}">
        <div class="id">${d.id} ${nr}</div>
        <div class="tag">${plat} <span class="badge badge--status">${statusTxt}</span></div>
        ${codBadge}
        <div style="flex:1"></div>
        <div>${qty>0? qty : ''}</div>
        <div id="codslot-${d.id}">${preisHtml}</div>
      </div>`;
    }).join('');

    lastList.innerHTML = rowsHtml;
// ارفع كل الطلبات "Unterwegs" للأعلى مباشرة بعد الرندر (مع الحفاظ على ترتيبها النسبي)
(() => {
  const rows = Array.from(lastList.querySelectorAll('.rowx'));
  const underway = rows.filter(r => (r.dataset.status || '').trim() === 'Unterwegs');
  underway.reverse().forEach(r => lastList.prepend(r)); // reverse للحفاظ على نفس ترتيب السنبشوت
})();

    // بعد الرندر: لو فيه طلبات ما زال كاشها يُجلب من stops، حدّث الخلايا عند توفر الكاش
    snap.docs.forEach(d=>{
      const o = d.data()||{};
      const qty = Number(o.stops_total ?? o.qty ?? 0) || 0;
      const codCount = Number(o?.payment?.codCount || 0);
      if (qty <= 1 || codCount <= 0) return;

      const slot = document.getElementById(`codslot-${d.id}`);
      if (!slot) return;

      const codSumDoc = Number(o?.payment?.codSum || 0);
      const val = COD_CACHE.has(d.id) ? Number(COD_CACHE.get(d.id)||0) : (codSumDoc>0 ? codSumDoc : 0);
      if (val > 0 && !slot.innerHTML.includes('(Bar:')){
        slot.innerHTML += ` <span class="cash-note">(Bar: ${money(val)})</span>`;
      }
    });

    // إبقاء نبض الطلب الجاري
    markUnterwegsRows();

    // (الباقي من منطق الأصوات/التحديد كما هو عندك)
    snap.docChanges().forEach(ch=>{
      const id = ch.doc.id; const o = ch.doc.data()||{};
      const prev = ORDER_CACHE.get(id)?.status;
      ORDER_CACHE.set(id, {status:o.status});
      if(prev !== undefined && prev !== o.status){
        if(o.status === 'Unterwegs'){
          playSnd('unterwegs', id);
          if(!SELECTED_ORDER_ID){ showTripCard(id, o); }
        }
		// عند انتقال الطلب إلى "Unterwegs" ارفعه فورًا للأعلى بدون انتظار إعادة بناء القائمة
{
  const row = lastList.querySelector(`.rowx[data-oid="${id}"]`);
  if (row) lastList.prepend(row);
}

        if(o.status === 'Geliefert'){
          playSnd('delivered', id);
          if(SELECTED_ORDER_ID===id){
            stopDriverTracking();
            clearMapArtifacts();
            resetTripTimesUI();
          }
        }
      }
      if(SELECTED_ORDER_ID===id){ showTripCard(id, o); }
    });

    if(!lastList.__bound){
      lastList.__bound = true;
      lastList.addEventListener('click', async (e)=>{
        const row = e.target.closest('.rowx'); if(!row) return;
        const oid = row.getAttribute('data-oid'); if(!oid) return;
        try{
          const ds = await getDoc(doc(db,'orders', oid));
          if(ds.exists()) showTripCard(oid, ds.data());
        }catch(_){}
      });
    }
  }
);
