<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, interactive-widget=resizes-content">
<title>Taussil â€“ Restaurant (PROD v7)</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
:root{ --bg:#f7f8fb; --card:#fff; --ink:#111; --muted:#6b7280; --cta:#33BBDF; --border:1px solid rgba(0,0,0,.08); --radius:12px; --shadow:0 8px 24px rgba(0,0,0,.10); --hit:44px; --gap:12px; }
/* === Bindings: ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªÙˆÙƒÙ†Ø² Ø¨Ø£Ù…Ø§Ù† (fallback ÙŠØ­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ø§Ù„Ø´ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠ) === */

/* Ù‚Ø§Ø¹Ø¯Ø© Ø¹Ø§Ù…Ø© */
html,body{
  background: var(--clr-bg, var(--bg));
  color:      var(--clr-ink, var(--ink));
  font-size:  var(--fs-base, 14px);
}

/* Ø§Ù„Ø´Ø¨ÙƒØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© */
.shell{
  gap:      var(--shell-gap, var(--gap));
  padding:  var(--shell-pad, var(--gap));
}

/* Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª/Ø§Ù„Ù„ÙˆØ­Ø§Øª */
.panel, .panel .pb, .panel .ph,
.card, .trip, .map-wrap, .stat, .rowx, .banner{
  border-radius: var(--radius-card, var(--radius));
  box-shadow:    var(--shadow-soft, var(--shadow));
  background:    var(--clr-card, var(--card));
  color:         var(--clr-ink, var(--ink));
  border-color:  var(--clr-border, rgba(0,0,0,.08));
}

/* Ø±Ø£Ø³ Ø§Ù„Ù„ÙˆØ­Ø§Øª */
.ph .t{ font-weight: var(--fw-bold, 800); }
.ph .s{ font-size:  var(--fs-small, 12px); color: var(--clr-muted, var(--muted)); }

/* Ø£Ø²Ø±Ø§Ø± Ø¹Ø§Ù…Ø© ÙˆÙ…Ø¯Ø®Ù„Ø§Øª */
.input, select, .btn, a.btn{
  height:        var(--input-h, var(--hit));
  border-radius: var(--input-radius, 10px);
  font-size:     var(--fs-base, 14px);
}
.btn{
  height:        var(--btn-h, var(--hit));
  border-radius: var(--btn-radius, 12px);
  font-weight:   var(--fw-bold, 800);
}
.btn-mini{
  height:  calc(var(--btn-h, var(--hit)) * .75);
  border-radius: 10px;
  padding: 2px 10px;
  font-size: var(--fs-small, 12px);
}

/* Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ØµØºÙŠØ±Ø© (Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø·Ù„Ø¨Ø§Øª) */
.btn-icon{
  width:  var(--btn-icon-size, 48px);
  height: var(--btn-icon-size, 48px);
  border-radius: 12px;
}

/* Ø´Ø¨ÙƒØ© Ù…Ø²ÙˆÙ‘Ø¯ÙŠ Ø§Ù„Ù…Ù†ØµÙ‘Ø§Øª */
.providers{
  grid-template-columns: repeat(var(--prov-cols, 5), 1fr);
}
.provider{
  height: var(--prov-card-h, 66px);
}
.p-qty{
  height: var(--prov-badge-h, 22px);
  line-height: var(--prov-badge-h, 22px);
}

/* ØµÙˆØ±Ø©/Ø´Ø¹Ø§Ø± Ø§Ù„Ø·Ù„Ø¨ */
.logo img, .logo .ph{
  width:  var(--logo-size, 56px);
  height: var(--logo-size, 56px);
  border-radius: 12px;
}

/* Ø§Ù„Ø¯Ø±Ø¬ Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ ÙˆØ§Ù„Ù…ÙˆØ¯Ø§Ù„Ø§Øª Ø§Ù„Ø¨ÙŠØ¶Ø§Ø¡ */
.drawer .sheet{
  width: min(var(--drawer-w, 360px), var(--drawer-maxvw, 86vw));
}
.modal.white .box{
  max-width: var(--log-max, 920px);
  width:     var(--log-w, 92%);
}

/* Ø´Ø§Ø±Ø§Øª ÙˆÙ†ØµÙˆØµ ØµØºÙŠØ±Ø© */
.small{ font-size: var(--fs-small, 12px); color: var(--clr-muted, var(--muted)); }

/* Ø£Ù„ÙˆØ§Ù† CTA ÙˆØ§Ù„Ù†Ø¬Ø§Ø­ ÙˆØ§Ù„ØªØ­Ø°ÙŠØ± ÙˆØ§Ù„Ø®Ø·Ø£ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ø¥Ù† Ø£Ø±Ø¯Øª ØªÙˆØ­ÙŠØ¯Ù‡Ø§) */
.btn-cta{
  background: linear-gradient(180deg, var(--clr-cta, #33BBDF), color-mix(in oklab, var(--clr-cta, #33BBDF) 70%, #0aa));
}
.banner{
  border-color: color-mix(in oklab, var(--clr-ok, #22c55e) 40%, #fff);
  background:   color-mix(in oklab, var(--clr-ok, #22c55e) 12%, #fff);
  color:        #166534;
}

*{box-sizing:border-box}
html,body{margin:0;padding:0;height:100dvh;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;overflow:hidden}
/* Ø«Ù„Ø§Ø«Ø© Ø£Ø¹Ù…Ø¯Ø© Ù…ØªØ³Ø§ÙˆÙŠØ© Ø§Ù„Ø¹Ø±Ø¶ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø© */
.shell{
  display:grid;
  grid-template-columns: 1fr 1fr 1fr;   /* â† ØªØ³Ø§ÙˆÙŠ Ø§Ù„Ø¹Ø±Ø¶ */
  gap:var(--gap);
  height:100dvh;
  padding:var(--gap);
  padding-bottom: calc(var(--gap) + 16px + env(safe-area-inset-bottom, 0px));
}

.panel{background:var(--card);border:var(--border);border-radius:var(--radius);box-shadow:var(--shadow);display:flex;flex-direction:column;min-height:0}
.ph{padding:12px 14px;border-bottom:1px solid rgba(0,0,0,.06);display:flex;align-items:center;justify-content:space-between}
.ph .t{font-weight:800} .ph .s{color:var(--muted);font-size:12px}
.pb{flex:1;min-height:0;overflow:auto;padding:12px 14px}

/* left: form */
.providers{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-bottom:10px}
.provider{position:relative;height:66px;border-radius:14px;overflow:hidden;border:1px solid rgba(0,0,0,.06);background:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center}
/* Ø§Ù„ØµÙˆØ±Ø© Ø·Ø¨Ù‚Ø© Ø³ÙÙ„Ù‰ ØµØ§ÙÙŠØ© */
.provider img{
  width:100%;height:100%;
  object-fit:contain;display:block;
  padding:6px;background:#fff;
  position:relative; z-index:0;
}
/* Ø´Ø§Ø±Ø© Ø§Ù„ÙƒÙ…ÙŠØ© ØªØ¨Ù‚Ù‰ Ø£Ø¹Ù„Ù‰ ÙƒÙ„ Ø´ÙŠØ¡ Ù„ÙƒÙ† Ø¨Ø¯ÙˆÙ† Ø£ÙŠ Ø§Ù†Ø¹ÙƒØ§Ø³ */
.p-qty{ z-index:3; mix-blend-mode:normal; }

/* Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ù‡Ø§Ù„Ø©/Outline Ø¹Ù„Ù‰ Ø£Ø²Ø±Ø§Ø± +/âˆ’ Ø¹Ù†Ø¯ Ø§Ù„ØªØ±ÙƒÙŠØ² */
.p-qty button:focus,
.p-qty button:focus-visible{
  outline:none; box-shadow:none;
}

/* Ø¥Ø·Ø§Ø± Ø®Ø§Ø±Ø¬ÙŠ ÙÙ‚Ø· (Ù„Ø§ ÙŠÙ„Ù…Ø³ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØµÙˆØ±Ø©) */
.provider.is-selected{ box-shadow:0 0 0 3px #33BBDF; }

.p-qty{position:absolute;right:6px;bottom:6px;display:none;gap:6px;align-items:center;background:rgba(255,255,255,.98);border:1px solid rgba(0,0,0,.12);border-radius:999px;padding:3px 6px;box-shadow:0 2px 8px rgba(0,0,0,.12);z-index:3}
.p-qty .n{ font-size:12px; line-height:1; font-weight:700; min-width:18px; text-align:center; font-variant-numeric:tabular-nums }
.p-qty button{width:20px;height:20px;border:1px solid rgba(0,0,0,.15);border-radius:6px;background:#fff;cursor:pointer;line-height:1;font-weight:800}

.row{display:grid;grid-template-columns:1fr 1fr;gap:8px;align-items:center}
.qty-wrap{display:flex;align-items:center;justify-content:center;gap:6px}
.btn-step{width:44px;height:var(--hit);border:1px solid rgba(0,0,0,.12);border-radius:9px;background:#fff;cursor:pointer;font-weight:800;font-size:18px;line-height:1}
.btn-step:disabled{opacity:.5;cursor:not-allowed}
.input, select{height:var(--hit);border:var(--border);border-radius:10px;background:#fff;padding:0 10px;font-size:14px;width:100%;margin-top:15px}
.row .input{margin-top:0}
.input.center{text-align:center}
.input:focus{outline:none;box-shadow:0 0 0 2px #aee7f5}
.full{grid-column:1/-1}
input[type="number"]::-webkit-outer-spin-button,input[type="number"]::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}
input[type="number"]{-moz-appearance:textfield;text-align:center;font-variant-numeric:tabular-nums}
.send{margin-top:10px;width:100%;height:var(--hit);border:none;border-radius:12px;background:linear-gradient(180deg,#33BBDF,#1da9cf);color:#fff;font-weight:800;cursor:pointer;box-shadow:0 8px 18px rgba(51,187,223,.35)}
.send:disabled{opacity:.6;cursor:not-allowed}
.banner{margin-top:10px;display:none;align-items:center;justify-content:center;height:38px;border-radius:10px;border:1px solid #34c759;background:#ecfdf5;color:#166534;font-weight:800}
.banner.show{display:flex}

/* trip */
.trip{margin-top:20px;border:var(--border);border-radius:12px;background:#fff;box-shadow:var(--shadow);padding:7px 12px}
.trip.hidden{display:none}
.trip-title{font-weight:800;margin-bottom:6px}
.trip-row{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:6px 0;border-top:1px solid rgba(0,0,0,.06)}
.trip-row:first-child{border-top:0}
.trip-row .k{color:var(--muted);font-size:12px}
.trip-row .v{font-weight:600}
/* Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙƒØ±Ø§Ø¨Ø· Ù„ÙƒÙ† Ø¨Ù†ÙØ³ Ù„ÙˆÙ† Ø§Ù„Ù†Øµ */
.trip-row .v a{ color:inherit; text-decoration:none; }
.trip-row .v a:hover{ text-decoration:underline; }
.trip-row .v a[disabled]{ pointer-events:none; opacity:.7; text-decoration:none; }
.countdown{font-weight:800;color:#16a34a}

/* map */
.map-wrap{position:relative;height:100%;border-radius:12px;overflow:hidden;border:1px solid rgba(0,0,0,.08)}
#map{position:absolute;inset:0}
.map-ui{position:absolute;right:10px;top:10px;display:flex;gap:6px;background:rgba(255,255,255,.95);border:1px solid rgba(0,0,0,.08);border-radius:10px;padding:6px 8px;font-size:12px;z-index:2}
.map-ui select{border:1px solid rgba(0,0,0,.2);border-radius:6px;padding:2px 6px;background:#fff}


/* right */
.stats{display:grid;grid-template-columns:1fr;gap:8px;margin-bottom:10px}
.stat{background:#fff;border:var(--border);border-radius:12px;padding:10px;display:flex;align-items:center;justify-content:space-between}
.stat .k{font-weight:800}.stat .t{color:var(--muted);font-size:12px}
.list{display:flex;flex-direction:column;gap:8px}
.rowx{display:flex;gap:8px;align-items:center;justify-content:space-between;border:1px solid rgba(0,0,0,.06);border-radius:10px;padding:8px 10px;background:#fff;cursor:pointer}
.rowx .id{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-size:12px;opacity:.85}
.rowx .tag{font-size:11px;padding:3px 8px;border-radius:999px;background:#f3f4f6;border:1px solid rgba(0,0,0,.05)}

*{-webkit-tap-highlight-color:transparent}
@media (pointer:coarse){.input{font-size:16px}}
@media (max-width:1100px){.shell{grid-template-columns:340px 1fr}.right{grid-column:1/-1;order:3}}
@media (max-width:740px){.shell{grid-template-columns:1fr}.left{order:1}.center{order:2}.right{order:3}}

/* Auth modal (Restaurant) */
#restAuth{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.55);z-index:10000}
#restAuth .box{width:min(560px,92%);background:#0f1a30;border:1px solid rgba(255,255,255,.14);border-radius:16px;padding:14px;box-shadow:0 12px 40px rgba(0,0,0,.35);color:#e6e9ef}
#restAuth .btn{height:44px;padding:0 12px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:#13213a;color:#e6e9ef;cursor:pointer;font-weight:700}
#restAuth .btn-cta{background:linear-gradient(180deg,#33BBDF,#1da9cf);border:none;color:#fff}
#restAuth .input{height:44px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:#0f1a30;color:#e6e9ef;padding:0 12px}
#restAuth .small{font-size:12px;color:#9aa4b2}

/* tiny button */
.btn-mini{border:1px solid rgba(0,0,0,.15);background:#fff;border-radius:8px;padding:2px 8px;font-size:12px;cursor:pointer}

/* === ADDED: Countdown warning blink === */
@keyframes blinkRed { 0%,100%{color:#ef4444} 50%{color:transparent} }
.countdown.blink-red{ animation:blinkRed 1s linear infinite; }
/* ØªØ¹ØªÙŠÙ… 50% ÙÙˆÙ‚ Ø§Ù„ØµÙˆØ±Ø© ÙÙ‚Ø· */
.provider.is-selected::after{
  content:"";
  position:absolute;
  inset:0;
  background:rgba(0,0,0,.5);   /* 50% */
  border-radius:14px;           /* ÙŠØ·Ø§Ø¨Ù‚ Ø§Ù„ÙƒØ±Øª */
  z-index:1;                    /* ÙÙˆÙ‚ Ø§Ù„ØµÙˆØ±Ø© ÙˆØªØ­Øª Ø§Ù„Ø´Ø§Ø±Ø© */
  pointer-events:none;
}

/* Ø¹Ù„Ø§Ù…Ø© âœ“ ØµØºÙŠØ±Ø© Ù„ØªÙˆØ¶ÙŠØ­ Ø§Ù„ØªØ­Ø¯ÙŠØ¯ */
.provider.is-selected::before{
  content:"âœ“";
  position:absolute;
  top:6px; left:6px;
  width:22px; height:22px;
  border-radius:999px;
  background:#10b981; color:#fff;
  font-weight:800; font-size:14px; line-height:1;
  display:flex; align-items:center; justify-content:center;
  box-shadow:0 2px 6px rgba(0,0,0,.18);
  z-index:2;                    /* ÙÙˆÙ‚ Ø§Ù„ØªØ¹ØªÙŠÙ… ÙˆØªØ­Øª Ø´Ø§Ø±Ø© Ø§Ù„ÙƒÙ…ÙŠØ© */
  pointer-events:none;
}
/* Drawer (right, white) */
.backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;z-index:1200}
.backdrop.show{display:block}
.drawer{position:fixed;inset:0;display:none;justify-content:flex-end;z-index:1201}
.drawer.show{display:flex}
.drawer .sheet{width:min(360px,86vw);height:100%;background:#fff;color:#111;border-left:1px solid rgba(0,0,0,.1);display:flex;flex-direction:column;padding:12px}
.drawer .hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.drawer .item{padding:12px;border-radius:10px;color:#111;text-decoration:none;border:1px solid rgba(0,0,0,.08);background:#fff;margin-bottom:8px}
.drawer .item:hover{background:#f3f4f6}

/* Log modal (white) */
.modal.white{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:1300}
.modal.white.show{display:flex}
.modal.white .box{background:#fff;color:#111;border-radius:16px;max-width:920px;width:92%;padding:12px;border:1px solid #e5e7eb}
.log-head{display:flex;align-items:center;justify-content:space-between;gap:8px}
.log-actions button{margin-left:6px}
.log-list{display:flex;flex-direction:column;gap:6px;margin-top:8px}
.log-row{display:grid;grid-template-columns:auto 1fr auto auto auto;gap:8px;align-items:center;border:1px solid #e5e7eb;border-radius:10px;padding:8px;background:#fff}
.log-id{font-family:ui-monospace,Menlo,monospace;font-size:12px;opacity:.9}
.log-tag{font-size:11px;padding:3px 8px;border-radius:999px;background:#eef2ff;border:1px solid #e5e7eb}
.chip{display:inline-block;font-size:12px;padding:6px 10px;border-radius:999px;background:#f3f4f6;border:1px solid #e5e7eb;margin-right:6px}
/* === Log modal: fixed size + internal scrolling === */
.modal.white .box{
  display:flex; flex-direction:column;
  max-height: 86vh; /* Ø§Ø±ØªÙØ§Ø¹ Ø«Ø§Ø¨Øª ØªÙ‚Ø±ÙŠØ¨Ù‹Ø§ */
  overflow:hidden;  /* Ù…Ù…Ù†ÙˆØ¹ ØªØªÙ…Ø¯Ù‘Ø¯ Ø®Ø§Ø±Ø¬ Ø§Ù„Ø´Ø§Ø´Ø© */
}
.log-filter{
  display:grid; grid-template-columns: 1fr 1fr 1fr auto; gap:8px;
  background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:8px;
  position:sticky; top:0; z-index:1; /* ÙŠØ«Ø¨Øª Ø£Ø¹Ù„Ù‰ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªÙ…Ø±ÙŠØ± */
}
.log-filter .input, .log-filter select, .log-filter button{
  height:38px; border-radius:10px; border:1px solid #e5e7eb; background:#fff;
}
.log-scroll{ flex:1; min-height:0; overflow:auto; padding-top:8px; }
.log-list{ display:flex; flex-direction:column; gap:6px; }
.log-row{
  display:grid; grid-template-columns:auto 1fr auto auto auto auto; gap:8px; align-items:center;
  border:1px solid #e5e7eb; border-radius:10px; padding:8px; background:#fff;
}
.log-id{ font-family: ui-monospace, Menlo, monospace; font-size:12px; opacity:.9 }
.log-tag{ font-size:11px; padding:3px 8px; border-radius:999px; background:#eef2ff; border:1px solid #e5e7eb }
/* === MULTI-ORDERS (restaurant) â€” per-provider rows === */
.multi-rows{ display:flex; flex-direction:column; gap:8px; margin:10px 0; }
.multi-row{ display:grid; grid-template-columns: 1.2fr 0.8fr 1fr; gap:8px; align-items:center; }
.multi-row .prov{ font-weight:700; }
.multi-row input.input{ margin-top:0; }
/* === Export fields modal (checkbox grid) === */
#exportModal .box{ max-width:720px; }
.field-grid{
  display:grid; grid-template-columns:1fr 1fr; gap:8px 16px;
  margin:10px 0;
}
.field-grid label{ display:flex; align-items:center; gap:8px; font-size:13px; }
.field-actions{ display:flex; gap:8px; justify-content:flex-end; }
.tabs-inline{display:flex;gap:6px;background:#fff;border:1px solid rgba(0,0,0,.08);border-radius:10px;padding:4px;margin-bottom:8px}
.tab-btn{flex:1;height:36px;border-radius:8px;background:#fff;border:1px solid rgba(0,0,0,.12);cursor:pointer;font-weight:800}
.tab-btn.active{background:linear-gradient(180deg,#33BBDF,#1da9cf);color:#fff;border:none;box-shadow:0 6px 18px rgba(29,169,207,.32)}
/* ===== Underway pulse ===== */
:root{
  --pulse-color: #22c55e;   /* Ø£Ø®Ø¶Ø± */
  --pulse-radius: 12px;     /* Ù†ÙØ³ Ù†ØµÙ Ù‚Ø·Ø± Ø¨Ø·Ø§Ù‚ØªÙƒ ØªÙ‚Ø±ÙŠØ¨Ù‹Ø§ */
}

/* ===== Underway pulse (right list rows) ===== */
:root{
  --pulse-color: #22c55e;
  --pulse-radius: 10px; /* ÙŠØ·Ø§Ø¨Ù‚ border-radius Ù„ .rowx */
}

/* Ø¨Ø·Ø§Ù‚Ø§Øª Ù‚Ø§Ø¦Ù…Ø© "Letzte AuftrÃ¤ge" */
#lastList .rowx{ position: relative; }

#lastList .rowx.is-underway::after{
  content:"";
  position:absolute;
  inset:-2px;                 /* Ù‡Ø§Ù„Ø© Ø®Ø§Ø±Ø¬ÙŠØ© Ø±ÙÙŠØ¹Ø© */
  border-radius: var(--pulse-radius);
  pointer-events:none;
  box-shadow: 0 0 0 0 rgba(34,197,94,.45);
  animation: taussil-pulse 1.6s ease-out infinite;
  will-change: box-shadow, opacity;
}

@keyframes taussil-pulse{
  0%   { box-shadow: 0 0 0 0   rgba(34,197,94,.45); opacity: 1; }
  70%  { box-shadow: 0 0 0 14px rgba(34,197,94,0);  opacity: .9; }
  100% { box-shadow: 0 0 0 0   rgba(34,197,94,0);   opacity: 1; }
}

/* ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø­Ø±ÙƒØ© */
@media (prefers-reduced-motion: reduce){
  #lastList .rowx.is-underway::after{
    animation: none;
    box-shadow: 0 0 0 3px rgba(34,197,94,.55);
  }
}
/* ===== Driver pulsing marker (green dot + ring) ===== */
.gm-driver{
  position:absolute;
  pointer-events:none;      /* Ù„Ø§ ÙŠØªØ¹Ø§Ø±Ø¶ Ù…Ø¹ Ø³Ø­Ø¨/ØªÙƒØ¨ÙŠØ± Ø§Ù„Ø®Ø±ÙŠØ·Ø© */
}
.gm-driver .dot{
  position:absolute; top:0; left:0;
  width:15px; height:15px;              /* Ø­Ø¬Ù… Ø§Ù„Ù†Ù‚Ø·Ø© */
  background:#22c55e;                   /* Ø£Ø®Ø¶Ø± */
  border:2px solid #fff;                /* Ø­Ø§ÙØ© Ø¨ÙŠØ¶Ø§Ø¡ */
  border-radius:50%;
  box-shadow:0 1px 3px rgba(0,0,0,.25);
  transform: translate(-50%,-50%);
}
.gm-driver .ring{
  position:absolute; top:0; left:0;
  width:20px; height:20px;
  border-radius:50%;
  background: rgba(34,197,94,.35);      /* Ø£Ø®Ø¶Ø± Ø´ÙÙ‘Ø§Ù */
  transform: translate(-50%,-50%);
  animation: gmPulse 1.6s ease-out infinite;
}
@keyframes gmPulse{
  0%   { opacity:.9; transform: translate(-50%,-50%) scale(1); }
  70%  { opacity:0;  transform: translate(-50%,-50%) scale(2.6); }
  100% { opacity:0;  transform: translate(-50%,-50%) scale(1); }
}
/* Ø§Ø­ØªØ±Ø§Ù… ØªÙØ¶ÙŠÙ„ ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø­Ø±ÙƒØ© */
@media (prefers-reduced-motion: reduce){
  .gm-driver .ring{ animation: none; opacity:.5; }
}


</style>
</head>
<section class="panel left">
  <div class="pb">
<!-- Drawer (right) -->
<div id="drawerBackdrop" class="backdrop"></div>
<div id="sideMenu" class="drawer">
  <div class="sheet">
    <div class="hdr">
      <strong>MenÃ¼</strong>
      <button id="drawerClose" class="btn-mini">âœ•</button>
    </div>
    <a href="#" id="navLog" class="item">ğŸ“’ Bestellverlauf</a>
    <a href="#" id="navLogout" class="item">ğŸšª Abmelden</a>
  </div>
</div>
<!-- Orders Log Modal (white) -->
<div id="logModal" class="modal white">
  <div class="box">
    <div class="log-head">
      <h3 style="margin:0">Bestellverlauf</h3>
      <div class="log-actions">
  <button id="logPDF" class="btn-mini">PDF / Drucken</button>
</div>

    </div>
    <div class="log-sums">
	<!-- Ø¶Ø¹ Ù‡Ø°Ø§ Ø¯Ø§Ø®Ù„ .box ÙÙŠ Ø£Ø¹Ù„Ù‰ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø³Ø¬Ù„ (Ø¨Ø¹Ø¯ Ø§Ù„Ø´ÙŠØ¨Ø³/Ø§Ù„Ù…Ø¬Ø§Ù…ÙŠØ¹) -->
<div class="log-filter">
  <input id="logTo"   class="input" type="date" />
  <select id="logProvider">
    <option value="">Alle Plattformen</option>
    <option>Lieferando</option>
    <option>Uber Eats</option>
    <option>Wolt</option>
    <option>Restablo</option>
    <option>Andere</option>
  </select>
  <button id="logReset" class="btn-mini" type="button">ZurÃ¼cksetzen</button>
</div>

      <span class="chip">Summe Preise: <b id="logSumPrice">0,00â‚¬</b></span>
      <span class="chip">Summe LiefergebÃ¼hren: <b id="logSumFee">0,00â‚¬</b></span>
    </div>
    <div id="logScroll" class="log-scroll">
  <div id="logList" class="log-list"></div>
</div>

    <div style="display:flex;justify-content:center;margin-top:8px">
      <button id="logClose" class="btn btn-ghost" style="height:38px">SchlieÃŸen</button>
    </div>
  </div>
</div>
<!-- Export (choose fields) Modal -->
<div id="exportModal" class="modal white">
  <div class="box">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
      <h3 style="margin:0">Felder wÃ¤hlen</h3>
      <div>
        <button id="expAll" class="btn-mini" type="button">Alle</button>
        <button id="expNone" class="btn-mini" type="button">Keine</button>
        <button id="expClose" class="btn-mini" type="button">âœ•</button>
      </div>
    </div>
    <div id="exportFields" class="field-grid"></div>
    <div class="field-actions">
      <button id="expPrint" class="btn-mini" type="button">Drucken</button>
      <button id="expPDF"   class="btn-mini" type="button">PDF</button>
    </div>
  </div>
</div>

<body>
  <!-- Auth Modal (Restaurant) -->
  <div id="restAuth">
    <div class="box">
      <div style="display:flex;gap:6px;margin-bottom:10px">
        <button id="rTabLogin" class="btn" style="flex:1">Anmelden</button>
        <button id="rTabRegister" class="btn" style="flex:1;opacity:.8">Registrieren</button>
      </div>

      <!-- Login -->
      <form id="rPaneLogin">
        <div style="display:grid;gap:8px">
          <input id="rLoginEmail" class="input" type="email" placeholder="E-Mail" autocomplete="username" required>
          <input id="rLoginPass"  class="input" type="password" placeholder="Passwort" autocomplete="current-password" required>
        </div>
        <button id="rLoginBtn" class="btn btn-cta" style="margin-top:8px">Anmelden</button>
        <div id="rLoginMsg" class="small" style="margin-top:6px;color:#fca5a5"></div>
      </form>

      <!-- Register -->
      <form id="rPaneRegister" style="display:none">
        <div style="display:grid;gap:8px">
          <input id="rRestName" class="input" type="text" placeholder="Restaurant-Name" required>
          <input id="rRestPhone" class="input" type="tel"  placeholder="Telefon (+49 â€¦)" required>
          <input id="rRestAddr"  class="input" type="text" placeholder="Adresse (fÃ¼r Karte)" required>
          <input id="rRegEmail"  class="input" type="email" placeholder="E-Mail" required>
          <input id="rRegPass"   class="input" type="password" placeholder="Passwort (6+)" required>
        </div>
        <button id="rRegisterBtn" class="btn btn-cta" style="margin-top:8px">Registrieren</button>
        <div id="rRegMsg" class="small" style="margin-top:6px;color:#fca5a5"></div>
        <div class="small" style="opacity:.85;margin-top:4px">Nach der Registrierung prÃ¼ft der Admin dein Konto.</div>
      </form>
    </div>
  </div>

  <div class="shell">
    <!-- left -->
    <section class="panel left">
      <div class="ph"><div class="t">Neue Bestellung</div><div class="s">Nr: <span id="nrBox">â€”</span> <button id="sndBtn" class="btn-mini" title="Audio wÃ¤hlen (Alt = Dateien)">ğŸ”Š</button></div></div>
      <div class="pb">
	  <!-- === MV FULL SWITCH TAB === -->
<div class="tabs-inline" id="sendTabsNav" role="tablist" aria-label="Bestell-Tabs">
  <button id="tabSend" class="tab-btn active" type="button" role="tab" aria-selected="true">Auftrag Senden</button>
  <button id="tabMV"   class="tab-btn"        type="button" role="tab" aria-selected="false">Shop Verwaltung</button>
</div>

        <div class="providers" id="providers">
          <div class="provider" data-src="Lieferando"><img src="Lieferando.png" alt="Lieferando"><div class="p-qty"><button class="p-dec">âˆ’</button><span class="n">1</span><button class="p-inc">+</button></div></div>
          <div class="provider" data-src="Uber Eats"><img src="Uber.png" alt="Uber Eats"><div class="p-qty"><button class="p-dec">âˆ’</button><span class="n">1</span><button class="p-inc">+</button></div></div>
          <div class="provider" data-src="Wolt"><img src="Wolt.png" alt="Wolt"><div class="p-qty"><button class="p-dec">âˆ’</button><span class="n">1</span><button class="p-inc">+</button></div></div>
          <div class="provider" data-src="Restablo"><img src="Restablo.jpg" alt="Restablo"><div class="p-qty"><button class="p-dec">âˆ’</button><span class="n">1</span><button class="p-inc">+</button></div></div>
          <div class="provider" data-src="Andere"><img src="Andere.png" alt="Andere"><div class="p-qty"><button class="p-dec">âˆ’</button><span class="n">1</span><button class="p-inc">+</button></div></div>
        </div>
		<!-- === MULTI-ORDERS UI START === -->
<div id="multiRows" class="multi-rows"></div>
<!-- === MULTI-ORDERS UI END === -->

        <!-- TAUSSIL-PATCH-BEGIN [row-time-replace] -->
<div class="row">
  <input id="time" class="input center" type="time" placeholder="HH:MM">
  <input id="price" class="input center" type="text" value="0,00â‚¬" placeholder="0,00â‚¬" readonly>
</div>
<!-- TAUSSIL-PATCH-END -->

        <button id="sendBtn" class="send" type="button" disabled>Senden</button>
        <div id="banner" class="banner">âœ” Gesendet</div>

        <!-- Trip card -->
        <div class="trip hidden" id="tripCard">
          <div class="trip-title">Fahrt & Bestellung</div>
          <div class="trip-row"><div class="k">Vorname</div><div class="v" id="tripDriverName">â€”</div></div>
		  <div class="trip-row">
  <div class="k">Fahrer-Telefon</div>
  <div class="v"><a id="tripDriverPhone" href="#" style="text-decoration:none;color:inherit">â€”</a></div>
</div>
          <div class="trip-row"><div class="k">Status</div><div class="v" id="tripStatus">â€”</div></div>
          <div class="trip-row"><div class="k">Auftrag-ID</div><div class="v" id="tripOrderId">â€”</div></div>
          <div class="trip-row"><div class="k">ETM (zum Restaurant)</div><div class="v countdown" id="tripETM">--:--</div></div>
          <div class="trip-row"><div class="k">LiefergebÃ¼hr</div><div class="v" id="tripDeliveryFee">0,00â‚¬</div></div>
        </div>
      </div>
    </section>

    <!-- center -->
    <section class="panel center">
      <div class="ph"><div class="t">Karte</div><div class="s" id="mapInfo">â€”</div></div>
      <div class="pb" style="padding:12px">
        <div class="map-wrap">
          <div class="map-ui">
		  <label style="display:flex;align-items:center;gap:6px">
  <input id="mapLiveToggle" type="checkbox" />
  <span>Live-ETA</span>
</label>

            <span>Style:</span>
            <select id="mapStyle">
              <option value="classic">Klassisch</option>
              <option value="mono">Monochrom</option>
              <option value="cartoon">Cartoon</option>
              <option value="satellite">Satellit</option>
            </select>
          </div>
          <div id="map"></div>
        </div>
      </div>
    </section>

    <!-- right -->
    <section class="panel right">
<div class="ph" id="overviewHeader">
  <div class="t">Ãœbersicht</div>
  <div class="s">Live</div>
  <button id="menuBtn" class="btn-mini" style="margin-left:auto">â˜°</button>
</div>

      <div class="pb">
        <div class="stats">
          <div class="stat"><div class="t">Summe Preise (â‰  Abgebrochen)</div><div class="k" id="sumPreis">0,00â‚¬</div></div>
          <div class="stat"><div class="t">Summe LiefergebÃ¼hren (â‰  Abgebrochen)</div><div class="k" id="sumLiefer">0,00â‚¬</div></div>
        </div>
        <h4 style="margin:10px 2px">Letzte AuftrÃ¤ge</h4>
        <div id="lastList" class="list"></div>
      </div>
    </section>
  </div>

  <!-- sounds -->
  <audio id="sendSound"      src="senden.mp3"     preload="auto"></audio>
  <audio id="unterwegsSound" src="unterwegs.mp3"  preload="auto"></audio>
  <audio id="timer160Sound"  src="Ankunft.mp3"    preload="auto"></audio>
  <audio id="deliveredSound" src="Geliefert.mp3"  preload="auto"></audio>
  <input id="soundPicker" type="file" accept="audio/mpeg" multiple style="display:none">

<script type="module">
/* ================= Firebase Core ================= */
const firebaseConfig = {
  apiKey: "AIzaSyD0g9T3amjuPodsLS6ZQkHYWrzV1UrX_QI", /* â† Ø£Ø¹ÙŠØ¯ ÙƒÙ…Ø§ ÙƒØ§Ù† */
  authDomain: "taussil-lieferservice-8bbe9.firebaseapp.com",
  projectId: "taussil-lieferservice-8bbe9",
  storageBucket: "taussil-lieferservice-8bbe9.firebasestorage.app",
  messagingSenderId: "583536892937",
  appId: "1:583536892937:web:5d5ff133de4d8b3b28ecd8",
  databaseURL: "https://taussil-lieferservice-8bbe9-default-rtdb.europe-west1.firebasedatabase.app"
};

import { initializeApp, getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getFirestore, collection, doc, setDoc, getDoc, serverTimestamp,
  onSnapshot, query, where, orderBy, limit, getDocs, startAfter,
  getCountFromServer
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";


import { getDatabase, ref as rRef, get as rGet, onValue as rOn, off as rOff } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

let app; try{ app=getApp(); }catch{ app=initializeApp(firebaseConfig); }
const db   = getFirestore(app);
const rtdb = getDatabase(app);
const auth = getAuth(app);
setPersistence(auth, browserLocalPersistence).catch(()=>{});

/* ================= Shortcuts & State ================= */
const $ = (s)=>document.querySelector(s);
const money = n=> (Number(n||0)).toLocaleString("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2})+"â‚¬";
const parsePrice = s => { if(s==null) return 0; const n = parseFloat(String(s).replace(/[^\d.,-]/g,"").replace(",",".")); return Number.isFinite(n)?n:0; };
/* === TAUSSIL-COST: Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ØªÙˆÙÙŠØ± Ø§Ù„ØªÙƒÙ„ÙØ© === */
const COST_SAVE = {
  GEOFENCE_M: 280,          // 200â€“300m Ù„Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØªØ¨Ù‘Ø¹ ÙˆØ§Ù„Ù€Directions
  ROUTE_MIN_MS: 60000,      // Ø£Ù‚Ù„ ÙØªØ±Ø© Ø¨ÙŠÙ† Ù…ÙƒØ§Ù„Ù…Ø§Øª Directions (60s)
  ROUTE_MIN_MOVE_M: 700,    // Ø£Ùˆ Ø¹Ù†Ø¯ ØªØ­Ø±Ù‘Ùƒ Ø§Ù„Ø³Ø§Ø¦Ù‚ â‰¥ 700Ù…
  LIVE_DEFAULT: false       // Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§ *Ø¨Ø¯ÙˆÙ†* Live-ETA (ØªÙˆÙÙŠØ±)
};

// Ø­Ø§Ù„Ø© Ø¯Ø§Ø®Ù„ÙŠØ© Ù„Ù„ØªØ«Ø¨ÙŠØª/Ø§Ù„Ø«Ø±ÙˆØªÙ„
let __lastRouteAt   = 0;              // Ø¢Ø®Ø± ÙˆÙ‚Øª Ø·Ù„Ø¨ Directions
let __lastRouteFrom = null;           // Ø¢Ø®Ø± Ù…ÙˆØ¶Ø¹ Ø§Ø³ØªÙØ®Ø¯Ù… Ù„Ù„Ù€Directions
let __geofenceHit   = false;          // Ù‚ÙÙÙ„ Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø¨ Ù…Ù† Ø§Ù„Ù…Ø·Ø¹Ù…

/* === Persist keys (localStorage) === */
const LS_TRIP_OID   = 'trip:selectedOrderId';
const LS_TRIP_TARGET= 'trip:targetMs';
const LS_REST_POS   = 'rest:pos';

/* Helpers: localStorage */
const ls = {
  set(k,v){ try{ localStorage.setItem(k, typeof v==='string'? v : JSON.stringify(v)); }catch(_){} },
  get(k, def=null){ try{ const v=localStorage.getItem(k); return v==null? def : (v.startsWith('{')||v.startsWith('[')? JSON.parse(v): (isFinite(+v)? +v : v)); }catch(_){ return def; } },
  del(k){ try{ localStorage.removeItem(k);}catch(_){} }
};

/* UI refs */
const providersRoot = $("#providers");
const providerEls   = providersRoot ? Array.from(providersRoot.querySelectorAll(".provider")) : [];
const qtyEl   = $("#qty");
const priceEl = $("#price");
const timeEl  = $("#time");
const sendBtn = $("#sendBtn");
const banner  = $("#banner");
const lastList = $("#lastList");
const sumPreis = $("#sumPreis");
const sumLiefer= $("#sumLiefer");
const nrBox    = $("#nrBox");
const qtyMinus = $("#qtyMinus");
const qtyPlus  = $("#qtyPlus");

/* Auth modal refs (Restaurant) */
const restAuth     = $("#restAuth");
const rTabLogin    = $("#rTabLogin");
const rTabRegister = $("#rTabRegister");
const rPaneLogin   = $("#rPaneLogin");
const rPaneRegister= $("#rPaneRegister");
const rLoginEmail  = $("#rLoginEmail");
const rLoginPass   = $("#rLoginPass");
const rLoginBtn    = $("#rLoginBtn");
const rLoginMsg    = $("#rLoginMsg");
const rRegName     = $("#rRestName");
const rRegPhone    = $("#rRestPhone");
const rRegAddr     = $("#rRestAddr");
const rRegEmail    = $("#rRegEmail");
const rRegPass     = $("#rRegPass");
const rRegisterBtn = $("#rRegisterBtn");
const rRegMsg      = $("#rRegMsg");

/* Hidden defaults */
const hiddenDefaults = { Restaurant_ID: null, Restaurant_Name: null, Restaurant_Adresse: null, Telefon: null };
/* Ù†Ø¨Ø¶ Ù„Ù„Ø·Ù„Ø¨Ø§Øª Unterwegs ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙŠÙ…ÙŠÙ† */
function markUnterwegsRows(){
  if(!lastList) return;
  lastList.querySelectorAll('.rowx').forEach(row=>{
    const s = (row.dataset.status || '').trim();
    const isDone = (s === 'Geliefert' || s === 'Abgebrochen');
    row.classList.toggle('is-underway', s === 'Unterwegs' && !isDone);
  });
}

/* ===== Tabs (login/register) ===== */
function switchPane(which){
  const reg = which==='register';
  if(rPaneLogin)    rPaneLogin.style.display    = reg ? 'none' : 'block';
  if(rPaneRegister) rPaneRegister.style.display = reg ? 'block': 'none';
  if(rTabLogin)     rTabLogin.style.opacity     = reg ? .7 : 1;
  if(rTabRegister)  rTabRegister.style.opacity  = reg ? 1 : .7;
}
rTabLogin?.addEventListener('click', (e)=>{ e.preventDefault(); switchPane('login'); });
rTabRegister?.addEventListener('click', (e)=>{ e.preventDefault(); switchPane('register'); });

/* ===== Providers + Qty logic ===== */
const selectedProviders = new Set();
const providerQty = new Map();
/* TAUSSIL-PATCH-BEGIN [multi-rows-stepper-and-per-item-prices] */
function refreshQtyAndSendState(){
  // ØªØ¹ÙˆÙŠØ¶ Ø¢Ù…Ù† Ù„Ø£ÙŠ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡Ø§Øª Ù‚Ø¯ÙŠÙ…Ø©
  if (typeof renderMultiRows === 'function') renderMultiRows();
}
/* === MULTI-ORDERS: per-provider per-item prices + stepper in-row (no overlay) === */
const providerPrices = new Map();   // key => number[] (Ø³Ø¹Ø± Ù„ÙƒÙ„ Ø¹Ù†ØµØ± Ù„Ù†ÙØ³ Ø§Ù„Ù…Ø²ÙˆÙ‘Ø¯)
const multiRows = document.getElementById('multiRows');

function slugKey(k){ return String(k||'').toLowerCase().replace(/\s+/g,'_').replace(/[^a-z0-9_]/g,''); }
function globalTotalQty(){
  let s = 0; selectedProviders.forEach(k => s += Math.max(0, Number(providerQty.get(k)||0))); return s;
}
function ensurePricesArray(key){
  const q = Math.max(1, Math.min(3, Number(providerQty.get(key)||1)));
  providerQty.set(key, q);
  let arr = Array.isArray(providerPrices.get(key)) ? providerPrices.get(key) : [];
  if(arr.length < q) arr = arr.concat(new Array(q - arr.length).fill(0));
  if(arr.length > q) arr = arr.slice(0, q);
  providerPrices.set(key, arr);
  return arr;
}
function totalsForForm(){
  let totalQty = 0, totalAmount = 0;
  selectedProviders.forEach(k=>{
    const q   = Math.max(0, Number(providerQty.get(k)||0));
    const arr = ensurePricesArray(k);
    totalQty  += q;
    totalAmount += arr.reduce((a,v)=> a + (Number(v)||0), 0);
  });
  totalAmount = Math.round(totalAmount * 100) / 100;
  return { totalQty, totalAmount };
}
function recalcAndValidate(){
  const { totalQty, totalAmount } = totalsForForm();

  // Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙÙŠ Ø­Ù‚ÙˆÙ„ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
  if(qtyEl){ qtyEl.value = String(totalQty); qtyEl.readOnly = true; }  // Ø¥Ù† ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§
  if(priceEl){ priceEl.value = money(totalAmount); priceEl.readOnly = true; }

  // Ø´Ø±ÙˆØ· Ø§Ù„ØªÙØ¹ÙŠÙ„: 1..3 Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙƒÙ…ÙŠØ§Øª + ÙƒÙ„ Ø³Ø¹Ø± > 0
  const inRange = (totalQty >= 1 && totalQty <= 3);
  let allPriced = true;
  selectedProviders.forEach(k=>{
    const q   = Math.max(0, Number(providerQty.get(k)||0));
    const arr = ensurePricesArray(k);
    if(q===0){ allPriced=false; return; }
    for(let i=0;i<q;i++){ if(!(Number(arr[i])>0)) { allPriced=false; break; } }
  });
  sendBtn.disabled = !(inRange && allPriced);
}

/* Ø±Ø³Ù… ØµÙÙˆÙ Ø§Ù„Ù…Ø²ÙˆØ¯ÙŠÙ†: [Ø§Ø³Ù…] [Ø¹Ø¯Ø§Ø¯ +/âˆ’] [Ø­Ù‚ÙˆÙ„ Ø£Ø³Ø¹Ø§Ø± Ø¨Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙ…ÙŠØ©] */
function renderMultiRows(){
  if(!multiRows) return;

  const rows = [...selectedProviders].map(k=>{
    const q   = Math.max(1, Math.min(3, Number(providerQty.get(k)||1)));
    providerQty.set(k, q);
    const arr = ensurePricesArray(k);

    // Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø³Ø¹Ø±ÙŠØ© Ù„ÙƒÙ„ Ø¹Ù†ØµØ± (#1..#q)
    const pricesInputs = Array.from({length:q}, (_,i)=>{
      const val = arr[i] ? String(arr[i]).replace('.',',') : '';
      return `
        <div class="price-chip" data-idx="${i}" style="display:flex;align-items:center;gap:6px;margin:4px 0;">
          <span class="small" style="width:22px;text-align:center">#${i+1}</span>
          <input class="input per-price" type="text" inputmode="decimal" placeholder="0,00â‚¬" value="${val}">
        </div>`;
    }).join('');

    return `
      <div class="multi-row" data-key="${k}">
        <div class="prov">${k}</div>
        <div class="qty-wrap">
          <button type="button" class="btn-step q-dec">âˆ’</button>
          <input class="input center per-qty" type="number" min="1" max="3" value="${q}" readonly>
          <button type="button" class="btn-step q-inc">+</button>
        </div>
        <div class="prices">${pricesInputs}</div>
      </div>`;
  });

  // Ø§Ù„Ø´Ø¨ÙƒØ© Ù„Ø¯ÙŠÙƒ Ù…Ø¹Ø±ÙØ© Ù…Ø³Ø¨Ù‚Ù‹Ø§: 1.2fr 0.8fr 1fr
  multiRows.innerHTML = rows.join('');
  recalcAndValidate();
}

/* Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± â€” ÙŠØ­Ø³Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙˆÙŠØºÙ„Ù‚ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø°Ø§ Ù„Ø²Ù… */
multiRows?.addEventListener('input', (e)=>{
  if(!e.target.classList.contains('per-price')) return;
  const row = e.target.closest('.multi-row'); if(!row) return;
  const key = row.getAttribute('data-key');
  const idx = Number(e.target.closest('.price-chip')?.getAttribute('data-idx')||0);
  const raw = String(e.target.value||'').replace(/[^\d,.\-]/g,'').replace(',','.');
  const num = Number(raw);
  const arr = ensurePricesArray(key);
  arr[idx] = (Number.isFinite(num) && num>0) ? Math.round(num*100)/100 : 0;
  providerPrices.set(key, arr);
  recalcAndValidate();
}, true);

/* ØªÙ†Ø³ÙŠÙ‚ â‚¬ Ø¹Ù†Ø¯ blur */
multiRows?.addEventListener('blur', (e)=>{
  if(!e.target.classList.contains('per-price')) return;
  const row = e.target.closest('.multi-row'); if(!row) return;
  const key = row.getAttribute('data-key');
  const idx = Number(e.target.closest('.price-chip')?.getAttribute('data-idx')||0);
  const arr = ensurePricesArray(key);
  const p = Number(arr[idx]||0);
  e.target.value = p ? money(p) : '';
}, true);

/* Ø¹Ø¯Ù‘Ø§Ø¯ +/âˆ’ Ø¯Ø§Ø®Ù„ Ø§Ù„ØµÙ */
multiRows?.addEventListener('click', (e)=>{
  const row = e.target.closest('.multi-row'); if(!row) return;
  const key = row.getAttribute('data-key'); if(!selectedProviders.has(key)) return;

  if(e.target.classList.contains('q-inc')){
    const tot = globalTotalQty();
    const cur = Math.max(1, Number(providerQty.get(key)||1));
    if(tot >= 3 || cur >= 3) return;
    providerQty.set(key, cur+1);
    ensurePricesArray(key);
    renderMultiRows();
  }
  if(e.target.classList.contains('q-dec')){
    const cur = Math.max(1, Number(providerQty.get(key)||1));
    if(cur <= 1) return;
    providerQty.set(key, cur-1);
    ensurePricesArray(key);
    renderMultiRows();
  }
});

/* Ø§Ø®ØªÙŠØ§Ø±/Ø¥Ù„ØºØ§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø²ÙˆØ¯ Ù…Ù† Ø´Ø¨ÙƒØ© Ø§Ù„ØµÙˆØ± (Ø¨Ø¯ÙˆÙ† Ø£ÙŠ Ø£Ø²Ø±Ø§Ø± ÙÙˆÙ‚ Ø§Ù„ØµÙˆØ±) */
if(providersRoot){
  providersRoot.addEventListener('click', (ev)=>{
    // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø¶ØºØ· Ø¯Ø§Ø®Ù„ Ø´Ø§Ø±Ø© Ø§Ù„ØµÙˆØ±Ø© Ø¥Ù† ÙˆÙØ¬Ø¯Øª (Ù„ÙƒÙ†Ù†Ø§ Ù…Ø®ÙÙŠÙ‘Ù†Ù‡Ø§ Ø£Ø³Ø§Ø³Ù‹Ø§)
    if(ev.target.closest('.p-qty')) return;
    const card = ev.target.closest('.provider'); if(!card) return;
    const key = card.getAttribute('data-src');
    card.classList.toggle('is-selected');
    if(card.classList.contains('is-selected')){
      selectedProviders.add(key);
      if(!providerQty.has(key)) providerQty.set(key, 1);
      ensurePricesArray(key);
    }else{
      selectedProviders.delete(key);
      providerQty.delete(key);
      providerPrices.delete(key);
    }
    renderMultiRows();
  });
}

renderMultiRows();
/* TAUSSIL-PATCH-END */



qtyMinus?.addEventListener('click', ()=>{
  if(selectedProviders.size===1){
    const key=[...selectedProviders][0];
    const cur=providerQty.get(key)||1;
    providerQty.set(key, Math.max(1, cur-1));
    refreshQtyAndSendState();
  }
});
qtyPlus?.addEventListener('click', ()=>{
  if(selectedProviders.size===1){
    const key=[...selectedProviders][0];
    const cur=providerQty.get(key)||1;
    providerQty.set(key, cur+1);
    refreshQtyAndSendState();
  }
});

if(priceEl){
  if(!priceEl.value) priceEl.value="0,00â‚¬";
  priceEl.addEventListener("input", ()=>{ priceEl.value = priceEl.value.replace(/[^\d.,]/g,""); });
  priceEl.addEventListener("blur",  ()=>{ priceEl.value = money(parsePrice(priceEl.value)); });
  priceEl.addEventListener("focus", ()=>{ const n=parsePrice(priceEl.value); priceEl.value = n===0 ? "" : String(n).replace(".",","); });
}

/* ===== Auth (Restaurant) ===== */
function showAuth(on=true){ if(restAuth) restAuth.style.display = on?'flex':'none'; }

rLoginBtn?.addEventListener('click', async (ev)=>{
  ev.preventDefault();
  const email=(rLoginEmail?.value||'').trim();
  const pass =(rLoginPass ?.value||'');
  if(!email || !pass){ if(rLoginMsg) rLoginMsg.textContent='Bitte E-Mail & Passwort eingeben.'; return; }
  rLoginBtn.disabled=true; if(rLoginMsg) rLoginMsg.textContent='â€¦';
  try{
    await signInWithEmailAndPassword(auth, email, pass);
    if(rLoginMsg) rLoginMsg.textContent='';
    showAuth(false);
  }catch(e){
    console.error(e);
    if(rLoginMsg) rLoginMsg.textContent = (e && e.code) ? ('Fehler: '+e.code) : 'Anmeldung fehlgeschlagen.';
  }finally{ rLoginBtn.disabled=false; }
});

rRegisterBtn?.addEventListener('click', async (ev)=>{
  ev.preventDefault();
  const restName=(rRegName?.value||'').trim();
  const phone   =(rRegPhone?.value||'').trim();
  const addr    =(rRegAddr ?.value||'').trim();
  const email   =(rRegEmail?.value||'').trim();
  const pass    =(rRegPass ?.value||'');

  // âœ… ØªØ­Ù‚Ù‘Ù‚ Ù„ÙŠÙ†: ÙŠÙƒÙÙŠ Ø§Ù„Ø§Ø³Ù… + Ø§Ù„Ø¹Ù†ÙˆØ§Ù† + Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ + ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± 6+
  if(!restName || !addr || !email || (pass||'').length<6){
    if(rRegMsg) rRegMsg.textContent='Bitte gÃ¼ltige Daten eingeben.'; 
    return;
  }
  rRegisterBtn.disabled=true; if(rRegMsg) rRegMsg.textContent='â€¦';

  try{
    const cred = await createUserWithEmailAndPassword(auth, email, pass);
    const uid  = cred.user.uid;

    await setDoc(doc(db,'users', uid), {
      email, role:'restaurant', status:'pending', approved:false,
      restName, phone: phone || null, address_text: addr,
      createdAt: serverTimestamp(), updatedAt: serverTimestamp()
    }, { merge:false });

    if(rRegMsg) rRegMsg.textContent='Konto erstellt. Wird geprÃ¼ftâ€¦';
    await signOut(auth).catch(()=>{});
    switchPane('login'); showAuth(true);
  }catch(e){
    console.error(e);
    const map = {
      'auth/email-already-in-use':'E-Mail bereits verwendet.',
      'auth/invalid-email':'UngÃ¼ltige E-Mail.',
      'auth/weak-password':'Passwort zu schwach.',
    };
    if(rRegMsg) rRegMsg.textContent = map[e?.code] || (`Fehler: ${e?.code||'unbekannt'}`);
  }finally{ rRegisterBtn.disabled=false; }
});
/* ===== Approval Gate (Firestore first, RTDB fallback) ===== */
let RESTAURANT_ID = null;
let ORDERS_UNSUB = null;
onAuthStateChanged(auth, async (user)=>{
  try{
    if(!user){
      RESTAURANT_ID=null; hiddenDefaults.Restaurant_ID=null;
      if(ORDERS_UNSUB){ ORDERS_UNSUB(); ORDERS_UNSUB=null; }
      showAuth(true);
      return;
    }
    RESTAURANT_ID = user.uid;
    let approved=false, role=null;
    try{
      const us = await getDoc(doc(db,'users', RESTAURANT_ID));
      if(us.exists()){
        const u=us.data()||{};
        approved = (u.approved===true);
        role = u.role||null;
      }
    }catch(_){}
    if(!approved){
      try{
        const snap = await rGet(rRef(rtdb, `users_meta/${RESTAURANT_ID}`));
        const meta = snap.val()||{};
        if(meta.role==='restaurant' && meta.approved===true){ approved=true; }
      }catch(_){}
    }
    if(!approved || role!=='restaurant'){
      if(rLoginMsg) rLoginMsg.textContent='Konto wird geprÃ¼ftâ€¦';
      showAuth(true);
      return;
    }
    try{
      const rs = await getDoc(doc(db,'restaurants', RESTAURANT_ID));
      const rd = rs.exists()? (rs.data()||{}) : {};
      hiddenDefaults.Restaurant_ID = RESTAURANT_ID;
      hiddenDefaults.Restaurant_Name = rd.name || user.email || null;
      hiddenDefaults.Restaurant_Adresse = rd.address_text || null;
      hiddenDefaults.Telefon = rd.phone || null;
    }catch(_){}
    showAuth(false);
    ensureRestaurantGeocoded();
    attachMyTotalsAndLast();
  }catch(e){
    console.error('auth flow error', e);
    showAuth(true);
  }
});
/* ===== Next serial ===== */
const LS_NR_KEY = (rid)=> `rest:last_nr:${rid}`;

async function nextSerialForRestaurant(restId){
  const localBase = Number(ls.get(LS_NR_KEY(restId), 0)) || 0;
  try{
    const qs = await getDocs(
      query(
        collection(db,'orders'),
        where('restaurant.id','==', restId),
        orderBy('nr','desc'),
        limit(1)
      )
    );
    const remote = (!qs.empty ? Number(qs.docs[0].data()?.nr || 0) : 0);
    const next = Math.max(localBase, remote) + 1;
    ls.set(LS_NR_KEY(restId), next);
    return next;
  }catch(e){
    console.warn('nextSerialForRestaurant()', e);
    const next = localBase + 1;
    ls.set(LS_NR_KEY(restId), next);
    return next;
  }
}
/* ===== Audio controller & Trip state ===== */
const snd = {
  send: document.getElementById('sendSound'),
  unterwegs: document.getElementById('unterwegsSound'),
  timer160: document.getElementById('timer160Sound'),
  delivered: document.getElementById('deliveredSound'),
};
let SND_MUTED = localStorage.getItem('sndMuted')==='1';
function renderSndBtn(){
  const b=document.getElementById('sndBtn');
  if(b){ b.textContent = SND_MUTED ? 'ğŸ”‡' : 'ğŸ”Š'; b.title = SND_MUTED? 'Unmute (Alt = Dateien wÃ¤hlen)' : 'Mute (Alt = Dateien wÃ¤hlen)'; }
}
renderSndBtn();
const played = new Set();
function playSnd(key, oid){
  try{
    const tag = key+'::'+(oid||'');
    if(played.has(tag)) return;
    played.add(tag);
    if(!SND_MUTED && snd[key]){ snd[key].currentTime=0; snd[key].play().catch(()=>{}); }
    setTimeout(()=>played.delete(tag), 1200);
  }catch(_){}
}
function playOncePerOrder(key, oid){
  if(!oid) return playSnd(key);
  const flag=key+':'+oid;
  if(localStorage.getItem(flag)) return;
  playSnd(key, oid);
  localStorage.setItem(flag,'1');
}
let SELECTED_ORDER_ID=null;
let TRIP_TIMER=null;
let TRIP_TARGET_MS=null;
let DRIVER_SUB=null;
let lastDriverPos=null;
// ===== Driver green arrow (icon + rotation) =====
const DRIVER_COLOR = '#22c55e'; // Ø£Ø®Ø¶Ø±
function driverArrowIcon(rotationDeg = 0){
  return {
    path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
    scale: 6,
    fillColor: DRIVER_COLOR,
    fillOpacity: 1,
    strokeColor: '#0b7d3b',
    strokeWeight: 1.5,
    rotation: rotationDeg,
    anchor: new google.maps.Point(0, 2),
  };
}
function headingDeg(fromLL, toLL){
  try{
    const from = (fromLL instanceof google.maps.LatLng) ? fromLL : new google.maps.LatLng(fromLL);
    const to   = (toLL   instanceof google.maps.LatLng) ? toLL   : new google.maps.LatLng(toLL);
    const h = google.maps.geometry.spherical.computeHeading(from, to);
    return Number.isFinite(h) ? h : 0;
  }catch{ return 0; }
}

const ORDER_CACHE=new Map();
/* ===== Send Order ===== */
async function computeFormQty(){
  let sum = 0;
  selectedProviders.forEach(k=>{ sum += Math.max(0, Number(providerQty.get(k)||0)); });
  return sum;
}

sendBtn?.addEventListener('click', async ()=>{
  if(!RESTAURANT_ID){ 
    if(rLoginMsg) rLoginMsg.textContent='Bitte zuerst anmelden.'; 
    showAuth(true); 
    return; 
  }

  const platforms = Array.from(selectedProviders);
  const qty = await computeFormQty();
  const preis = Math.max(0, parsePrice(priceEl?.value||0));
  const pickup = timeEl?.value || null;

  if(platforms.length<1 || qty<1) return;

  try{
    sendBtn.disabled=true;

    const qNr   = query(collection(db,'orders'), where('restaurant.id','==', RESTAURANT_ID));
    const cSnap = await getCountFromServer(qNr);
    const nr    = Number(cSnap.data().count || 0) + 1;

    const id  = Math.random().toString(36).slice(2,8).toUpperCase();
    const ref = doc(db,'orders', id);

    const rSnap = await getDoc(doc(db,'restaurants', RESTAURANT_ID));
    const addr  = rSnap.exists() ? (rSnap.data().address_text ?? rSnap.data().addressText ?? null) : null;
    if(!addr){ 
      alert('Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø·Ø¹Ù… ØºÙŠØ± Ù…ØªÙˆÙØ± ÙÙŠ Ù…Ù„Ù Ø§Ù„Ù…Ø·Ø¹Ù….'); 
      return; 
    }

    // Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø£Ù…
    await setDoc(ref, {
  nr,
  status: 'Bearbeitung',
  platform: platforms,
  qty,

  // â¬‡ï¸ Ø§Ù„Ø¬Ø¯ÙŠØ¯
  stops_total: qty,
  stops_delivered: 0,

  price: Math.round(preis * 100) / 100,
  deliveryFee: 0,
  pickupTime: pickup,
  restaurant: {
    id: RESTAURANT_ID,
    name: hiddenDefaults?.Restaurant_Name ?? null,
    phone: hiddenDefaults?.Telefon ?? null,
    address_text: addr
  },
  driver: { id:null, firstName:null, pos:null },
  createdAt: serverTimestamp(),
  updatedAt: serverTimestamp()
});


    // === TAUSSIL-PATCH: Ø¥Ù†Ø´Ø§Ø¡ stops Ø¥Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ Ù…ØªØ¹Ø¯Ø¯ ===
if (qty > 1 && Array.isArray(platforms) && platforms.length) {
  try {
    const stopCol = collection(ref, 'stops');
    let stopIdx = 0;

    for (const plat of platforms) {
      const arr = providerPrices.get(plat) || [];
      for (let i = 0; i < arr.length; i++) {
        stopIdx++;
        const stopId = `${plat}_${i+1}`;
        const stopRef = doc(stopCol, stopId);

        await setDoc(stopRef, {
          nr,
          platform: plat,
          price: Math.round(Number(arr[i] || 0) * 100) / 100,
          qty: 1,
          deliveryFee: 0,
          status: "Bearbeitung",
          address_text: addr, // âœ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù†ÙØ³ Ø§Ù„Ù…ØªØºÙŠØ± addr
          name: hiddenDefaults?.Restaurant_Name ?? null,
          phone: hiddenDefaults?.Telefon ?? null,
          fullName: null,
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        });
      }
    }
  } catch(e){
    console.error("stops creation failed", e);
  }
}
// === END PATCH ===


    playSnd('send', id);
    if(nrBox) nrBox.textContent = nr;
    if(banner){ 
      banner.textContent='âœ” Gesendet'; 
      banner.classList.add('show'); 
      setTimeout(()=>banner.classList.remove('show'),1600); 
    }

    providerQty.clear(); 
    selectedProviders.clear();
    providerEls.forEach(el=>el.classList.remove('is-selected'));
    if(qtyEl){ qtyEl.value='0'; qtyEl.readOnly=true; }
    if(priceEl) priceEl.value='0,00â‚¬';
    if(timeEl) timeEl.value='';
    refreshQtyAndSendState();

  }catch(e){
    console.error(e);
    alert("Senden fehlgeschlagen. PrÃ¼fe Berechtigungen & Indizes.");
  }finally{
    sendBtn.disabled=false;
  }
});

/* ===== Totals + Last list ===== */
// === Ø¹Ø±Ø¶ Ø±Ø³ÙˆÙ… Ø§Ù„ØªÙˆØµÙŠÙ„ ÙÙŠ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø·Ø¹Ù… (Ø£ÙˆÙ„ÙˆÙŠØ© Ù„Ù€ serviceFee Ø«Ù… fallback Ø¥Ù„Ù‰ deliveryFee)
function feeForView(o){
  const s = Number(o?.serviceFee);
  if (Number.isFinite(s) && s >= 0) return s;
  const d = Number(o?.deliveryFee);
  return Number.isFinite(d) ? d : 0;
}

function attachMyTotalsAndLast(){
  if(ORDERS_UNSUB){ ORDERS_UNSUB(); ORDERS_UNSUB=null; }
  if(!RESTAURANT_ID) return;
  onSnapshot(query(collection(db,'orders'), where('restaurant.id','==', RESTAURANT_ID)), (snap)=>{
    let sumP=0, sumL=0;
snap.forEach(d=>{
  const o=d.data()||{};
  if(String(o.status||'')==='Abgebrochen') return;

  const p = Number(o.price || 0);
const l = Number(feeForView(o) || 0);


  if (Number.isFinite(p)) sumP += p;
  if (Number.isFinite(l)) sumL += l;
});

    if(sumPreis) sumPreis.textContent=money(sumP);
    if(sumLiefer) sumLiefer.textContent=money(sumL);
  });
  ORDERS_UNSUB = onSnapshot(
    query(collection(db,'orders'),
      where('restaurant.id','==', RESTAURANT_ID),
      orderBy('updatedAt','desc'),
      limit(8)),
    (snap)=>{
      if(!lastList) return;
      if(snap.empty){
        lastList.innerHTML = `<div class="rowx"><span>â€” Keine Daten â€”</span></div>`;
        return;
      }
      lastList.innerHTML = snap.docs.map(d=>{
  const o=d.data()||{};
  const plat = Array.isArray(o.platform)? o.platform.join(' / ') : (o.platform||'â€”');
  const preis= money(Number(o.price||0));
  const name = o.restaurant?.name || 'â€”';
  const qty  = Number(o.qty||0);
  const nr   = (o.nr!=null ? `#${o.nr}` : '');
  /* â¬…ï¸ Ø£Ø¶ÙÙ†Ø§ data-status */
  return `<div class="rowx" data-oid="${d.id}" data-status="${o.status||''}">
    <div class="id">${d.id} ${nr}</div>
    <div class="tag">${plat}</div>
    <div style="flex:1"></div>
    <div>${name}</div>
    <div>${qty>0? qty : ''}</div>
    <div>${preis}</div>
  </div>`;
}).join('');
/* â¬…ï¸ Ø¨Ø¹Ø¯ Ø§Ù„Ø±Ù†Ø¯Ø± Ù…Ø¨Ø§Ø´Ø±Ø© */
markUnterwegsRows();

      snap.docChanges().forEach(ch=>{
        const id = ch.doc.id; const o = ch.doc.data()||{};
        const prev = ORDER_CACHE.get(id)?.status;
        ORDER_CACHE.set(id, {status:o.status});
        if(prev !== undefined && prev !== o.status){
          if(o.status === 'Unterwegs'){
            playSnd('unterwegs', id);
            if(!SELECTED_ORDER_ID){ showTripCard(id, o); }
          }
          if(o.status === 'Geliefert'){
            playSnd('delivered', id);
            if(SELECTED_ORDER_ID===id){
              stopDriverTracking();
              clearMapArtifacts();
              resetTripTimesUI();
            }
          }
        }
        if(SELECTED_ORDER_ID===id){ showTripCard(id, o); }
      });
      if(!lastList.__bound){
        lastList.__bound = true;
        lastList.addEventListener('click', async (e)=>{
          const row = e.target.closest('.rowx'); if(!row) return;
          const oid = row.getAttribute('data-oid'); if(!oid) return;
          try{
            const ds = await getDoc(doc(db,'orders', oid));
            if(ds.exists()) showTripCard(oid, ds.data());
          }catch(_){}
        });
      }
    }
  );
}
/* ===== Driver name resolver (Vorname ÙÙ‚Ø· Ù…Ù† users) ===== */
const firstWord = (s)=> {
  const t = String(s||'').replace(/\s+/g,' ').trim();
  return t ? t.split(' ')[0] : 'â€”';
};

async function resolveDriverName(drv){
  try{
    // 1) Ù„Ùˆ Ø§Ù„Ø§Ø³Ù… Ù…ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù†ÙØ³Ù‡
    if (drv?.firstName && typeof drv.firstName === 'string') {
      return firstWord(drv.firstName);
    }

    // 2) Ù„Ùˆ Ø¹Ù†Ø¯ÙŠ driver.id: Ø¬Ø±Ù‘Ø¨ Ø§Ù‚Ø±Ø£ users/{id}
    if (drv?.id) {
      try{
        const us = await getDoc(doc(db,'users', drv.id));
        if (us.exists()) {
          const u = us.data() || {};
          // Ø¬Ø±Ù‘Ø¨ Ø£ÙƒØ«Ø± Ù…Ù† Ø­Ù‚Ù„ Ù…Ø­ØªÙ…Ù„
          const n = u.firstName || u.profile?.firstName || u.name || u.displayName || '';
          if (n) return firstWord(n);
        }
      }catch(e){
        // Ø¹Ù„Ù‰ ØµÙ„Ø§Ø­ÙŠØ§Øª Firestore: Ù„Ùˆ Ø·Ù„Ø¹ "Missing or insufficient permissions" Ø¨Ù†Ø±Ø¬Ø¹ Ù„Ø¨Ø¯Ø§Ø¦Ù„
        // console.warn('resolveDriverName(users)', e);
      }
    }

    // 3) Ø¨Ø¯ÙŠÙ„ Ø£Ø®ÙŠØ± Ù…Ù† Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ø¥Ù† ÙˆÙØ¬Ø¯ ÙÙŠ Ø§Ù„Ø·Ù„Ø¨
    if (typeof drv?.email === 'string' && drv.email.includes('@')) {
      return firstWord(drv.email.split('@')[0]);
    }
  } catch(_) {}

  return 'â€”';
}

/* ===== Trip card + order live listener ===== */
let TRIP_ORDER_UNSUB = null;
/* === ETM Live flags (Kill Switch + Buffer) === */
const ETM_LIVE_V1 = true;           // ÙŠÙ…ÙƒÙ† Ø¥Ø·ÙØ§Ø¤Ù‡ Ø³Ø±ÙŠØ¹Ø§Ù‹ Ø¥Ù† Ù„Ø²Ù…
const ETM_BUFFER_SEC = 180;         // Ù‡Ø§Ù…Ø´ Ø£Ù…Ø§Ù† ÙÙˆÙ‚ Ù…Ø¯Ø© Ø§Ù„Ø·Ø±ÙŠÙ‚
let SERVER_ETM_ACTIVE = false;
function setDriverPhoneFromOrder(o){
  const link = document.getElementById('tripDriverPhone');
  if(!link) return;

  // Ù†Ø¬Ø±Ø¨ Ø£ÙƒØ«Ø± Ù…Ù† Ø§Ø³Ù… Ø­Ù‚Ù„ Ù…Ø­ØªÙ…Ù„ Ø¯Ø§Ø®Ù„ o.driver
  const raw =
    (o?.driver?.phone) ??
    (o?.driver?.tel) ??
    (o?.driver?.mobile) ??
    null;

  if (typeof raw === 'string' && raw.trim()){
    const normalized = raw.replace(/[^\d+]/g, ''); // Ù†ÙØ¨Ù‚ÙŠ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ÙˆØ¹Ù„Ø§Ù…Ø© +
    link.textContent = raw;             // Ù†Ø¹Ø±Ø¶Ù‡ ÙƒÙ…Ø§ Ù‡Ùˆ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
    link.setAttribute('href', `tel:${normalized}`); // ÙŠÙØµØ¨Ø­ Ù‚Ø§Ø¨Ù„Ø§Ù‹ Ù„Ù„Ù†Ù‚Ø±
    link.style.pointerEvents = 'auto';
    link.style.opacity = '1';
  } else {
    link.textContent = 'â€”';
    link.removeAttribute('href');
    link.style.pointerEvents = 'none';
    link.style.opacity = '.7';
  }
}

function showTripCard(oid, o){
  SELECTED_ORDER_ID = oid;
  const card = document.getElementById('tripCard'); if(!card) return;
  card.classList.remove('hidden');
  document.getElementById('tripOrderId').textContent  = oid;
  document.getElementById('tripStatus').textContent   = o.status || 'â€”';
  setDriverPhoneFromOrder(o);

  {
  const feeVal = feeForView(o);
const el = document.getElementById('tripDeliveryFee');
if (el) el.textContent = money(feeVal);

}

  {
  const d = (o && o.driver) ? o.driver : {};
  const cand =
    (typeof d.firstName   === 'string' && d.firstName)   ||
    (typeof d.first_name  === 'string' && d.first_name)  ||
    (typeof d.first       === 'string' && d.first)       ||
    (typeof d.name        === 'string' && d.name)        ||
    (typeof d.fullName    === 'string' && d.fullName)    ||
    (typeof d.displayName === 'string' && d.displayName) ||
    (typeof d.email       === 'string' && d.email.split('@')[0]) ||
    '';
  const n = (String(cand||'').trim().split(/\s+/)[0]) || 'â€”';
  const el = document.getElementById('tripDriverName');
  if (el) el.textContent = n;
}

  attachOrderListener(oid);
}
function attachOrderListener(orderId){
  if(TRIP_ORDER_UNSUB){ TRIP_ORDER_UNSUB(); TRIP_ORDER_UNSUB=null; }
  const ref = doc(db,'orders', orderId);
  TRIP_ORDER_UNSUB = onSnapshot(ref, async (ds)=>{
    if(!ds.exists()) return;
    const o = ds.data() || {};
	setDriverPhoneFromOrder(o);

    document.getElementById('tripStatus').textContent = o.status || 'â€”';
    {
  const feeVal = feeForView(o);
const el = document.getElementById('tripDeliveryFee');
if (el) el.textContent = money(feeVal);

}

    {
  const d = (o && o.driver) ? o.driver : {};
  const cand =
    (typeof d.firstName   === 'string' && d.firstName)   ||
    (typeof d.first_name  === 'string' && d.first_name)  ||
    (typeof d.first       === 'string' && d.first)       ||
    (typeof d.name        === 'string' && d.name)        ||
    (typeof d.fullName    === 'string' && d.fullName)    ||
    (typeof d.displayName === 'string' && d.displayName) ||
    (typeof d.email       === 'string' && d.email.split('@')[0]) ||
    '';
  const n = (String(cand||'').trim().split(/\s+/)[0]) || 'â€”';
  const el = document.getElementById('tripDriverName');
  if (el) el.textContent = n;
}

    const status = String(o.status||'');
    const serverMs = Number(o.etmTargetMs ?? o.ETM_Target ?? 0);
    if(status === 'Unterwegs' && o.driver?.id){
      if(Number.isFinite(serverMs) && serverMs > Date.now() - 12*60*60*1000){
        SERVER_ETM_ACTIVE = true;
        TRIP_TARGET_MS = serverMs;
        ls.set(LS_TRIP_OID, orderId);
        ls.set(LS_TRIP_TARGET, TRIP_TARGET_MS);
        lastETARoundedSec = Math.ceil((TRIP_TARGET_MS - Date.now())/1000);
        startCountdown();
      }else{
        SERVER_ETM_ACTIVE = false; // Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¹Ù„Ù‰ Directions Ø§Ù„Ù…Ø­Ù„ÙŠ
      }
      startDriverTracking(orderId, o.driver.id);
      ensureRestaurantGeocoded();
    } else if(status === 'Geliefert' || status === 'Abgebrochen'){
      stopDriverTracking(); clearMapArtifacts(); resetTripTimesUI();
    } else {
      stopDriverTracking(); clearMapArtifacts(); resetTripTimesUI();
    }
  });
}
/* ===== Helpers: clear map & reset UI ===== */
function clearMapArtifacts(){
  try{ if(window.__dirRenderer){ window.__dirRenderer.setDirections({routes:[]}); } }catch(_){}
  try{
    if(window.__driverMarker){ window.__driverMarker.setMap(null); window.__driverMarker=null; }
    if(window.__restMarker){   window.__restMarker.setMap(null);   window.__restMarker=null; }
  }catch(_){}
  const mi = document.getElementById('mapInfo'); if(mi) mi.textContent='â€”';
}
function resetTripTimesUI(){
  const et = document.getElementById('tripETM');
  const di = document.getElementById('tripDistance');
  if(et){ et.textContent='--:--'; et.classList.remove('blink-red'); }
  if(di){ di.textContent='â€” km'; }
}
/* ===== Geometry & Map update ===== */
function haversine(a,b){
  const R=6371, toRad=x=>x*Math.PI/180;
  const dLat=toRad(b.lat-a.lat), dLng=toRad(b.lng-a.lng);
  const s=Math.sin(dLat/2)**2 + Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*Math.sin(dLng/2)**2;
  return 2*R*Math.asin(Math.sqrt(s));
}
let restGeocoded=false;
/* === TAUSSIL-COST: ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø®Ø±ÙŠØ·Ø© + Ø¬ÙŠÙˆÙÙÙ†Ø³ + ØªÙ‚Ù†ÙŠÙ† === */
function updateMapAndDistance(dLat, dLng){
  const map = window.__map;
  if(!map || !window.google?.maps) return;

  // 1) Ø±Ø³Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø¨Ø³Ù‡Ù… Ø£Ø®Ø¶Ø± Ù…Ø¹ Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ø­Ø±ÙƒØ©
  const nextLL = new google.maps.LatLng(Number(dLat), Number(dLng));
  const prevLL = (lastDriverPos && Number.isFinite(lastDriverPos.lat) && Number.isFinite(lastDriverPos.lng))
    ? new google.maps.LatLng(lastDriverPos.lat, lastDriverPos.lng)
    : nextLL;

  const rot = headingDeg(prevLL, nextLL);
  if(!window.__driverMarker){
  // Ø¯Ø§Ø¦Ø±Ø© Ø®Ø¶Ø±Ø§Ø¡ Ù…Ø¹ Ù†Ø¨Ø¶
  window.__driverMarker = new (window.PulsingMarker)(
    { lat: nextLL.lat(), lng: nextLL.lng() },
    map
  );
} else if (window.__driverMarker.setPosition){
  window.__driverMarker.setPosition({ lat: nextLL.lat(), lng: nextLL.lng() });
}


  lastDriverPos = { lat: nextLL.lat(), lng: nextLL.lng() };

  // 2) ØªØ£ÙƒÙŠØ¯ ÙˆØ¶Ù’Ø¹ Ø§Ù„Ù…Ø·Ø¹Ù… Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© (Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ù…Ø¹ Cache)
  if(window.__restPos){
    window.__restMarker = window.__restMarker || new google.maps.Marker({ map, label:'R' });
    window.__restMarker.setPosition(window.__restPos);
  } else {
    ensureRestaurantGeocoded(); // Ù„Ø¯ÙŠÙ‡Ø§ Cache Ø¨Ø§Ù„Ù€localStorage Ø¨Ø§Ù„ÙØ¹Ù„
  }

  // 3) Ù…Ø³Ø§ÙØ© Ù‡Ø§ÙØ±Ø³ÙŠÙ† (Ù…Ø¬Ø§Ù†ÙŠØ©) + Ø¬ÙŠÙˆÙÙÙ†Ø³ Ù„Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨Ø« Direction/RTDB
  if(window.__restPos){
    const distKm = haversine({lat:dLat,lng:dLng}, window.__restPos);
    const distM  = distKm * 1000;

    // Ø¬ÙŠÙˆÙÙÙ†Ø³ 280Ù…: Ø£ÙˆÙ‚Ù ØªØªØ¨Ù‘Ø¹ RTDB + Ù„Ø§ Directions + Ù†Ø¸Ù‘Ù Ø§Ù„Ø®Ø±ÙŠØ·Ø©
    if(!__geofenceHit && distM <= COST_SAVE.GEOFENCE_M){
      __geofenceHit = true;
      renderMapInfo(distKm, null);   // Ù†Ø¹Ø±Ø¶ Ù…Ø³Ø§ÙØ© ØªÙ‚Ø±ÙŠØ¨ÙŠØ© ÙÙ‚Ø·
      stopDriverTracking();          // â›” ÙŠÙˆÙ‚Ù Ø§Ù„Ù€RTDB listener (ØªÙˆÙÙŠØ± Ù‚Ø±Ø§Ø¡Ø§Øª)
      clearMapArtifacts();
      resetTripTimesUI();
      return;
    }

    // 4) ÙˆØ¶Ø¹ Ø§Ù„ØªÙˆÙÙŠØ±: Ø¥Ù† Ù„Ù… ÙŠÙƒÙ† Live-ETA Ù…ÙØ¹Ù‘Ù„Ø§Ù‹ØŒ Ù„Ø§ Ù†Ø·Ù„Ø¨ Directions Ø£Ø¨Ø¯Ø§Ù‹
    const liveOn = document.getElementById('mapLiveToggle')?.checked === true;
    if(!liveOn){
      renderMapInfo(distKm, null);   // Ù…Ø³Ø§ÙØ© ÙÙ‚Ø· (ETA ØºÙŠØ± Ø­ÙŠÙ‘)
      return;
    }

    // 5) Directions Ø¨Ø«Ø±ÙˆØªÙ„ Ù‚ÙˆÙŠ: ÙƒÙ„ 60s Ø£Ùˆ Ø¨Ø¹Ø¯ ØªØ­Ø±Ùƒ â‰¥ 700m
    const now = Date.now();
    const movedM = __lastRouteFrom ? (haversine(__lastRouteFrom, {lat:dLat,lng:dLng}) * 1000) : Infinity;
    const timeOk = (now - __lastRouteAt) >= COST_SAVE.ROUTE_MIN_MS;
    const moveOk = movedM >= COST_SAVE.ROUTE_MIN_MOVE_M;

    if(timeOk || moveOk || !TRIP_TARGET_MS){
      __lastRouteAt   = now;
      __lastRouteFrom = { lat:dLat, lng:dLng };
      computeRouteAndETA({ lat:dLat, lng:dLng });   // â† Ø·Ù„Ø¨ÙŠÙ‘Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø· Ø­Ø³Ø¨ Ø§Ù„Ø«Ø±ÙˆØªÙ„
    } else {
      // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ÙŠØ© ÙÙ‚Ø· Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø«Ø±ÙˆØªÙ„
      renderMapInfo(distKm, null);
    }
  }
}

/* === Realtime tracking + Directions/ETA === */
let lastRouteTs = 0;
let lastETARoundedSec = null;
function formatSeconds(total){
  const s = Math.max(0, Math.floor(total));
  const m = Math.floor(s/60);
  const ss = String(s%60).padStart(2,'0');
  return `${m}:${ss}`;
}
function kmFromMeters(m){ return Number.isFinite(m) ? (m/1000) : null; }
function renderMapInfo(km, sec){
  const mi = document.getElementById('mapInfo');
  if(!mi) return;
  const parts = [];
  if(Number.isFinite(km)) parts.push(`${km.toFixed(2)} km`);
  if(Number.isFinite(sec)) parts.push(`ETA ${Math.round(sec/60)} min`);
  mi.textContent = parts.length ? parts.join(' â€¢ ') : 'â€”';
}
function ensureDirections(){
  if(!window.google?.maps || !window.__map) return false;
  window.__dirService  = window.__dirService  || new google.maps.DirectionsService();
  if(!window.__dirRenderer){
    window.__dirRenderer = new google.maps.DirectionsRenderer({
      map: window.__map,
      suppressMarkers: true,
      polylineOptions: { strokeColor:'#1da9cf', strokeOpacity:0.95, strokeWeight:5 }
    });
  }
  return true;
}
/* === ETM Live (to pickup): Ù„Ø§ Ù†Ø¹ÙŠØ¯ Ø¶Ø¨Ø· Ø§Ù„Ù‡Ø¯Ù Ø¹Ù†Ø¯ ÙƒÙ„ ØªØ­Ø¯ÙŠØ« â€” Ù†Ø­Ø¯Ø¯Ù‡ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙˆÙ†Ø¶ÙŠÙ Buffer === */
let DRIVER_MARKER = null;
  let DID_FIT = false;
function computeRouteAndETA(driverPos){
  const liveOn = document.getElementById('mapLiveToggle')?.checked === true;
  if(!liveOn) return; // ØªÙˆÙÙŠØ±: Ù„Ø§ Directions Ù…Ø¹ Live-ETA Ù…Ø·ÙØ£
  // ... ØªØ§Ø¨Ø¹ Ø§Ù„Ø¯Ø§Ù„Ø© ÙƒÙ…Ø§ Ù‡ÙŠ ...

  if(!window.__restPos || !ensureDirections()) return;
  const now = Date.now();
  const movedM = __lastRouteFrom ? (haversine(__lastRouteFrom, driverPos) * 1000) : Infinity;
const timeOk = (now - __lastRouteAt) >= COST_SAVE.ROUTE_MIN_MS;
const moveOk = movedM >= COST_SAVE.ROUTE_MIN_MOVE_M;
if(!(timeOk || moveOk)) return;
__lastRouteAt   = now;
__lastRouteFrom = { ...driverPos };

  window.__dirService.route({
    origin: driverPos,
    destination: window.__restPos,
    travelMode:  google.maps.TravelMode.DRIVING
  }, (res, status)=>{
    if(status !== 'OK' || !res?.routes?.[0]?.legs?.[0]) return;
    window.__dirRenderer.setDirections(res);
    const leg = res.routes[0].legs[0];
    const distanceMeters = leg.distance?.value ?? null;
    const durationSec    = leg.duration?.value ?? null;
    const distEl = document.getElementById('tripDistance');
    if(distanceMeters!=null && distEl){
      const km = distanceMeters / 1000;
      distEl.textContent = `${km.toFixed(2)} km`;
    }
    // â€”â€”â€” Ø£Ù‡Ù… ØªØ¹Ø¯ÙŠÙ„: Ù„Ø§ Ù†ØºÙŠÙ‘Ø± TRIP_TARGET_MS Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø¶Ø¨ÙˆØ·Ù‹Ø§ Ø¨Ø§Ù„ÙØ¹Ù„ â€”â€”â€”
    if(ETM_LIVE_V1 && !SERVER_ETM_ACTIVE && Number.isFinite(durationSec)){
      // Ø§Ø¶Ø¨Ø· Ø§Ù„Ù‡Ø¯Ù Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø· (Ø¹Ù„Ù‰ Ø£ÙˆÙ„ Ø­Ø³Ø§Ø¨)ØŒ ÙˆØ£Ø¶Ù Buffer Ù„ØªØ¬Ù†Ù‘Ø¨ Ø§Ù„Ø¥Ù†Ø°Ø§Ø±Ø§Øª Ø§Ù„ÙƒØ§Ø°Ø¨Ø©
      if(!TRIP_TARGET_MS){
        TRIP_TARGET_MS = Date.now() + (durationSec + ETM_BUFFER_SEC) * 1000;
        if(SELECTED_ORDER_ID){ ls.set(LS_TRIP_OID, SELECTED_ORDER_ID); }
        ls.set(LS_TRIP_TARGET, TRIP_TARGET_MS);
        lastETARoundedSec = Math.ceil((TRIP_TARGET_MS - Date.now())/1000);
        startCountdown();
      }
    }
    // Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ÙÙ‚Ø· â€” Ù„Ø§ ÙŠØ¤Ø«Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ø¯Ø§Ø¯
    renderMapInfo(kmFromMeters(distanceMeters), durationSec);
  });
}
function startCountdown(){
  const el = document.getElementById('tripETM'); if(!el) return;
  if(TRIP_TIMER) clearInterval(TRIP_TIMER);
  TRIP_TIMER = setInterval(()=>{
    if(!TRIP_TARGET_MS){
      el.textContent = '--:--'; el.classList.remove('blink-red'); return;
    }
    const remainSec = Math.ceil((TRIP_TARGET_MS - Date.now())/1000);
    const safeRemain = Math.max(0, remainSec);
    if(lastETARoundedSec !== null && lastETARoundedSec > 120 && safeRemain <= 120){
      playOncePerOrder('timer160', SELECTED_ORDER_ID);
    }
    lastETARoundedSec = safeRemain;
    if(safeRemain <= 120) el.classList.add('blink-red');
    else el.classList.remove('blink-red');
    el.textContent = formatSeconds(safeRemain);
  }, 1000);
}
function stopDriverTracking(){
  if(TRIP_TIMER){ clearInterval(TRIP_TIMER); TRIP_TIMER=null; }
  TRIP_TARGET_MS = null;
  lastETARoundedSec = null;
  try{ if(DRIVER_SUB){ rOff(DRIVER_SUB.ref, 'value', DRIVER_SUB.cb); } }catch(_){}
  DRIVER_SUB = null;
  ls.del(LS_TRIP_TARGET);
  ls.del(LS_TRIP_OID);
}
function startDriverTracking(orderId, driverId){
  stopDriverTracking();
  if(!driverId) return;
  const ref = rRef(rtdb, `drivers_locations/${driverId}`);
  const cb  = (snap)=>{
    const val = snap.val() || {};
    const lat = Number(val.lat), lng = Number(val.lng);
    if(Number.isFinite(lat) && Number.isFinite(lng)){ updateMapAndDistance(lat, lng); }
  };
  rOn(ref, cb);
  DRIVER_SUB = { ref, cb };
}
/* ===== Restaurant Geocode (persist & early render) ===== */
function ensureRestaurantGeocoded(){
  const cached = ls.get(LS_REST_POS, null);
  if(cached && cached.lat && cached.lng && window.__map && window.google?.maps){
    window.__restPos = { lat:Number(cached.lat), lng:Number(cached.lng) };
    window.__restMarker = window.__restMarker || new google.maps.Marker({map: window.__map, label:'R'});
    window.__restMarker.setPosition(window.__restPos);
  }
  if(!window.__restPos && hiddenDefaults.Restaurant_Adresse && window.__map && window.google?.maps){
    const geocoder = new google.maps.Geocoder();
    geocoder.geocode({address:hiddenDefaults.Restaurant_Adresse}, (res,status)=>{
      if(status==='OK' && res[0]){
        const p=res[0].geometry.location;
        window.__restPos={lat:p.lat(), lng:p.lng()};
        ls.set(LS_REST_POS, window.__restPos);
        window.__restMarker = window.__restMarker || new google.maps.Marker({map: window.__map, label:'R'});
        window.__restMarker.setPosition(window.__restPos);
      }
    });
  }
}
/* ===== Map ===== */
const GMAPS_API_KEY = 'AIzaSyDipzUmxEQmAjaDkn6xQ91ZhqnkPmgl-2o';
function applyMapStyle(map, mode){
  const MONO=[{elementType:'geometry',stylers:[{saturation:-100},{lightness:10}]},{elementType:'labels.text.fill',stylers:[{color:'#4b4b4b'}]},{featureType:'road',stylers:[{saturation:-100},{lightness:30}]}];
  const CARTOON=[{elementType:'geometry',stylers:[{color:'#fef7e0'}]},{featureType:'road',elementType:'geometry',stylers:[{color:'#fdd96a'}]},{featureType:'water',elementType:'geometry',stylers:[{color:'#a2d2ff'}]}];
  if(mode==='satellite'){ map.setMapTypeId(google.maps.MapTypeId.SATELLITE); map.setOptions({styles:null}); }
  else if(mode==='mono'){ map.setMapTypeId(google.maps.MapTypeId.ROADMAP); map.setOptions({styles:MONO}); }
  else if(mode==='cartoon'){ map.setMapTypeId(google.maps.MapTypeId.ROADMAP); map.setOptions({styles:CARTOON}); }
  else { map.setMapTypeId(google.maps.MapTypeId.ROADMAP); map.setOptions({styles:null}); }
}
async function initMap(){
  const mapEl=document.getElementById('map'); if(!mapEl) return;
  const ensure=()=>new Promise((res,rej)=>{
    if(window.google?.maps) return res();
    const cb='__gm_'+Math.random().toString(36).slice(2);
    window[cb]=()=>{ delete window[cb]; res(); };
    const s=document.createElement('script');
    s.src=`https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(GMAPS_API_KEY)}&v=weekly&libraries=geometry&callback=${cb}`;

    s.async=true; s.defer=true; s.onerror=()=>{ delete window[cb]; rej(); };
    document.head.appendChild(s);
  });
  try{ await ensure(); }catch(_){ return; }
  const map=new google.maps.Map(mapEl,{ center:{lat:54.3233,lng:10.1228}, zoom:12, disableDefaultUI:true, gestureHandling:'greedy' });
  window.__map = map;
  const styleSel=document.getElementById('mapStyle');
  styleSel?.addEventListener('change', e=>applyMapStyle(map, e.target.value));
  // Ø¯Ø§Ø®Ù„ initMap() Ø¨Ø¹Ø¯ styleSel
const liveChk = document.getElementById('mapLiveToggle');
if (liveChk) {
  liveChk.checked = COST_SAVE.LIVE_DEFAULT; // Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§ Off
  liveChk.addEventListener('change', () => {
    if (liveChk.checked) {
      // ØªÙØ¹ÙŠÙ„: Ù†ÙÙƒÙ‘ Ø§Ù„Ø«Ø±ÙˆØªÙ„ Ù„Ø£ÙˆÙ„ Ø·Ù„Ø¨ ÙˆÙ†Ø­Ø§ÙˆÙ„ ØªÙˆØ¬ÙŠÙ‡ ÙÙˆØ±ÙŠ Ø¥Ù† ÙƒØ§Ù†Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªØ§Ø­Ø©
      __lastRouteAt = 0;
      __lastRouteFrom = null;
      // Ù„Ùˆ Ù†Ø­Ù† Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¬ÙŠÙˆÙÙÙ†Ø³ØŒ Ù„Ù† Ù†Ø±Ø³Ù… Ù…Ø³Ø§Ø±Ù‹Ø§ (ØªØµÙ…ÙŠÙ…Ù‹Ø§ Ù„Ù„ØªÙˆÙÙŠØ±)
      if (!__geofenceHit && window.__restPos && lastDriverPos) {
        ensureDirections();
        computeRouteAndETA({ lat: lastDriverPos.lat, lng: lastDriverPos.lng });
      }
    } else {
      // Ø¥ÙŠÙ‚Ø§Ù: Ù†Ù…Ø³Ø­ Ø®Ø· Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø£Ø²Ø±Ù‚ ÙˆÙ†ÙƒØªÙÙŠ Ø¨Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ÙŠØ©
      try { window.__dirRenderer?.setDirections({ routes: [] }); } catch {}
      renderMapInfo(null, null);
    }
  });
}
// === TAUSSIL-PATCH: Pulsing driver marker (HTML Overlay) ===
if(!window.PulsingMarker){
  class PulsingMarker extends google.maps.OverlayView{
    constructor(position, map){
      super();
      this.position = new google.maps.LatLng(position);
      this.div = null;
      this.setMap(map);
    }
    onAdd(){
      const div = document.createElement('div');
      div.className = 'gm-driver';
      const ring = document.createElement('div'); ring.className='ring';
      const dot  = document.createElement('div'); dot.className='dot';
      div.appendChild(ring); div.appendChild(dot);
      this.div = div;
      // ÙÙˆÙ‚ Ø§Ù„Ø·Ø¨Ù‚Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰ØŒ Ø¨Ø¯ÙˆÙ† Ø§Ø¹ØªØ±Ø§Ø¶ Ù„Ù„Ø£Ø­Ø¯Ø§Ø«
      this.getPanes().overlayMouseTarget.appendChild(div);
    }
    draw(){
      if(!this.div) return;
      const proj = this.getProjection();
      const pt = proj && proj.fromLatLngToDivPixel(this.position);
      if(pt){
        this.div.style.left = pt.x + 'px';
        this.div.style.top  = pt.y + 'px';
      }
    }
    onRemove(){ this.div?.remove(); this.div = null; }
    setPosition(latlng){
      this.position = new google.maps.LatLng(latlng);
      this.draw();
    }
  }
  window.PulsingMarker = PulsingMarker;
}

  ensureRestaurantGeocoded();
  
  // Bootstrap Ø§Ù„Ø¹Ø¯Ù‘Ø§Ø¯ Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ù‚Ø¨Ù„ ÙˆØµÙˆÙ„ Snapshot
  (function restoreCountdownEarly(){
    const savedMs = ls.get(LS_TRIP_TARGET, null);
    const savedOid= ls.get(LS_TRIP_OID, null);
    if(Number.isFinite(savedMs) && savedMs > Date.now() && savedOid){
      SELECTED_ORDER_ID = savedOid;
      TRIP_TARGET_MS = savedMs;
      lastETARoundedSec = Math.ceil((TRIP_TARGET_MS - Date.now())/1000);
      const card = document.getElementById('tripCard'); if(card) card.classList.remove('hidden');
      startCountdown();
    }
  })();
}
initMap();
/* ===== Sound picker ===== */
const sndBtn=document.getElementById('sndBtn');
const sndPicker=document.getElementById('soundPicker');
sndBtn?.addEventListener('click',(e)=>{
  if(e.altKey){ sndPicker?.click(); return; }
  SND_MUTED=!SND_MUTED;
  localStorage.setItem('sndMuted', SND_MUTED?'1':'0');
  renderSndBtn();
});
sndPicker?.addEventListener('change',(e)=>{
  const files=Array.from(e.target.files||[]);
  files.forEach(f=>{
    const name=f.name.toLowerCase();
    const url=URL.createObjectURL(f);
    if(name.includes('senden')||name.includes('send')) snd.send.src=url;
    else if(name.includes('unterwegs')||name.includes('start')) snd.unterwegs.src=url;
    else if(name.includes('160')||name.includes('timer')) snd.timer160.src=url;
    else if(name.includes('geliefert')||name.includes('deliver')||name.includes('liefer')) snd.delivered.src=url;
  });
});
/* ===== Error banners ===== */
window.addEventListener('error', (e)=>{
  try{
    if(banner){
      banner.textContent='âš ï¸ '+(e?.message||'Unbekannter Fehler');
      banner.classList.add('show');
      setTimeout(()=>banner.classList.remove('show'), 4000);
    }
  }catch(_){}
});
window.addEventListener('unhandledrejection', (e)=>{
  try{
    const msg=(e?.reason && e.reason.message) || String(e?.reason||'');
    if(banner){
      banner.textContent='âš ï¸ '+msg;
      banner.classList.add('show');
      setTimeout(()=>banner.classList.remove('show'), 4000);
    }
  }catch(_){}
});
/* ===== Init ===== */
function showAuthSafe(){ switchPane('login'); showAuth(true); }
renderMultiRows();

if(priceEl && !priceEl.value) priceEl.value="0,00â‚¬";
showAuthSafe();
/* Drawer/Menu â€” isolated (no globals touched) */
(() => {
  const btn   = document.getElementById('menuBtn');
  const side  = document.getElementById('sideMenu');
  const back  = document.getElementById('drawerBackdrop');
  const close = document.getElementById('drawerClose');
  const navLogout = document.getElementById('navLogout');
  const open = ()=>{ side?.classList.add('show'); back?.classList.add('show'); document.body.classList.add('no-scroll'); };
  const shut = ()=>{ side?.classList.remove('show'); back?.classList.remove('show'); document.body.classList.remove('no-scroll'); };
  btn?.addEventListener('click', open);
  back?.addEventListener('click', shut);
  close?.addEventListener('click', shut);
  navLogout?.addEventListener('click', async (e)=>{
    e.preventDefault(); shut();
    try{ await signOut(auth); }catch(_){}
    showAuth(true);
  });
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && side?.classList.contains('show')) shut(); });
})();
/* Orders Log â€” simple fetch (no composite index required) */
/* === Orders Log (Bestellverlauf) â€” Filters + Infinite Scroll (safe, no composite idx required) === */
(() => {
  const logModal = document.getElementById('logModal');
  const logClose = document.getElementById('logClose');
  const logList  = document.getElementById('logList');
  const logSumPrice = document.getElementById('logSumPrice');
  const logSumFee   = document.getElementById('logSumFee');
  const navLog      = document.getElementById('navLog');
  const logFrom = document.getElementById('logFrom');
  const logTo   = document.getElementById('logTo');
  const logProvider = document.getElementById('logProvider');
  const logReset = document.getElementById('logReset');
  const logScroll = document.getElementById('logScroll');
  const PAGE_SIZE = 50;
  let LOG_LAST = null;
  let LOG_BUSY = false;
  let RID = null;
  const SEEN = new Set();
  let NO_MORE = false;
  const ALL = [];
  const money = (n)=> (Number(n||0)).toLocaleString("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2})+"â‚¬";
  const dateISO = (d)=> d ? d.toLocaleString('de-DE') : 'â€”';
  const platStr = (p)=> Array.isArray(p)? p.join(' / ') : (p||'â€”');
  const getRID = ()=> (typeof RESTAURANT_ID!=='undefined' && RESTAURANT_ID) ? RESTAURANT_ID : (auth.currentUser?.uid || null);
  navLog && navLog.addEventListener('click', async (e)=>{
    e.preventDefault();
    await openLog();
  });
  async function openLog(){
    RID = getRID();
    if(!RID){ alert('Bitte zuerst anmelden.'); return; }
    resetState();  function resetState(){
    LOG_LAST=null; LOG_BUSY=false; ALL.length=0;
    SEEN.clear();
    NO_MORE=false;
    if(logList) logList.innerHTML = '';
    if(logFrom) logFrom.value='';
    if(logTo)   logTo.value='';
    if(logProvider) logProvider.value='';
  }
    logModal?.classList.add('show');
    try{
      const qs = await getDocs(query(collection(db,'orders'), where('restaurant.id','==', RID)));
      let sumP=0, sumL=0;
qs.forEach(d=>{
  const o=d.data()||{}; 
  if(String(o.status||'')==='Abgebrochen') return;

  const p = Number(o.price || 0);
const l = Number(feeForView(o) || 0);


  if (Number.isFinite(p)) sumP += p; 
  if (Number.isFinite(l)) sumL += l;
});

      if(logSumPrice) logSumPrice.textContent = money(sumP);
      if(logSumFee)   logSumFee.textContent   = money(sumL);
    }catch(e){ /* ignore */ }
    await loadMore();
    bindScroll();
  }
  function resetState(){
    LOG_LAST=null; LOG_BUSY=false; ALL.length=0;
    if(logList) logList.innerHTML = '';
    if(logFrom) logFrom.value='';
    if(logTo)   logTo.value='';
    if(logProvider) logProvider.value='';
  }
  function bindScroll(){
    if(!logScroll || logScroll.__bound) return;
    logScroll.__bound = true;
    logScroll.addEventListener('scroll', async ()=>{
      if (NO_MORE) return;
      const nearBottom = (logScroll.scrollTop + logScroll.clientHeight) >= (logScroll.scrollHeight - 120);
      if(nearBottom) await loadMore();
    });
  }
  async function loadMore(){
    if (LOG_BUSY || !RID || NO_MORE) return;
    LOG_BUSY = true;
    try{
      const snap = await runPageQuery(RID, LOG_LAST);
      if (!snap.empty) {
        const docs = snap.docs;
        for (const ds of docs) {
          const id = ds.id;
          if (SEEN.has(id)) continue;
          SEEN.add(id);
          ALL.push({ id, o: ds.data() || {} });
        }
        if (snap.size < PAGE_SIZE) {
          NO_MORE = true;
        } else {
          LOG_LAST = docs[docs.length - 1];
        }
        render();
      } else {
        NO_MORE = true;
      }
    } catch (e) {
      try{
        const snap2 = await getDocs(query(
          collection(db,'orders'),
          where('restaurant.id','==', RID),
          limit(PAGE_SIZE)
        ));
        let pushed = 0;
        snap2.forEach(ds=>{
          const id = ds.id;
          if (SEEN.has(id)) return;
          SEEN.add(id);
          ALL.push({ id, o: ds.data() || {} });
          pushed++;
        });
        render();
        NO_MORE = true;
      }catch(e2){
        if(!logList.innerHTML.trim()){
          logList.innerHTML = `<div class="small" style="opacity:.8">â€” Keine AuftrÃ¤ge â€”</div>`;
        }
        NO_MORE = true;
      }

    } finally {
      LOG_BUSY = false;
    }
  }
  function runPageQuery(rid, lastSnap){
    let q = query(
      collection(db,'orders'),
      where('restaurant.id','==', rid),
      orderBy('updatedAt','desc'),
      limit(PAGE_SIZE)
    );
    if(lastSnap){
      q = query(
        collection(db,'orders'),
        where('restaurant.id','==', rid),
        orderBy('updatedAt','desc'),
        startAfter(lastSnap),
        limit(PAGE_SIZE)
      );
    }
    return getDocs(q);
  }
  function applyFilters(items){
    const fromVal = logFrom?.value ? new Date(logFrom.value) : null;
    const toVal   = logTo?.value   ? new Date(logTo.value)   : null;
    const prov    = (logProvider?.value || '').trim().toLowerCase();
    return items.filter(({o})=>{
      const t = (o.updatedAt?.toDate?.() || o.createdAt?.toDate?.() || null);
      if(fromVal && t && t < startOfDay(fromVal)) return false;
      if(toVal && t && t > endOfDay(toVal)) return false;
      if(prov){
        const p = platStr(o.platform).toLowerCase();
        if(!p.includes(prov)) return false;
      }
      return true;
    });
  }
  function startOfDay(d){ const x=new Date(d); x.setHours(0,0,0,0); return x; }
  function endOfDay(d){ const x=new Date(d); x.setHours(23,59,59,999); return x; }
  function render(){
    if(!logList) return;
    const filtered = applyFilters(ALL);
    if(!filtered.length){
      logList.innerHTML = `<div class="small" style="opacity:.8">â€” Keine AuftrÃ¤ge â€”</div>`;
      return;
    }
	  // === Export helper for PDF/Print: FULL row data with many optional fields ===
window.__restExportGetData = function(){
  const filtered = applyFilters(ALL);
  const rows = filtered.map(({id,o},i)=>{
    const nr     = (o.nr!=null ? `#${o.nr}` : '');
    const code   = id;
    const plat   = Array.isArray(o.platform)? o.platform.join(' / ') : (o.platform||'â€”');
    const qty    = Number(o.qty||0) || 0;

    const price  = Number(o.price||0);
    const fee    = Number(feeForView(o) || 0);

    const status = o.status || 'â€”';

    const dtC    = (o.createdAt?.toDate?.()  || null);
    const dtU    = (o.updatedAt?.toDate?.()  || null);
    const created= dtC ? dtC.toLocaleString('de-DE') : 'â€”';
    const updated= dtU ? dtU.toLocaleString('de-DE') : 'â€”';

    const pickupTime = o.pickupTime || 'â€”';

    const rName  = o.restaurant?.name || 'â€”';
    const rAddr  = o.restaurant?.address_text || o.restaurant?.addressText || 'â€”';
    const rPhone = o.restaurant?.phone || 'â€”';
    const rId    = o.restaurant?.id || 'â€”';

    const dId    = o.driver?.id || 'â€”';
    const dName  = o.driver?.firstName || o.driver?.name || 'â€”';

    const stops_total     = Number(o.stops_total ?? o.qty ?? 0) || 0;
    const stops_delivered = Number(o.stops_delivered ?? 0) || 0;

    return {
      // Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
      idx: i+1, code, nr, platform: plat, qty, price, fee, status, created,
      // Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±ÙŠ
      updated, pickupTime,
      restaurantId: rId, restaurantName: rName, restaurantAddress: rAddr, restaurantPhone: rPhone,
      driverId: dId, driverName: dName,
      stops_total, stops_delivered
    };
  });

  const totals = rows.reduce((a,r)=>({
    orders: a.orders + 1,
    qty:    a.qty    + (r.qty||0),
    price:  a.price  + (r.price||0),
    fee:    a.fee    + (r.fee||0),
  }), {orders:0, qty:0, price:0, fee:0});

  const period = (() => {
    const f = logFrom?.value || '';
    const t = logTo  ?.value || '';
    if(!f && !t) return 'Alle';
    const toDE = s => { try { return new Date(s).toLocaleString('de-DE',{year:'numeric',month:'2-digit',day:'2-digit'}) } catch{ return s||'â€”' } };
    return `${f?toDE(f):'â€¦'} â†’ ${t?toDE(t):'â€¦'}`;
  })();

  return {
    meta: {
      restaurant: hiddenDefaults?.Restaurant_Name || 'â€”',
      period, status: 'All'
    },
    rows, totals
  };
};


    logList.innerHTML = filtered.map(({id,o})=>{
      const nr   = (o.nr!=null ? `#${o.nr}` : '');
      const rest = o.restaurant?.name || 'â€”';
      const plat = platStr(o.platform);
      const qty  = Number(o.qty||0) || 0;
      const price = money(Number(o.price||0));
      const feeNum  = Number(feeForView(o) || 0);
const fee     = money(feeNum);


      const st    = o.status || 'â€”';
      const dt    = (o.updatedAt?.toDate?.() || o.createdAt?.toDate?.() || null);
      const dtStr = dateISO(dt);
      return `
        <div class="log-row">
          <div class="log-id">${id} ${nr}</div>
          <div>${rest} Â· ${plat}<div class="small" style="opacity:.8">${dtStr}</div></div>
          <div class="log-tag">${st}</div>
          <div>Qty ${qty}</div>
          <div>${price}</div>
          <div>${fee}</div>
        </div>
      `;
    }).join('');
  }
  [logFrom, logTo, logProvider].forEach(el=>{
    el && el.addEventListener('change', ()=> render());
  });
  logReset && logReset.addEventListener('click', ()=>{
    if(logFrom) logFrom.value='';
    if(logTo)   logTo.value='';
    if(logProvider) logProvider.value='';
    render();
  });
  logClose && logClose.addEventListener('click', ()=> logModal.classList.remove('show'));
  logModal && logModal.addEventListener('click',(e)=>{ if(e.target===logModal) logModal.classList.remove('show'); });
})();
/* === Print & PDF â€” Smart fallback (print on desktop, PDF on Android WebView) === */
/* === Export Dialog (choose fields) + Smart Print/PDF === */
(() => {
  const btnOpen = document.getElementById('logPDF');      // Ø§Ù„Ø²Ø± Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø³Ø¬Ù„
  const modal   = document.getElementById('exportModal'); // Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯
  const grid    = document.getElementById('exportFields');
  const bAll    = document.getElementById('expAll');
  const bNone   = document.getElementById('expNone');
  const bClose  = document.getElementById('expClose');
  const bPrint  = document.getElementById('expPrint');
  const bPDF    = document.getElementById('expPDF');

  if(!btnOpen || !modal || !grid) return;

  const euro = n => (Number(n||0)).toLocaleString('de-DE',{minimumFractionDigits:2,maximumFractionDigits:2}) + 'â‚¬';
  const isAndroidWebView = () => {
    const ua = navigator.userAgent || '';
    return /Android/i.test(ua) && (/\bwv\b|\) wv/.test(ua));
  };

  // Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…ØªØ§Ø­Ø© Ù„Ù„Ø§Ø®ØªÙŠØ§Ø±
  const FIELDS = [
    {key:'idx',               label:'#',                    def:true},
    {key:'nr',                label:'Nr',                   def:false},
    {key:'code',              label:'OrderId',              def:true},
    {key:'platform',          label:'Plattform(en)',        def:true},
    {key:'qty',               label:'Qty',                  def:true},
    {key:'price',             label:'Preis â‚¬',              def:true},
    {key:'fee',               label:'LiefergebÃ¼hr â‚¬',       def:true},
    {key:'status',            label:'Status',               def:true},
    {key:'created',           label:'Erstellt',             def:true},
    {key:'updated',           label:'Aktualisiert',         def:false},
    {key:'pickupTime',        label:'Abholzeit',            def:false},
    {key:'restaurantName',    label:'Restaurant',           def:false},
    {key:'restaurantAddress', label:'Restaurant-Adresse',   def:false},
    {key:'restaurantPhone',   label:'Restaurant-Telefon',   def:false},
    {key:'restaurantId',      label:'Restaurant-ID',        def:false},
    {key:'driverId',          label:'Fahrer-ID',            def:false},
    {key:'driverName',        label:'Fahrername',           def:false},
    {key:'stops_total',       label:'Stops (gesamt)',       def:false},
    {key:'stops_delivered',   label:'Stops geliefert',      def:false},
  ];
  const NUM_KEYS = new Set(['qty','price','fee']);

  // Ø¨Ù†Ø§Ø¡ Ø´Ø¨ÙƒØ© Ø§Ù„Ø´ÙŠÙƒØ¨ÙˆÙƒØ³
  function buildGrid(){
    grid.innerHTML = FIELDS.map(f =>
      `<label><input type="checkbox" data-k="${f.key}" ${f.def?'checked':''}> ${f.label}</label>`
    ).join('');
  }
  function selectedKeys(){
    return Array.from(grid.querySelectorAll('input[type=checkbox]'))
      .filter(i=>i.checked).map(i=>i.getAttribute('data-k'));
  }

  // ØªØ­Ù…ÙŠÙ„ jsPDF/AutoTable ÙÙ‚Ø· ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ø¬Ø©
  function loadScript(src){
    return new Promise((res, rej)=>{
      const s=document.createElement('script'); s.src=src; s.async=true;
      s.onload=()=>res(); s.onerror=()=>rej(new Error('Failed: '+src));
      document.head.appendChild(s);
    });
  }
  async function ensureJsPDF(){
    if (window.jspdf?.jsPDF && window.jspdf?.jsPDF.API?.autoTable) return;
    if (!window.jspdf?.jsPDF){
      await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');
    }
    if (!window.jspdf?.jsPDF?.API?.autoTable){
      await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js');
    }
  }

  // HTML Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© (Ø£Ø¹Ù…Ø¯Ø© Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ©)
  function buildPrintableHTML(keys){
    const data = window.__restExportGetData ? window.__restExportGetData() : null;
    const rows = data?.rows || [];
    const meta = data?.meta || { restaurant:'â€”', period:'â€”', status:'All' };
    const tot  = data?.totals || { orders:0, qty:0, price:0, fee:0 };

    const heads = keys.map(k => {
      const f = FIELDS.find(x=>x.key===k);
      return `<th class="${NUM_KEYS.has(k)?'num':''}">${f?f.label:k}</th>`;
    }).join('');

    const body = rows.map(r=>{
      const tds = keys.map(k=>{
        let v = r[k];
        if(k==='price' || k==='fee') v = euro(v||0);
        if(k==='qty')                 v = String(v||0);
        return `<td class="${NUM_KEYS.has(k)?'num':''}">${(v ?? 'â€”')}</td>`;
      }).join('');
      return `<tr>${tds}</tr>`;
    }).join('');

    // ØªØ°ÙŠÙŠÙ„ Ø§Ù„Ù…Ø¬Ø§Ù…ÙŠØ¹: ÙÙ‚Ø· Ù„Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø±Ù‚Ù…ÙŠØ© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
    const footCells = keys.map((k,i)=>{
      if(k==='qty')   return `<td class="num">${tot.qty||0}</td>`;
      if(k==='price') return `<td class="num">${euro(tot.price||0)}</td>`;
      if(k==='fee')   return `<td class="num">${euro(tot.fee||0)}</td>`;
      // Ø£ÙˆÙ„ Ø®Ù„ÙŠØ© ØºÙŠØ± Ø±Ù‚Ù…ÙŠØ© Ù†ÙƒØªØ¨ ÙÙŠÙ‡Ø§ "Totals"
      return (i===0) ? `<td>Totals</td>` : `<td></td>`;
    }).join('');

    const CSS = `
    <style>
      :root{ color-scheme: light; }
      html,body{ margin:0; padding:0; background:#fff; color:#111;
        font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
      .wrap{ width:1000px; max-width:100%; margin:0 auto; padding:14px; }
      h2{ margin:0 0 8px 0 }
      .meta{ font-size:12px; color:#555; margin-bottom:10px }
      table{ width:90%; border-collapse:collapse; font-size:12px }
      th,td{ border:1px solid #e5e7eb; padding:6px 8px; text-align:left; vertical-align:top; }
      thead th{ background:#f8fafc; font-weight:800 }
      tfoot td{ background:#f3f4f6; font-weight:800 }
      .num{ text-align:right; font-variant-numeric: tabular-nums; }
      .small{ font-size:11px; color:#666 }
      @page{ size:A4; margin:12mm; }
    </style>`;

    return `<!doctype html>
<html><head><meta charset="utf-8"><title>Abrechnungsbericht</title>${CSS}</head>
<body>
  <div class="wrap">
    <h2>Abrechnungsbericht</h2>
    <div class="meta">
      Restaurant: <b>${meta.restaurant}</b> &nbsp;â€¢&nbsp;
      Period: <b>${meta.period}</b> &nbsp;â€¢&nbsp;
      Status: <b>${meta.status}</b> &nbsp;â€¢&nbsp;
      Rows: <b>${rows.length}</b>
    </div>
    <table>
      <thead><tr>${heads}</tr></thead>
      <tbody>${body || `<tr><td colspan="${keys.length}">â€” Keine Daten â€”</td></tr>`}</tbody>
      <tfoot><tr>${footCells}</tr></tfoot>
    </table>
  </div>
</body></html>`;
  }

  function printInHiddenIframe(html){
    const ifr = document.createElement('iframe');
    ifr.style.position='fixed'; ifr.style.width='0'; ifr.style.height='0'; ifr.style.border='0';
    document.body.appendChild(ifr);
    const d = ifr.contentWindow.document;
    d.open(); d.write(html); d.close();
    const go = () => {
      setTimeout(()=>{ try{ ifr.contentWindow.focus(); ifr.contentWindow.print(); }catch(_){} 
        setTimeout(()=>{ try{ ifr.remove(); }catch(_){ } }, 400); }, 180);
    };
    if (ifr.contentDocument.readyState === 'complete') go(); else ifr.onload = go;
  }

  async function exportPDF(keys){
    const data = window.__restExportGetData ? window.__restExportGetData() : null;
    if(!data){ alert('Keine Daten zum Export.'); return; }
    await ensureJsPDF();

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation:'portrait', unit:'pt', format:'a4' });

    const meta = data.meta || {};
    const rows = data.rows || [];
    const tot  = data.totals || {};

    let y = 40;
    doc.setFontSize(14);  doc.text('Abrechnungsbericht', 40, y); y += 16;
    doc.setFontSize(10);  doc.text(`Restaurant: ${meta.restaurant||'â€”'}`, 40, y); y += 12;
    doc.text(`Period: ${meta.period||'â€”'}   Status: ${meta.status||'All'}   Rows: ${rows.length}`, 40, y); y += 14;

    const head = [ keys.map(k => (FIELDS.find(f=>f.key===k)?.label || k)) ];
    const body = rows.map(r => keys.map(k => {
      let v = r[k];
      if(k==='price' || k==='fee') v = euro(v||0);
      if(k==='qty')                 v = String(v||0);
      return (v ?? 'â€”');
    }));

    const foot = [ keys.map(k => {
      if(k==='qty')   return String(tot.qty||0);
      if(k==='price') return euro(tot.price||0);
      if(k==='fee')   return euro(tot.fee||0);
      return ''; // ØªÙØªØ±Ùƒ ÙØ§Ø±ØºØ© Ù„ØºÙŠØ± Ø§Ù„Ø±Ù‚Ù…ÙŠØ©
    }) ];
    if (foot[0].length) {
      // Ø£ÙˆÙ„ Ø®Ù„ÙŠØ© "Totals" Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ø±Ù‚Ù…ÙŠØ©
      if(!NUM_KEYS.has(keys[0])) foot[0][0] = 'Totals';
    }

    if (doc.autoTable) {
      doc.autoTable({
        head, body, foot,
        startY: y,
        styles: { fontSize:9, cellPadding:3, overflow:'linebreak' },
        headStyles: { fillColor: [248,250,252] },
      });
    } else {
      // Ø¨Ø¯ÙŠÙ„ Ø¨Ø³ÙŠØ· Ø¬Ø¯Ø§Ù‹ Ø¥Ù† Ù„Ù… ØªØªÙˆÙØ± AutoTable
      let yy = y + 12;
      doc.setFontSize(9);
      body.forEach((r,i)=>{
        if(yy>780){ doc.addPage(); yy=40; }
        doc.text(`${r.join(' | ')}`, 40, yy); yy += 12;
      });
    }

    doc.save('Abrechnungsbericht.pdf');
  }

  // ÙØªØ­ Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø±
  btnOpen.addEventListener('click', (e)=>{
    e.preventDefault();
    buildGrid();
    modal.classList.add('show');
    // Ø¹Ù„Ù‰ Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯ WebView: Ù…Ù…ÙƒÙ† ØªØ®ÙÙŠ Ø²Ø± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ù„Ø£Ù†Ù‡ Ø¹Ø§Ø¯Ø© Ù„Ø§ ÙŠØ¹Ù…Ù„
    if (isAndroidWebView()) bPrint.style.display='none'; else bPrint.style.display='';
  });

  // ØªØ­ÙƒÙ…Ø§Øª Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
  bAll?.addEventListener('click', ()=> grid.querySelectorAll('input').forEach(i=>i.checked=true));
  bNone?.addEventListener('click',()=> grid.querySelectorAll('input').forEach(i=>i.checked=false));
  bClose?.addEventListener('click',()=> modal.classList.remove('show'));
  modal.addEventListener('click',(e)=>{ if(e.target===modal) modal.classList.remove('show'); });

  // ØªÙ†ÙÙŠØ°
  bPrint?.addEventListener('click', ()=>{
    const keys = selectedKeys();
    if(!keys.length){ alert('Bitte mindestens ein Feld wÃ¤hlen.'); return; }
    const html = buildPrintableHTML(keys);
    printInHiddenIframe(html);
    modal.classList.remove('show');
  });
  bPDF?.addEventListener('click', async ()=>{
    const keys = selectedKeys();
    if(!keys.length){ alert('Bitte mindestens ein Feld wÃ¤hlen.'); return; }
    try{ await exportPDF(keys); }catch(_){ alert('PDF-Export fehlgeschlagen.'); }
    modal.classList.remove('show');
  });
})();

/* === Full-page switch to Multi-Vendor Admin (robust) === */
(() => {
  // ØºÙŠÙ‘Ø± Ø§Ù„Ø§Ø³Ù… Ù‡Ù†Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ù„Ù ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ù„ØªÙŠ-ÙÙŠÙ†Ø¯ÙˆØ± Ø¨Ø§Ø³Ù…/Ù…Ø³Ø§Ø± Ù…Ø®ØªÙ„Ù
  const MV_LOCAL_KEY = 'mv:path';              // ÙŠÙ…ÙƒÙ† ØªØ®Ø²ÙŠÙ† Ù…Ø³Ø§Ø± Ù…Ø®ØµØµ
  const DEFAULT_ENTRY = localStorage.getItem(MV_LOCAL_KEY) || 'mv-admin.html';

  const bSend = document.getElementById('tabSend');
  const bMV   = document.getElementById('tabMV');

  async function gotoMV(){
    // Ù…Ø³Ø§Ø±Ø§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù†Ø­Ø§ÙˆÙ„Ù‡Ø§ Ø¨Ø§Ù„ØªØªØ§Ù„ÙŠ
    const base = new URL('.', location.href);
    const candidates = [
      DEFAULT_ENTRY,
      './' + DEFAULT_ENTRY,
      'admin/' + DEFAULT_ENTRY,
      'pages/' + DEFAULT_ENTRY,
      '../' + DEFAULT_ENTRY
    ];

    // Ø¹Ù„Ù‰ Ø¨ÙŠØ¦Ø© file:// (ÙØªØ­ Ù…Ù„ÙØ§Øª Ù…Ø­Ù„ÙŠÙ‹Ø§) Ù„Ø§ Ù†Ù‚Ø¯Ø± Ù†Ø¹Ù…Ù„ fetch HEADØ› Ù†Ù†ØªÙ‚Ù„ Ù…Ø¨Ø§Ø´Ø±Ø©
    if (location.protocol === 'file:') {
      const url = new URL(candidates[0], location.href);
      location.href = url.toString();
      return;
    }

    // Ù†Ø­Ø§ÙˆÙ„ HEAD Ø¹Ù„Ù‰ Ù†ÙØ³ Ø§Ù„Ø£ØµÙ„ Ù„Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù„Ù Ù‚Ø¨Ù„ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„
    for (const p of candidates){
      const url = new URL(p, base);
      try{
        const res = await fetch(url, { method:'HEAD', cache:'no-store' });
        if (res.ok) { window.location.assign(url.toString()); return; }
      }catch(_){ /* ØªØ¬Ø§Ù‡Ù„ ÙˆÙ†Ø¬Ø±Ù‘Ø¨ Ø§Ù„ØªØ§Ù„ÙŠ */ }
    }

    // Ù„Ùˆ Ù„Ù… Ù†Ø¬Ø¯ Ø§Ù„Ù…Ù„ÙØŒ Ø§Ø³Ù…Ø­ Ø¨Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø³Ø§Ø± Ù…Ø®ØµØµ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©
    const custom = prompt('Datei nicht gefunden. Pfad zur MV-Seite eingeben (z. B. /admin/mv-admin.html):');
    if (custom) {
      localStorage.setItem(MV_LOCAL_KEY, custom.trim());
      const url = new URL(custom.trim(), base);
      window.location.assign(url.toString());
    } else {
      alert('mv-admin.html nicht gefunden. Bitte legen Sie die Datei im selben Ordner ab oder passen Sie den Pfad an.');
    }
  }

  bSend?.addEventListener('click', () => {
    bSend.classList.add('active');
    bMV?.classList.remove('active');
  });
  bMV?.addEventListener('click', (e) => {
    e.preventDefault();
    gotoMV();
  });
})();


</script>
</body>
</html>
