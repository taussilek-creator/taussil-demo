<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<meta name="theme-color" content="#0b1320">
<title>Taussil – Fahrer (PROD v7)</title>
<link rel="icon" href="icons/taussil-192.png">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0b1320; --card:#111a2b; --ink:#e6e9ef; --muted:#9aa4b2; --cta:#33BBDF;
  --ok:#22c55e; --warn:#f59e0b; --err:#ef4444; --border:1px solid rgba(255,255,255,.08);
  --radius:16px; --shadow:0 12px 40px rgba(0,0,0,.35); --hit:52px;
}
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
.app{max-width:560px;margin:0 auto;padding:12px 14px 24px;display:flex;flex-direction:column;gap:12px}

/* Header */
.header{position:sticky;top:0;z-index:5;background:linear-gradient(180deg,rgba(11,19,32,1),rgba(11,19,32,.75));backdrop-filter:blur(6px);
  border-bottom:1px solid rgba(255,255,255,.08); padding:10px 12px;border-radius:0 0 14px 14px;display:flex;align-items:center;justify-content:space-between;gap:8px}
.brand{display:flex;align-items:center;gap:10px;font-weight:800}
.badge-dot{width:10px;height:10px;border-radius:50%;background:#555;margin-left:6px}
.badge-dot.on{background:var(--ok)} .badge-dot.off{background:#555}
.menu-btn{height:36px;min-width:36px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:#0f1a30;color:var(--ink);display:flex;align-items:center;justify-content:center;cursor:pointer}
.menu{position:absolute;right:12px;top:58px;background:#0f1a30;border:1px solid rgba(255,255,255,.12);border-radius:12px;box-shadow:var(--shadow);display:none;flex-direction:column;min-width:220px;overflow:hidden}
.menu.show{display:flex}
.menu a{padding:10px 12px;color:var(--ink);text-decoration:none;border-top:1px solid rgba(255,255,255,.08)} .menu a:first-child{border-top:0}
.menu a:hover{background:#142036}

/* Online toggle */
.toggle{display:flex;align-items:center;gap:8px}
.tgl{position:relative;width:46px;height:26px;background:#2a3348;border-radius:999px;border:1px solid rgba(255,255,255,.12);cursor:pointer}
.tgl::after{content:"";position:absolute;top:3px;left:3px;width:20px;height:20px;border-radius:50%;background:#fff;transition:.18s}
.tgl.on{background:#0f3e23;border-color:#1f8a53}
.tgl.on::after{left:23px;background:#caffdc}
.stat{font-size:12px;color:var(--muted)}

/* Cards & inputs */
.card{background:var(--card);border:var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:12px}
.row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.input, .btn, select, a.btn{height:var(--hit);background:#0f1a30;color:var(--ink);border:1px solid rgba(255,255,255,.12);border-radius:14px;padding:0 14px;font-size:16px;width:100%;text-decoration:none}
.btn{display:flex;align-items:center;justify-content:center;cursor:pointer;font-weight:800}
.btn:disabled{opacity:.6;cursor:not-allowed}
.btn-cta{background:linear-gradient(180deg,#33BBDF,#1da9cf);border:none;color:#fff}
.btn-ghost{background:#13213a;border:1px solid rgba(255,255,255,.14);color:#e6e9ef}
.small{font-size:12px;color:var(--muted)}
.kv{display:flex;justify-content:space-between;gap:8px;padding:6px 0;border-top:1px solid rgba(255,255,255,.08)}
.kv:first-child{border-top:0}

/* Orders list */
.list{display:flex;flex-direction:column;gap:10px}
.card-order{display:grid;grid-template-columns:56px 1fr auto;gap:10px;align-items:center;border:1px solid rgba(255,255,255,.08);border-radius:14px;background:#0f1a30;padding:8px 10px;cursor:pointer}
.logo img{width:56px;height:56px;border-radius:12px;object-fit:cover;border:1px solid rgba(255,255,255,.08)}
.logo .ph{width:56px;height:56px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-weight:800;background:#1a2742;border:1px solid rgba(255,255,255,.08)}
.line{display:flex;align-items:center;gap:8px}
.tag{font-size:11px;padding:4px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.14);background:#0f1a30;color:#9aa4b2}
.btn-icon{width:48px;height:48px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:#122037;display:flex;align-items:center;justify-content:center;cursor:pointer}
.btn-go{background:linear-gradient(180deg,#4ade80,#22c55e);border:none;color:#06220f}
.btn-done{background:linear-gradient(180deg,#a7f3d0,#34d399);border:none;color:#06220f}
/* Multi-stops (inline, خفيف) */
.multi-stops{margin-top:8px;padding-top:8px;border-top:1px solid rgba(255,255,255,.08)}
.stop-row{display:grid;grid-template-columns:56px 1fr 48px;gap:10px;align-items:center;
  margin:6px 0;padding:8px 10px;border:1px solid rgba(255,255,255,.08);border-radius:14px;background:#0f1a30}
.stop-logo{width:56px;height:56px;border-radius:12px;background:#1a2742;display:flex;align-items:center;justify-content:center;font-weight:800}

/* Detail bottom sheet */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:flex-end;z-index:1000}
.modal.show{display:flex}
.sheet{background:#0f1a30;border-radius:16px 16px 0 0;width:100%;max-height:60vh;min-height:40vh;overflow:auto;border:1px solid rgba(255,255,255,.12);padding:12px;animation:rise .18s ease}
@keyframes rise{from{transform:translateY(20px);opacity:.8}to{transform:translateY(0);opacity:1}}
.sheet .hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
.sheet .title{font-weight:800}
.sheet .close{width:36px;height:36px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:#111a2b;color:#e6e9ef;display:flex;align-items:center;justify-content:center;cursor:pointer}

/* Incoming order popup */
.pop{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.5);z-index:50}
.pop.show{display:flex}
.pop .box{background:#0f1a30;border:1px solid rgba(255,255,255,.14);border-radius:16px;box-shadow:var(--shadow);padding:14px;max-width:520px;width:92%}
.pop .row{grid-template-columns:1fr 1fr}
/* toast */
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#0f1a30;border:1px solid rgba(255,255,255,.14);color:#e6e9ef;border-radius:12px;padding:10px 14px;opacity:0;transition:opacity .18s}
.toast.show{opacity:1}
.tab-btn.active{
  background:linear-gradient(180deg,#33BBDF,#1da9cf);
  border:none;
  color:#fff;
}
@media (max-width:460px){ .row{grid-template-columns:1fr} }
/* === NEO DRIVER UI (design-only) — radical restyle to match the mock === */
.neo-driver{
  --bg:#5a5a5a;           /* خلفية رمادية كما بالمخطط */
  --ink:#111;             /* نص غامق */
  --card:#f1f1f1;         /* بطاقات فاتحة */
  --muted:#555;
  --bar:#1d2021;          /* شريط علوي/سفلي غامق مستدير */
  --accent:#33BBDF;       /* سماوي للأيقونات */
  --ok:#22c55e; --err:#ef4444;
}
/* خلفية عامة */
.neo-driver html, .neo-driver body{
  background:#5a5a5a !important; color:#111 !important;
}
/* الحاوية */
.neo-driver .app{
  max-width: 720px;
  padding: 18px 14px 92px; /* مساحة للأسفل لشريط الإجراءات */
}
/* الشريط العلوي: بار غامق مستدير بثلاث دوائر */
.neo-toolbar{
  position: sticky; top: 8px; z-index: 10;
  display:flex; align-items:center; justify-content:space-between; gap:14px;
  background:var(--bar); color:#fff; border-radius:24px;
  padding:10px 16px; border:1px solid rgba(255,255,255,.12);
  box-shadow:0 8px 24px rgba(0,0,0,.35);
}
/* أخفي عناصر الهيدر القديمة داخل هذا الوضع (ما نحذفها) */
.neo-driver .header{ display:none; }
/* زر دائري كبير */
.neo-circle{
  width:66px; height:66px; border-radius:999px;
  background:transparent; color:#fff; border:2px solid rgba(255,255,255,.7);
  display:flex; align-items:center; justify-content:center;
  font-size:28px; cursor:pointer;
}
.neo-circle:focus{ outline:none }
.neo-circle:active{ transform:scale(.98) }
/* أيقونات الدائرة – لمسات */
.neo-circle.power.on{ box-shadow:0 0 0 3px rgba(34,197,94,.25) inset; color:#86efac; border-color:#86efac; }
.neo-circle.power.off{ opacity:.65 }
.neo-circle.money{ color:#c7f9ff; }
.neo-circle.gear{ color:#e5e7eb; }
/* قائمة الطلبات: بطاقات كبيرة بيضاء مع حدود مستديرة قوية */
.neo-driver #ordersList{
  max-height: calc(100vh - 220px);
  overflow:auto; overscroll-behavior:contain;
  scrollbar-width:none; -ms-overflow-style:none;
}
.neo-driver #ordersList::-webkit-scrollbar{ width:0; height:0 }
.neo-driver .card{
  background: transparent; border:none; box-shadow:none; padding:0;
}
.neo-driver .card-order{
  background:var(--card) !important; color:var(--ink);
  border:2px solid #3334; border-radius:22px; box-shadow:0 8px 22px rgba(0,0,0,.20);
  padding:12px 14px; margin:1px 0;
  display:grid; grid-template-columns:78px 1fr auto; gap:12px; align-items:center;
}
/* صورة المطعم كبيرة ومستديرة */
.neo-driver .card-order .logo img,
.neo-driver .card-order .logo .ph{
  width:72px; height:72px; border-radius:16px;
  border:1px solid #0002; background:#fff;
}
/* نص العنوان */
.neo-driver .card-order .info .line{
  gap:10px; align-items:center;
}
.neo-driver .card-order .info strong{
  font-size:22px; line-height:1.2; color:#000;
}
.neo-driver .card-order .small{ color:#333; font-size:15px }
/* زر الملاحة: دائرة فيروزي + أيقونة ورق الطائرة */
.neo-driver .btn-icon.btn-go{
  width:60px; height:60px; border-radius:999px; border:none;
  background:#07b3c7; color:transparent; box-shadow:0 6px 16px rgba(0,0,0,.25);
  position:relative; text-indent:-9999px; overflow:hidden;
}
.neo-driver .btn-icon.btn-go::before{
  content:""; position:absolute; inset:0; margin:auto; width:28px; height:28px;
  background-repeat:no-repeat; background-position:center; background-size:28px 28px;
  /* أيقونة ورق طائرة SVG مضمّنة */
  background-image:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'><path d='M2.01 21L23 12 2.01 3 2 10l15 2-15 2z'/></svg>");
}
/* حالة “رمادية/غير نشط” (مثلاً أول بطاقة بالمخطط) */
.neo-driver .card-order[data-status="Neu"].is-dim,
.neo-driver .card-order.is-dim{
  background:#bdbdbd !important; color:#111; border-color:#0003;
  opacity:.9;
}
/* الشارات */
.neo-driver .tag{
  background:#e9eef3; color:#111; border:1px solid #0001; border-radius:999px;
  padding:3px 10px; font-weight:800; font-size:12px;
}

.neo-bottom .neo-circle{
  width:74px; height:74px; font-size:34px; border-color:#fff9;
}
.neo-bottom .neo-circle.x{ color:#ffd1d1; }
.neo-bottom .neo-circle.ok{ color:#c8ffd8; }
.neo-bottom .neo-circle.pin{ color:#e5f1ff; }
/* نص “Abholung in …” أسود وواضح */
.neo-driver .eta-line{
  font-weight:800; color:#000; font-size:20px; margin-bottom:2px;
}
/* اجعل حواف البطاقات مستوحاة من الصورة */
.neo-driver .card-order{ border-radius:24px }
/* === Multi-Stops inside a card: light tile + border + shadow + black text === */
.card-order .multi-stops .stop-row{
  background: #ffffff !important;                 /* لون فاتح مثل البطاقة الكبيرة */
  border: 1px solid rgba(0,0,0,.12) !important;   /* إطار واضح */
  box-shadow: 0 8px 18px rgba(0,0,0,.50);         /* ظل خفيف */
  color: #111 !important;                         /* النص أسود */
}
/* اجعل كل النصوص داخل الستوب سوداء بدون التأثير على باقي الواجهة */
.card-order .multi-stops .stop-row *{
  color: #111 !important;
}
/* شارة الحروف (اللوغو المختصر) تناسب الخلفية الفاتحة */
.card-order .multi-stops .stop-logo{
  background: #f6f8fc !important;
  border: 1px solid rgba(0,0,0,.10) !important;
  color: #111 !important;
}
/* لمسة تفاعل */
.card-order .multi-stops .stop-row:hover{
  filter: brightness(1.03);
}
/* === Stop logo as image === */
.card-order .multi-stops .stop-logo{
  width:56px; height:56px;
  border-radius:12px;
  background:#fff;                          /* خلفية فاتحة */
  border:1px solid rgba(0,0,0,.12);
  display:flex; align-items:center; justify-content:center;
  overflow:hidden;
}
.card-order .multi-stops .stop-logo img{
  width:100%; height:100%; object-fit:contain; display:block;
}
/* fallback لو ما في صورة: إظهار حروف */
.card-order .multi-stops .stop-logo .init{
  font-weight:800; color:#111;
}
/* Tabs bar: نفس خلفية الشريط العلوي */
#tabsRow{
  background: linear-gradient(180deg, rgba(11,19,32,1), rgba(11,19,32,.75));
  border: 1px solid rgba(255,255,255,.12);
  border-radius: 12px;
  padding: 6px;
  gap: 6px; /* مسافة بين الأزرار */
}
/* أزرار التبويب (غير المفعّل): شفافة فوق الشريط */
.tab-btn{
  background: transparent !important;          /* يغلب على .btn-ghost */
  border: 1px solid rgba(255,255,255,.14);
  color: var(--ink);
}
/* عند التحويم (اختياري) */
.tab-btn:hover{
  background: rgba(255,255,255,.06);
}
/* التبويب المفعّل: نترك التحديد كما هو (التدرّج الأزرق) */
.tab-btn.active{
  background: linear-gradient(180deg,#33BBDF,#1da9cf) !important;
  border: none !important;
  color: #fff;
  box-shadow: 0 6px 18px rgba(29,169,207,.32);
}
/* نص التبويبات أبيض دائماً */
#tabsRow .tab-btn{
  color:#fff !important;
}
/* عند التحويم يبقى أبيض */
#tabsRow .tab-btn:hover{
  color:#fff !important;
}
/* التبويب المفعّل: يحتفظ بالتدرّج + النص أبيض */
#tabsRow .tab-btn.active{
  color:#fff !important;
}
/* أيقونات جديدة للدوائر */
.neo-circle.exit{ color:#ffd1d1; border-color:#ffd1d1aa; }
.neo-circle.menu{ color:#c7f9ff; }
/* 1) امنع أي تمرير أفقي عام */
html, body { max-width: 100%; overflow-x: hidden; }

/* 2) خلّي الحاوية تلتزم عرض الشاشة */
.app { width: 100%; }

/* 3) حلّ مشكلة Grid overflow:
   استخدم minmax(0,1fr) + min-width:0 حتى تسمح للأعمدة أنها تنضغط وتعمل ellipsis */
.neo-driver .card-order {
  grid-template-columns: 72px minmax(0,1fr) auto;
}
.neo-driver .card-order .info { min-width: 0; }            /* مهم جداً */
.neo-driver .card-order .info .line,
.neo-driver .card-order .info .small { min-width: 0; }

/* نفس الفكرة لأسطر الـstops */
.card-order .multi-stops .stop-row {
  grid-template-columns: 56px minmax(0,1fr) 48px;
}
.card-order .multi-stops .info { min-width: 0; }

/* الشبكات العامة اللي عندك (مثل الفورم/التبويبات) */
.row { grid-template-columns: repeat(2, minmax(0,1fr)); }
#tabsRow { grid-template-columns: repeat(3, minmax(0,1fr)); }

/* أمان إضافي للقوائم */
#ordersList { overflow-x: hidden; }

/* 4) تحجيم أزرار وصور لما الشاشات تصغر جداً */
@media (max-width: 380px){
  .neo-driver .card-order {
    grid-template-columns: 60px minmax(0,1fr) 48px;
    gap: 8px;
  }
  .neo-driver .card-order .logo img,
  .neo-driver .card-order .logo .ph { width: 60px; height: 60px; }
  .btn-icon, .btn-icon.btn-go { width: 48px; height: 48px; }
}


</style>
</head>
<body class="neo-driver">
<!-- Auth Modal -->
<div id="authModal" style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.55)">
  <div style="width:min(560px,92%);background:#0f1a30;border:1px solid rgba(255,255,255,.14);border-radius:16px;padding:14px;box-shadow:0 12px 40px rgba(0,0,0,.35)">
    <div style="display:flex;gap:6px;margin-bottom:10px">
      <button id="tabLogin"    class="btn" style="flex:1">Anmelden</button>
      <button id="tabRegister" class="btn" style="flex:1;opacity:.8">Registrieren</button>
    </div>
    <!-- Login -->
    <form id="formLogin" onsubmit="return false">
      <div class="row" style="grid-template-columns:1fr 1fr">
        <input id="loginEmail" class="input" type="email" placeholder="E-Mail" autocomplete="username" required>
        <input id="loginPass"  class="input" type="password" placeholder="Passwort" autocomplete="current-password" required>
      </div>
      <button id="loginBtn" class="btn btn-cta" style="margin-top:8px">Anmelden</button>
      <div id="loginMsg" class="small" style="margin-top:6px;color:#fca5a5"></div>
    </form>
    <!-- Register -->
    <form id="formRegister" onsubmit="return false" style="display:none">
      <div class="row" style="grid-template-columns:1fr 1fr">
        <input id="regFirst" class="input" type="text" placeholder="Vorname (≥ 2)" autocomplete="given-name" required>
        <input id="regLast"  class="input" type="text" placeholder="Nachname (≥ 2)" autocomplete="family-name" required>
      </div>
      <div class="row" style="grid-template-columns:1fr 1fr">
        <input id="regPhone" class="input" type="tel" placeholder="Telefonnummer (+49 …)" autocomplete="tel" inputmode="tel">
        <input id="regEmail" class="input" type="email" placeholder="E-Mail" autocomplete="email" required>
      </div>
      <div class="row" style="grid-template-columns:1fr 1fr">
        <input id="regPass"  class="input" type="password" placeholder="Passwort (6+)" autocomplete="new-password" required>
        <label style="display:flex;align-items:center;gap:8px;user-select:none">
          <input id="regTerms" type="checkbox" style="width:18px;height:18px" required>
          <span class="small">
            Ich akzeptiere
            <a href="agb.html" target="_blank" rel="noopener noreferrer" style="color:#33BBDF;text-decoration:none">AGB</a>
            &amp;
            <a href="datenschutz.html" target="_blank" rel="noopener noreferrer" style="color:#33BBDF;text-decoration:none">Datenschutz</a>
          </span>
        </label>
      </div>
      <button id="registerBtn" class="btn btn-cta" style="margin-top:8px">Registrieren</button>
      <div id="regMsg" class="small" style="margin-top:6px;color:#fca5a5"></div>
      <div class="small" style="margin-top:4px;opacity:.85">Nach der Registrierung wird dein Konto vom Admin geprüft.</div>
    </form>
  </div>
</div>
<!-- Bottom Neo Bar (shortcuts – اختيارية) -->
<div id="appRoot" class="app" style="display:none">
<!-- Top Neo Toolbar -->
<div class="neo-toolbar">
  <button id="neoMoney" class="neo-circle money" title="Abrechnung">↩︎</button>
  <!-- كان: class="neo-circle power on" -->
<button id="neoPower" class="neo-circle power off" title="Online/Offline">Go</button>

  <button id="neoGear"  class="neo-circle gear"  title="Einstellungen">☰</button>
</div>

  <!-- Header -->
  <div class="header">
    <div class="brand">Fahrer <span id="netDot" class="badge-dot off"></span></div>
    <div class="toggle">
      <div class="stat" id="statText">Offline</div>
      <div id="onlineToggle" class="tgl" title="Online/Offline"></div>
    </div>
    <div>
      <button id="menuBtn" class="menu-btn">☰</button>
      <div id="menu" class="menu">
        <a href="#" id="mNav">🗺️ Navigation-App</a>
        <a href="#" id="mLogout">🚪 Abmelden</a>
      </div>
    </div>
  </div>
  <!-- Orders -->
  <section class="card">
  <div class="kv">
    <div class="small">Aufträge</div>
    <div class="small" id="ordersInfo">—</div>
	<div class="eta-line">Abholung in 13 min</div>
<div class="small">Liefergebühr: 7.50€</div>
  </div>
  <!-- Tabs -->
  <div class="row" id="tabsRow" style="grid-template-columns:repeat(3,1fr);margin-top:8px">
    <button class="btn btn-ghost tab-btn active" data-tab="Neu">Neu</button>
    <button class="btn btn-ghost tab-btn" data-tab="Geliefert">Geliefert</button>
    <button class="btn btn-ghost tab-btn" data-tab="Abgebrochen">Abgebrochen</button>
  </div>
  <div id="ordersList" class="list"></div>
</section>
</div>
<!-- Detail Bottom Sheet -->
<div id="orderModal" class="modal">
  <div class="sheet" role="dialog" aria-modal="true">
    <div class="hdr">
      <div class="title" id="md_title">Auftrag</div>
      <button class="close" id="md_close">✕</button>
    </div>
    <div class="kv"><div class="small">Auftrag-ID</div><div class="small" id="md_id">—</div></div>
    <div class="kv"><div class="small">Status</div><div class="small" id="md_status">—</div></div>
    <div class="kv"><div class="small">Plattform</div><div class="small" id="md_platform">—</div></div>
    <div class="kv"><div class="small">Restaurant</div><div class="small" id="md_rest">—</div></div>
    <div class="kv"><div class="small">Adresse</div><div class="small" id="md_addr">—</div></div>
    <div class="kv"><div class="small">Qty</div><div class="small" id="md_qty">—</div></div>
    <div class="kv"><div class="small">Abholzeit</div><div class="small" id="md_pickup">—</div></div>
    <div class="row" style="margin-top:8px">
	<!-- Preis row (editable) -->
<div class="kv">
  <div class="small">Preis</div>
  <div class="small" style="display:flex;align-items:center;gap:8px">
    <span id="md_price_value">—</span>
    <button id="md_price_edit"
            style="height:28px;min-width:28px;padding:0 8px;border:1px solid rgba(255,255,255,.14);
                   background:#13213a;color:#e6e9ef;border-radius:8px;cursor:pointer;font-size:12px">
      Bearbeiten
    </button>
  </div>
</div>
      <a id="md_nav" class="btn btn-cta" href="#" target="_blank" rel="noopener noreferrer">Navigation</a>
      <button id="md_start" class="btn btn-ghost">Start Fahrt</button>
      <button id="md_done"  class="btn btn-ghost">Geliefert</button>
    </div>
  </div>
</div>
<!-- Navigation preference modal -->
<div id="navModal" class="modal">
  <div class="sheet" role="dialog" aria-modal="true">
    <div class="hdr">
      <div class="title">Navigation-App</div>
      <button class="close" id="nav_close">✕</button>
    </div>
    <div class="row" style="grid-template-columns:1fr">
      <label class="small"><input type="radio" name="navpref" value="auto"> Auto (empfohlen)</label>
      <label class="small"><input type="radio" name="navpref" value="google"> Google Maps</label>
      <label class="small"><input type="radio" name="navpref" value="apple"> Apple Karten</label>
    </div>
    <button id="nav_save" class="btn btn-cta" style="margin-top:8px">Speichern</button>
  </div>
</div>
<!-- Price Edit Modal -->
<div id="priceModal" class="modal">
  <div class="sheet" role="dialog" aria-modal="true" style="max-width:560px;margin:0 auto">
    <div class="hdr">
      <div class="title">Preis anpassen</div>
      <button class="close" id="price_close">✕</button>
    </div>
    <div class="row" style="grid-template-columns:1fr">
      <input id="price_input" class="input" inputmode="decimal" placeholder="0,00 €" aria-label="Neuer Preis in Euro">
    </div>
    <div class="row" style="grid-template-columns:1fr 1fr;margin-top:8px">
      <button id="price_cancel" class="btn btn-ghost">Abbrechen</button>
      <button id="price_save"   class="btn btn-cta">Speichern</button>
    </div>
  </div>
</div>
<!-- Incoming order popup -->
<div id="incoming" class="pop">
  <div class="box">
    <div style="font-weight:800;margin-bottom:8px">Neuer Auftrag</div>
    <div id="in_text" class="small" style="margin-bottom:10px">—</div>
    <div class="row">
      <button id="in_accept" class="btn btn-cta">Akzeptieren</button>
      <button id="in_reject" class="btn btn-ghost">Abbrechen</button>
    </div>
  </div>
</div>
<!-- Sounds -->
<audio id="newOrderSound" src="neu1.mp3" preload="auto"></audio>
<div id="toast" class="toast">OK</div>
<script type="module">
/* ===== Firebase ===== */
import { initializeApp, getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
// أضف getDocs هنا:
import {
  getFirestore, collection, query, where, limit, onSnapshot, doc,
  setDoc, updateDoc, getDoc, getDocs, Timestamp, serverTimestamp,
  runTransaction, increment
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

import {
  getDatabase, ref, onDisconnect, update as rUpdate, onValue, serverTimestamp as rServerTs
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
import {
  getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword,
  signOut, setPersistence, browserSessionPersistence
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyD0g9T3amjuPodsLS6ZQkHYWrzV1UrX_QI",
  authDomain: "taussil-lieferservice-8bbe9.firebaseapp.com",
  projectId: "taussil-lieferservice-8bbe9",
  storageBucket: "taussil-lieferservice-8bbe9.firebasestorage.app",
  messagingSenderId: "583536892937",
  appId: "1:583536892937:web:5d5ff133de4d8b3b28ecd8",
  databaseURL: "https://taussil-lieferservice-8bbe9-default-rtdb.europe-west1.firebasedatabase.app"
};
let app; try{ app=getApp(); }catch{ app=initializeApp(firebaseConfig); }
const db = getFirestore(app);
const rtdb = getDatabase(app);
const auth = getAuth(app);
await setPersistence(auth, browserSessionPersistence).catch(()=>{});
/* ===== Invite Mode — helpers & loader ===== */
const trim  = s => String(s||'').trim();
const lower = s => trim(s).toLowerCase();
const eqStrict = (a,b)=> trim(a) === trim(b);
const eqEmail  = (a,b)=> lower(a) === lower(b);

const urlq = new URLSearchParams(location.search);
let inviteCtx = null;  // { fleetId, invId, invRef, inv }
async function loadInviteIfAny(){
  const fleetId = urlq.get('fleet') || '';
  const invId   = urlq.get('inv')   || '';
  if(!fleetId || !invId) return null;
  try{
    const invRef = doc(db, 'fleet', fleetId, 'invites', invId);
    const snap   = await getDoc(invRef);
    if(!snap.exists()){ regMsg.textContent='Einladung nicht gefunden.'; return null; }
    const inv = snap.data() || {};
    // صلاحية/حالة أساسية (التحقق النهائي يتم بالقواعد)
    if(inv.status !== 'pending'){ regMsg.textContent='Einladung bereits verwendet/abgebrochen.'; return null; }
    const expMs = inv.expiresAt?.toMillis?.()
               ?? (typeof inv.expiresAt?._seconds==='number' ? inv.expiresAt._seconds*1000 : Date.parse(inv.expiresAt));
    if(expMs && Date.now() >= expMs){ regMsg.textContent='Einladungslink abgelaufen (48h).'; return null; }
    // تعبئة الحقول لمساعدة السائق (المطابقة ستكون صارمة عند الضغط تسجيل)
    regFirst.value = inv.firstName || '';
    regLast.value  = inv.lastName  || '';
    regPhone.value = inv.phone     || '';
    regEmail.value = inv.email     || '';
    inviteCtx = { fleetId, invId, invRef, inv };
    switchPane('register'); // افتح تبويب التسجيل تلقائيًا
    return inviteCtx;
  }catch(e){
    console.error('loadInviteIfAny', e);
    regMsg.textContent='Einladung konnte nicht geladen werden.';
    return null;
  }
}
/* ===== Address + Distance + Pricing Helpers ===== */
/* مفتاح خرائط جوجل (استخدمت نفس المفتاح الموجود بواجهة المطعم) */
const GMAPS_API_KEY = 'AIzaSyDipzUmxEQmAjaDkn6xQ91ZhqnkPmgl-2o';
async function ensureGmaps(){
  if (window.google?.maps) return true;
  await new Promise((resolve, reject)=>{
    const cb='gm_cb_'+Math.random().toString(36).slice(2);
    window[cb]=()=>{ delete window[cb]; resolve(true); };
    const s=document.createElement('script');
    s.src=`https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(GMAPS_API_KEY)}&v=weekly&loading=async&callback=${cb}`;
    s.async=true; s.defer=true; s.onerror=()=>{ delete window[cb]; reject(new Error('gmaps-load-failed')); };
    document.head.appendChild(s);
  });
  return true;
}
async function routeKm(origin, destination){
  await ensureGmaps();
  return new Promise((resolve, reject)=>{
    const ds = new google.maps.DirectionsService();
    ds.route({ origin, destination, travelMode: google.maps.TravelMode.DRIVING }, (res, status)=>{
      const leg = res?.routes?.[0]?.legs?.[0];
      if (status==='OK' && leg?.distance?.value!=null) {
        resolve(leg.distance.value / 1000);
      } else {
        reject(new Error(status || 'no-route'));
      }
    });
  });
}
function haversineKm(a,b){
  if(!a||!b||!isFinite(a.lat)||!isFinite(a.lng)||!isFinite(b.lat)||!isFinite(b.lng)) return 0;
  const R=6371, toRad=x=>x*Math.PI/180;
  const dLat=toRad(b.lat-a.lat), dLng=toRad(b.lng-a.lng);
  const s=Math.sin(dLat/2)**2 + Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*Math.sin(dLng/2)**2;
  return 2*R*Math.asin(Math.sqrt(s));
}
function getRestaurantAddr(o){
  return (o?.restaurant?.addressText || o?.restaurant?.address_text || '').trim() || null;
}
function getDropAddr(o){
  const cand = [
    o?.dropoff?.addressText, o?.dropoff?.address_text,
    o?.customer?.addressText, o?.customer?.address_text,
    o?.destination?.addressText, o?.destination?.address_text,
    o?.deliveryAddress, o?.delivery_address,
    o?.addr, o?.address
  ];
  for (const v of cand){ if (v && String(v).trim()) return String(v).trim(); }
  return null;
}
async function getCurrentLLOnce(){
  return new Promise(res=>{
    if(navigator.geolocation){
      navigator.geolocation.getCurrentPosition(
        p=>res({lat:p.coords.latitude, lng:p.coords.longitude}),
        _=>res(null), {enableHighAccuracy:true, maximumAge:1000, timeout:7000}
      );
    } else { res(null); }
  });
}
/* سلسلة التسليمات (multi-drop): نخزن آخر نقطة تسليم */
const LS_CHAIN_LAST_DEST = 'driver:chain:lastDest';
function getLastDest(){
  try{ const s=localStorage.getItem(LS_CHAIN_LAST_DEST); return s? JSON.parse(s) : null; }catch(_){ return null; }
}
function setLastDestFromText(addr){ try{ localStorage.setItem(LS_CHAIN_LAST_DEST, JSON.stringify({addrText: String(addr||'').trim()})); }catch(_){ } }
function setLastDestFromLL(ll){ try{ if(ll&&isFinite(ll.lat)&&isFinite(ll.lng)) localStorage.setItem(LS_CHAIN_LAST_DEST, JSON.stringify({lat: ll.lat, lng: ll.lng})); }catch(_){ } }
/* أصل الرحلة: آخر تسليم وإلا المطعم */
function computeLegOrigin(o){
  const last = getLastDest();
  if(last?.addrText) return last.addrText;
  if(last && isFinite(last.lat) && isFinite(last.lng)) return {lat: last.lat, lng: last.lng};
  return getRestaurantAddr(o);
}
/* كم حقيقي للرحلة الحالية */
async function computeLegKmForOrder(o){
  const origin = computeLegOrigin(o);
  let destination = getDropAddr(o);
  if(!destination){
    // إن لم يكن عنوان التسليم محفوظًا في الوثيقة، نستخدم موقع السائق الحالي كوجهة
    const ll = lastLL || await getCurrentLLOnce();
    if(ll) destination = {lat: ll.lat, lng: ll.lng};
  }
  if(!origin || !destination) return 0;
  try{
    return await routeKm(origin, destination);
  }catch(_){
    if(typeof origin==='object' && 'lat' in origin && typeof destination==='object' && 'lat' in destination){
      return haversineKm(origin, destination);
    }
    return 0;
  }
}
// حساب مباشر لمسافة الطلب المنفرد: المطعم → نقطة التسليم (مستقل عن أي سلسلة)
async function computeDirectKmRestaurantToDrop(o){
  const origin = getRestaurantAddr(o);
  let destination = getDropAddr(o);
  if(!destination){
    const ll = lastLL || await getCurrentLLOnce();
    if(ll) destination = {lat: ll.lat, lng: ll.lng};
  }
  if(!origin || !destination) return 0;
  try{
    return await routeKm(origin, destination);
  }catch(_){
    if (typeof destination === 'object' && 'lat' in destination) {
      const restLL = {
        lat: Number(o?.restaurant?.lat),
        lng: Number(o?.restaurant?.lng)
      };
      if (Number.isFinite(restLL.lat) && Number.isFinite(restLL.lng)) {
        return haversineKm(restLL, destination);
      }
    }
    return 0;
  }
}
/* مبلغ الطلب (Betrag) */
function getOrderAmount(o){
  // في نظامك، المطعم يرسل price كمبلغ الطلب و deliveryFee كبداية 0
  const cands = [o.price, o.amount, o.total, o.orderTotal, o.sum];
  for (const v of cands){
    const n = Number(v);
    if (Number.isFinite(n)) return n;
  }
  return 0;
}
/* معادلة Liefergebühr (متوافقة مع سياسة <25 ثابت) */
function calcDeliveryFeeEUR(betrag, km){
  const price = Math.max(0, Number(betrag || 0));
  const d     = Math.max(0, Number(km || 0));
  // الجزء الثابت/النسبي حسب السياسة
  const base = (price < 25) ? 3.50 : (price * 0.14);
  // شرائح المسافة بعد أول 2 كم مجانًا
  const segA = Math.min(Math.max(d - 2, 0), 5) * 0.50;  // >2–7
  const segB = Math.min(Math.max(d - 7, 0), 5) * 0.80;  // >7–12
  const segC = Math.max(d - 12, 0) * 1.00;              // >12
  const fee = base + segA + segB + segC;
  return Math.round(fee * 100) / 100; // تقريب إلى سنتين
}
// === Distance cost from TOTAL km (multi-order): deduct 2 km, then tiers
function distanceCostFromTotalKm(totalKm){
  const d = Math.max(0, Number(totalKm) || 0);
  const bill = Math.max(0, d - 2);
  const segA = Math.min(bill, 5) * 0.50;                 // >2–7
  const segB = Math.min(Math.max(bill - 5, 0), 5) * 0.80; // >7–12
  const segC = Math.max(bill - 10, 0) * 1.00;             // >12
  return Math.round((segA + segB + segC) * 100) / 100;
}
/* === PRICING v2.1 (Multi-Orders progressive tiers; no waiting) === */
/* تخزين حالة التسعير عبر الأرجل في localStorage */
const LS_ROUTE_PRICE = 'driver:chain:pricing';
const round2 = n => Math.round((Number(n||0) + Number.EPSILON) * 100) / 100;
function loadRouteState(){
  try{
    const s = JSON.parse(localStorage.getItem(LS_ROUTE_PRICE) || '{}');
    const freeLeft = Number.isFinite(+s.freeLeft)? +s.freeLeft : 2;  // 2 كم مجاناً مرة لكل رحلة
    const progKm   = Number.isFinite(+s.progKm)?   +s.progKm   : 0;  // كم فوترة مُستهلكة للشرائح
    return { freeLeft, progKm };
  }catch(_){ return { freeLeft:2, progKm:0 }; }
}
function saveRouteState(st){
  try{ localStorage.setItem(LS_ROUTE_PRICE, JSON.stringify({ freeLeft: +st.freeLeft, progKm: +st.progKm })); }catch(_){}
}
function resetRouteState(){ saveRouteState({ freeLeft:2, progKm:0 }); }

/* تسعير رجل واحدة بشكل تراكمي عبر الرحلة */
function priceDistanceProgressive(legKm, resetFirstLeg=false){
  if(resetFirstLeg) resetRouteState();
  const st = loadRouteState();
  const km = Math.max(0, +legKm || 0);
  // استهلاك المجاني المتبقي من هذه الرجل
  const freeUse = Math.min(st.freeLeft, km);
  let billable  = Math.max(0, km - st.freeLeft);
  st.freeLeft   = Math.max(0, st.freeLeft - km);
  // تطبيق الشرائح تراكميًا حسب progKm
  let val = 0;
  // شريحة1: حتى +5 كم فوترة من بداية الرحلة
  const tier1Left = Math.max(0, 5 - Math.min(st.progKm, 5));
  const take1 = Math.min(billable, tier1Left);
  val += take1 * 0.50; billable -= take1; st.progKm += take1;
  // شريحة2: حتى +10 كم فوترة (5 إضافية)
  if(billable > 0){
    const tier2Cap  = 10;
    const tier2Left = Math.max(0, tier2Cap - Math.min(st.progKm, tier2Cap));
    const take2 = Math.min(billable, tier2Left);
    val += take2 * 0.80; billable -= take2; st.progKm += take2;
  }
  // شريحة3: ما بعد ذلك
  if(billable > 0){
    val += billable * 1.00; st.progKm += billable;
  }
  saveRouteState(st);
  return round2(val);
}
/* هل هذه بداية رحلة جديدة؟ (أول رجل: المطعم → عميل1) */
function isRouteFirstLeg(orderObj){
  const origin = computeLegOrigin(orderObj);     // من ملفك (يعتمد آخر تسليم أو عنوان المطعم)
  const rest   = getRestaurantAddr(orderObj);    // من ملفك
  if(!origin) return true;
  // إذا كانت البداية من المطعم (نصّاً) نعتبرها أول رجل ونصفّر الحالة
  if(typeof origin === 'string' && typeof rest === 'string'){
    return origin.trim() === rest.trim();
  }
  return false;
}
/* قاعدة الطلب كما هي (<25 = 3.50€، وإلا 14%) */
function calcBaseV21(amount){
  amount = Math.max(0, +amount || 0);
  return amount < 25 ? 3.50 : (amount * 0.14);
}
/* الرسوم النهائية لطلب واحد:
   - مفرد (لا سلسلة): نستخدم معادلتك الحالية calcDeliveryFeeEUR (تحسب 2 كم على نفس الطلب)
   - داخل سلسلة Multi: 2 كم مجاناً مرة واحدة + الشرائح تراكميًا عبر الأرجل
*/
function calcFeeSingleOrMulti(orderObj, betrag, legKm){
  const base = round2(calcBaseV21(betrag));
  const firstLeg = isRouteFirstLeg(orderObj);
  // إن كانت سلسلة: استخدم التسعير التراكمي لهذه الرجل
  const inChain = !firstLeg && !!getLastDest(); // وجود وجهة سابقة = داخل سلسلة
  const distEUR = inChain
    ? priceDistanceProgressive(legKm, false)
    : priceDistanceProgressive(legKm, true);    // أول رجل: صفّر الحالة وابدأ من جديد
  // ملاحظة: لو أردت إجبار الطلبات المنفردة خارج أي سلسلة على المعادلة القديمة:
  // return round2(base + (inChain ? distEUR : priceDistanceSingle(legKm)));
  return round2(base + distEUR);
}
/* ===== Helpers/UI ===== */
const $=s=>document.querySelector(s);
const toast=t=>{ const el=$("#toast"); el.textContent=t; el.classList.add("show"); setTimeout(()=>el.classList.remove("show"),1600); if(navigator.vibrate) navigator.vibrate(20); };
const nowStr=()=>new Date().toLocaleTimeString();
/* ===== Navigation Preference & URL ===== */
const NAV_PREF_KEY='taussil_nav_pref';
function detectDefaultNav(){
  const ua = navigator.userAgent||navigator.vendor||'';
  const iOS = /iPad|iPhone|iPod/.test(ua);
  const macTouch = /\bMacintosh\b/.test(ua) && 'ontouchend' in document;
  return (iOS || macTouch) ? 'apple' : 'google';
}
function getNavPref(){ return localStorage.getItem(NAV_PREF_KEY) || 'auto'; }
function makeNavUrl(addr){
  const pref = getNavPref();
  const mode = (pref==='auto')? detectDefaultNav() : pref;
  const enc = encodeURIComponent(addr||'');
  if(mode==='apple'){ return `https://maps.apple.com/?daddr=${enc}&dirflg=d`; }
  return `https://www.google.com/maps/dir/?api=1&destination=${enc}&travelmode=driving`;
}
/* ===== Refs ===== */
const netDot=$("#netDot"), statText=$("#statText"), onlineToggle=$("#onlineToggle");
const menuBtn=$("#menuBtn")||null, menu=$("#menu")||null;     // قد لا توجد بعد التنظيف
const mNav=$("#mNav")||null, mLogout=$("#mLogout")||null;

const navModal=$("#navModal"), navClose=$("#nav_close"), navSave=$("#nav_save");
const listEl=$("#ordersList"), ordersInfo=$("#ordersInfo");
const md=$("#orderModal"), mdClose=$("#md_close");
const md_id=$("#md_id"), md_status=$("#md_status"), md_platform=$("#md_platform"), md_rest=$("#md_rest"), md_addr=$("#md_addr"), md_qty=$("#md_qty"), md_pickup=$("#md_pickup"), md_title=$("#md_title");
const md_start=$("#md_start"), md_done=$("#md_done"), md_nav=$("#md_nav");
const incoming=$("#incoming"), inText=$("#in_text"), inAccept=$("#in_accept"), inReject=$("#in_reject");
const neoPower = document.getElementById('neoPower');

/* === صوت التنبيه (موجود في الـHTML): <audio id="newOrderSound" src="neu1.mp3" preload="auto"></audio> === */
const newOrderSound=$("#newOrderSound");
const appRoot=$("#appRoot"); const authModal=$("#authModal");
document.querySelectorAll('.tab-btn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    currentTab = btn.getAttribute('data-tab') || 'Neu';
    renderOrders(lastOrders); // إعادة رسم حسب التبويب
  });
});

/* Auth popup elements */
const tabLogin=$("#tabLogin"), tabRegister=$("#tabRegister");
const formLogin=$("#formLogin"), formRegister=$("#formRegister");
const loginEmail=$("#loginEmail"), loginPass=$("#loginPass"), loginBtn=$("#loginBtn"), loginMsg=$("#loginMsg");
const regFirst=$("#regFirst"), regLast=$("#regLast"), regPhone=$("#regPhone"), regEmail=$("#regEmail"), regPass=$("#regPass"), regTerms=$("#regTerms"), registerBtn=$("#registerBtn"), regMsg=$("#regMsg");

/* ===== State ===== */
const ONLINE_PREF_KEY='taussil_driver_online_pref';
const SESSION_OK='driver_session_ok';
let lastAuthTab = localStorage.getItem('driver_auth_tab') || 'login';

let uid=null, approved=false, online=false, watchId=null, lastLL=null, lastSentAt=0;
let currentTab = 'Neu';
let lastOrders = [];

function normStatus(raw){
  const s = String(raw||'').toLowerCase();
  if (['bearbeitung','zugewiesen','assigned','angenommen','unterwegs'].includes(s)) return 'neu';
  if (s==='geliefert')   return 'geliefert';
  if (s==='abgebrochen') return 'abgebrochen';
  return 'neu';
}
function inTab(o, tab){
  const ns = normStatus(o?.status);
  if (tab==='Neu')         return ns==='neu';
  if (tab==='Geliefert')   return ns==='geliefert';
  if (tab==='Abgebrochen') return ns==='abgebrochen';
  return true;
}

let regInFlight = false; // ← تسجيل حساب جديد جارٍ

/* ===== Menu ===== */
if(menuBtn && menu){
  menuBtn.addEventListener("click", (e)=>{ e.preventDefault(); menu.classList.toggle("show"); });
  document.addEventListener("click",(e)=>{ if(!e.target.closest(".menu") && !e.target.closest("#menuBtn")) menu.classList.remove("show"); });
}

async function doLogout(){
  try{ await signOut(auth); }catch(_){}
  sessionStorage.removeItem(SESSION_OK);
  appRoot.style.display='none'; authModal.style.display='flex';
  detachOrders(); stopPresence(); detachInbox(); stopIncomingAlert(); stopMedianBG();
  toast('Abgemeldet');
}
// لو القائمة القديمة موجودة، خلّيها تستخدم نفس الدالة
if(mLogout){
  mLogout.addEventListener('click', async (e)=>{ e.preventDefault(); await doLogout(); });
}
// الزر الأيسر (⎋) = خروج مباشر
document.getElementById('neoMoney')?.addEventListener('click', (e)=>{ e.preventDefault(); doLogout(); });
window.__driverLogout = doLogout; // إتاحة الاستدعاء للسكربت السفلي







/* ===== Navigation Pref UI ===== */
function openNavPref(){
  const pref=getNavPref();
  navModal.classList.add('show');
  document.querySelectorAll('input[name="navpref"]').forEach(r=>{ r.checked = (r.value===pref); });
}
mNav.addEventListener('click', (e)=>{ e.preventDefault(); openNavPref(); });
navClose.addEventListener('click', ()=> navModal.classList.remove('show'));
navModal.addEventListener('click',(e)=>{ if(e.target===navModal) navModal.classList.remove('show'); });
navSave.addEventListener('click', (e)=>{
  e.preventDefault();
  const sel = document.querySelector('input[name="navpref"]:checked');
  const val = sel? sel.value : 'auto';
  localStorage.setItem(NAV_PREF_KEY, val);
  navModal.classList.remove('show');
  toast('Navigation gespeichert');
});

/* ===== Tabs ===== */
function switchPane(which){
  const reg = (which==='register');
  formLogin.style.display    = reg ? 'none' : 'block';
  formRegister.style.display = reg ? 'block': 'none';
  tabLogin.style.opacity     = reg ? .7 : 1;
  tabRegister.style.opacity  = reg ? 1 : .7;
  lastAuthTab = reg? 'register':'login';
  localStorage.setItem('driver_auth_tab', lastAuthTab);
}
tabLogin.addEventListener('click', (e)=>{ e.preventDefault(); switchPane('login'); });
tabRegister.addEventListener('click', (e)=>{ e.preventDefault(); switchPane('register'); });

/* ===== Auth Actions ===== */
loginBtn.addEventListener('click', async (e)=>{
  e.preventDefault();
  loginMsg.textContent=''; loginBtn.disabled=true;
  try{
    const email=(loginEmail?.value||'').trim();
    const pass =(loginPass ?.value||'');
    if(!email || !pass){ loginMsg.textContent='Bitte E-Mail & Passwort eingeben.'; return; }
    await signInWithEmailAndPassword(auth, email, pass);
    sessionStorage.setItem(SESSION_OK,'1');
  }catch(e){
    console.error(e);
    const map = {'auth/invalid-email':'E-Mail ungültig.','auth/user-not-found':'Kein Nutzer gefunden.','auth/wrong-password':'Falsches Passwort.','auth/too-many-requests':'Zu viele Versuche.','auth/network-request-failed':'Netzwerkfehler.'};
    loginMsg.textContent = map[e?.code] || ('Anmeldung fehlgeschlagen: '+(e?.code||''));
  }finally{ loginBtn.disabled=false; }
});

registerBtn.addEventListener('click', async (e)=>{
  e.preventDefault();
  regMsg.textContent=''; registerBtn.disabled=true; regInFlight = true;

  // إزالة أي تمييز أخطاء قديم
  const markErr = (el, on)=>{ if(!el) return; el.style.borderColor = on? 'var(--err)' : ''; };
  [regFirst,regLast,regPhone,regEmail].forEach(i=>markErr(i,false));

  const first=(regFirst?.value||'').trim();
  const last =(regLast ?.value||'').trim();
  const phone=(regPhone?.value||'').trim();
  const email=(regEmail?.value||'').trim();
  const pass =(regPass ?.value||'');

  // فحوصات عامة
  if(first.length<2){ regMsg.textContent='Bitte Vornamen (≥2)'; registerBtn.disabled=false; regInFlight=false; return; }
  if(last.length<2){  regMsg.textContent='Bitte Nachnamen (≥2)'; registerBtn.disabled=false; regInFlight=false; return; }
  if(!/\S+@\S+\.\S+/.test(email)){ regMsg.textContent='E-Mail ungültig'; registerBtn.disabled=false; regInFlight=false; return; }
  if((pass||'').length<6){ regMsg.textContent='Passwort zu kurz'; registerBtn.disabled=false; regInFlight=false; return; }
  if(!regTerms?.checked){ regMsg.textContent='Bitte AGB & Datenschutz akzeptieren.'; registerBtn.disabled=false; regInFlight=false; return; }

  try{
    // لو الدعوة موجودة، نُلزم تطابق الحقول الأربع 100%
    if (inviteCtx){
      const inv = inviteCtx.inv || {};
      const expMs = inv.expiresAt?.toMillis?.()
                 ?? (typeof inv.expiresAt?._seconds==='number' ? inv.expiresAt._seconds*1000 : Date.parse(inv.expiresAt));
      const stillValid = inv.status==='pending' && inv.singleUse===true && (!expMs || Date.now()<expMs);
      if(!stillValid){ throw new Error('invite-invalid'); }

      const eqTrim  = (a,b)=> String(a||'').trim() === String(b||'').trim();
      const eqEmail = (a,b)=> String(a||'').trim().toLowerCase() === String(b||'').trim().toLowerCase();

      const mismatches=[];
      if(!eqEmail(email, inv.emailLower || inv.email)){ mismatches.push('E-Mail'); markErr(regEmail,true); }
      if(!eqTrim(first, inv.firstName)){ mismatches.push('Vorname'); markErr(regFirst,true); }
      if(!eqTrim(last,  inv.lastName )){ mismatches.push('Nachname'); markErr(regLast,true); }
      if(!eqTrim(phone, inv.phone    )){ mismatches.push('Telefon');  markErr(regPhone,true); }

      if(mismatches.length){
        regMsg.textContent = 'Daten stimmen nicht mit der Einladung überein: ' + mismatches.join(', ');
        registerBtn.disabled=false; regInFlight=false; return; // ← هنا نمنع إنشاء الحساب
      }
    }
    // ملاحظة: إذا ما في دعوة بالـURL، نسير كتسجيل عادي (لا نمنع)

    // إنشاء الحساب
    const cred=await createUserWithEmailAndPassword(auth,email,pass);
    const user=cred.user;
    await user.getIdToken(true);

    const uref=doc(db,'users', user.uid);
    const ex=await getDoc(uref);
    if(ex.exists()){
      regMsg.textContent='Konto existiert bereits. Bitte anmelden.';
      await signOut(auth).catch(()=>{});
      switchPane('login'); return;
    }

    const nowTs = Timestamp.now();
    await setDoc(uref,{
      email: user.email || email,
      role:'driver',
      approved:false,
      status:'pending',
      firstName:first,
      lastName:last,
      phone: phone||null,
      ...(inviteCtx ? { fleetId: inviteCtx.fleetId } : {}),
      createdAt: nowTs,
      updatedAt: nowTs
    },{merge:false});

    // إن كان التسجيل عبر دعوة: نوسمها "used"
    if(inviteCtx?.invRef){
      await setDoc(inviteCtx.invRef, {
        status:'used',
        consumedAt: serverTimestamp(),
        consumedBy: user.uid,
        updatedAt: serverTimestamp()
      }, { merge:true });
    }

    regMsg.textContent='Registrierung erfolgreich. Konto wird vom Admin geprüft.';
    await signOut(auth).catch(()=>{});
    switchPane('login');

  }catch(e){
    console.error(e);
    const code = e?.code || e?.message || '';
    if(String(code).includes('invite-invalid')) regMsg.textContent='Einladung ungültig/abgelaufen.';
    else{
      const map = {
        'permission-denied':'Berechtigung verweigert (Rules).',
        'auth/email-already-in-use':'E-Mail bereits vergeben.',
        'auth/invalid-email':'E-Mail ungültig.',
        'auth/weak-password':'Passwort zu schwach (6+).',
        'auth/network-request-failed':'Netzwerkfehler.'
      };
      regMsg.textContent = map[e?.code] || ('Registrierung fehlgeschlagen: '+(e?.code||''));
    }
  }finally{
    registerBtn.disabled=false; regInFlight=false;
  }
});


/* ===== Online toggle ===== */
onlineToggle.addEventListener("click", (e)=>{ e.preventDefault(); setOnline(!online); });

function setOnline(flag){
  // حراسة: لو المستخدم غير مسجّل أو غير مُعتمد → أبقِ الواجهة على OFF
  if(!uid){
    toast("Bitte zuerst anmelden.");
    online = false;
    onlineToggle.classList.remove("on");
    neoPower?.classList.remove("on"); neoPower?.classList.add("off");
    statText.textContent = "Offline";
    window.online = online;
    return;
  }
  if(!approved){
    toast("Dein Konto wird geprüft");
    online = false;
    onlineToggle.classList.remove("on");
    neoPower?.classList.remove("on"); neoPower?.classList.add("off");
    statText.textContent = "Offline";
    window.online = online;
    return;
  }

  online = !!flag;
  window.online = online; // ← إتاحة الحالة للسكربت الثاني

  // مزامنة الزرين: السلايدر (مخفي) + زر الباور المرئي
  onlineToggle.classList.toggle("on", online);
  neoPower?.classList.toggle("on",  online);
  neoPower?.classList.toggle("off", !online);

  statText.textContent = online ? "Online" : "Offline";
  localStorage.setItem(ONLINE_PREF_KEY, online ? '1' : '0');

  if (online){
    startPresence();
    attachOrders();
    attachInbox();
    startMedianBG(uid);
  } else {
    stopPresence();
    detachOrders();
    detachInbox();
    stopIncomingAlert();
    stopMedianBG();
  }
}

// اجعل الدالة متاحة للسكربت غير الموديول
window.setOnline = setOnline;



/* ===== Presence + GPS (RTDB) ===== */
let hbTimer = null;

function startPresence(){
  if (!uid) { console.warn('startPresence: no uid'); return; }
  const pRef = ref(rtdb, `drivers_presence/${uid}`);
  rUpdate(pRef, { online:true, desired:true, ts: Date.now(), ver:'driver-web-v7' }).catch(()=>{});
  try{ onDisconnect(pRef).update({ lastDisconnectAt: rServerTs() }); }catch(_){}
  if (hbTimer) clearInterval(hbTimer);
  hbTimer = setInterval(()=> {
    rUpdate(pRef, { online:true, ts: Date.now(), ver:'driver-web-v7' }).catch(()=>{});
  }, 15000);
  startWatch();
}

function stopPresence(){
  if (hbTimer){ clearInterval(hbTimer); hbTimer=null; }
  if (!uid) { stopWatch(); return; }
  try{ rUpdate(ref(rtdb,`drivers_presence/${uid}`), { online:false, desired:false, ts: Date.now() }); }catch(_){}
  stopWatch();
}

function startWatch(){
  if(!("geolocation" in navigator)){ return; }
  if(watchId!=null) return;
  watchId = navigator.geolocation.watchPosition(
    pos=>{
      const { latitude:lat, longitude:lng, accuracy, speed } = pos.coords;
      lastLL={lat,lng};
      const now=Date.now();
      if(now-lastSentAt>=4000){
        rUpdate(ref(rtdb,`drivers_locations/${uid}`), { lat,lng, accuracy: Number.isFinite(accuracy)?accuracy:null, updatedAt: now }).catch(()=>{});
        lastSentAt=now;
      }
    },
    _=>{},
    { enableHighAccuracy:true, maximumAge:1000, timeout:10000 }
  );
}
function stopWatch(){ if(watchId!=null){ try{ navigator.geolocation.clearWatch(watchId); }catch(_){ } watchId=null; } }
/* === Addon: Live driver location v2 (non-invasive) === */
let LIVE_WATCH_ID=null, LIVE_LAST_LL=null, LIVE_LAST_SENT=0, LIVE_HB=null;

function driverLiveStart(){
  try{
    const uid = auth?.currentUser?.uid; if(!uid || !('geolocation' in navigator)) return;
    const locRef = ref(rtdb, `drivers_locations/${uid}`);


    // طلقة أولى دقيقة
    navigator.geolocation.getCurrentPosition(p=>{
      const { latitude, longitude, accuracy } = p.coords || {};
      if (!Number.isFinite(latitude) || !Number.isFinite(longitude)) return;
      const lat = +Number(latitude).toFixed(6);
      const lng = +Number(longitude).toFixed(6);
      LIVE_LAST_LL = { lat, lng };
      rUpdate(locRef, { lat, lng, accuracy: Number.isFinite(accuracy)? accuracy:null, ts: Date.now(), ver:'kick' }).catch(()=>{});
    }, ()=>{}, { enableHighAccuracy:true, timeout:10000 });

    // متابعة مباشرة بالحركة (قد تتوقف بالخلفية على بعض الأجهزة)
    if (LIVE_WATCH_ID===null){
      LIVE_WATCH_ID = navigator.geolocation.watchPosition(p=>{
        const c = p.coords || {}; const now = Date.now();
        if (!Number.isFinite(c.latitude) || !Number.isFinite(c.longitude)) return;
        if (c.accuracy && c.accuracy > 80) return; // تجاهل قراءات غير دقيقة (>80m)
        const lat = +Number(c.latitude).toFixed(6);
        const lng = +Number(c.longitude).toFixed(6);
        LIVE_LAST_LL = { lat, lng };
        if (now - LIVE_LAST_SENT < 4000) return;   // حد أقصى كل ≥4 ثوانٍ
        LIVE_LAST_SENT = now;
        rUpdate(locRef, {
          lat, lng,
          accuracy: Number.isFinite(c.accuracy)? c.accuracy : null,
          speed:    Number.isFinite(c.speed)?    c.speed    : null,
          heading:  Number.isFinite(c.heading)?  c.heading  : null,
          ts: now, ver:'watch'
        }).catch(()=>{});
      }, err=>console.warn('GPS', err), { enableHighAccuracy:true, maximumAge:0, timeout:10000 });
    }

    // نبض كل 15s يدفع آخر نقطة حتى لو التبويب بالخلفية
    if (!LIVE_HB){
      LIVE_HB = setInterval(()=>{
        if(!LIVE_LAST_LL) return;
        rUpdate(locRef, { ...LIVE_LAST_LL, ts: Date.now(), ver:'hb' }).catch(()=>{});
      }, 15000);
    }
  }catch(e){ console.error('driverLiveStart error', e); }
}

function driverLiveStop(){
  try{
    if (LIVE_WATCH_ID!==null){ navigator.geolocation.clearWatch(LIVE_WATCH_ID); LIVE_WATCH_ID=null; }
    if (LIVE_HB){ clearInterval(LIVE_HB); LIVE_HB=null; }
  }catch(_){}
}

// أعِد تشغيل التتبّع عند رجوع التبويب للمقدمة (Safari/Android قد يوقفه بالخلفية)
document.addEventListener('visibilitychange', ()=>{ if (!document.hidden) driverLiveStart(); });
/* ===== Median Background Location (Android/iOS) ===== */
let MEDIAN_BG_ON = false;

function startMedianBG(uid){
  if(!uid) return;

  const postUrlBase = "https://europe-west1-taussil-lieferservice-8bbe9.cloudfunctions.net/driverLocation";
  const url = `${postUrlBase}?uid=${encodeURIComponent(uid)}&token=Taussil_hK8f9Q2w7yP1n`;

  const tryStart = () => {
    try{
      if (!window.median || !median.backgroundLocation) return false;
      median.backgroundLocation.start({
        postUrl: url,

        // ANDROID
        androidPriority: "highAccuracy",
        androidInterval: 15000,
        androidFastestInterval: 5000,
        androidNotificationTitle: "Taussil – Standort aktiv",
        androidNotificationText:  "Fahrer-Tracking läuft im Hintergrund.",

        // iOS
        iosBackgroundIndicator: true,
        iosPauseAutomatically: false,
        iosDesiredAccuracy: "bestForNavigation",
        iosActivityType: "automotiveNavigation"
      });
      MEDIAN_BG_ON = true;
      return true;
    }catch(e){
      console.warn("[Median] start failed (will retry)", e);
      return false;
    }
  };

  if (!tryStart()){
    let tries = 0;
    const t = setInterval(()=>{
      tries++;
      if (tryStart() || tries >= 20) clearInterval(t);
    }, 500);
  }
}

function stopMedianBG(){
  try{ median?.backgroundLocation?.stop(); }catch(_){}
  MEDIAN_BG_ON = false;
}

/* ===== Orders ===== */
/* === Multi-order (stops) support === */

// يجلب delivered_ll لأحدث ستوب "Geliefert" (غير الحالي) داخل نفس الطلب
async function getPrevDeliveredLL(orderId, excludeStopId){
  const sref = collection(db, "orders", orderId, "stops");
  const snap = await getDocs(sref);
  const toMs = t => (t?.toMillis?.() || (typeof t?._seconds==="number" ? t._seconds*1000 : 0));
  const asLL = x => (x && Number.isFinite(+x.lat) && Number.isFinite(+x.lng))
    ? { lat:+Number(x.lat).toFixed(6), lng:+Number(x.lng).toFixed(6) } : null;

  const delivered = snap.docs
    .filter(d => d.id !== excludeStopId)
    .map(d=>d.data()||{})
    .filter(s => String(s.status||'').toLowerCase()==='geliefert')
    .sort((a,b)=> toMs(b.deliveredAt) - toMs(a.deliveredAt));

  const ll = asLL(delivered[0]?.delivered_ll);
  return ll; // قد يكون null إن لم يوجد مُسلَّم سابق
}

const stopsUnsubs = new Map();
function detachStopsAll(){ stopsUnsubs.forEach(u=>{try{u();}catch(_){}}); stopsUnsubs.clear(); }

/* تسليم stop واحد مع حساب مسافة الرجل فقط (تراكمي عبر الرحلة) */
async function getSequentialOriginForStop(orderId, stopData, orderData) {
  const sref = collection(db, "orders", orderId, "stops");
  const snap = await getDocs(sref);
  const toMillis = t => (t?.toMillis?.() ?? (typeof t?._seconds === "number" ? t._seconds * 1000 : 0));

  const deliveredStops = snap.docs
    .map(d => ({ id: d.id, s: d.data() || {} }))
    .filter(x => String(x.s.status || '').trim().toLowerCase() === 'geliefert'
                 && x.id !== stopData.id)
    .sort((a, b) => toMillis(a.s.deliveredAt) - toMillis(b.s.deliveredAt));

  if (deliveredStops.length > 0) {
    const last = deliveredStops[deliveredStops.length - 1].s;
    if (last.delivered_ll && Number.isFinite(+last.delivered_ll.lat) && Number.isFinite(+last.delivered_ll.lng)) {
      return { lat: +last.delivered_ll.lat, lng: +last.delivered_ll.lng };
    } else if (last.delivered_addr_text) {
      return last.delivered_addr_text;
    }
  }

  return getRestaurantAddr(orderData);
}

async function finalizeStop(orderId, stopId, stopData, orderData) {
  try {
    // 1) الموقع السابق: آخر stop مُسلّم أو عنوان المطعم
    const origin = await getSequentialOriginForStop(orderId, stopData, orderData);

    // 2) موقع السائق الحالي ← نقطة التسليم الفعلية
    const ll = lastLL || await getCurrentLLOnce();
    if (!origin || !ll) {
      toast('Standort fehlt');
      return;
    }

    const destination = { lat: +ll.lat.toFixed(6), lng: +ll.lng.toFixed(6) };

    // 3) حساب المسافة بين الموقع السابق و الحالي
    let km = 0;
    try {
      km = await routeKm(origin, destination);
    } catch (_) {
      km = haversineKm(origin, destination);
    }
    km = Math.max(0, Number(km || 0));

    // 4) حساب 14% من سعر الستوب
    const stopPrice = Number(stopData.price || 0);
    const fee14 = Math.round(stopPrice * 0.14 * 100) / 100;

    // 5) تحديث الستوب
    const sref = doc(db, "orders", orderId, "stops", stopId);
    await setDoc(sref, {
      status: "Geliefert",
      deliveredAt: serverTimestamp(),
      distance_km: km,
      deliveryFee: fee14,
      delivered_ll: destination,
      updatedAt: serverTimestamp()
    }, { merge: true });

    // 6) حفظ الموقع مؤقتاً لاستخدامه في الستوب التالي
    setLastDestFromLL(destination);

    // 7) تحديث الطلب الأم
    const prevDel = Number(orderData.stops_delivered || 0);
    const qty = Number(orderData.qty || 0);
    await updateDoc(doc(db, "orders", orderId), {
      stops_delivered: increment(1),
      updatedAt: serverTimestamp()
    });

    const justDelivered = prevDel + 1;
    if (qty > 0 && justDelivered >= qty) {
      await recalcOrderFees(orderId);
      await patchOrder(orderId, { status: "Geliefert" });
    }

    toast(`Stop geliefert · ${km.toFixed(2)} km · 14% = ${fee14.toFixed(2)}€`);
  } catch (e) {
    console.error('finalizeStop error', e);
    toast("Fehler beim Stop");
  }
}





/* === Provider logos map (for stop tiles) === */
const PROVIDER_LOGOS_BASE = './'; // عدّل المسار إذا كانت الصور في مجلد آخر
const PROVIDER_LOGOS = [
  { k: 'uber eats',  f: 'Uber.png' },
  { k: 'ubereats',   f: 'Uber.png' },
  { k: 'uber',       f: 'Uber.png' },
  { k: 'lieferando', f: 'Lieferando.png' },
  { k: 'wolt',       f: 'Wolt.png' },
  { k: 'restablo',   f: 'Restablo.jpg' },
  { k: 'andere',     f: 'Andere.png' },
];

function providerLogoUrl(platform){
  const s = String(platform||'').trim().toLowerCase();
  if(!s) return null;
  const hit = PROVIDER_LOGOS.find(x => s.includes(x.k));
  return hit ? (PROVIDER_LOGOS_BASE + hit.f) : null;
}

/* مستمع فرعي لكل طلب: يعرض أسطر الـstops ويخفي زر Delivered العام */
function attachStopsForOrder(orderId, orderData, cardEl){
  // فضِّ أي مستمع سابق لهذا الطلب
  try{ stopsUnsubs.get(orderId)?.(); }catch(_){}
  const cont = cardEl.querySelector('.multi-stops');
  if(!cont) return;
  const doneGeneral = cardEl.querySelector('button[data-act="delivered"]');

  const subCol = collection(db, "orders", orderId, "stops");
  const unsub = onSnapshot(subCol, (snap)=>{
    const docs = snap.docs.map(d=>({ id:d.id, s:d.data()||{} }));
    if(docs.length===0){
      cont.style.display='none';
      if(doneGeneral) doneGeneral.style.display='inline-flex'; // طلب منفرد => يرجع الزر العام
      return;
    }
    cont.style.display='block';
    if(doneGeneral) doneGeneral.style.display='none';          // Multi => نخفي الزر العام

    // ترتيب: حسب nr ثم id
    docs.sort((a,b)=>{
      const na=Number(a.s.nr||0), nb=Number(b.s.nr||0);
      if(na!==nb) return na-nb; return a.id.localeCompare(b.id);
    });

    cont.innerHTML = docs.map(({id,s},i)=>{
      const st  = mapStatusLabel(s.status||'Bearbeitung');
      const del = String(s.status||'').toLowerCase()==='geliefert';
      // ...
const plat = s.platform || '';
const addr = s.address_text || s.addressText || '';
const initials = (plat||id).slice(0,2).toUpperCase();

// ⬅️ جديد: صورة اللوجو إن توفرت، وإلا الأحرف
const logoSrc  = providerLogoUrl(plat);
const logoHTML = logoSrc
  ? `<img src="${logoSrc}" alt="${plat}">`
  : `<span class="init">${initials}</span>`;

const btn = del ? `<span class="btn-icon btn-done" title="Geliefert">✓</span>`
                : `<button class="btn-icon btn-done" data-stop="${id}" title="Diesen Stop liefern">✓</button>`;

return `
  <div class="stop-row" data-stop="${id}">
    <div class="stop-logo">${logoHTML}</div>
    <div class="info">
      <div class="line"><strong>${s.name || orderData.restaurant?.name || '—'}</strong>
        <span class="tag">Item #${i+1} · ${st}</span></div>
      <div class="small">${plat || '—'}</div>
      <div class="small" style="opacity:.85;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${addr || '—'}</div>
    </div>
    <div class="act">${btn}</div>
  </div>`;

    }).join("");

    // ربط زر التسليم لكل stop
    cont.querySelectorAll('button[data-stop]').forEach(btn=>{
      btn.onclick = async (e)=>{
        e.stopPropagation();
        const sid = btn.getAttribute('data-stop');
        const sd  = docs.find(d=>d.id===sid)?.s || {};
        await finalizeStop(orderId, sid, sd, orderData);
      };
    });
  }, ()=>{ cont.style.display='none'; if(doneGeneral) doneGeneral.style.display='inline-flex'; });

  stopsUnsubs.set(orderId, unsub);
}

let unsubOrders=null, unsubInbox=null;
function detachOrders(){
  unsubOrders?.(); unsubOrders=null;
  ordersInfo.textContent="—"; listEl.innerHTML="";
  detachStopsAll(); /* ← إضافة */
}

function mapStatusLabel(s){ const low=String(s||"").toLowerCase(); if(low==="bearbeitung") return "Neu"; return s||"—"; }

function attachOrders(){
  detachOrders();
  if(!uid){ ordersInfo.textContent="—"; return; }
  const qMine=query(collection(db,"orders"), where("driver.id","==", uid), limit(50));
  unsubOrders = onSnapshot(qMine,(snap)=>{
    const items = snap.docs.map(d=>({ id:d.id, o:d.data()||{} }))
      .sort((a,b)=>{
        const ta=(a.o.updatedAt&&a.o.updatedAt.toMillis)?a.o.updatedAt.toMillis():0;
        const tb=(b.o.updatedAt&&b.o.updatedAt.toMillis)?b.o.updatedAt.toMillis():0;
        return tb-ta;
      });
    lastOrders = items.slice();
    renderOrders(lastOrders);
    snap.docChanges().forEach(ch=>{
      const now=String(ch.doc.data()?.status||'').toLowerCase();
      if(now==='zugewiesen' || now==='assigned'){ showIncoming({id:ch.doc.id, o:ch.doc.data()||{}}); }
    });
  }, ()=>{ ordersInfo.textContent="Wird geprüft…"; });
}

function renderOrders(items){
  const filtered = items.filter(({o})=> inTab(o, currentTab));
  ordersInfo.textContent = `${filtered.length} sichtbar (${currentTab})`;
  if(filtered.length===0){ listEl.innerHTML = `<div class="small" style="opacity:.8">— Keine Aufträge —</div>`; return; }

  listEl.innerHTML = filtered.map(({id,o})=>{
    const stRaw=o.status||"—", st=mapStatusLabel(stRaw);
    const rest=o.restaurant?.name||"—";
    const addr=(o.restaurant?.addressText || o.restaurant?.address_text || "").trim();
    const qty =Number(o.qty||0)||0;
    const plat=Array.isArray(o.platform)? o.platform.join(" / ") : (o.platform||"—");
    const lower=String(stRaw).toLowerCase();
    const showStart = (lower==="angenommen" || lower==="zugewiesen" || lower==="assigned" || lower==="bearbeitung");
    const showDone  = (lower==="unterwegs");
    const logoUrl=o.restaurant?.logoUrl||"";
    const logoHTML = logoUrl? `<img src="${logoUrl}" alt="${rest}">` : `<div class="ph">${(rest||"—").slice(0,2).toUpperCase()}</div>`;
    const navHref = addr ? makeNavUrl(addr) : '#';
    return `
      <div class="card-order" data-id="${id}" data-addr="${encodeURIComponent(addr)}" data-status="${st}">

        <div class="logo">${logoHTML}</div>
        <div class="info">
          <div class="line"><strong>${rest}</strong> <span class="tag">${st}</span></div>
          <div class="small">${plat} · Qty ${qty}</div>
          <div class="small" style="opacity:.85;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${addr || '—'}</div>
		  <div class="multi-stops" data-stops-of="${id}" style="grid-column:1 / -1; display:none"></div>
        </div>
        <div class="act">
          ${ showStart ? `<a class="btn-icon btn-go" href="${navHref}" target="_blank" rel="noopener noreferrer" data-act="start">▶</a>` : ``}
          ${ showDone  ? `<button class="btn-icon btn-done" data-act="delivered">✓</button>` : ``}
        </div>
      </div>
    `;
  }).join("");
  // خريطة للوصول السريع لكائن الـorder
const omap = new Map(filtered.map(({id,o})=>[id,o]));

listEl.querySelectorAll(".card-order").forEach(el=>{
  const id = el.getAttribute("data-id");
  const addr = decodeURIComponent(el.getAttribute("data-addr")||"").trim();

  // ربط تفاصيل البطاقة كما هو موجود عندك
  el.addEventListener("click",(e)=>{
    if(e.target.closest(".btn-icon")) return;
    openDetail(id);
  });

  // أزرارك القديمة كما هي
  const startA = el.querySelector('a[data-act="start"]');
  if(startA){
    startA.addEventListener("click", async (e)=>{
      if(!addr){ e.preventDefault(); toast('Restaurant-Adresse fehlt'); return; }
      await safeSetStatusToUnterwegs(id);
    });
  }
  const doneBtn = el.querySelector('button[data-act="delivered"]');
  if(doneBtn){
    doneBtn.addEventListener("click", async (e)=>{
      e.stopPropagation();
      await finalizeOrderWithFee(id); // يظل للطلب المنفرد فقط
    });
  }

  // ✅ تشغيل مستمع الـstops لهذا الطلب (إن وُجدت subcollection سيظهروا؛ غير ذلك يبقى المنطق القديم)
  const o = omap.get(id) || {};
  attachStopsForOrder(id, o, el);
});


  // ربط الأحداث
  listEl.querySelectorAll(".card-order").forEach(el=>{
    el.addEventListener("click",(e)=>{
      if(e.target.closest(".btn-icon")) return;
      const id = el.getAttribute("data-id"); openDetail(id);
    });
    const startA = el.querySelector('a[data-act="start"]');
    if(startA){
      startA.addEventListener("click", async (e)=>{
        const id = el.getAttribute("data-id");
        const addr = decodeURIComponent(el.getAttribute("data-addr")||"").trim();
        if(!addr){ e.preventDefault(); toast('Restaurant-Adresse fehlt'); return; }
        await safeSetStatusToUnterwegs(id);
      });
    }
    const doneBtn = el.querySelector('button[data-act="delivered"]');
    if(doneBtn){
      doneBtn.addEventListener("click", async (e)=>{
        e.stopPropagation();
        const id = el.getAttribute("data-id");
        await finalizeOrderWithFee(id);
      });
    }
  });
}


/* ===== Inbox (RTDB) ===== */
function detachInbox(){ unsubInbox?.(); unsubInbox=null; }
function attachInbox(){
  detachInbox();
  if(!uid) return;
  const inboxRef = ref(rtdb, `drivers_inbox/${uid}`);
  unsubInbox = onValue(inboxRef, (snap)=>{
    const v = snap.val()||{};
    const oid = v.lastOrderAssigned || null;
    if(oid){
      getDoc(doc(db,"orders", oid)).then(ds=>{
        if(!ds.exists()) return;
        const o=ds.data()||{};
        const s=String(o.status||'').toLowerCase();
        if(s==='abgebrochen' || s==='geliefert') return;
        showIncoming({id:oid, o});
      }).catch(()=>{});
    }
  });
}

/* ===== Incoming popup + تنبيه صوتي مُصحّح ===== */
function showIncoming({id,o}){
  inText.textContent = `${o.restaurant?.name||'—'} · ${Array.isArray(o.platform)?o.platform.join(' / '):(o.platform||'—')}`;
  incoming.classList.add("show");
  // 🔔 فعّل الصوت عند ظهور الـincoming
  startIncomingSound(id);
  inAccept.onclick = async (e)=>{ e.preventDefault(); await acceptAssigned(id); stopIncomingAlert(); closeIncoming(); };
  inReject.onclick = async (e)=>{ e.preventDefault(); await rejectAssigned(id); stopIncomingAlert(); closeIncoming(); };
}
function closeIncoming(){ incoming.classList.remove("show"); /* أوقف الصوت عند الإغلاق */ stopIncomingAlert(); }

/* === Audio Autoplay Unlock + Beep Scheduler (FIX) === */
let beepTimer=null;
let audioUnlocked=false;
function unlockAudioOnce(){
  if(audioUnlocked) return;
  audioUnlocked = true;
  try{
    if(newOrderSound){
      newOrderSound.muted = false;
      newOrderSound.volume = 1;
      // نبضة سريعة لفك القفل
      newOrderSound.play().then(()=>newOrderSound.pause()).catch(()=>{});
    }
  }catch(_){}
}
// فك القفل بعد أي تفاعل لمرة واحدة
['pointerdown','touchstart','keydown','focus'].forEach(evt=>{
  window.addEventListener(evt, unlockAudioOnce, { once:true, capture:true });
});

function startIncomingSound(scope=''){
  if(!newOrderSound) return;
  // لا نسمح بتعدد المؤقتات
  if(beepTimer){ clearInterval(beepTimer); beepTimer=null; }
  const play = ()=>{
    try{
      newOrderSound.muted = false; newOrderSound.volume = 1;
      newOrderSound.currentTime = 0;
      newOrderSound.play().catch(()=>{ /* قد يرفض قبل unlock؛ لا مشكلة */ });
    }catch(_){}
  };
  play();
  // إعادة التنبيه كل 30 ثانية إذا ما تفاعل السائق
  beepTimer = setInterval(play, 30000);
}
function stopIncomingAlert(){
  if(beepTimer){ clearInterval(beepTimer); beepTimer=null; }
  try{ newOrderSound?.pause(); }catch(_){}
}

/* ===== Start / Accept / Reject ===== */
async function safeSetStatusToUnterwegs(id){
  try{
    const snap=await getDoc(doc(db,"orders", id));
    const o=snap.exists()? (snap.data()||{}) : {};
    const s=String(o.status||'').toLowerCase();
    if(!(s==='angenommen' || s==='unterwegs')){ await patchOrder(id, { status:"Angenommen" }); }
    await patchOrder(id, { status:"Unterwegs" });
    toast("Unterwegs");
  }catch(_){ toast("Fehler beim Start"); }
}
async function acceptAssigned(id){ await patchOrder(id, { status:"Angenommen" }); toast("Angenommen"); }
async function rejectAssigned(id){ await patchOrder(id, { status:"Abgebrochen" }); toast("Abgebrochen"); }

/* ===== Detail sheet ===== */
// === Price helpers & refs ===
const md_price_value = document.getElementById('md_price_value');
const md_price_edit  = document.getElementById('md_price_edit');

const priceModal   = document.getElementById('priceModal');
const price_close  = document.getElementById('price_close');
const price_cancel = document.getElementById('price_cancel');
const price_save   = document.getElementById('price_save');
const price_input  = document.getElementById('price_input');

let priceEditOrderId = null;
let priceBusy = false;

function formatEUR(val){
  const n = Number(val||0);
  try{ return new Intl.NumberFormat('de-DE',{style:'currency',currency:'EUR'}).format(n); }
  catch{ return n.toFixed(2)+' €'; }
}
function parseEUR(raw){
  if(!raw) return null;
  const cleaned = String(raw).replace(/[^\d,.\-]/g,'').trim().replace(',', '.');
  const num = Number(cleaned);
  if(!isFinite(num) || num < 0) return null;
  if(num > 500) return null;
  return Math.round(num * 100) / 100;
}
function canEditPrice(o){
  const assigned = (o?.driver?.id === uid);
  const s = String(o?.status||'').toLowerCase();
  const allowed = (s==='bearbeitung' || s==='unterwegs' || s==='angenommen' || s==='assigned' || s==='zugewiesen');
  return assigned && allowed;
}
function openPriceModal(prefillEUR){
  price_input.value = (typeof prefillEUR === 'number' ? prefillEUR.toFixed(2).replace('.', ',') : '');
  priceModal.classList.add('show');
  setTimeout(()=>{ price_input?.focus(); price_input?.select(); }, 0);
}
function closePriceModal(){ priceModal.classList.remove('show'); }
price_close?.addEventListener('click', closePriceModal);
price_cancel?.addEventListener('click', closePriceModal);
priceModal?.addEventListener('click', (e)=>{ if(e.target===priceModal) closePriceModal(); });

async function savePriceEUR(orderId, newPriceEUR){
  if(priceBusy) return;
  priceBusy = true; price_save.disabled = true;
  try{
    const refDoc = doc(db, 'orders', orderId);
    await runTransaction(db, async (tx) => {
      const snap = await tx.get(refDoc);
      if(!snap.exists()) throw new Error('Order not found');
      const data = snap.data() || {};
      if(!canEditPrice(data)) throw new Error('Status/Berechtigung');

      const prevEUR  = Number(data.price||0) || 0;
      const prevCent = Number.isFinite(data.price_cents)? data.price_cents : Math.round(prevEUR*100);

      tx.update(refDoc, {
        price: newPriceEUR,
        price_cents: Math.round(newPriceEUR*100),
        price_prev_cents: prevCent,
        price_change_count: increment(1),
        price_updated_by: 'driver',
        price_updated_at: serverTimestamp(),
        updatedAt: serverTimestamp(),
      });
    });
    md_price_value.textContent = formatEUR(newPriceEUR);
    toast('✔ Preis gespeichert');
    closePriceModal();
  }catch(e){
    const msg = String(e?.message||e);
    if(msg.includes('Status/Berechtigung')) toast('Status erlaubt keine Änderung / Keine Berechtigung');
    else toast('Fehler beim Speichern');
  }finally{
    priceBusy = false; price_save.disabled = false;
  }
}

// ربط زر الحفظ مرة واحدة
price_save?.addEventListener('click', async ()=>{
  const eur = parseEUR(price_input.value);
  if(eur===null){ toast('Ungültiger Betrag (0–500 €)'); return; }
  if(!priceEditOrderId){ toast('Kein Auftrag'); return; }
  await savePriceEUR(priceEditOrderId, eur);
});

async function openDetail(id){
  const snap=await getDoc(doc(db,"orders", id)); if(!snap.exists()) return;
  const o=snap.data()||{};
  md_id.textContent=id;
  md_status.textContent=mapStatusLabel(o.status||"—");
  md_platform.textContent=Array.isArray(o.platform)?o.platform.join(" / "):(o.platform||"—");
  md_rest.textContent=o.restaurant?.name||"—";
  const addr=(o.restaurant?.addressText || o.restaurant?.address_text || "").trim();
  md_addr.textContent=addr || '—';
  md_qty.textContent=Number(o.qty||0)||0;
  md_pickup.textContent=o.pickupTime || "—";
  md_title.textContent=o.restaurant?.name||"Auftrag";
  const priceEUR = Number(o.price||0) || 0;
md_price_value.textContent = formatEUR(priceEUR);
md_price_edit.disabled = !canEditPrice(o);
md_price_edit.title = md_price_edit.disabled ? 'Keine Berechtigung / الحالة لا تسمح' : 'Preis bearbeiten';
priceEditOrderId = id;
md_price_edit.onclick = (e)=>{
  e.preventDefault();
  if(md_price_edit.disabled) return;
  openPriceModal(priceEUR);
};

  md.classList.add("show");
  md_start.onclick=async (e)=>{
    e.preventDefault();
    if(!addr){ toast('Restaurant-Adresse fehlt'); return; }
    window.open(makeNavUrl(addr), '_blank', 'noopener,noreferrer');
    await safeSetStatusToUnterwegs(id);
  };
  md_done.onclick = async (e)=>{
    e.preventDefault();
    await finalizeOrderWithFee(id);
    md.classList.remove("show");
  };
  md_nav.onclick  = (e)=>{
    e.preventDefault();
    if(!addr){ toast('Restaurant-Adresse fehlt'); return; }
    window.open(makeNavUrl(addr), '_blank', 'noopener,noreferrer');
  };
}
mdClose.addEventListener("click", ()=> md.classList.remove("show"));
md.addEventListener("click",(e)=>{ if(e.target===md) md.classList.remove("show"); });

/* ===== Patch order helper ===== */
async function patchOrder(id, fields){
  const allowed = {};
  if ('status'        in fields) allowed.status        = fields.status;
  if ('price'         in fields) allowed.price         = Number(fields.price);
  if ('deliveryFee'   in fields) allowed.deliveryFee   = Number(fields.deliveryFee);   // للـ backward-compat
  if ('distanceFee'   in fields) allowed.distanceFee   = Number(fields.distanceFee);   // اختياري
  if ('serviceFee'    in fields) allowed.serviceFee    = Number(fields.serviceFee);    // 👈 المرجع لعرض البطاقة
  if ('distance_km'   in fields) allowed.distance_km   = Number(fields.distance_km);   // اختياري
  if ('distance_km_total'    in fields) allowed.distance_km_total    = Number(fields.distance_km_total);
  if ('distance_km_billable' in fields) allowed.distance_km_billable = Number(fields.distance_km_billable);
  if ('etmTargetMs'   in fields) allowed.etmTargetMs   = fields.etmTargetMs;
  if ('ETM_Target'    in fields) allowed.ETM_Target    = fields.ETM_Target;

  allowed.updatedAt = serverTimestamp();

  const refDoc = doc(db, "orders", id);
  try { await updateDoc(refDoc, allowed); }
  catch { await setDoc(refDoc, allowed, { merge:true }); }
}


/* كتابة الرسوم مع Fallback ليتوافق مع القواعد الحالية (للطلب المفرد) */
/* كتابة الرسوم مع Fallback (للطلب المفرد) */
async function writeFeeOnly(id, fee){
  // fee هنا هو المجموع النهائي (serviceFee)
  await patchOrder(id, { 
    status: "Geliefert",
    serviceFee: Number(fee),        // 👈 المرجع لعرض البطاقة
    deliveryFee: Number(fee)        // للتوافق مع أي واجهة قديمة تقرأ من deliveryFee
  });
  return { field: 'serviceFee', fee };
}


/* === Recalculate order fees (Multi-Orders: 14% + distance from stops) === */
async function recalcOrderFees(orderId) {
  try {
    const oref = doc(db, "orders", orderId);
    const osnap = await getDoc(oref);
    if (!osnap.exists()) return;
    const odata = osnap.data() || {};

    const sref = collection(db, "orders", orderId, "stops");
    const snap = await getDocs(sref);
    if (snap.empty) return;

    const toMillis = t => (t?.toMillis?.() ?? (typeof t?._seconds === "number" ? t._seconds * 1000 : 0));
    const delivered = snap.docs
      .map(d => ({ id: d.id, s: d.data() || {} }))
      .filter(x => String(x.s.status || '').trim().toLowerCase() === 'geliefert')
      .sort((a, b) => toMillis(a.s.deliveredAt) - toMillis(b.s.deliveredAt));

    const n = delivered.length;
    if (n === 0) return;

    const asLL = x => (x && Number.isFinite(+x.lat) && Number.isFinite(+x.lng))
      ? { lat:+Number(x.lat).toFixed(6), lng:+Number(x.lng).toFixed(6) } : null;

    async function segmentKm(origin, destLL) {
      if (!destLL) return 0;
      if (typeof origin === 'object' && origin.lat !== undefined && origin.lng !== undefined) {
        const approx = haversineKm(origin, destLL);
        if (approx <= 0.05) return 0;
        try { return await routeKm(origin, destLL); } catch { return approx; }
      } else {
        try { return await routeKm(origin, destLL); } catch { return 0; }
      }
    }

    const firstLL = asLL(delivered[0].s.delivered_ll);
    const restaurantAddr = getRestaurantAddr(odata);
    let totalKm = 0;
    if (restaurantAddr && firstLL) {
      totalKm += await segmentKm(restaurantAddr, firstLL);
    }

    for (let i = 1; i < n; i++) {
      const prevLL = asLL(delivered[i - 1].s.delivered_ll);
      const currLL = asLL(delivered[i].s.delivered_ll);
      if (prevLL && currLL) {
        totalKm += await segmentKm(prevLL, currLL);
      }
    }

    totalKm = Math.max(0, Number(totalKm || 0));
    const totalKmRounded = Math.round(totalKm * 100) / 100;

    let sum14 = 0;
    let itemsTotal = 0;
    delivered.forEach(({ s }) => {
      const s14 = Number.isFinite(+s.deliveryFee) ? +s.deliveryFee
                  : Math.round((Number(s.price || 0) * 0.14) * 100) / 100;
      sum14 += s14;
      itemsTotal += Number(s.price || 0);
    });
    sum14 = Math.round(sum14 * 100) / 100;

    const billableKm = Math.max(0, totalKmRounded - 2);
    const billableKmRounded = Math.round(billableKm * 100) / 100;

    const distanceFee = distanceCostFromTotalKm(totalKmRounded);
    const deliveryFee = sum14;
    const serviceFee = Math.round((distanceFee + deliveryFee) * 100) / 100;

    await updateDoc(oref, {
      distance_km_total:    totalKmRounded,
      distance_km_billable: billableKmRounded,
      distanceFee:          distanceFee,
      deliveryFee:          deliveryFee,
      serviceFee:           serviceFee,
      items_total_eur:      Math.round(itemsTotal * 100) / 100,
      stops_delivered:      n,
      stops_total:          snap.size,
      updatedAt:            serverTimestamp()
    });
  } catch (e) {
    console.error('recalcOrderFees error', e);
    toast('Fehler beim Neuberechnen der Gebühren');
  }
}






/* العملية الكاملة عند التسليم: route → km → Betrag → Fee → تحديث (للطلب المفرد) */
async function finalizeSingleDelivery(orderId) {
  try {
    const oref = doc(db, "orders", orderId);
    const osnap = await getDoc(oref);
    if (!osnap.exists()) return;
    const odata = osnap.data() || {};

    const restaurant = getRestaurantAddr(odata);
    if (!restaurant) {
      toast("Restaurant-Adresse fehlt");
      return;
    }

    const gps = lastLL || await getCurrentLLOnce();
    if (!gps || !Number.isFinite(gps.lat) || !Number.isFinite(gps.lng)) {
      toast("Standort fehlt");
      return;
    }

    const destination = {
      lat: +gps.lat.toFixed(6),
      lng: +gps.lng.toFixed(6)
    };

    // المسافة بين المطعم والموقع الحالي
    let km = 0;
    try {
      km = await routeKm(restaurant, destination);
    } catch (_) {
      km = haversineKm(restaurant, destination);
    }
    km = Math.max(0, Number(km || 0));
    const kmRounded = Math.round(km * 100) / 100;

    const billableKm = Math.max(0, km - 2);
    const billableKmRounded = Math.round(billableKm * 100) / 100;

    const amountEUR = (Number.isFinite(+odata.items_total_eur) && +odata.items_total_eur > 0)
  ? +odata.items_total_eur
  : getOrderAmount(odata);
const deliveryFee = amountEUR < 25 ? 3.5 : Math.round(amountEUR * 0.14 * 100) / 100;


    const distanceFee = distanceCostFromTotalKm(kmRounded);
    const serviceFee = Math.round((distanceFee + deliveryFee) * 100) / 100;

    await updateDoc(oref, {
      delivered_ll: destination,
      distance_km_total: kmRounded,
      distance_km_billable: billableKmRounded,
      distanceFee: distanceFee,
      deliveryFee: deliveryFee,
      serviceFee: serviceFee,
      updatedAt: serverTimestamp(),
      status: "Geliefert"
    });

    toast(`Geliefert · ${kmRounded} km · Gebühr: ${serviceFee}€`);
  } catch (e) {
    console.error("finalizeSingleDelivery error", e);
    toast("Fehler bei der Einzellieferung");
  }
}

// تفعيل زر "Geliefert" للطلب المنفرد فقط، مع إيقاف أي مستمعات قديمة
document.addEventListener("click", async function onSingleDeliverClick(e) {
  // نلتقط زر الطلب المنفرد فقط: عنده data-act="delivered" وليس data-stop
  const btn = e.target.closest("button.btn-done[data-act='delivered']");
  if (!btn) return; // ليس زر الطلب المنفرد

  // امنع أي مستمعات أقدم من التشغيل (هذا أهم شيء)
  e.preventDefault();
  e.stopPropagation();
  if (typeof e.stopImmediatePropagation === "function") e.stopImmediatePropagation();

  // نجيب معرّف الطلب من البطاقة
  const card = btn.closest(".card-order");
  const orderId = card?.dataset?.id;
  if (!orderId) { console.warn("No orderId on card-order"); return; }

  // تأكد أن الدالة موجودة
  if (typeof finalizeSingleDelivery !== "function") {
    console.error("finalizeSingleDelivery fehlt");
    toast("Aktion nicht verfügbar");
    return;
  }

  try {
    await finalizeSingleDelivery(orderId);
  } catch (err) {
    console.error("finalizeSingleDelivery error:", err);
    toast("Fehler bei der Einzellieferung");
  }
}, true); // ← مهم: الالتقاط (capturing) لقطع الطريق قبل المستمعات القديمة




/* ===== Auth gate ===== */
onAuthStateChanged(auth, async (user)=>{
  // امنع الدخول التلقائي إلا أثناء التسجيل (regInFlight)
  if (user && sessionStorage.getItem(SESSION_OK) !== '1' && !regInFlight) {
    await signOut(auth).catch(()=>{});
    authModal.style.display='flex'; appRoot.style.display='none';
    return;
  }
  if(!user){
    // نوقف الحضور باستخدام uid القديم
    stopPresence();
    uid = null;                      // ← انقله هنا (بعد stopPresence)
    appRoot.style.display='none'; authModal.style.display='flex';
    detachOrders(); stopIncomingAlert(); stopMedianBG();
    switchPane(lastAuthTab==='register' ? 'register' : 'login');
    return;
  }
  uid = user.uid;

  // تحقق الموافقة
  approved=false;
  try{
    const ds=await getDoc(doc(db,'users',uid));
    if(ds.exists()){
      const u=ds.data()||{};
      approved=(u.approved===true && u.role==='driver');
    }
  }catch(_){}

  authModal.style.display='none'; appRoot.style.display='block';
  attachOrders();
});

/* ===== Network dot ===== */
function setNet(on){ netDot.classList.toggle("on", on); netDot.classList.toggle("off", !on); }
setNet(navigator.onLine);
window.addEventListener("online", ()=>setNet(true));
window.addEventListener("offline", ()=>setNet(false));

/* ===== Init ===== */
document.addEventListener('DOMContentLoaded', async ()=>{
  authModal.style.display='flex';
  online = false;
window.online = online;
onlineToggle?.classList.remove('on');
neoPower?.classList.remove('on'); neoPower?.classList.add('off');
statText.textContent = 'Offline';

  switchPane(lastAuthTab==='register' ? 'register' : 'login');
  await loadInviteIfAny(); // ← مهم
});


</script>
<script>
/* Wiring without altering logic */
(() => {
  const $ = s => document.querySelector(s);

  // أعلى: مال/طاقة/إعدادات
$("#neoPower")?.addEventListener("click", () => $("#onlineToggle")?.click());  // كما هي



// الزر الأيسر ⇦ يسجل خروج
$("#neoMoney")?.addEventListener("click", (e)=>{ e.preventDefault(); window.__driverLogout?.(); });

  

  $("#neoOK")?.addEventListener("click", async () => {
    const id = (document.getElementById("md_id")?.textContent||"").trim();
    if (!id) return;
    // نستخدم دالتك الحالية لتسليم الطلب المنفرد
    if (typeof window.finalizeSingleDelivery === "function") {
      await window.finalizeSingleDelivery(id);
    } else if (typeof window.patchOrder === "function") {
      // Fallback: علّم الحالة “Geliefert” (لا يمس الحسابات)
      await window.patchOrder(id, { status:"Geliefert" });
    }
  });

  $("#neoPin")?.addEventListener("click", () => {
    // افتح الملاحة لعنوان المطعم من النافذة المفتوحة (كما تفعل أزرارك)
    const addr = (document.getElementById("md_addr")?.textContent||"").trim();
    if (!addr || addr === "—") return;
    try {
      const a = document.createElement("a");
      a.href = (window.makeNavUrl ? window.makeNavUrl(addr) 
                                  : "https://www.google.com/maps/dir/?api=1&destination="+encodeURIComponent(addr));
      a.target = "_blank"; a.rel="noopener noreferrer";
      a.click();
    } catch(_) {}
  });

  // حوّل زر الملاحة في البطاقة إلى أيقونة فقط
  document.querySelectorAll(".btn-go").forEach(a => { a.setAttribute("aria-label","Navigation"); a.textContent=""; });

  // مثال بسيط: عتّم بطاقة معيّنة لو حالتها "Neu" (اختياري تمامًا)
  // document.querySelector('.card-order[data-status="Neu"]')?.classList.add('is-dim');
})();
</script>


</body>
</html>
