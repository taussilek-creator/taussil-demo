<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<meta name="theme-color" content="#0b1320">
<title>Taussil â€“ Fahrer (PROD v7)</title>
<link rel="icon" href="icons/taussil-192.png">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0b1320; --card:#111a2b; --ink:#e6e9ef; --muted:#9aa4b2; --cta:#33BBDF;
  --ok:#22c55e; --warn:#f59e0b; --err:#ef4444; --border:1px solid rgba(255,255,255,.08);
  --radius:16px; --shadow:0 12px 40px rgba(0,0,0,.35); --hit:52px;
}
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
.app{max-width:560px;margin:0 auto;padding:12px 14px 24px;display:flex;flex-direction:column;gap:12px}

/* Header */
.header{position:sticky;top:0;z-index:5;background:linear-gradient(180deg,rgba(11,19,32,1),rgba(11,19,32,.75));backdrop-filter:blur(6px);
  border-bottom:1px solid rgba(255,255,255,.08); padding:10px 12px;border-radius:0 0 14px 14px;display:flex;align-items:center;justify-content:space-between;gap:8px}
.brand{display:flex;align-items:center;gap:10px;font-weight:800}
.badge-dot{width:10px;height:10px;border-radius:50%;background:#555;margin-left:6px}
.badge-dot.on{background:var(--ok)} .badge-dot.off{background:#555}
.menu-btn{height:36px;min-width:36px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:#0f1a30;color:var(--ink);display:flex;align-items:center;justify-content:center;cursor:pointer}
.menu{position:absolute;right:12px;top:58px;background:#0f1a30;border:1px solid rgba(255,255,255,.12);border-radius:12px;box-shadow:var(--shadow);display:none;flex-direction:column;min-width:220px;overflow:hidden}
.menu.show{display:flex}
.menu a{padding:10px 12px;color:var(--ink);text-decoration:none;border-top:1px solid rgba(255,255,255,.08)} .menu a:first-child{border-top:0}
.menu a:hover{background:#142036}

/* Online toggle */
.toggle{display:flex;align-items:center;gap:8px}
.tgl{position:relative;width:46px;height:26px;background:#2a3348;border-radius:999px;border:1px solid rgba(255,255,255,.12);cursor:pointer}
.tgl::after{content:"";position:absolute;top:3px;left:3px;width:20px;height:20px;border-radius:50%;background:#fff;transition:.18s}
.tgl.on{background:#0f3e23;border-color:#1f8a53}
.tgl.on::after{left:23px;background:#caffdc}
.stat{font-size:12px;color:var(--muted)}

/* Cards & inputs */
.card{background:var(--card);border:var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:12px}
.row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.input, .btn, select, a.btn{height:var(--hit);background:#0f1a30;color:var(--ink);border:1px solid rgba(255,255,255,.12);border-radius:14px;padding:0 14px;font-size:16px;width:100%;text-decoration:none}
.btn{display:flex;align-items:center;justify-content:center;cursor:pointer;font-weight:800}
.btn:disabled{opacity:.6;cursor:not-allowed}
.btn-cta{background:linear-gradient(180deg,#33BBDF,#1da9cf);border:none;color:#fff}
.btn-ghost{background:#13213a;border:1px solid rgba(255,255,255,.14);color:#e6e9ef}
.small{font-size:12px;color:var(--muted)}
.kv{display:flex;justify-content:space-between;gap:8px;padding:6px 0;border-top:1px solid rgba(255,255,255,.08)}
.kv:first-child{border-top:0}

/* Orders list */
.list{display:flex;flex-direction:column;gap:10px}
.card-order{display:grid;grid-template-columns:56px 1fr auto;gap:10px;align-items:center;border:1px solid rgba(255,255,255,.08);border-radius:14px;background:#0f1a30;padding:8px 10px;cursor:pointer}
.logo img{width:56px;height:56px;border-radius:12px;object-fit:cover;border:1px solid rgba(255,255,255,.08)}
.logo .ph{width:56px;height:56px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-weight:800;background:#1a2742;border:1px solid rgba(255,255,255,.08)}
.line{display:flex;align-items:center;gap:8px}
.tag{font-size:11px;padding:4px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.14);background:#0f1a30;color:#9aa4b2}
.btn-icon{width:48px;height:48px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:#122037;display:flex;align-items:center;justify-content:center;cursor:pointer}
.btn-go{background:linear-gradient(180deg,#4ade80,#22c55e);border:none;color:#06220f}
.btn-done{background:linear-gradient(180deg,#a7f3d0,#34d399);border:none;color:#06220f}
/* Multi-stops (inline, Ø®ÙÙŠÙ) */
.multi-stops{margin-top:8px;padding-top:8px;border-top:1px solid rgba(255,255,255,.08)}
.stop-row{display:grid;grid-template-columns:56px 1fr 48px;gap:10px;align-items:center;
  margin:6px 0;padding:8px 10px;border:1px solid rgba(255,255,255,.08);border-radius:14px;background:#0f1a30}
.stop-logo{width:56px;height:56px;border-radius:12px;background:#1a2742;display:flex;align-items:center;justify-content:center;font-weight:800}

/* Detail bottom sheet */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:flex-end;z-index:1000}
.modal.show{display:flex}
.sheet{background:#0f1a30;border-radius:16px 16px 0 0;width:100%;max-height:60vh;min-height:40vh;overflow:auto;border:1px solid rgba(255,255,255,.12);padding:12px;animation:rise .18s ease}
@keyframes rise{from{transform:translateY(20px);opacity:.8}to{transform:translateY(0);opacity:1}}
.sheet .hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
.sheet .title{font-weight:800}
.sheet .close{width:36px;height:36px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:#111a2b;color:#e6e9ef;display:flex;align-items:center;justify-content:center;cursor:pointer}

/* Incoming order popup */
.pop{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.5);z-index:50}
.pop.show{display:flex}
.pop .box{background:#0f1a30;border:1px solid rgba(255,255,255,.14);border-radius:16px;box-shadow:var(--shadow);padding:14px;max-width:520px;width:92%}
.pop .row{grid-template-columns:1fr 1fr}

/* toast */
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#0f1a30;border:1px solid rgba(255,255,255,.14);color:#e6e9ef;border-radius:12px;padding:10px 14px;opacity:0;transition:opacity .18s}
.toast.show{opacity:1}
.tab-btn.active{
  background:linear-gradient(180deg,#33BBDF,#1da9cf);
  border:none;
  color:#fff;
}

@media (max-width:460px){ .row{grid-template-columns:1fr} }
</style>
</head>
<body>

<!-- Auth Modal -->
<div id="authModal" style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.55)">
  <div style="width:min(560px,92%);background:#0f1a30;border:1px solid rgba(255,255,255,.14);border-radius:16px;padding:14px;box-shadow:0 12px 40px rgba(0,0,0,.35)">
    <div style="display:flex;gap:6px;margin-bottom:10px">
      <button id="tabLogin"    class="btn" style="flex:1">Anmelden</button>
      <button id="tabRegister" class="btn" style="flex:1;opacity:.8">Registrieren</button>
    </div>

    <!-- Login -->
    <form id="formLogin" onsubmit="return false">
      <div class="row" style="grid-template-columns:1fr 1fr">
        <input id="loginEmail" class="input" type="email" placeholder="E-Mail" autocomplete="username" required>
        <input id="loginPass"  class="input" type="password" placeholder="Passwort" autocomplete="current-password" required>
      </div>
      <button id="loginBtn" class="btn btn-cta" style="margin-top:8px">Anmelden</button>
      <div id="loginMsg" class="small" style="margin-top:6px;color:#fca5a5"></div>
    </form>

    <!-- Register -->
    <form id="formRegister" onsubmit="return false" style="display:none">
      <div class="row" style="grid-template-columns:1fr 1fr">
        <input id="regFirst" class="input" type="text" placeholder="Vorname (â‰¥ 2)" autocomplete="given-name" required>
        <input id="regLast"  class="input" type="text" placeholder="Nachname (â‰¥ 2)" autocomplete="family-name" required>
      </div>
      <div class="row" style="grid-template-columns:1fr 1fr">
        <input id="regPhone" class="input" type="tel" placeholder="Telefonnummer (+49 â€¦)" autocomplete="tel" inputmode="tel">
        <input id="regEmail" class="input" type="email" placeholder="E-Mail" autocomplete="email" required>
      </div>
      <div class="row" style="grid-template-columns:1fr 1fr">
        <input id="regPass"  class="input" type="password" placeholder="Passwort (6+)" autocomplete="new-password" required>
        <label style="display:flex;align-items:center;gap:8px;user-select:none">
          <input id="regTerms" type="checkbox" style="width:18px;height:18px" required>
          <span class="small">
            Ich akzeptiere
            <a href="agb.html" target="_blank" rel="noopener noreferrer" style="color:#33BBDF;text-decoration:none">AGB</a>
            &amp;
            <a href="datenschutz.html" target="_blank" rel="noopener noreferrer" style="color:#33BBDF;text-decoration:none">Datenschutz</a>
          </span>
        </label>
      </div>
      <button id="registerBtn" class="btn btn-cta" style="margin-top:8px">Registrieren</button>
      <div id="regMsg" class="small" style="margin-top:6px;color:#fca5a5"></div>
      <div class="small" style="margin-top:4px;opacity:.85">Nach der Registrierung wird dein Konto vom Admin geprÃ¼ft.</div>
    </form>
  </div>
</div>

<div id="appRoot" class="app" style="display:none">

  <!-- Header -->
  <div class="header">
    <div class="brand">Fahrer <span id="netDot" class="badge-dot off"></span></div>
    <div class="toggle">
      <div class="stat" id="statText">Offline</div>
      <div id="onlineToggle" class="tgl" title="Online/Offline"></div>
    </div>
    <div>
      <button id="menuBtn" class="menu-btn">â˜°</button>
      <div id="menu" class="menu">
        <a href="#" id="mNav">ğŸ—ºï¸ Navigation-App</a>
        <a href="#" id="mLogout">ğŸšª Abmelden</a>
      </div>
    </div>
  </div>

  <!-- Orders -->
  <section class="card">
  <div class="kv">
    <div class="small">AuftrÃ¤ge</div>
    <div class="small" id="ordersInfo">â€”</div>
  </div>

  <!-- Tabs -->
  <div class="row" id="tabsRow" style="grid-template-columns:repeat(3,1fr);margin-top:8px">
    <button class="btn btn-ghost tab-btn active" data-tab="Neu">Neu</button>
    <button class="btn btn-ghost tab-btn" data-tab="Geliefert">Geliefert</button>
    <button class="btn btn-ghost tab-btn" data-tab="Abgebrochen">Abgebrochen</button>
  </div>

  <div id="ordersList" class="list"></div>
</section>


</div>

<!-- Detail Bottom Sheet -->
<div id="orderModal" class="modal">
  <div class="sheet" role="dialog" aria-modal="true">
    <div class="hdr">
      <div class="title" id="md_title">Auftrag</div>
      <button class="close" id="md_close">âœ•</button>
    </div>
    <div class="kv"><div class="small">Auftrag-ID</div><div class="small" id="md_id">â€”</div></div>
    <div class="kv"><div class="small">Status</div><div class="small" id="md_status">â€”</div></div>
    <div class="kv"><div class="small">Plattform</div><div class="small" id="md_platform">â€”</div></div>
    <div class="kv"><div class="small">Restaurant</div><div class="small" id="md_rest">â€”</div></div>
    <div class="kv"><div class="small">Adresse</div><div class="small" id="md_addr">â€”</div></div>
    <div class="kv"><div class="small">Qty</div><div class="small" id="md_qty">â€”</div></div>
    <div class="kv"><div class="small">Abholzeit</div><div class="small" id="md_pickup">â€”</div></div>
    <div class="row" style="margin-top:8px">
	<!-- Preis row (editable) -->
<div class="kv">
  <div class="small">Preis</div>
  <div class="small" style="display:flex;align-items:center;gap:8px">
    <span id="md_price_value">â€”</span>
    <button id="md_price_edit"
            style="height:28px;min-width:28px;padding:0 8px;border:1px solid rgba(255,255,255,.14);
                   background:#13213a;color:#e6e9ef;border-radius:8px;cursor:pointer;font-size:12px">
      Bearbeiten
    </button>
  </div>
</div>

      <a id="md_nav" class="btn btn-cta" href="#" target="_blank" rel="noopener noreferrer">Navigation</a>
      <button id="md_start" class="btn btn-ghost">Start Fahrt</button>
      <button id="md_done"  class="btn btn-ghost">Geliefert</button>
    </div>
  </div>
</div>

<!-- Navigation preference modal -->
<div id="navModal" class="modal">
  <div class="sheet" role="dialog" aria-modal="true">
    <div class="hdr">
      <div class="title">Navigation-App</div>
      <button class="close" id="nav_close">âœ•</button>
    </div>
    <div class="row" style="grid-template-columns:1fr">
      <label class="small"><input type="radio" name="navpref" value="auto"> Auto (empfohlen)</label>
      <label class="small"><input type="radio" name="navpref" value="google"> Google Maps</label>
      <label class="small"><input type="radio" name="navpref" value="apple"> Apple Karten</label>
    </div>
    <button id="nav_save" class="btn btn-cta" style="margin-top:8px">Speichern</button>
  </div>
</div>
<!-- Price Edit Modal -->
<div id="priceModal" class="modal">
  <div class="sheet" role="dialog" aria-modal="true" style="max-width:560px;margin:0 auto">
    <div class="hdr">
      <div class="title">Preis anpassen</div>
      <button class="close" id="price_close">âœ•</button>
    </div>
    <div class="row" style="grid-template-columns:1fr">
      <input id="price_input" class="input" inputmode="decimal" placeholder="0,00 â‚¬" aria-label="Neuer Preis in Euro">
    </div>
    <div class="row" style="grid-template-columns:1fr 1fr;margin-top:8px">
      <button id="price_cancel" class="btn btn-ghost">Abbrechen</button>
      <button id="price_save"   class="btn btn-cta">Speichern</button>
    </div>
  </div>
</div>

<!-- Incoming order popup -->
<div id="incoming" class="pop">
  <div class="box">
    <div style="font-weight:800;margin-bottom:8px">Neuer Auftrag</div>
    <div id="in_text" class="small" style="margin-bottom:10px">â€”</div>
    <div class="row">
      <button id="in_accept" class="btn btn-cta">Akzeptieren</button>
      <button id="in_reject" class="btn btn-ghost">Abbrechen</button>
    </div>
  </div>
</div>

<!-- Sounds -->
<audio id="newOrderSound" src="neu1.mp3" preload="auto"></audio>

<div id="toast" class="toast">OK</div>

<script type="module">
/* ===== Firebase ===== */
import { initializeApp, getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
// Ø£Ø¶Ù getDocs Ù‡Ù†Ø§:
import {
  getFirestore, collection, query, where, limit, onSnapshot, doc,
  setDoc, updateDoc, getDoc, getDocs, Timestamp, serverTimestamp,
  runTransaction, increment
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

import {
  getDatabase, ref, onDisconnect, update as rUpdate, onValue, serverTimestamp as rServerTs
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
import {
  getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword,
  signOut, setPersistence, browserSessionPersistence
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyD0g9T3amjuPodsLS6ZQkHYWrzV1UrX_QI",
  authDomain: "taussil-lieferservice-8bbe9.firebaseapp.com",
  projectId: "taussil-lieferservice-8bbe9",
  storageBucket: "taussil-lieferservice-8bbe9.firebasestorage.app",
  messagingSenderId: "583536892937",
  appId: "1:583536892937:web:5d5ff133de4d8b3b28ecd8",
  databaseURL: "https://taussil-lieferservice-8bbe9-default-rtdb.europe-west1.firebasedatabase.app"
};
let app; try{ app=getApp(); }catch{ app=initializeApp(firebaseConfig); }
const db = getFirestore(app);
const rtdb = getDatabase(app);
const auth = getAuth(app);
await setPersistence(auth, browserSessionPersistence).catch(()=>{});

/* ===== Address + Distance + Pricing Helpers ===== */

/* Ù…ÙØªØ§Ø­ Ø®Ø±Ø§Ø¦Ø· Ø¬ÙˆØ¬Ù„ (Ø§Ø³ØªØ®Ø¯Ù…Øª Ù†ÙØ³ Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ Ø¨ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø·Ø¹Ù…) */
const GMAPS_API_KEY = 'AIzaSyDipzUmxEQmAjaDkn6xQ91ZhqnkPmgl-2o';
async function ensureGmaps(){
  if (window.google?.maps) return true;
  await new Promise((resolve, reject)=>{
    const cb='gm_cb_'+Math.random().toString(36).slice(2);
    window[cb]=()=>{ delete window[cb]; resolve(true); };
    const s=document.createElement('script');
    s.src=`https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(GMAPS_API_KEY)}&v=weekly&callback=${cb}`;
    s.async=true; s.defer=true; s.onerror=()=>{ delete window[cb]; reject(new Error('gmaps-load-failed')); };
    document.head.appendChild(s);
  });
  return true;
}
async function routeKm(origin, destination){
  await ensureGmaps();
  return new Promise((resolve, reject)=>{
    const ds = new google.maps.DirectionsService();
    ds.route({ origin, destination, travelMode: google.maps.TravelMode.DRIVING }, (res, status)=>{
      const leg = res?.routes?.[0]?.legs?.[0];
      if (status==='OK' && leg?.distance?.value!=null) {
        resolve(leg.distance.value / 1000);
      } else {
        reject(new Error(status || 'no-route'));
      }
    });
  });
}
function haversineKm(a,b){
  if(!a||!b||!isFinite(a.lat)||!isFinite(a.lng)||!isFinite(b.lat)||!isFinite(b.lng)) return 0;
  const R=6371, toRad=x=>x*Math.PI/180;
  const dLat=toRad(b.lat-a.lat), dLng=toRad(b.lng-a.lng);
  const s=Math.sin(dLat/2)**2 + Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*Math.sin(dLng/2)**2;
  return 2*R*Math.asin(Math.sqrt(s));
}
function getRestaurantAddr(o){
  return (o?.restaurant?.addressText || o?.restaurant?.address_text || '').trim() || null;
}
function getDropAddr(o){
  const cand = [
    o?.dropoff?.addressText, o?.dropoff?.address_text,
    o?.customer?.addressText, o?.customer?.address_text,
    o?.destination?.addressText, o?.destination?.address_text,
    o?.deliveryAddress, o?.delivery_address,
    o?.addr, o?.address
  ];
  for (const v of cand){ if (v && String(v).trim()) return String(v).trim(); }
  return null;
}
async function getCurrentLLOnce(){
  return new Promise(res=>{
    if(navigator.geolocation){
      navigator.geolocation.getCurrentPosition(
        p=>res({lat:p.coords.latitude, lng:p.coords.longitude}),
        _=>res(null), {enableHighAccuracy:true, maximumAge:1000, timeout:7000}
      );
    } else { res(null); }
  });
}

/* Ø³Ù„Ø³Ù„Ø© Ø§Ù„ØªØ³Ù„ÙŠÙ…Ø§Øª (multi-drop): Ù†Ø®Ø²Ù† Ø¢Ø®Ø± Ù†Ù‚Ø·Ø© ØªØ³Ù„ÙŠÙ… */
const LS_CHAIN_LAST_DEST = 'driver:chain:lastDest';
function getLastDest(){
  try{ const s=localStorage.getItem(LS_CHAIN_LAST_DEST); return s? JSON.parse(s) : null; }catch(_){ return null; }
}
function setLastDestFromText(addr){ try{ localStorage.setItem(LS_CHAIN_LAST_DEST, JSON.stringify({addrText: String(addr||'').trim()})); }catch(_){ } }
function setLastDestFromLL(ll){ try{ if(ll&&isFinite(ll.lat)&&isFinite(ll.lng)) localStorage.setItem(LS_CHAIN_LAST_DEST, JSON.stringify({lat: ll.lat, lng: ll.lng})); }catch(_){ } }

/* Ø£ØµÙ„ Ø§Ù„Ø±Ø­Ù„Ø©: Ø¢Ø®Ø± ØªØ³Ù„ÙŠÙ… ÙˆØ¥Ù„Ø§ Ø§Ù„Ù…Ø·Ø¹Ù… */
function computeLegOrigin(o){
  const last = getLastDest();
  if(last?.addrText) return last.addrText;
  if(last && isFinite(last.lat) && isFinite(last.lng)) return {lat: last.lat, lng: last.lng};
  return getRestaurantAddr(o);
}

/* ÙƒÙ… Ø­Ù‚ÙŠÙ‚ÙŠ Ù„Ù„Ø±Ø­Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© */
async function computeLegKmForOrder(o){
  const origin = computeLegOrigin(o);
  let destination = getDropAddr(o);
  if(!destination){
    // Ø¥Ù† Ù„Ù… ÙŠÙƒÙ† Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªØ³Ù„ÙŠÙ… Ù…Ø­ÙÙˆØ¸Ù‹Ø§ ÙÙŠ Ø§Ù„ÙˆØ«ÙŠÙ‚Ø©ØŒ Ù†Ø³ØªØ®Ø¯Ù… Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙƒÙˆØ¬Ù‡Ø©
    const ll = lastLL || await getCurrentLLOnce();
    if(ll) destination = {lat: ll.lat, lng: ll.lng};
  }
  if(!origin || !destination) return 0;
  try{
    return await routeKm(origin, destination);
  }catch(_){
    if(typeof origin==='object' && 'lat' in origin && typeof destination==='object' && 'lat' in destination){
      return haversineKm(origin, destination);
    }
    return 0;
  }
}

/* Ù…Ø¨Ù„Øº Ø§Ù„Ø·Ù„Ø¨ (Betrag) */
function getOrderAmount(o){
  // ÙÙŠ Ù†Ø¸Ø§Ù…ÙƒØŒ Ø§Ù„Ù…Ø·Ø¹Ù… ÙŠØ±Ø³Ù„ price ÙƒÙ…Ø¨Ù„Øº Ø§Ù„Ø·Ù„Ø¨ Ùˆ deliveryFee ÙƒØ¨Ø¯Ø§ÙŠØ© 0
  const cands = [o.price, o.amount, o.total, o.orderTotal, o.sum];
  for (const v of cands){
    const n = Number(v);
    if (Number.isFinite(n)) return n;
  }
  return 0;
}

/* Ù…Ø¹Ø§Ø¯Ù„Ø© LiefergebÃ¼hr Ø§Ù„ØªÙŠ Ø£Ø±Ø³Ù„ØªÙ‡Ø§ (Ù…Ù‚Ø±Ø¨Ø© Ù„Ù„Ø³Ù†Øª) */
function calcDeliveryFeeEUR(betrag, km){
  const price = Math.max(0, Number(betrag || 0));
  const d     = Math.max(0, Number(km || 0));

  // Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø«Ø§Ø¨Øª Ø­Ø³Ø¨ Ø§Ù„Ø³Ø¹Ø±
  const base = (price <= 25) ? 3.50 : (price * 0.14);

  // Ø´Ø±Ø§Ø¦Ø­ Ø§Ù„Ù…Ø³Ø§ÙØ© (Ø­Ø§Ø³Ø¨Ø© Ù‡Ø§Ù…Ø´ÙŠØ©)
  // >2â€“7 ÙƒÙ…: 0.50 â‚¬/ÙƒÙ… (Ø­ØªÙ‰ 5 ÙƒÙ… Ù…Ù† Ù‡Ø°Ù‡ Ø§Ù„Ø´Ø±ÙŠØ­Ø©)
  const segA = Math.min(Math.max(d - 2, 0), 5) * 0.50;
  // >7â€“12 ÙƒÙ…: 0.80 â‚¬/ÙƒÙ… (Ø­ØªÙ‰ 5 ÙƒÙ… Ù…Ù† Ù‡Ø°Ù‡ Ø§Ù„Ø´Ø±ÙŠØ­Ø©)
  const segB = Math.min(Math.max(d - 7, 0), 5) * 0.80;
  // >12 ÙƒÙ…: 1.00 â‚¬/ÙƒÙ… (Ø¨Ù„Ø§ Ø­Ø¯ Ø£Ø¹Ù„Ù‰)
  const segC = Math.max(d - 12, 0) * 1.00;

  const fee = base + segA + segB + segC;
  return Math.round(fee * 100) / 100; // ØªÙ‚Ø±ÙŠØ¨ Ø¥Ù„Ù‰ Ø³Ù†ØªÙŠÙ†
}
/* === PRICING v2.1 (Multi-Orders progressive tiers; no waiting) === */
/* ØªØ®Ø²ÙŠÙ† Ø­Ø§Ù„Ø© Ø§Ù„ØªØ³Ø¹ÙŠØ± Ø¹Ø¨Ø± Ø§Ù„Ø£Ø±Ø¬Ù„ ÙÙŠ localStorage */
const LS_ROUTE_PRICE = 'driver:chain:pricing';
const round2 = n => Math.round((Number(n||0) + Number.EPSILON) * 100) / 100;

function loadRouteState(){
  try{
    const s = JSON.parse(localStorage.getItem(LS_ROUTE_PRICE) || '{}');
    const freeLeft = Number.isFinite(+s.freeLeft)? +s.freeLeft : 2;  // 2 ÙƒÙ… Ù…Ø¬Ø§Ù†Ø§Ù‹ Ù…Ø±Ø© Ù„ÙƒÙ„ Ø±Ø­Ù„Ø©
    const progKm   = Number.isFinite(+s.progKm)?   +s.progKm   : 0;  // ÙƒÙ… ÙÙˆØªØ±Ø© Ù…ÙØ³ØªÙ‡Ù„ÙƒØ© Ù„Ù„Ø´Ø±Ø§Ø¦Ø­
    return { freeLeft, progKm };
  }catch(_){ return { freeLeft:2, progKm:0 }; }
}
function saveRouteState(st){
  try{ localStorage.setItem(LS_ROUTE_PRICE, JSON.stringify({ freeLeft: +st.freeLeft, progKm: +st.progKm })); }catch(_){}
}
function resetRouteState(){ saveRouteState({ freeLeft:2, progKm:0 }); }

/* ØªØ³Ø¹ÙŠØ± Ø±Ø¬Ù„ ÙˆØ§Ø­Ø¯Ø© Ø¨Ø´ÙƒÙ„ ØªØ±Ø§ÙƒÙ…ÙŠ Ø¹Ø¨Ø± Ø§Ù„Ø±Ø­Ù„Ø© */
function priceDistanceProgressive(legKm, resetFirstLeg=false){
  if(resetFirstLeg) resetRouteState();
  const st = loadRouteState();

  const km = Math.max(0, +legKm || 0);

  // Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù…Ù† Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø¬Ù„
  const freeUse = Math.min(st.freeLeft, km);
  let billable  = Math.max(0, km - st.freeLeft);
  st.freeLeft   = Math.max(0, st.freeLeft - km);

  // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø´Ø±Ø§Ø¦Ø­ ØªØ±Ø§ÙƒÙ…ÙŠÙ‹Ø§ Ø­Ø³Ø¨ progKm
  let val = 0;

  // Ø´Ø±ÙŠØ­Ø©1: Ø­ØªÙ‰ +5 ÙƒÙ… ÙÙˆØªØ±Ø© Ù…Ù† Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø±Ø­Ù„Ø©
  const tier1Left = Math.max(0, 5 - Math.min(st.progKm, 5));
  const take1 = Math.min(billable, tier1Left);
  val += take1 * 0.50; billable -= take1; st.progKm += take1;

  // Ø´Ø±ÙŠØ­Ø©2: Ø­ØªÙ‰ +10 ÙƒÙ… ÙÙˆØªØ±Ø© (5 Ø¥Ø¶Ø§ÙÙŠØ©)
  if(billable > 0){
    const tier2Cap  = 10;
    const tier2Left = Math.max(0, tier2Cap - Math.min(st.progKm, tier2Cap));
    const take2 = Math.min(billable, tier2Left);
    val += take2 * 0.80; billable -= take2; st.progKm += take2;
  }

  // Ø´Ø±ÙŠØ­Ø©3: Ù…Ø§ Ø¨Ø¹Ø¯ Ø°Ù„Ùƒ
  if(billable > 0){
    val += billable * 1.00; st.progKm += billable;
  }

  saveRouteState(st);
  return round2(val);
}

/* Ù‡Ù„ Ù‡Ø°Ù‡ Ø¨Ø¯Ø§ÙŠØ© Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©ØŸ (Ø£ÙˆÙ„ Ø±Ø¬Ù„: Ø§Ù„Ù…Ø·Ø¹Ù… â†’ Ø¹Ù…ÙŠÙ„1) */
function isRouteFirstLeg(orderObj){
  const origin = computeLegOrigin(orderObj);     // Ù…Ù† Ù…Ù„ÙÙƒ (ÙŠØ¹ØªÙ…Ø¯ Ø¢Ø®Ø± ØªØ³Ù„ÙŠÙ… Ø£Ùˆ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø·Ø¹Ù…)
  const rest   = getRestaurantAddr(orderObj);    // Ù…Ù† Ù…Ù„ÙÙƒ
  if(!origin) return true;
  // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ù…Ù† Ø§Ù„Ù…Ø·Ø¹Ù… (Ù†ØµÙ‘Ø§Ù‹) Ù†Ø¹ØªØ¨Ø±Ù‡Ø§ Ø£ÙˆÙ„ Ø±Ø¬Ù„ ÙˆÙ†ØµÙÙ‘Ø± Ø§Ù„Ø­Ø§Ù„Ø©
  if(typeof origin === 'string' && typeof rest === 'string'){
    return origin.trim() === rest.trim();
  }
  return false;
}

/* Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø·Ù„Ø¨ ÙƒÙ…Ø§ Ù‡ÙŠ (â‰¤25 = 3.50â‚¬ØŒ ØºÙŠØ± Ø°Ù„Ùƒ 14%) */
function calcBaseV21(amount){
  amount = Math.max(0, +amount || 0);
  return amount <= 25 ? 3.50 : (amount * 0.14);
}

/* Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ù„Ø·Ù„Ø¨ ÙˆØ§Ø­Ø¯:
   - Ù…ÙØ±Ø¯ (Ù„Ø§ Ø³Ù„Ø³Ù„Ø©): Ù†Ø³ØªØ®Ø¯Ù… Ù…Ø¹Ø§Ø¯Ù„ØªÙƒ Ø§Ù„Ø­Ø§Ù„ÙŠØ© calcDeliveryFeeEUR (ØªØ­Ø³Ø¨ 2 ÙƒÙ… Ø¹Ù„Ù‰ Ù†ÙØ³ Ø§Ù„Ø·Ù„Ø¨)
   - Ø¯Ø§Ø®Ù„ Ø³Ù„Ø³Ù„Ø© Multi: 2 ÙƒÙ… Ù…Ø¬Ø§Ù†Ø§Ù‹ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© + Ø§Ù„Ø´Ø±Ø§Ø¦Ø­ ØªØ±Ø§ÙƒÙ…ÙŠÙ‹Ø§ Ø¹Ø¨Ø± Ø§Ù„Ø£Ø±Ø¬Ù„
*/
function calcFeeSingleOrMulti(orderObj, betrag, legKm){
  const base = round2(calcBaseV21(betrag));
  const firstLeg = isRouteFirstLeg(orderObj);

  // Ø¥Ù† ÙƒØ§Ù†Øª Ø³Ù„Ø³Ù„Ø©: Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„ØªØ³Ø¹ÙŠØ± Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø¬Ù„
  const inChain = !firstLeg && !!getLastDest(); // ÙˆØ¬ÙˆØ¯ ÙˆØ¬Ù‡Ø© Ø³Ø§Ø¨Ù‚Ø© = Ø¯Ø§Ø®Ù„ Ø³Ù„Ø³Ù„Ø©
  const distEUR = inChain
    ? priceDistanceProgressive(legKm, false)
    : priceDistanceProgressive(legKm, true);    // Ø£ÙˆÙ„ Ø±Ø¬Ù„: ØµÙÙ‘Ø± Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØ§Ø¨Ø¯Ø£ Ù…Ù† Ø¬Ø¯ÙŠØ¯

  // Ù…Ù„Ø§Ø­Ø¸Ø©: Ù„Ùˆ Ø£Ø±Ø¯Øª Ø¥Ø¬Ø¨Ø§Ø± Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ù†ÙØ±Ø¯Ø© Ø®Ø§Ø±Ø¬ Ø£ÙŠ Ø³Ù„Ø³Ù„Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©:
  // return round2(base + (inChain ? distEUR : priceDistanceSingle(legKm)));
  return round2(base + distEUR);
}


/* ===== Helpers/UI ===== */
const $=s=>document.querySelector(s);
const toast=t=>{ const el=$("#toast"); el.textContent=t; el.classList.add("show"); setTimeout(()=>el.classList.remove("show"),1600); if(navigator.vibrate) navigator.vibrate(20); };
const nowStr=()=>new Date().toLocaleTimeString();

/* ===== Navigation Preference & URL ===== */
const NAV_PREF_KEY='taussil_nav_pref';
function detectDefaultNav(){
  const ua = navigator.userAgent||navigator.vendor||'';
  const iOS = /iPad|iPhone|iPod/.test(ua);
  const macTouch = /\bMacintosh\b/.test(ua) && 'ontouchend' in document;
  return (iOS || macTouch) ? 'apple' : 'google';
}
function getNavPref(){ return localStorage.getItem(NAV_PREF_KEY) || 'auto'; }
function makeNavUrl(addr){
  const pref = getNavPref();
  const mode = (pref==='auto')? detectDefaultNav() : pref;
  const enc = encodeURIComponent(addr||'');
  if(mode==='apple'){ return `https://maps.apple.com/?daddr=${enc}&dirflg=d`; }
  return `https://www.google.com/maps/dir/?api=1&destination=${enc}&travelmode=driving`;
}

/* ===== Refs ===== */
const netDot=$("#netDot"), statText=$("#statText"), onlineToggle=$("#onlineToggle"), menuBtn=$("#menuBtn"), menu=$("#menu");
const mNav=$("#mNav"), mLogout=$("#mLogout");
const navModal=$("#navModal"), navClose=$("#nav_close"), navSave=$("#nav_save");
const listEl=$("#ordersList"), ordersInfo=$("#ordersInfo");
const md=$("#orderModal"), mdClose=$("#md_close");
const md_id=$("#md_id"), md_status=$("#md_status"), md_platform=$("#md_platform"), md_rest=$("#md_rest"), md_addr=$("#md_addr"), md_qty=$("#md_qty"), md_pickup=$("#md_pickup"), md_title=$("#md_title");
const md_start=$("#md_start"), md_done=$("#md_done"), md_nav=$("#md_nav");
const incoming=$("#incoming"), inText=$("#in_text"), inAccept=$("#in_accept"), inReject=$("#in_reject");
/* === ØµÙˆØª Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ (Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù€HTML): <audio id="newOrderSound" src="neu1.mp3" preload="auto"></audio> === */
const newOrderSound=$("#newOrderSound");
const appRoot=$("#appRoot"); const authModal=$("#authModal");
document.querySelectorAll('.tab-btn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    currentTab = btn.getAttribute('data-tab') || 'Neu';
    renderOrders(lastOrders); // Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù… Ø­Ø³Ø¨ Ø§Ù„ØªØ¨ÙˆÙŠØ¨
  });
});

/* Auth popup elements */
const tabLogin=$("#tabLogin"), tabRegister=$("#tabRegister");
const formLogin=$("#formLogin"), formRegister=$("#formRegister");
const loginEmail=$("#loginEmail"), loginPass=$("#loginPass"), loginBtn=$("#loginBtn"), loginMsg=$("#loginMsg");
const regFirst=$("#regFirst"), regLast=$("#regLast"), regPhone=$("#regPhone"), regEmail=$("#regEmail"), regPass=$("#regPass"), regTerms=$("#regTerms"), registerBtn=$("#registerBtn"), regMsg=$("#regMsg");

/* ===== State ===== */
const ONLINE_PREF_KEY='taussil_driver_online_pref';
const SESSION_OK='driver_session_ok';
let lastAuthTab = localStorage.getItem('driver_auth_tab') || 'login';

let uid=null, approved=false, online=false, watchId=null, lastLL=null, lastSentAt=0;
let currentTab = 'Neu';
let lastOrders = [];

function normStatus(raw){
  const s = String(raw||'').toLowerCase();
  if (['bearbeitung','zugewiesen','assigned','angenommen','unterwegs'].includes(s)) return 'neu';
  if (s==='geliefert')   return 'geliefert';
  if (s==='abgebrochen') return 'abgebrochen';
  return 'neu';
}
function inTab(o, tab){
  const ns = normStatus(o?.status);
  if (tab==='Neu')         return ns==='neu';
  if (tab==='Geliefert')   return ns==='geliefert';
  if (tab==='Abgebrochen') return ns==='abgebrochen';
  return true;
}

let regInFlight = false; // â† ØªØ³Ø¬ÙŠÙ„ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯ Ø¬Ø§Ø±Ù

/* ===== Menu ===== */
menuBtn.addEventListener("click", (e)=>{ e.preventDefault(); menu.classList.toggle("show"); });
document.addEventListener("click",(e)=>{ if(!e.target.closest(".menu") && !e.target.closest("#menuBtn")) menu.classList.remove("show"); });
mLogout.addEventListener('click', async (e)=>{
  e.preventDefault();
  try{ await signOut(auth); }catch(_){}
  sessionStorage.removeItem(SESSION_OK);
  appRoot.style.display='none'; authModal.style.display='flex';
  detachOrders(); stopPresence(); stopIncomingAlert();
  stopMedianBG();

  toast('Abgemeldet');
});

/* ===== Navigation Pref UI ===== */
function openNavPref(){
  const pref=getNavPref();
  navModal.classList.add('show');
  document.querySelectorAll('input[name="navpref"]').forEach(r=>{ r.checked = (r.value===pref); });
}
mNav.addEventListener('click', (e)=>{ e.preventDefault(); openNavPref(); });
navClose.addEventListener('click', ()=> navModal.classList.remove('show'));
navModal.addEventListener('click',(e)=>{ if(e.target===navModal) navModal.classList.remove('show'); });
navSave.addEventListener('click', (e)=>{
  e.preventDefault();
  const sel = document.querySelector('input[name="navpref"]:checked');
  const val = sel? sel.value : 'auto';
  localStorage.setItem(NAV_PREF_KEY, val);
  navModal.classList.remove('show');
  toast('Navigation gespeichert');
});

/* ===== Tabs ===== */
function switchPane(which){
  const reg = (which==='register');
  formLogin.style.display    = reg ? 'none' : 'block';
  formRegister.style.display = reg ? 'block': 'none';
  tabLogin.style.opacity     = reg ? .7 : 1;
  tabRegister.style.opacity  = reg ? 1 : .7;
  lastAuthTab = reg? 'register':'login';
  localStorage.setItem('driver_auth_tab', lastAuthTab);
}
tabLogin.addEventListener('click', (e)=>{ e.preventDefault(); switchPane('login'); });
tabRegister.addEventListener('click', (e)=>{ e.preventDefault(); switchPane('register'); });

/* ===== Auth Actions ===== */
loginBtn.addEventListener('click', async (e)=>{
  e.preventDefault();
  loginMsg.textContent=''; loginBtn.disabled=true;
  try{
    const email=(loginEmail?.value||'').trim();
    const pass =(loginPass ?.value||'');
    if(!email || !pass){ loginMsg.textContent='Bitte E-Mail & Passwort eingeben.'; return; }
    await signInWithEmailAndPassword(auth, email, pass);
    sessionStorage.setItem(SESSION_OK,'1');
  }catch(e){
    console.error(e);
    const map = {'auth/invalid-email':'E-Mail ungÃ¼ltig.','auth/user-not-found':'Kein Nutzer gefunden.','auth/wrong-password':'Falsches Passwort.','auth/too-many-requests':'Zu viele Versuche.','auth/network-request-failed':'Netzwerkfehler.'};
    loginMsg.textContent = map[e?.code] || ('Anmeldung fehlgeschlagen: '+(e?.code||''));
  }finally{ loginBtn.disabled=false; }
});

registerBtn.addEventListener('click', async (e)=>{
  e.preventDefault();
  regMsg.textContent=''; registerBtn.disabled=true; regInFlight = true;
  const first=(regFirst?.value||'').trim();
  const last =(regLast ?.value||'').trim();
  const phone=(regPhone?.value||'').trim();
  const email=(regEmail?.value||'').trim();
  const pass =(regPass ?.value||'');
  if(first.length<2){ regMsg.textContent='Bitte Vornamen (â‰¥2)'; registerBtn.disabled=false; regInFlight=false; return; }
  if(last.length<2){  regMsg.textContent='Bitte Nachnamen (â‰¥2)'; registerBtn.disabled=false; regInFlight=false; return; }
  if(!/\S+@\S+\.\S+/.test(email)){ regMsg.textContent='E-Mail ungÃ¼ltig'; registerBtn.disabled=false; regInFlight=false; return; }
  if((pass||'').length<6){ regMsg.textContent='Passwort zu kurz'; registerBtn.disabled=false; regInFlight=false; return; }
  if(!regTerms?.checked){ regMsg.textContent='Bitte AGB & Datenschutz akzeptieren.'; registerBtn.disabled=false; regInFlight=false; return; }
  try{
    const cred=await createUserWithEmailAndPassword(auth,email,pass);
    const user=cred.user;
    await user.getIdToken(true);
    const tokenRes=await user.getIdTokenResult(true);
    const claimsEmail=(tokenRes?.claims?.email ?? user.email ?? email).toString().trim();
    const uref=doc(db,'users', user.uid);
    const ex=await getDoc(uref);
    if(ex.exists()){
      regMsg.textContent='Konto existiert bereits. Bitte anmelden.';
      await signOut(auth).catch(()=>{});
      switchPane('login');
      return;
    }
    const nowTs = Timestamp.now();
    await setDoc(uref,{
      email: claimsEmail, role:'driver', approved:false, status:'pending',
      firstName:first, lastName:last, phone: phone||null,
      createdAt: nowTs, updatedAt: nowTs
    },{merge:false});
    regMsg.textContent='Konto erstellt. Wird geprÃ¼ftâ€¦';
    await signOut(auth).catch(()=>{});
    switchPane('login');
  }catch(e){
    console.error(e);
    const map = {'permission-denied': 'Berechtigung verweigert (Rules).','auth/email-already-in-use':'E-Mail bereits vergeben.','auth/invalid-email':'E-Mail ungÃ¼ltig.','auth/weak-password':'Passwort zu schwach (6+).','auth/network-request-failed':'Netzwerkfehler.'};
    regMsg.textContent = map[e?.code] || ('Registrierung fehlgeschlagen: '+(e?.code||''));
  }finally{ registerBtn.disabled=false; regInFlight=false; }
});

/* ===== Online toggle ===== */
onlineToggle.addEventListener("click", (e)=>{ e.preventDefault(); setOnline(!online); });function setOnline(flag){
  if(!uid){ toast("Bitte zuerst anmelden."); return; }
  if(!approved){ toast("Dein Konto wird geprÃ¼ft"); return; }

  online = !!flag;
  onlineToggle.classList.toggle("on", online);
  statText.textContent = online ? "Online" : "Offline";
  localStorage.setItem(ONLINE_PREF_KEY, online ? '1' : '0');

  if (online){
    startPresence();
    attachOrders();
    attachInbox();
    // âœ… Ø´ØºÙ‘Ù„ ØªØªØ¨Ù‘Ø¹ Median Ù„Ù…Ø§ ÙŠÙƒÙˆÙ† Online
    startMedianBG(uid);
  } else {
    stopPresence();
    detachOrders();
    detachInbox();
    stopIncomingAlert();
    // â›”ï¸ Ø£ÙˆÙ‚Ù Median Ù„Ù…Ø§ ÙŠÙƒÙˆÙ† Offline
    stopMedianBG();
  }
}


/* ===== Presence + GPS (RTDB) ===== */
let hbTimer = null; // Ù…Ø¤Ù‚Øª Ø§Ù„Ù†Ø¨Ø¶Ø§Øª
function startPresence(){
  const pRef = ref(rtdb, `drivers_presence/${uid}`);
  rUpdate(pRef,{ online:true, desired:true, ts: Date.now(), ver:'driver-web-v7' }).catch(()=>{});
  try{ onDisconnect(pRef).update({ lastDisconnectAt: rServerTs() }); }catch(_){}
  // âœ¨ Ø§Ø¨Ø¯Ø£ heartbeat ÙƒÙ„ 15 Ø«Ø§Ù†ÙŠØ©
  if(hbTimer) clearInterval(hbTimer);
  hbTimer = setInterval(()=>{
    rUpdate(pRef,{ online:true, ts: Date.now(), ver:'driver-web-v7' }).catch(()=>{});
  },15000);
  startWatch();
}
function stopPresence(){
  if(hbTimer){ clearInterval(hbTimer); hbTimer=null; }
  try{ rUpdate(ref(rtdb,`drivers_presence/${uid}`), { online:false, desired:false, ts: Date.now() }); }catch(_){}
  stopWatch();
}
function startWatch(){
  if(!("geolocation" in navigator)){ return; }
  if(watchId!=null) return;
  watchId = navigator.geolocation.watchPosition(
    pos=>{
      const { latitude:lat, longitude:lng, accuracy, speed } = pos.coords;
      lastLL={lat,lng};
      const now=Date.now();
      if(now-lastSentAt>=4000){
        rUpdate(ref(rtdb,`drivers_locations/${uid}`), { lat,lng, accuracy: Number.isFinite(accuracy)?accuracy:null, updatedAt: now }).catch(()=>{});
        lastSentAt=now;
      }
    },
    _=>{},
    { enableHighAccuracy:true, maximumAge:1000, timeout:10000 }
  );
}
function stopWatch(){ if(watchId!=null){ try{ navigator.geolocation.clearWatch(watchId); }catch(_){ } watchId=null; } }
/* === Addon: Live driver location v2 (non-invasive) === */
let LIVE_WATCH_ID=null, LIVE_LAST_LL=null, LIVE_LAST_SENT=0, LIVE_HB=null;

function driverLiveStart(){
  try{
    const uid = auth?.currentUser?.uid; if(!uid || !('geolocation' in navigator)) return;
    const locRef = rRef(rtdb, `drivers_locations/${uid}`);

    // Ø·Ù„Ù‚Ø© Ø£ÙˆÙ„Ù‰ Ø¯Ù‚ÙŠÙ‚Ø©
    navigator.geolocation.getCurrentPosition(p=>{
      const { latitude, longitude, accuracy } = p.coords || {};
      if (!Number.isFinite(latitude) || !Number.isFinite(longitude)) return;
      const lat = +Number(latitude).toFixed(6);
      const lng = +Number(longitude).toFixed(6);
      LIVE_LAST_LL = { lat, lng };
      rUpdate(locRef, { lat, lng, accuracy: Number.isFinite(accuracy)? accuracy:null, ts: Date.now(), ver:'kick' }).catch(()=>{});
    }, ()=>{}, { enableHighAccuracy:true, timeout:10000 });

    // Ù…ØªØ§Ø¨Ø¹Ø© Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ø§Ù„Ø­Ø±ÙƒØ© (Ù‚Ø¯ ØªØªÙˆÙ‚Ù Ø¨Ø§Ù„Ø®Ù„ÙÙŠØ© Ø¹Ù„Ù‰ Ø¨Ø¹Ø¶ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©)
    if (LIVE_WATCH_ID===null){
      LIVE_WATCH_ID = navigator.geolocation.watchPosition(p=>{
        const c = p.coords || {}; const now = Date.now();
        if (!Number.isFinite(c.latitude) || !Number.isFinite(c.longitude)) return;
        if (c.accuracy && c.accuracy > 80) return; // ØªØ¬Ø§Ù‡Ù„ Ù‚Ø±Ø§Ø¡Ø§Øª ØºÙŠØ± Ø¯Ù‚ÙŠÙ‚Ø© (>80m)
        const lat = +Number(c.latitude).toFixed(6);
        const lng = +Number(c.longitude).toFixed(6);
        LIVE_LAST_LL = { lat, lng };
        if (now - LIVE_LAST_SENT < 4000) return;   // Ø­Ø¯ Ø£Ù‚ØµÙ‰ ÙƒÙ„ â‰¥4 Ø«ÙˆØ§Ù†Ù
        LIVE_LAST_SENT = now;
        rUpdate(locRef, {
          lat, lng,
          accuracy: Number.isFinite(c.accuracy)? c.accuracy : null,
          speed:    Number.isFinite(c.speed)?    c.speed    : null,
          heading:  Number.isFinite(c.heading)?  c.heading  : null,
          ts: now, ver:'watch'
        }).catch(()=>{});
      }, err=>console.warn('GPS', err), { enableHighAccuracy:true, maximumAge:0, timeout:10000 });
    }

    // Ù†Ø¨Ø¶ ÙƒÙ„ 15s ÙŠØ¯ÙØ¹ Ø¢Ø®Ø± Ù†Ù‚Ø·Ø© Ø­ØªÙ‰ Ù„Ùˆ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø¨Ø§Ù„Ø®Ù„ÙÙŠØ©
    if (!LIVE_HB){
      LIVE_HB = setInterval(()=>{
        if(!LIVE_LAST_LL) return;
        rUpdate(locRef, { ...LIVE_LAST_LL, ts: Date.now(), ver:'hb' }).catch(()=>{});
      }, 15000);
    }
  }catch(e){ console.error('driverLiveStart error', e); }
}

function driverLiveStop(){
  try{
    if (LIVE_WATCH_ID!==null){ navigator.geolocation.clearWatch(LIVE_WATCH_ID); LIVE_WATCH_ID=null; }
    if (LIVE_HB){ clearInterval(LIVE_HB); LIVE_HB=null; }
  }catch(_){}
}

// Ø£Ø¹ÙØ¯ ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØªØ¨Ù‘Ø¹ Ø¹Ù†Ø¯ Ø±Ø¬ÙˆØ¹ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ù„Ù„Ù…Ù‚Ø¯Ù…Ø© (Safari/Android Ù‚Ø¯ ÙŠÙˆÙ‚ÙÙ‡ Ø¨Ø§Ù„Ø®Ù„ÙÙŠØ©)
document.addEventListener('visibilitychange', ()=>{ if (!document.hidden) driverLiveStart(); });
/* ===== Median Background Location (Android/iOS) ===== */
let MEDIAN_BG_ON = false;

function startMedianBG(uid){
  if(!uid) return;

  const postUrlBase = "https://europe-west1-taussil-lieferservice-8bbe9.cloudfunctions.net/driverLocation";
  const url = `${postUrlBase}?uid=${encodeURIComponent(uid)}&token=Taussil_hK8f9Q2w7yP1n`;

  const tryStart = () => {
    try{
      if (!window.median || !median.backgroundLocation) return false;
      median.backgroundLocation.start({
        postUrl: url,

        // ANDROID
        androidPriority: "highAccuracy",
        androidInterval: 15000,
        androidFastestInterval: 5000,
        androidNotificationTitle: "Taussil â€“ Standort aktiv",
        androidNotificationText:  "Fahrer-Tracking lÃ¤uft im Hintergrund.",

        // iOS
        iosBackgroundIndicator: true,
        iosPauseAutomatically: false,
        iosDesiredAccuracy: "bestForNavigation",
        iosActivityType: "automotiveNavigation"
      });
      MEDIAN_BG_ON = true;
      return true;
    }catch(e){
      console.warn("[Median] start failed (will retry)", e);
      return false;
    }
  };

  if (!tryStart()){
    let tries = 0;
    const t = setInterval(()=>{
      tries++;
      if (tryStart() || tries >= 20) clearInterval(t);
    }, 500);
  }
}

function stopMedianBG(){
  try{ median?.backgroundLocation?.stop(); }catch(_){}
  MEDIAN_BG_ON = false;
}

/* ===== Orders ===== */
/* === Multi-order (stops) support === */
const stopsUnsubs = new Map();
function detachStopsAll(){ stopsUnsubs.forEach(u=>{try{u();}catch(_){}}); stopsUnsubs.clear(); }

/* ØªØ³Ù„ÙŠÙ… stop ÙˆØ§Ø­Ø¯ Ù…Ø¹ Ø­Ø³Ø§Ø¨ Ù…Ø³Ø§ÙØ© Ø§Ù„Ø±Ø¬Ù„ ÙÙ‚Ø· (ØªØ±Ø§ÙƒÙ…ÙŠ Ø¹Ø¨Ø± Ø§Ù„Ø±Ø­Ù„Ø©) */
async function finalizeStop(orderId, stopId, stopData, orderData){
  try{
    // Ù†Ø¨Ù†ÙŠ ÙƒØ§Ø¦Ù† "ÙŠØ´Ø¨Ù‡" Ø§Ù„Ø·Ù„Ø¨ Ù„Ù‚ÙŠØ§Ø³ Ø§Ù„Ù…Ø³Ø§ÙØ©: Ù…Ø·Ø¹Ù… Ù…Ù† Ø§Ù„Ù€order ÙˆÙˆØ¬Ù‡Ø© Ù…Ù† Ø§Ù„Ù€stop
    const orderLike = { ...orderData, address_text: (stopData.address_text || stopData.addressText || '') };
    const km = await computeLegKmForOrder(orderLike);

    // ØªØ³Ø¹ÙŠØ± Ø§Ù„Ù…Ø³Ø§ÙØ© ÙÙ‚Ø· Ø¨Ø´ÙƒÙ„ ØªØ±Ø§ÙƒÙ…ÙŠ Ø¹Ø¨Ø± Ø§Ù„Ø£Ø±Ø¬Ù„ (Ø§Ù„Ù€ 2 ÙƒÙ… Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ© ØªÙØ·Ø¨Ù‘ÙÙ‚ Ù…Ø±Ù‘Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙŠ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø³Ù„Ø³Ù„Ø©)
    const firstLeg = isRouteFirstLeg(orderData);
    const distEUR  = priceDistanceProgressive(km, firstLeg);

    // ØªØ­Ø¯ÙŠØ« ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ù€stop ÙÙ‚Ø·
    const sref = doc(db, "orders", orderId, "stops", stopId);
    await updateDoc(sref, {
      status: "Geliefert",
      deliveredAt: serverTimestamp(),
      distance_km: km,
      deliveryFee: distEUR,
      updatedAt: serverTimestamp()
    });

    // Ø±Ø¨Ø· Ø§Ù„Ø³Ù„Ø³Ù„Ø©: Ø¢Ø®Ø± ÙˆØ¬Ù‡Ø© = Ù‡Ø°Ø§ Ø§Ù„ØªØ³Ù„ÙŠÙ…
    const drop = (stopData.address_text || stopData.addressText || '');
    if(drop) setLastDestFromText(drop); else if(lastLL) setLastDestFromLL(lastLL);

    // Ø¹Ø¯Ù‘Ø§Ø¯ Ø§Ù„ØªÙ‚Ø¯Ù… ÙÙŠ Ø§Ù„Ù€order (Ø¨Ø¯ÙˆÙ† Ù‚Ø±Ø§Ø¡Ø© Ø¥Ø¶Ø§ÙÙŠØ©)
    const prevDel = Number(orderData.stops_delivered||0);
    const qty     = Number(orderData.qty||0);
    await updateDoc(doc(db,"orders", orderId), { stops_delivered: increment(1), updatedAt: serverTimestamp() });
	await recalcOrderFees(orderId);
    if(qty>0 && (prevDel+1)>=qty){ await patchOrder(orderId, { status:"Geliefert" }); }

    toast(`Stop geliefert Â· ${km.toFixed(2)} km Â· +${distEUR.toFixed(2)}â‚¬`);
  }catch(e){ console.error(e); toast("Fehler beim Stop"); }
}

/* Ù…Ø³ØªÙ…Ø¹ ÙØ±Ø¹ÙŠ Ù„ÙƒÙ„ Ø·Ù„Ø¨: ÙŠØ¹Ø±Ø¶ Ø£Ø³Ø·Ø± Ø§Ù„Ù€stops ÙˆÙŠØ®ÙÙŠ Ø²Ø± Delivered Ø§Ù„Ø¹Ø§Ù… */
function attachStopsForOrder(orderId, orderData, cardEl){
  // ÙØ¶Ù‘Ù Ø£ÙŠ Ù…Ø³ØªÙ…Ø¹ Ø³Ø§Ø¨Ù‚ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨
  try{ stopsUnsubs.get(orderId)?.(); }catch(_){}
  const cont = cardEl.querySelector('.multi-stops');
  if(!cont) return;
  const doneGeneral = cardEl.querySelector('button[data-act="delivered"]');

  const subCol = collection(db, "orders", orderId, "stops");
  const unsub = onSnapshot(subCol, (snap)=>{
    const docs = snap.docs.map(d=>({ id:d.id, s:d.data()||{} }));
    if(docs.length===0){
      cont.style.display='none';
      if(doneGeneral) doneGeneral.style.display='inline-flex'; // Ø·Ù„Ø¨ Ù…Ù†ÙØ±Ø¯ => ÙŠØ±Ø¬Ø¹ Ø§Ù„Ø²Ø± Ø§Ù„Ø¹Ø§Ù…
      return;
    }
    cont.style.display='block';
    if(doneGeneral) doneGeneral.style.display='none';          // Multi => Ù†Ø®ÙÙŠ Ø§Ù„Ø²Ø± Ø§Ù„Ø¹Ø§Ù…

    // ØªØ±ØªÙŠØ¨: Ø­Ø³Ø¨ nr Ø«Ù… id
    docs.sort((a,b)=>{
      const na=Number(a.s.nr||0), nb=Number(b.s.nr||0);
      if(na!==nb) return na-nb; return a.id.localeCompare(b.id);
    });

    cont.innerHTML = docs.map(({id,s},i)=>{
      const st  = mapStatusLabel(s.status||'Bearbeitung');
      const del = String(s.status||'').toLowerCase()==='geliefert';
      const plat= s.platform || '';
      const addr= s.address_text || s.addressText || '';
      const initials = (plat||id).slice(0,2).toUpperCase();
      const btn = del ? `<span class="btn-icon btn-done" title="Geliefert">âœ“</span>`
                      : `<button class="btn-icon btn-done" data-stop="${id}" title="Diesen Stop liefern">âœ“</button>`;
      return `
        <div class="stop-row" data-stop="${id}">
          <div class="stop-logo">${initials}</div>
          <div class="info">
            <div class="line"><strong>${s.name || orderData.restaurant?.name || 'â€”'}</strong> <span class="tag">Item #${i+1} Â· ${st}</span></div>
            <div class="small">${plat || 'â€”'}</div>
            <div class="small" style="opacity:.85;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${addr || 'â€”'}</div>
          </div>
          <div class="act">${btn}</div>
        </div>`;
    }).join("");

    // Ø±Ø¨Ø· Ø²Ø± Ø§Ù„ØªØ³Ù„ÙŠÙ… Ù„ÙƒÙ„ stop
    cont.querySelectorAll('button[data-stop]').forEach(btn=>{
      btn.onclick = async (e)=>{
        e.stopPropagation();
        const sid = btn.getAttribute('data-stop');
        const sd  = docs.find(d=>d.id===sid)?.s || {};
        await finalizeStop(orderId, sid, sd, orderData);
      };
    });
  }, ()=>{ cont.style.display='none'; if(doneGeneral) doneGeneral.style.display='inline-flex'; });

  stopsUnsubs.set(orderId, unsub);
}

let unsubOrders=null, unsubInbox=null;
function detachOrders(){
  unsubOrders?.(); unsubOrders=null;
  ordersInfo.textContent="â€”"; listEl.innerHTML="";
  detachStopsAll(); /* â† Ø¥Ø¶Ø§ÙØ© */
}

function mapStatusLabel(s){ const low=String(s||"").toLowerCase(); if(low==="bearbeitung") return "Neu"; return s||"â€”"; }

function attachOrders(){
  detachOrders();
  if(!uid){ ordersInfo.textContent="â€”"; return; }
  const qMine=query(collection(db,"orders"), where("driver.id","==", uid), limit(50));
  unsubOrders = onSnapshot(qMine,(snap)=>{
    const items = snap.docs.map(d=>({ id:d.id, o:d.data()||{} }))
      .sort((a,b)=>{
        const ta=(a.o.updatedAt&&a.o.updatedAt.toMillis)?a.o.updatedAt.toMillis():0;
        const tb=(b.o.updatedAt&&b.o.updatedAt.toMillis)?b.o.updatedAt.toMillis():0;
        return tb-ta;
      });
    lastOrders = items.slice();
    renderOrders(lastOrders);
    snap.docChanges().forEach(ch=>{
      const now=String(ch.doc.data()?.status||'').toLowerCase();
      if(now==='zugewiesen' || now==='assigned'){ showIncoming({id:ch.doc.id, o:ch.doc.data()||{}}); }
    });
  }, ()=>{ ordersInfo.textContent="Wird geprÃ¼ftâ€¦"; });
}

function renderOrders(items){
  const filtered = items.filter(({o})=> inTab(o, currentTab));
  ordersInfo.textContent = `${filtered.length} sichtbar (${currentTab})`;
  if(filtered.length===0){ listEl.innerHTML = `<div class="small" style="opacity:.8">â€” Keine AuftrÃ¤ge â€”</div>`; return; }

  listEl.innerHTML = filtered.map(({id,o})=>{
    const stRaw=o.status||"â€”", st=mapStatusLabel(stRaw);
    const rest=o.restaurant?.name||"â€”";
    const addr=(o.restaurant?.addressText || o.restaurant?.address_text || "").trim();
    const qty =Number(o.qty||0)||0;
    const plat=Array.isArray(o.platform)? o.platform.join(" / ") : (o.platform||"â€”");
    const lower=String(stRaw).toLowerCase();
    const showStart = (lower==="angenommen" || lower==="zugewiesen" || lower==="assigned" || lower==="bearbeitung");
    const showDone  = (lower==="unterwegs");
    const logoUrl=o.restaurant?.logoUrl||"";
    const logoHTML = logoUrl? `<img src="${logoUrl}" alt="${rest}">` : `<div class="ph">${(rest||"â€”").slice(0,2).toUpperCase()}</div>`;
    const navHref = addr ? makeNavUrl(addr) : '#';
    return `
      <div class="card-order" data-id="${id}" data-addr="${encodeURIComponent(addr)}">
        <div class="logo">${logoHTML}</div>
        <div class="info">
          <div class="line"><strong>${rest}</strong> <span class="tag">${st}</span></div>
          <div class="small">${plat} Â· Qty ${qty}</div>
          <div class="small" style="opacity:.85;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${addr || 'â€”'}</div>
		  <div class="multi-stops" data-stops-of="${id}" style="grid-column:1 / -1; display:none"></div>
        </div>
        <div class="act">
          ${ showStart ? `<a class="btn-icon btn-go" href="${navHref}" target="_blank" rel="noopener noreferrer" data-act="start">â–¶</a>` : ``}
          ${ showDone  ? `<button class="btn-icon btn-done" data-act="delivered">âœ“</button>` : ``}
        </div>
      </div>
    `;
  }).join("");
  // Ø®Ø±ÙŠØ·Ø© Ù„Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹ Ù„ÙƒØ§Ø¦Ù† Ø§Ù„Ù€order
const omap = new Map(filtered.map(({id,o})=>[id,o]));

listEl.querySelectorAll(".card-order").forEach(el=>{
  const id = el.getAttribute("data-id");
  const addr = decodeURIComponent(el.getAttribute("data-addr")||"").trim();

  // Ø±Ø¨Ø· ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ÙƒÙ…Ø§ Ù‡Ùˆ Ù…ÙˆØ¬ÙˆØ¯ Ø¹Ù†Ø¯Ùƒ
  el.addEventListener("click",(e)=>{
    if(e.target.closest(".btn-icon")) return;
    openDetail(id);
  });

  // Ø£Ø²Ø±Ø§Ø±Ùƒ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ÙƒÙ…Ø§ Ù‡ÙŠ
  const startA = el.querySelector('a[data-act="start"]');
  if(startA){
    startA.addEventListener("click", async (e)=>{
      if(!addr){ e.preventDefault(); toast('Restaurant-Adresse fehlt'); return; }
      await safeSetStatusToUnterwegs(id);
    });
  }
  const doneBtn = el.querySelector('button[data-act="delivered"]');
  if(doneBtn){
    doneBtn.addEventListener("click", async (e)=>{
      e.stopPropagation();
      await finalizeOrderWithFee(id); // ÙŠØ¸Ù„ Ù„Ù„Ø·Ù„Ø¨ Ø§Ù„Ù…Ù†ÙØ±Ø¯ ÙÙ‚Ø·
    });
  }

  // âœ… ØªØ´ØºÙŠÙ„ Ù…Ø³ØªÙ…Ø¹ Ø§Ù„Ù€stops Ù„Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ (Ø¥Ù† ÙˆÙØ¬Ø¯Øª subcollection Ø³ÙŠØ¸Ù‡Ø±ÙˆØ§Ø› ØºÙŠØ± Ø°Ù„Ùƒ ÙŠØ¨Ù‚Ù‰ Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ù‚Ø¯ÙŠÙ…)
  const o = omap.get(id) || {};
  attachStopsForOrder(id, o, el);
});


  // Ø±Ø¨Ø· Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
  listEl.querySelectorAll(".card-order").forEach(el=>{
    el.addEventListener("click",(e)=>{
      if(e.target.closest(".btn-icon")) return;
      const id = el.getAttribute("data-id"); openDetail(id);
    });
    const startA = el.querySelector('a[data-act="start"]');
    if(startA){
      startA.addEventListener("click", async (e)=>{
        const id = el.getAttribute("data-id");
        const addr = decodeURIComponent(el.getAttribute("data-addr")||"").trim();
        if(!addr){ e.preventDefault(); toast('Restaurant-Adresse fehlt'); return; }
        await safeSetStatusToUnterwegs(id);
      });
    }
    const doneBtn = el.querySelector('button[data-act="delivered"]');
    if(doneBtn){
      doneBtn.addEventListener("click", async (e)=>{
        e.stopPropagation();
        const id = el.getAttribute("data-id");
        await finalizeOrderWithFee(id);
      });
    }
  });
}


/* ===== Inbox (RTDB) ===== */
function detachInbox(){ unsubInbox?.(); unsubInbox=null; }
function attachInbox(){
  detachInbox();
  if(!uid) return;
  const inboxRef = ref(rtdb, `drivers_inbox/${uid}`);
  unsubInbox = onValue(inboxRef, (snap)=>{
    const v = snap.val()||{};
    const oid = v.lastOrderAssigned || null;
    if(oid){
      getDoc(doc(db,"orders", oid)).then(ds=>{
        if(!ds.exists()) return;
        const o=ds.data()||{};
        const s=String(o.status||'').toLowerCase();
        if(s==='abgebrochen' || s==='geliefert') return;
        showIncoming({id:oid, o});
      }).catch(()=>{});
    }
  });
}

/* ===== Incoming popup + ØªÙ†Ø¨ÙŠÙ‡ ØµÙˆØªÙŠ Ù…ÙØµØ­Ù‘Ø­ ===== */
function showIncoming({id,o}){
  inText.textContent = `${o.restaurant?.name||'â€”'} Â· ${Array.isArray(o.platform)?o.platform.join(' / '):(o.platform||'â€”')}`;
  incoming.classList.add("show");
  // ğŸ”” ÙØ¹Ù‘Ù„ Ø§Ù„ØµÙˆØª Ø¹Ù†Ø¯ Ø¸Ù‡ÙˆØ± Ø§Ù„Ù€incoming
  startIncomingSound(id);
  inAccept.onclick = async (e)=>{ e.preventDefault(); await acceptAssigned(id); stopIncomingAlert(); closeIncoming(); };
  inReject.onclick = async (e)=>{ e.preventDefault(); await rejectAssigned(id); stopIncomingAlert(); closeIncoming(); };
}
function closeIncoming(){ incoming.classList.remove("show"); /* Ø£ÙˆÙ‚Ù Ø§Ù„ØµÙˆØª Ø¹Ù†Ø¯ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ */ stopIncomingAlert(); }

/* === Audio Autoplay Unlock + Beep Scheduler (FIX) === */
let beepTimer=null;
let audioUnlocked=false;
function unlockAudioOnce(){
  if(audioUnlocked) return;
  audioUnlocked = true;
  try{
    if(newOrderSound){
      newOrderSound.muted = false;
      newOrderSound.volume = 1;
      // Ù†Ø¨Ø¶Ø© Ø³Ø±ÙŠØ¹Ø© Ù„ÙÙƒ Ø§Ù„Ù‚ÙÙ„
      newOrderSound.play().then(()=>newOrderSound.pause()).catch(()=>{});
    }
  }catch(_){}
}
// ÙÙƒ Ø§Ù„Ù‚ÙÙ„ Ø¨Ø¹Ø¯ Ø£ÙŠ ØªÙØ§Ø¹Ù„ Ù„Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©
['pointerdown','touchstart','keydown','focus'].forEach(evt=>{
  window.addEventListener(evt, unlockAudioOnce, { once:true, capture:true });
});

function startIncomingSound(scope=''){
  if(!newOrderSound) return;
  // Ù„Ø§ Ù†Ø³Ù…Ø­ Ø¨ØªØ¹Ø¯Ø¯ Ø§Ù„Ù…Ø¤Ù‚ØªØ§Øª
  if(beepTimer){ clearInterval(beepTimer); beepTimer=null; }
  const play = ()=>{
    try{
      newOrderSound.muted = false; newOrderSound.volume = 1;
      newOrderSound.currentTime = 0;
      newOrderSound.play().catch(()=>{ /* Ù‚Ø¯ ÙŠØ±ÙØ¶ Ù‚Ø¨Ù„ unlockØ› Ù„Ø§ Ù…Ø´ÙƒÙ„Ø© */ });
    }catch(_){}
  };
  play();
  // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ© Ø¥Ø°Ø§ Ù…Ø§ ØªÙØ§Ø¹Ù„ Ø§Ù„Ø³Ø§Ø¦Ù‚
  beepTimer = setInterval(play, 30000);
}
function stopIncomingAlert(){
  if(beepTimer){ clearInterval(beepTimer); beepTimer=null; }
  try{ newOrderSound?.pause(); }catch(_){}
}

/* ===== Start / Accept / Reject ===== */
async function safeSetStatusToUnterwegs(id){
  try{
    const snap=await getDoc(doc(db,"orders", id));
    const o=snap.exists()? (snap.data()||{}) : {};
    const s=String(o.status||'').toLowerCase();
    if(!(s==='angenommen' || s==='unterwegs')){ await patchOrder(id, { status:"Angenommen" }); }
    await patchOrder(id, { status:"Unterwegs" });
    toast("Unterwegs");
  }catch(_){ toast("Fehler beim Start"); }
}
async function acceptAssigned(id){ await patchOrder(id, { status:"Angenommen" }); toast("Angenommen"); }
async function rejectAssigned(id){ await patchOrder(id, { status:"Abgebrochen" }); toast("Abgebrochen"); }

/* ===== Detail sheet ===== */
// === Price helpers & refs ===
const md_price_value = document.getElementById('md_price_value');
const md_price_edit  = document.getElementById('md_price_edit');

const priceModal   = document.getElementById('priceModal');
const price_close  = document.getElementById('price_close');
const price_cancel = document.getElementById('price_cancel');
const price_save   = document.getElementById('price_save');
const price_input  = document.getElementById('price_input');

let priceEditOrderId = null;
let priceBusy = false;

function formatEUR(val){
  const n = Number(val||0);
  try{ return new Intl.NumberFormat('de-DE',{style:'currency',currency:'EUR'}).format(n); }
  catch{ return n.toFixed(2)+' â‚¬'; }
}
function parseEUR(raw){
  if(!raw) return null;
  const cleaned = String(raw).replace(/[^\d,.\-]/g,'').trim().replace(',', '.');
  const num = Number(cleaned);
  if(!isFinite(num) || num < 0) return null;
  if(num > 500) return null;
  return Math.round(num * 100) / 100;
}
function canEditPrice(o){
  const assigned = (o?.driver?.id === uid);
  const s = String(o?.status||'').toLowerCase();
  const allowed = (s==='bearbeitung' || s==='unterwegs' || s==='angenommen' || s==='assigned' || s==='zugewiesen');
  return assigned && allowed;
}
function openPriceModal(prefillEUR){
  price_input.value = (typeof prefillEUR === 'number' ? prefillEUR.toFixed(2).replace('.', ',') : '');
  priceModal.classList.add('show');
  setTimeout(()=>{ price_input?.focus(); price_input?.select(); }, 0);
}
function closePriceModal(){ priceModal.classList.remove('show'); }
price_close?.addEventListener('click', closePriceModal);
price_cancel?.addEventListener('click', closePriceModal);
priceModal?.addEventListener('click', (e)=>{ if(e.target===priceModal) closePriceModal(); });

async function savePriceEUR(orderId, newPriceEUR){
  if(priceBusy) return;
  priceBusy = true; price_save.disabled = true;
  try{
    const refDoc = doc(db, 'orders', orderId);
    await runTransaction(db, async (tx) => {
      const snap = await tx.get(refDoc);
      if(!snap.exists()) throw new Error('Order not found');
      const data = snap.data() || {};
      if(!canEditPrice(data)) throw new Error('Status/Berechtigung');

      const prevEUR  = Number(data.price||0) || 0;
      const prevCent = Number.isFinite(data.price_cents)? data.price_cents : Math.round(prevEUR*100);

      tx.update(refDoc, {
        price: newPriceEUR,
        price_cents: Math.round(newPriceEUR*100),
        price_prev_cents: prevCent,
        price_change_count: increment(1),
        price_updated_by: 'driver',
        price_updated_at: serverTimestamp(),
        updatedAt: serverTimestamp(),
      });
    });
    md_price_value.textContent = formatEUR(newPriceEUR);
    toast('âœ” Preis gespeichert');
    closePriceModal();
  }catch(e){
    const msg = String(e?.message||e);
    if(msg.includes('Status/Berechtigung')) toast('Status erlaubt keine Ã„nderung / Keine Berechtigung');
    else toast('Fehler beim Speichern');
  }finally{
    priceBusy = false; price_save.disabled = false;
  }
}

// Ø±Ø¨Ø· Ø²Ø± Ø§Ù„Ø­ÙØ¸ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©
price_save?.addEventListener('click', async ()=>{
  const eur = parseEUR(price_input.value);
  if(eur===null){ toast('UngÃ¼ltiger Betrag (0â€“500 â‚¬)'); return; }
  if(!priceEditOrderId){ toast('Kein Auftrag'); return; }
  await savePriceEUR(priceEditOrderId, eur);
});

async function openDetail(id){
  const snap=await getDoc(doc(db,"orders", id)); if(!snap.exists()) return;
  const o=snap.data()||{};
  md_id.textContent=id;
  md_status.textContent=mapStatusLabel(o.status||"â€”");
  md_platform.textContent=Array.isArray(o.platform)?o.platform.join(" / "):(o.platform||"â€”");
  md_rest.textContent=o.restaurant?.name||"â€”";
  const addr=(o.restaurant?.addressText || o.restaurant?.address_text || "").trim();
  md_addr.textContent=addr || 'â€”';
  md_qty.textContent=Number(o.qty||0)||0;
  md_pickup.textContent=o.pickupTime || "â€”";
  md_title.textContent=o.restaurant?.name||"Auftrag";
  const priceEUR = Number(o.price||0) || 0;
md_price_value.textContent = formatEUR(priceEUR);
md_price_edit.disabled = !canEditPrice(o);
md_price_edit.title = md_price_edit.disabled ? 'Keine Berechtigung / Ø§Ù„Ø­Ø§Ù„Ø© Ù„Ø§ ØªØ³Ù…Ø­' : 'Preis bearbeiten';
priceEditOrderId = id;
md_price_edit.onclick = (e)=>{
  e.preventDefault();
  if(md_price_edit.disabled) return;
  openPriceModal(priceEUR);
};

  md.classList.add("show");
  md_start.onclick=async (e)=>{
    e.preventDefault();
    if(!addr){ toast('Restaurant-Adresse fehlt'); return; }
    window.open(makeNavUrl(addr), '_blank', 'noopener,noreferrer');
    await safeSetStatusToUnterwegs(id);
  };
  md_done.onclick = async (e)=>{
    e.preventDefault();
    await finalizeOrderWithFee(id);
    md.classList.remove("show");
  };
  md_nav.onclick  = (e)=>{
    e.preventDefault();
    if(!addr){ toast('Restaurant-Adresse fehlt'); return; }
    window.open(makeNavUrl(addr), '_blank', 'noopener,noreferrer');
  };
}
mdClose.addEventListener("click", ()=> md.classList.remove("show"));
md.addEventListener("click",(e)=>{ if(e.target===md) md.classList.remove("show"); });

/* ===== Patch order helper ===== */
// Ù„Ùˆ Ø£Ø±Ø¯Øª Ø§Ø³ØªØ®Ø¯Ø§Ù… deliveryFee Ø±Ø³Ù…ÙŠÙ‹Ø§: Ø§Ø³Ù…Ø­ Ø¨Ù‡ ÙÙŠ Ø§Ù„Ù€ Rules
const PREFER_DELIVERY_FEE_FIELD = true;

async function patchOrder(id, fields){
  const allowed = {};
  if ('status'      in fields) allowed.status      = fields.status;
  if ('price'       in fields) allowed.price       = Number(fields.price);
  if ('deliveryFee' in fields) allowed.deliveryFee = Number(fields.deliveryFee);
  if ('etmTargetMs' in fields) allowed.etmTargetMs = fields.etmTargetMs;
  if ('ETM_Target'  in fields) allowed.ETM_Target  = fields.ETM_Target;
  allowed.updatedAt = serverTimestamp();

  const refDoc = doc(db, "orders", id);
  try { await updateDoc(refDoc, allowed); }
  catch { await setDoc(refDoc, allowed, { merge:true }); }
}

/* ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø±Ø³ÙˆÙ… Ù…Ø¹ Fallback Ù„ÙŠØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠØ© (Ù„Ù„Ø·Ù„Ø¨ Ø§Ù„Ù…ÙØ±Ø¯) */
async function writeFeeOnly(id, fee){
  await patchOrder(id, { status:"Geliefert", deliveryFee: fee });
  return { field:'deliveryFee', fee };
}

/* === Recalculate order fees (Multi-Orders: 14% + distance from stops) === */
async function recalcOrderFees(orderId){
  try{
    const oref  = doc(db,"orders", orderId);
    const osnap = await getDoc(oref);
    if(!osnap.exists()) return;

    // Ø§Ù‚Ø±Ø£ Ø³ØªÙˆØ¨Ø²
    const sref = collection(db, "orders", orderId, "stops");
    const snap = await getDocs(sref);
    if (snap.empty) return; // Ù„Ø§ Ø³ØªÙˆØ¨Ø² => Ù„ÙŠØ³ Ù…Ù„ØªÙŠ

    let itemsTotal = 0;
    let distTotal  = 0;
    let delivered  = 0;
    let qtyTotal   = 0;

    snap.forEach(d=>{
      const s = d.data() || {};
      itemsTotal += Number(s.price||0) || 0;
      qtyTotal   += Number(s.qty||0)   || 0;

      // Ù†Ø¬Ù…Ø¹ Ø±Ø³ÙˆÙ… Ø§Ù„Ù…Ø³Ø§ÙØ© ÙÙ‚Ø· Ù„Ù„Ø³ØªÙˆØ¨ Ø§Ù„Ù…Ø¹Ù„Ù† Geliefert
      if (String(s.status||'').trim().toLowerCase() === 'geliefert'){
        delivered++;
        distTotal += Number(s.deliveryFee||0) || 0;
      }
    });

    // 14% Ù…Ù† Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚ÙŠÙ…Ø© Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ù„ØªÙŠ
    const service = Math.round(itemsTotal * 0.14 * 100) / 100;
    const total   = Math.round((service + distTotal) * 100) / 100;

    await updateDoc(oref, {
      items_total_eur: itemsTotal,
      serviceFee:      service,
      distanceFee:     distTotal,
      deliveryFee:     total,
      stops_delivered: delivered,
      qty:             qtyTotal,
      updatedAt:       serverTimestamp()
    });
  }catch(e){
    console.error('recalcOrderFees', e);
  }
}

/* Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ÙƒØ§Ù…Ù„Ø© Ø¹Ù†Ø¯ Ø§Ù„ØªØ³Ù„ÙŠÙ…: route â†’ km â†’ Betrag â†’ Fee â†’ ØªØ­Ø¯ÙŠØ« (Ù„Ù„Ø·Ù„Ø¨ Ø§Ù„Ù…ÙØ±Ø¯) */
async function finalizeOrderWithFee(id){
  try{
    const ds = await getDoc(doc(db,"orders", id));
    if(!ds.exists()){ toast("Auftrag nicht gefunden"); return; }
    const o   = ds.data() || {};

    const km     = await computeLegKmForOrder(o); // ÙƒÙ… ÙØ¹Ù„ÙŠ
    const betrag = getOrderAmount(o);             // Ù…Ø¨Ù„Øº Ø§Ù„Ø·Ù„Ø¨
    const fee    = calcFeeSingleOrMulti(o, betrag, km);

    const res = await writeFeeOnly(id, fee);

    // Ø§Ø±Ø¨Ø· Ø§Ù„Ø³Ù„Ø³Ù„Ø©: Ø¢Ø®Ø± Ù†Ù‚Ø·Ø© = Ù‡Ø°Ø§ Ø§Ù„ØªØ³Ù„ÙŠÙ…
    const drop = getDropAddr(o);
    if (drop) setLastDestFromText(drop);
    else if (lastLL) setLastDestFromLL(lastLL);

    toast(`Geliefert Â· ${km.toFixed(2)} km Â· LiefergebÃ¼hr ${fee.toFixed(2)}â‚¬ (${res.field})`);
  }catch(e){
    console.error('finalizeOrderWithFee', e);
    toast('Fehler beim AbschlieÃŸen');
  }
}


/* ===== Auth gate ===== */
onAuthStateChanged(auth, async (user)=>{
  // Ø§Ù…Ù†Ø¹ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¥Ù„Ø§ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ (regInFlight)
  if (user && sessionStorage.getItem(SESSION_OK) !== '1' && !regInFlight) {
    await signOut(auth).catch(()=>{});
    authModal.style.display='flex'; appRoot.style.display='none';
    return;
  }
  if(!user){
    uid=null;
    appRoot.style.display='none'; authModal.style.display='flex';
    detachOrders(); stopPresence(); stopIncomingAlert();
	stopMedianBG();

    switchPane(lastAuthTab==='register' ? 'register' : 'login');
    return;
  }
  uid = user.uid;

  // ØªØ­Ù‚Ù‚ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©
  approved=false;
  try{
    const ds=await getDoc(doc(db,'users',uid));
    if(ds.exists()){
      const u=ds.data()||{};
      approved=(u.approved===true && u.role==='driver');
    }
  }catch(_){}

  authModal.style.display='none'; appRoot.style.display='block';
  attachOrders();
});

/* ===== Network dot ===== */
function setNet(on){ netDot.classList.toggle("on", on); netDot.classList.toggle("off", !on); }
setNet(navigator.onLine);
window.addEventListener("online", ()=>setNet(true));
window.addEventListener("offline", ()=>setNet(false));

/* ===== Init ===== */
document.addEventListener('DOMContentLoaded', ()=>{
  authModal.style.display='flex';
  switchPane(lastAuthTab==='register' ? 'register' : 'login');
});
</script>

</body>
</html>
